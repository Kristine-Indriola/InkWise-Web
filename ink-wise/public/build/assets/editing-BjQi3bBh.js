document.addEventListener("DOMContentLoaded",()=>{var ta,ea,ra,aa,na,ia,oa,sa,ca,la;document.addEventListener("focusin",t=>{t.target&&t.target.matches("input[data-text-node]")&&mt(t.target)}),document.addEventListener("click",t=>{t.target&&t.target.matches("input[data-text-node]")&&mt(t.target);const e=t.target&&t.target.closest&&t.target.closest("svg [data-text-node]"),r=t.target&&t.target.closest&&(t.target.closest("svg image")||t.target.closest("svg [data-uploaded]"));if(e){const a=t.target.closest("[data-text-node]"),n=a.closest("svg"),i=n.closest(".card"),o=i&&i.dataset&&i.dataset.card?i.dataset.card:n.id==="cardFront"?"front":"back";A=a,V=o,mt(t.target),$(a,o);try{Wt(a,o)}catch{}}else if(r){const a=t.target.closest("image")||t.target.closest("[data-uploaded]");if(a){const n=a.closest("svg"),i=n.closest(".card"),o=i&&i.dataset&&i.dataset.card?i.dataset.card:n.id==="cardFront"?"front":"back";if(!fr){le();return}A=a,V=o,le(),$(a,o)}}});const ze=document.getElementById("showFront"),Me=document.getElementById("showBack"),ua=document.querySelectorAll(".view-toggle button"),ot=document.getElementById("cardFront"),st=document.getElementById("cardBack"),Ae=document.getElementById("zoomIn"),xe=document.getElementById("zoomOut"),cr=document.getElementById("zoomLevel"),Re=document.querySelector(".canvas"),et=document.getElementById("textFields"),lr=document.getElementById("addTextField"),De=document.querySelectorAll(".side-btn"),da=document.querySelectorAll(".editor-panel"),ur=document.querySelectorAll("[data-image-input]"),fa=document.querySelectorAll("[data-reset-image]"),Gt={front:document.querySelector('[data-image-preview="front"]'),back:document.querySelector('[data-image-preview="back"]')},dr=((ta=document.body)==null?void 0:ta.dataset)||{},He=(dr.imageReplacementMode||"").toLowerCase();let se="full";He==="panel-only"||He==="disabled"?se=He:dr.allowImageReplacement==="false"&&(se="disabled");const Ue=se!=="disabled",fr=se==="full",Z=se==="disabled",ut=ur.length>0,ct=document.getElementById("textToolbar"),It=document.querySelector(".canvas-area"),Ft=document.querySelector(".canvas"),pr=document.getElementById("changeImageBtn"),we=window.inkwiseTemplateParser||{},gr=we.front||{},yr=we.back||{},hr=Array.isArray(we.warnings)?we.warnings:[],Se=(t,e,r)=>{if(!t||typeof t!="object")return 0;const a=t[e];if(typeof a=="number"&&Number.isFinite(a))return Number(a);const n=t[r];return Array.isArray(n)?n.length:0},mr={front:Se(gr,"text_count","text_elements"),back:Se(yr,"text_count","text_elements")},Ut={front:Se(gr,"changeable_count","changeable_images"),back:Se(yr,"changeable_count","changeable_images")},br=Ut.front+Ut.back;function pa(){const t=document.getElementById("parserFrontSummary");t&&(t.textContent=`Front: text ${mr.front} • replaceable images ${Ut.front}`);const e=document.getElementById("parserBackSummary");e&&(e.textContent=`Back: text ${mr.back} • replaceable images ${Ut.back}`);const r=document.getElementById("parserWarningsContainer"),a=document.getElementById("parserWarningsList");r&&a&&(hr.length?(r.hidden=!1,a.innerHTML="",hr.forEach(o=>{const s=document.createElement("li");s.textContent=o,a.appendChild(s)})):(r.hidden=!0,a.innerHTML=""));const n=[`front ${Ut.front}`];Ut.back&&n.push(`back ${Ut.back}`);const i=document.getElementById("imageParserStatus");i&&(br>0?fr?i.textContent=`Replaceable image areas detected: ${n.join(" • ")}`:i.textContent="Use the Images panel to swap the template background.":i.textContent="No replaceable image areas detected in this template."),pr&&(pr.title=br>0?`Swap detected image areas (${n.join(" • ")})`:"Template import did not include replaceable image frames.")}if(pa(),It){const t=window.getComputedStyle(It).position;(!t||t==="static")&&(It.style.position="relative")}else if(Ft){const t=window.getComputedStyle(Ft).position;(!t||t==="static")&&(Ft.style.position="relative")}function vr(t){var n;if(!t)return;const e={left:"start",center:"middle",right:"end",justify:"start"},r=t==="justify"?"justify":t||"center",a=document.activeElement;if(a&&a.matches&&a.matches("input[data-text-node]")){const i=_(a),o=(n=q[i])==null?void 0:n.get(O(a));o&&I(o,i);try{a.dataset.align=r}catch{}if(o){try{o.setAttribute("text-anchor",e[r]||"middle")}catch{}const s=o.getAttribute("x")||o.dataset.originalX||null;s&&o.querySelectorAll("tspan").forEach(c=>c.setAttribute("x",s));try{P(o,i)}catch{}try{N(i)}catch{}$(o,i)}return}if(E){const i=E,o=Y;I(i,o);try{i.setAttribute("text-anchor",e[r]||"middle")}catch{}const s=i.getAttribute("x")||i.dataset.originalX||null;s&&i.querySelectorAll("tspan").forEach(c=>c.setAttribute("x",s));try{P(i,o)}catch{}try{N(o)}catch{}$(i,o);return}if(A&&A.tagName&&A.tagName.toLowerCase()==="text"){const i=A,o=V||k||"front";I(i,o);try{i.setAttribute("text-anchor",e[r]||"middle")}catch{}const s=i.getAttribute("x")||i.dataset.originalX||null;s&&i.querySelectorAll("tspan").forEach(c=>c.setAttribute("x",s));try{P(i,o)}catch{}try{N(o)}catch{}$(i,o);try{i&&i.tagName&&i.tagName.toLowerCase()==="text"&&Wt(i,o)}catch{}return}}let ce=null,Oe=!1,Ke=!1;function mt(t){ct&&(clearTimeout(ce),ct.classList.add("is-visible"),ct.setAttribute("aria-hidden","false"))}function le(){ct&&(clearTimeout(ce),ct.classList.remove("is-visible"),ct.setAttribute("aria-hidden","true"))}function Ee(){ct&&(clearTimeout(ce),ce=setTimeout(()=>{var e;if(Oe||Ke||F.active)return;const t=document.activeElement;if(!t){le();return}ct.contains(t)||(e=t.closest)!=null&&e.call(t,".text-field")||wt&&t===wt||t!=null&&t.hasAttribute&&t.hasAttribute("data-text-node")||le()},150))}ct&&(ct.addEventListener("focusin",()=>clearTimeout(ce)),ct.addEventListener("focusout",Ee));const bt=document.getElementById("fontModal"),Bt=document.getElementById("fontList"),Le=document.getElementById("fontSearch"),Ar=document.getElementById("fontClose"),xr=(ea=bt==null?void 0:bt.dataset)==null?void 0:ea.googleFontsKey;function ga(){if(bt){bt.setAttribute("aria-hidden","false"),Oe=!0,mt(),ba();try{Le.focus()}catch{}}}function We(){bt&&(bt.setAttribute("aria-hidden","true"),Oe=!1)}Ar&&Ar.addEventListener("click",We),bt&&bt.addEventListener("pointerdown",t=>{t.target===bt&&We()});const Ot=document.getElementById("colorModal"),wr=document.getElementById("colorClose"),R=document.getElementById("colorNative"),U=document.getElementById("colorHexInput"),j=document.getElementById("colorSample"),Sr=document.getElementById("recentColors");function ya(){var t;if(Ot){Ot.setAttribute("aria-hidden","false"),Ke=!0,mt();try{const e=document.querySelector(".toolbar-color-swatch"),r=((t=e==null?void 0:e.dataset)==null?void 0:t.color)||e&&e.style&&e.style.background||"#1f2933";R&&(R.value=r),U&&(U.value=r),j&&(j.style.background=r)}catch{}}}function Er(){Ot&&(Ot.setAttribute("aria-hidden","true"),Ke=!1)}wr&&wr.addEventListener("click",Er),Ot&&Ot.addEventListener("pointerdown",t=>{t.target===Ot&&Er()}),document.querySelectorAll(".toolbar-color").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation(),ya()})}),R&&R.addEventListener("input",t=>{const e=R.value;U&&(U.value=e),j&&(j.style.background=e),Kt(e)}),U&&U.addEventListener("change",()=>{const t=U.value.trim();/^#([0-9A-F]{3}){1,2}$/i.test(t)&&(R&&(R.value=t),j&&(j.style.background=t),Kt(t),Cr(t))}),document.addEventListener("click",t=>{const e=t.target.closest(".swatch");if(!e)return;const r=e.dataset.color;r&&(R&&(R.value=r),U&&(U.value=r),j&&(j.style.background=r),Kt(r),Cr(r))});function Kt(t){var i,o;if(!t)return;const e=document.activeElement;let r=null,a=null;if(e&&e.matches&&e.matches("input[data-text-node]")){r=(i=q[_(e)])==null?void 0:i.get(O(e)),a=_(e),r&&I(r,a),e.style.color=t;const s=_(e),c=O(e),l=(o=q[s])==null?void 0:o.get(c);l&&l.setAttribute("fill",t)}else if(E)I(E,Y),E.setAttribute("fill",t);else if(A&&A.tagName&&A.tagName.toLowerCase()==="text"){I(A,V),A.setAttribute("fill",t);try{P(A,V)}catch{}}const n=document.querySelector(".toolbar-color-swatch");n&&(n.style.background=t,n.dataset.color=t);try{r&&a?P(r,a):E&&P(E,Y)}catch{}}const vt=document.getElementById("colorGradient"),Zt=document.getElementById("colorGradientPointer"),Pt=document.getElementById("hueSlider"),ue=document.getElementById("huePointer"),Lr=document.getElementById("presetSwatches"),kr=document.getElementById("eyedropperBtn"),ke=(t,e,r)=>Math.max(e,Math.min(r,t));function de(t,e,r){let a,n,i,o=Math.floor(t*6),s=t*6-o,c=r*(1-e),l=r*(1-s*e),u=r*(1-(1-s)*e);switch(o%6){case 0:a=r,n=u,i=c;break;case 1:a=l,n=r,i=c;break;case 2:a=c,n=r,i=u;break;case 3:a=c,n=l,i=r;break;case 4:a=u,n=c,i=r;break;case 5:a=r,n=c,i=l;break}const f=d=>Math.round(d*255).toString(16).padStart(2,"0");return`#${f(a)}${f(n)}${f(i)}`.toUpperCase()}function ha(t){if(!t)return{h:0,s:0,v:0};t=t.replace("#",""),t.length===3&&(t=t.split("").map(f=>f+f).join(""));const e=parseInt(t,16),r=(e>>16&255)/255,a=(e>>8&255)/255,n=(e&255)/255,i=Math.max(r,a,n),o=Math.min(r,a,n);let s=0,c=0,l=i;const u=i-o;if(c=i===0?0:u/i,i===o)s=0;else{switch(i){case r:s=(a-n)/u+(a<n?6:0);break;case a:s=(n-r)/u+2;break;case n:s=(r-a)/u+4;break}s/=6}return{h:s,s:c,v:l}}function Xe(t){if(!vt)return;const e=de(t,1,1);vt.style.background=`linear-gradient(to right, #fff, ${e})`}function Nr(t,e,r,a){if(!t||!e)return;const n=t.getBoundingClientRect(),i=ke(r-n.left,0,n.width),o=ke(a-n.top,0,n.height);return e.style.left=i+"px",e.style.top=o+"px",{px:i,py:o,w:n.width,h:n.height}}let pt=0,qt=1,Tt=1;if(vt&&Zt){let t=!1;vt.addEventListener("pointerdown",e=>{t=!0,vt.setPointerCapture(e.pointerId);const r=Nr(vt,Zt,e.clientX,e.clientY);qt=r.px/r.w,Tt=1-r.py/r.h;const a=de(pt,qt,Tt);j&&(j.style.background=a),U&&(U.value=a),R&&(R.value=a),Kt(a)}),window.addEventListener("pointermove",e=>{if(t)try{const r=Nr(vt,Zt,e.clientX,e.clientY);qt=r.px/r.w,Tt=1-r.py/r.h;const a=de(pt,qt,Tt);j&&(j.style.background=a),U&&(U.value=a),R&&(R.value=a),Kt(a)}catch{}}),window.addEventListener("pointerup",e=>{if(t){t=!1;try{vt.releasePointerCapture(e.pointerId)}catch{}}})}if(Pt&&ue){let t=!1;Pt.addEventListener("pointerdown",e=>{t=!0,Pt.setPointerCapture(e.pointerId);const r=Pt.getBoundingClientRect(),a=ke(e.clientX-r.left,0,r.width);pt=a/r.width,ue.style.left=a+"px",Xe(pt);const i=de(pt,qt,Tt);j&&(j.style.background=i),U&&(U.value=i),R&&(R.value=i),Kt(i)}),window.addEventListener("pointermove",e=>{if(t)try{const r=Pt.getBoundingClientRect(),a=ke(e.clientX-r.left,0,r.width);pt=a/r.width,ue.style.left=a+"px",Xe(pt);const i=de(pt,qt,Tt);j&&(j.style.background=i),U&&(U.value=i),R&&(R.value=i),Kt(i)}catch{}}),window.addEventListener("pointerup",e=>{if(t){t=!1;try{Pt.releasePointerCapture(e.pointerId)}catch{}}})}document.querySelectorAll(".color-tabs .tab").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".color-tabs .tab").forEach(r=>r.classList.remove("active")),t.classList.add("active");const e=t.dataset.tab;document.querySelectorAll(".tab-panel").forEach(r=>{r.style.display=r.dataset.panel===e?"":"none"})})}),Lr&&[["#0ea5e9","#38bdf8","#7dd3fc","#bae6fd","#e0f2fe"],["#16a34a","#4ade80","#86efac","#bbf7d0","#ecfdf5"],["#f59e0b","#facc15","#fde68a","#fff7cc","#fffaf0"],["#ef4444","#fb7185","#fda4af","#ffdde1","#fff5f5"],["#2563eb","#3b82f6","#60a5fa","#93c5fd","#dbeafe"]].forEach(e=>e.forEach(r=>{const a=document.createElement("button");a.type="button",a.className="swatch",a.dataset.color=r,a.style.background=r,Lr.appendChild(a)})),kr&&R&&kr.addEventListener("click",()=>{try{R.click()}catch{}});function ma(t){if(!t)return;const e=ha(t);if(pt=e.h,qt=e.s,Tt=e.v,Pt&&ue){const r=Pt.getBoundingClientRect();ue.style.left=pt*r.width+"px"}if(vt&&Zt){const r=vt.getBoundingClientRect();Zt.style.left=qt*r.width+"px",Zt.style.top=(1-Tt)*r.height+"px"}Xe(pt)}try{const t=document.querySelector(".toolbar-color-swatch");t&&ma(t.dataset.color||t.style.background)}catch{}function Cr(t){if(!Sr)return;const e=Sr.querySelector(".recent-list");if(!e)return;const r=Array.from(e.querySelectorAll(".swatch")).map(o=>o.dataset.color.toLowerCase()),a=t.toLowerCase();if(r.includes(a))return;const n=document.createElement("button");n.type="button",n.className="swatch",n.dataset.color=t,n.style.background=t,e.insertBefore(n,e.firstChild);const i=e.querySelectorAll(".swatch");i.length>8&&i[i.length-1].remove()}async function ba(){if(!Bt)return;Bt.innerHTML='<div class="font-list-loading">Loading fonts…</div>';const t=["Roboto","Open Sans","Lato","Montserrat","Merriweather","Playfair Display","Source Sans Pro"];if(!xr){Bt.innerHTML="",t.forEach(e=>Ye(e));return}try{const e=await fetch(`https://www.googleapis.com/webfonts/v1/webfonts?key=${encodeURIComponent(xr)}&sort=popularity`);if(!e.ok)throw new Error("Failed to fetch");const a=(await e.json()).items||[];Bt.innerHTML="",a.slice(0,200).forEach(n=>Ye(n.family)),Ir()}catch(e){console.error("Fonts API failed",e),Bt.innerHTML="",t.forEach(r=>Ye(r)),Ir()}}function va(){const t=new Set;return document.querySelectorAll("input[data-text-node]").forEach(e=>{const r=e.style.fontFamily||e.dataset.fontFamily||null;r&&t.add(r.replace(/['\"]+/g,"").split(",")[0].trim())}),["front","back"].forEach(e=>{var r;(r=q[e])==null||r.forEach(a=>{if(!a)return;const i=(a.getAttribute("style")||"").match(/font-family:\s*['"]?([^;',]+)['"]?/i);i&&i[1]&&t.add(i[1].trim())})}),Array.from(t).slice(0,8)}function Ir(){const t=document.getElementById("recentFonts"),e=t==null?void 0:t.querySelector(".recent-list");if(!t||!e)return;const r=va();if(e.innerHTML="",r.length===0){t.setAttribute("aria-hidden","true"),e.textContent="No recent fonts";return}t.setAttribute("aria-hidden","false"),r.forEach(a=>{const n=document.createElement("button");n.type="button",n.className="recent-item",n.textContent=a,n.addEventListener("click",()=>Pr(a)),e.appendChild(n)})}function Ye(t){if(!Bt)return;const e=document.createElement("div");e.className="font-item",e.dataset.family=t;const r=document.createElement("div");r.className="font-sample",r.textContent=t,r.style.fontFamily="system-ui, sans-serif",e.appendChild(r),e.addEventListener("click",()=>Pr(t)),Bt.appendChild(e);try{fe&&fe.observe(e)}catch{}}let Fr=new Set;function Br(t){if(Fr.has(t))return Promise.resolve();const e=document.createElement("link");return e.rel="stylesheet",e.href=`https://fonts.googleapis.com/css2?family=${encodeURIComponent(t)}:wght@400;700&display=swap`,document.head.appendChild(e),Fr.add(t),new Promise(r=>{e.onload=()=>r(),e.onerror=()=>r()})}let fe=null;try{fe=new IntersectionObserver(t=>{t.forEach(async e=>{if(!e.isIntersecting)return;const r=e.target,a=r.dataset.family;if(!a)return;await Br(a);const n=r.querySelector(".font-sample");n&&(n.style.fontFamily=`'${a}', system-ui, sans-serif`),fe.unobserve(r)})},{root:Bt,rootMargin:"200px",threshold:.01})}catch{fe=null}async function Pr(t){var r;await Br(t);const e=document.activeElement;if(e&&e.matches&&e.matches("input[data-text-node]")){e.style.fontFamily=`'${t}', system-ui, sans-serif`;try{e.dataset.fontFamily=t}catch{}const a=_(e),n=O(e),i=(r=q[a])==null?void 0:r.get(n);if(i){i.setAttribute("style",`font-family: '${t}', system-ui, sans-serif;`);try{i.dataset.fontFamily=t}catch{}}}else if(E){E.setAttribute("style",`font-family: '${t}', system-ui, sans-serif;`);try{E.dataset.fontFamily=t}catch{}}else if(A&&A.tagName&&A.tagName.toLowerCase()==="text")try{A.setAttribute("style",`font-family: '${t}', system-ui, sans-serif;`);try{A.dataset.fontFamily=t}catch{}try{N(V||k||"front")}catch{}try{$(A,V||k||"front")}catch{}}catch(a){console.error("selectFont apply to selectedElementNode failed",a)}We()}document.querySelectorAll('[data-tool="font"]').forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation(),ga()})});const qr=document.querySelector(".font-size-control"),dt=document.getElementById("toolbarFontSizeInput"),J=document.querySelector(".font-size-dropdown");function Tr(t){var n,i;if(!t)return;const e=document.activeElement;let r=null,a=null;if(e&&e.matches&&e.matches("input[data-text-node]")){r=(n=q[_(e)])==null?void 0:n.get(O(e)),a=_(e),r&&I(r,a),e.style.fontSize=t+"px";try{e.dataset.fontSize=String(t)}catch{}const o=_(e),s=O(e),c=(i=q[o])==null?void 0:i.get(s);if(c){const l=ft(c),u=parseFloat(c.getAttribute("font-size")||window.getComputedStyle(c).fontSize||String(t))||t,f=Number(t)/u;jt(l,f,Number(l.dataset.iwRotate||0)||0,c);try{c.dataset.fontSize=String(t)}catch{}}}else if(E){const o=E;I(o,Y);const s=ft(o),c=parseFloat(o.getAttribute("font-size")||window.getComputedStyle(o).fontSize||String(t))||t,l=Number(t)/c;jt(s,l,Number(s.dataset.iwRotate||0)||0,o);try{o.dataset.fontSize=String(t)}catch{}try{P(o,Y)}catch{}}else if(A&&A.tagName&&A.tagName.toLowerCase()==="text"){const o=A,s=V||k||"front";I(o,s);const c=ft(o),l=parseFloat(o.getAttribute("font-size")||window.getComputedStyle(o).fontSize||String(t))||t,u=Number(t)/l;jt(c,u,Number(c.dataset.iwRotate||0)||0,o);try{o.dataset.fontSize=String(t)}catch{}try{P(o,s)}catch{}}try{r&&a&&P(r,a)}catch{}}J&&(dt&&(dt.addEventListener("click",t=>{t.stopPropagation();const e=J.getAttribute("aria-hidden")==="false";J.setAttribute("aria-hidden",e?"true":"false")}),dt.addEventListener("keydown",t=>{if(t.key==="Enter"||t.key===" "){t.preventDefault();const e=J.getAttribute("aria-hidden")==="false";J.setAttribute("aria-hidden",e?"true":"false")}else if(t.key==="ArrowDown"){t.preventDefault(),J.setAttribute("aria-hidden","false");try{const e=J.querySelector(".font-size-option");e&&e.focus()}catch{}}else t.key==="Escape"&&J.setAttribute("aria-hidden","true")})),J.addEventListener("click",t=>{const e=t.target.closest(".font-size-option");if(!e)return;const r=Number(e.textContent.trim());dt&&(dt.value=String(r)),Tr(r),J.setAttribute("aria-hidden","true")}),document.addEventListener("click",t=>{qr&&(qr.contains(t.target)||J.setAttribute("aria-hidden","true"))})),dt&&(dt.addEventListener("change",()=>{const t=Number(dt.value);Number.isFinite(t)&&Tr(t)}),dt.addEventListener("click",t=>{t.stopPropagation(),J&&J.setAttribute("aria-hidden","false")}),dt.addEventListener("keydown",t=>{t.key==="ArrowDown"&&(t.preventDefault(),J&&J.setAttribute("aria-hidden","false"))}));function Wt(t,e){if(!t)return;const r=ft(t),a=parseFloat(t.getAttribute("font-size")||window.getComputedStyle(t).fontSize||"16")||16,n=Number(r&&r.dataset&&r.dataset.iwScale||1)||1,i=Math.round(a*n);dt&&(dt.value=String(i));const o=t.getAttribute("fill")||t.dataset.color||"#1f2933",s=document.querySelector(".toolbar-color-swatch");s&&(s.style.background=o,s.dataset.color=o),R&&(R.value=o),U&&(U.value=o),Ie(t)||t.dataset.fontFamily;try{const c=document.querySelector('[data-tool="bold"]'),l=(t.getAttribute("font-weight")||t.style.fontWeight||t.dataset.fontWeight||"").toString(),u=l==="700"||l.toLowerCase()==="bold";c&&(c.classList.toggle("is-active",!!u),c.setAttribute("aria-pressed",u?"true":"false"))}catch{}try{const c=document.querySelector('[data-tool="list"]'),u=(G(t)||"").split(/\r?\n/).map(d=>d.trim()).filter(Boolean),f=u.length>0&&u.every(d=>d.startsWith("•")||d.startsWith("-"));c&&(c.classList.toggle("is-active",!!f),c.setAttribute("aria-pressed",f?"true":"false"))}catch{}try{const c=document.querySelector('[data-tool="align"]'),l=t.getAttribute("text-anchor")||"middle",u=Fe(l);c&&(c.dataset.align=u,c.setAttribute("data-current-align",u),c.title="Align: "+(u.charAt(0).toUpperCase()+u.slice(1)))}catch{}try{const c=document.querySelector(".toolbar-select");c&&(c.value="")}catch{}}function Aa(){var e;const t=document.activeElement;if(t&&t.matches&&t.matches("input[data-text-node]")){const r=_(t),a=(e=q[r])==null?void 0:e.get(O(t));a&&I(a,r);const n=t.style.fontWeight||t.dataset.fontWeight||"",i=n==="700"||n==="bold"?"":"700";t.style.fontWeight=i;try{t.dataset.fontWeight=i}catch{}if(a){try{a.setAttribute("font-weight",i)}catch{}try{P(a,r)}catch{}try{N(r)}catch{}$(a,r)}return}if(E){I(E,Y);const r=E.getAttribute("font-weight")||E.style.fontWeight||"",a=r==="700"||r==="bold"?"":"700";try{E.setAttribute("font-weight",a)}catch{}try{E.style.fontWeight=a}catch{}try{P(E,Y)}catch{}try{N(Y)}catch{}$(E,Y);try{Wt(E,Y)}catch{}return}if(A&&A.tagName&&A.tagName.toLowerCase()==="text"){const r=A,a=V||k||"front";I(r,a);const n=r.getAttribute("font-weight")||r.style.fontWeight||"",i=n==="700"||n==="bold"?"":"700";try{r.setAttribute("font-weight",i)}catch{}try{r.style.fontWeight=i}catch{}try{P(r,a)}catch{}try{N(a)}catch{}$(r,a);return}}function xa(){var r;const t={left:"start",center:"middle",right:"end"},e=document.activeElement;if(e&&e.matches&&e.matches("input[data-text-node]")){const a=_(e),n=(r=q[a])==null?void 0:r.get(O(e));n&&I(n,a);const i=(e.dataset.align||"center").toLowerCase(),o=["left","center","right"],s=o.indexOf(i)>=0?o.indexOf(i):1,c=o[(s+1)%o.length];try{e.dataset.align=c}catch{}if(n){try{n.setAttribute("text-anchor",t[c])}catch{}const l=n.getAttribute("x")||n.dataset.originalX||null;l&&n.querySelectorAll("tspan").forEach(u=>u.setAttribute("x",l));try{P(n,a)}catch{}try{N(a)}catch{}$(n,a);try{n&&n.tagName&&n.tagName.toLowerCase()==="text"&&Wt(n,a)}catch{}}return}if(E){const a=E,n=Y;I(a,n);const i=Fe(a.getAttribute("text-anchor"))||"center",o=["left","center","right"],s=o.indexOf(i)>=0?o.indexOf(i):1,c=o[(s+1)%o.length];try{a.setAttribute("text-anchor",t[c])}catch{}const l=a.getAttribute("x")||a.dataset.originalX||null;l&&a.querySelectorAll("tspan").forEach(u=>u.setAttribute("x",l));try{P(a,n)}catch{}try{N(n)}catch{}$(a,n);return}if(A&&A.tagName&&A.tagName.toLowerCase()==="text"){const a=A,n=V||k||"front";I(a,n);const i=Fe(a.getAttribute("text-anchor"))||"center",o=["left","center","right"],s=o.indexOf(i)>=0?o.indexOf(i):1,c=o[(s+1)%o.length];try{a.setAttribute("text-anchor",t[c])}catch{}const l=a.getAttribute("x")||a.dataset.originalX||null;l&&a.querySelectorAll("tspan").forEach(u=>u.setAttribute("x",l));try{P(a,n)}catch{}try{N(n)}catch{}$(a,n);return}}function wa(){var r;const e=document.activeElement;if(e&&e.matches&&e.matches("input[data-text-node]")){const a=_(e),n=(r=q[a])==null?void 0:r.get(O(e));n&&I(n,a);const o=(e.value||"").split(/\r?\n/).map(l=>l.trim()),c=o.length>0&&o.every(l=>l.startsWith("• "))?o.map(l=>l.replace(new RegExp("^•\\s?"),"")):o.map(l=>l&&"• "+l);e.value=c.join(`
`);try{qe(e,e.value)}catch{}if(n){try{P(n,a)}catch{}try{N(a)}catch{}$(n,a)}return}if(E){const a=E,n=Y;I(a,n);const o=(G(a)||"").split(/\r?\n/).map(l=>l.trim()),c=o.length>0&&o.every(l=>l.startsWith("• "))?o.map(l=>l.replace(new RegExp("^•\\s?"),"")):o.map(l=>l&&"• "+l);K(a,c.join(`
`));try{P(a,n)}catch{}try{N(n)}catch{}$(a,n);return}if(A&&A.tagName&&A.tagName.toLowerCase()==="text"){const a=A,n=V||k||"front";I(a,n);const o=(G(a)||"").split(/\r?\n/).map(l=>l.trim()),c=o.length>0&&o.every(l=>l.startsWith("• "))?o.map(l=>l.replace(new RegExp("^•\\s?"),"")):o.map(l=>l&&"• "+l);K(a,c.join(`
`));try{P(a,n)}catch{}try{N(n)}catch{}$(a,n);return}}function je(t){var r;if(!t)return;const e=document.activeElement;if(e&&e.matches&&e.matches("input[data-text-node]")){const a=_(e),n=(r=q[a])==null?void 0:r.get(O(e));n&&I(n,a);const i=e.value||"",o=t==="uppercase"?i.toUpperCase():t==="lowercase"?i.toLowerCase():i;e.value=o;try{qe(e,o)}catch{}if(n){try{P(n,a)}catch{}try{N(a)}catch{}$(n,a)}return}if(E){const a=E,n=Y;I(a,n);const i=G(a)||"",o=t==="uppercase"?i.toUpperCase():t==="lowercase"?i.toLowerCase():i;K(a,o);try{P(a,n)}catch{}try{N(n)}catch{}$(a,n);return}if(A&&A.tagName&&A.tagName.toLowerCase()==="text"){const a=A,n=V||k||"front";I(a,n);const i=G(a)||"",o=t==="uppercase"?i.toUpperCase():t==="lowercase"?i.toLowerCase():i;K(a,o);try{P(a,n)}catch{}try{N(n)}catch{}$(a,n);return}}document.querySelectorAll('[data-tool="bold"]').forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation(),Aa()})}),document.querySelectorAll('[data-tool="align"]').forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation(),xa()})}),document.querySelectorAll('[data-tool="list"]').forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation(),wa()})});const Ne=document.querySelector(".toolbar-select");if(Ne&&Ne.addEventListener("change",t=>{const e=Ne.value;e&&(je(e),Ne.value="")}),Le){let t=null;Le.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{const e=Le.value.trim().toLowerCase();Array.from(document.querySelectorAll(".font-item")).forEach(r=>{const a=r.textContent.toLowerCase();r.style.display=e&&!a.includes(e)?"none":""})},160)})}const rt=document.getElementById("toolbarListBtn"),at=document.querySelector(".list-dropdown-menu");let Ve=!1;function Sa(){if(!(!rt||!at)){rt.setAttribute("aria-expanded","true"),at.setAttribute("aria-hidden","false"),Ve=!0;try{const t=at.querySelector(".list-option");t&&typeof t.focus=="function"&&t.focus()}catch{}}}function _t(){!rt||!at||(rt.setAttribute("aria-expanded","false"),at.setAttribute("aria-hidden","true"),Ve=!1)}function _r(){Ve?_t():Sa()}rt&&(rt.addEventListener("click",t=>{t.stopPropagation();const e=t.target,r=e.classList&&(e.classList.contains("fa-list-ul")||e.classList.contains("fa-list-ol")||e.classList.contains("fa-ban"));!r&&e!==rt&&!e.closest||!r&&!e.closest(".fa-list-ul, .fa-list-ol, .fa-ban")||_r()}),rt.addEventListener("keydown",t=>{t.key==="Enter"||t.key===" "?(t.preventDefault(),_r()):t.key==="Escape"&&_t()})),document.addEventListener("click",t=>{!rt||!at||rt.contains(t.target)||at.contains(t.target)||_t()}),at&&at.querySelectorAll(".list-option").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();const r=t.dataset.list;Mr(r),_t()}),t.setAttribute("tabindex","0"),t.addEventListener("keydown",e=>{if(e.key==="Enter"||e.key===" "){e.preventDefault();const r=t.dataset.list;Mr(r),_t()}else if(e.key==="ArrowRight"||e.key==="ArrowDown"){e.preventDefault();const r=t.nextElementSibling||at.querySelector(".list-option");r&&r.focus()}else if(e.key==="ArrowLeft"||e.key==="ArrowUp"){e.preventDefault();const r=t.previousElementSibling||at.querySelector(".list-option:last-child");r&&r.focus()}else if(e.key==="Escape"){_t();try{rt.focus()}catch{}}})});const At=document.getElementById("toolbarFormatBtn"),Et=document.querySelector(".format-dropdown-menu");let Ge=!1;function Ea(){if(!(!At||!Et)){At.setAttribute("aria-expanded","true"),Et.setAttribute("aria-hidden","false"),Ge=!0;try{const t=Et.querySelector(".format-option");t&&t.focus()}catch{}}}function Jt(){!At||!Et||(At.setAttribute("aria-expanded","false"),Et.setAttribute("aria-hidden","true"),Ge=!1)}function $r(){Ge?Jt():Ea()}if(At&&(At.addEventListener("click",t=>{t.stopPropagation(),$r()}),At.addEventListener("keydown",t=>{t.key==="Enter"||t.key===" "?(t.preventDefault(),$r()):t.key==="Escape"&&Jt()})),Et){const t=Et.querySelectorAll(".format-option");t.forEach(e=>{e.setAttribute("tabindex","0"),e.addEventListener("click",r=>{r.stopPropagation();const a=e.dataset.format;je(a),Jt()}),e.addEventListener("keydown",r=>{if(r.key==="Enter"||r.key===" ")r.preventDefault(),je(e.dataset.format),Jt();else if(r.key==="ArrowRight"||r.key==="ArrowDown")r.preventDefault(),(e.nextElementSibling||t[0]).focus();else if(r.key==="ArrowLeft"||r.key==="ArrowUp")r.preventDefault(),(e.previousElementSibling||t[t.length-1]).focus();else if(r.key==="Escape"){Jt();try{At.focus()}catch{}}})})}document.addEventListener("click",t=>{!At||!Et||At.contains(t.target)||Et.contains(t.target)||Jt()});const xt=document.getElementById("toolbarAlignBtn"),Lt=document.querySelector(".align-dropdown-menu");let Ze=!1;function La(){if(!(!xt||!Lt)){xt.setAttribute("aria-expanded","true"),Lt.setAttribute("aria-hidden","false"),Ze=!0;try{const t=Lt.querySelector(".align-option");t&&t.focus()}catch{}}}function Qt(){!xt||!Lt||(xt.setAttribute("aria-expanded","false"),Lt.setAttribute("aria-hidden","true"),Ze=!1)}function zr(){Ze?Qt():La()}if(xt&&(xt.addEventListener("click",t=>{t.stopPropagation(),zr()}),xt.addEventListener("keydown",t=>{t.key==="Enter"||t.key===" "?(t.preventDefault(),zr()):t.key==="Escape"&&Qt()})),Lt){const t=Lt.querySelectorAll(".align-option");t.forEach(e=>{e.setAttribute("tabindex","0"),e.addEventListener("click",r=>{r.stopPropagation();const a=(e.dataset.align||"").toLowerCase();vr(a),Qt()}),e.addEventListener("keydown",r=>{if(r.key==="Enter"||r.key===" ")r.preventDefault(),vr(e.dataset.align),Qt();else if(r.key==="ArrowRight"||r.key==="ArrowDown")r.preventDefault(),(e.nextElementSibling||t[0]).focus();else if(r.key==="ArrowLeft"||r.key==="ArrowUp")r.preventDefault(),(e.previousElementSibling||t[t.length-1]).focus();else if(r.key==="Escape"){Qt();try{xt.focus()}catch{}}})})}document.addEventListener("click",t=>{!xt||!Lt||xt.contains(t.target)||Lt.contains(t.target)||Qt()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&_t()});try{_t()}catch{}at&&(at.addEventListener("pointerenter",t=>{t.stopPropagation()}),at.addEventListener("mouseover",t=>{t.stopPropagation()})),rt&&(rt.addEventListener("focus",t=>{}),rt.addEventListener("mouseover",t=>{}));function Mr(t){var i;const e=document.activeElement,r="•",a=/^\s*\d+\.\s*/,n=/^\s*[\u2022\-*]\s*/;if(e&&e.matches&&e.matches("input[data-text-node]")){const o=_(e),s=(i=q[o])==null?void 0:i.get(O(e)),l=(e.value||"").split(/\r?\n/).map(f=>f.trim());let u=[];t==="ul"?u=l.map(f=>f&&r+" "+f):t==="ol"?u=l.map((f,d)=>f&&d+1+". "+f):t==="none"&&(u=l.map(f=>f.replace(a,"").replace(n,""))),e.value=u.join(`
`);try{qe(e,e.value)}catch{}if(s)try{N(o)}catch{}return}if(E){const o=E,s=Y,l=(G(o)||"").split(/\r?\n/).map(f=>f.trim());let u="";t==="ul"?u=l.map(f=>f&&r+" "+f).join(`
`):t==="ol"?u=l.map((f,d)=>f&&d+1+". "+f).join(`
`):t==="none"&&(u=l.map(f=>f.replace(a,"").replace(n,"")).join(`
`)),I(o,s),K(o,u);try{P(o,s)}catch{}try{N(s)}catch{}$(o,s);return}if(A&&A.tagName&&A.tagName.toLowerCase()==="text"){const o=A,s=V||k||"front",l=(G(o)||"").split(/\r?\n/).map(f=>f.trim());let u="";t==="ul"?u=l.map(f=>f&&r+" "+f).join(`
`):t==="ol"?u=l.map((f,d)=>f&&d+1+". "+f).join(`
`):t==="none"&&(u=l.map(f=>f.replace(a,"").replace(n,"")).join(`
`)),I(o,s),K(o,u);try{P(o,s)}catch{}try{N(s)}catch{}$(o,s);return}}document.addEventListener("pointerdown",t=>{var r,a,n,i;if(!ct||ct.contains(t.target))return;const e=t.target.closest(".bounding-box-handle");if(e){t.preventDefault(),t.stopPropagation();const o=e.getAttribute("data-handle-type"),s=e.closest("svg"),c=s.id==="cardFront"?"front":"back";let l=A;try{const u=e.dataset&&e.dataset.targetNodeKey;if(!l&&u){const f=ye(u);l=s.querySelector(`[data-text-node="${f}"]`)||s.querySelector(`[data-text-node="${u}"]`)}}catch{}if(l||(l=s.querySelector("[data-text-node]")||s.querySelector("image")),!l)return;if(o==="resize"){w.active=!0,w.node=l,w.side=c,w.startY=t.clientY;try{l.tagName&&l.tagName.toLowerCase()==="text"?w.startScale=Number(ft(l).dataset.iwScale||1):w.startScale=Number(l.dataset.iwScale||1)}catch{w.startScale=1}w.pointerId=t.pointerId,e.setPointerCapture(t.pointerId),I(l,c)}else if(o==="rotate"){const u=ft(l);v.active=!0,v.node=l,v.side=c,v.startAngle=Number(u&&u.dataset&&u.dataset.iwRotate||0)||0;const f=he(s,t.clientX,t.clientY),d=nr(u,l);v.startPointerAngle=Math.atan2(f.y-d.cy,f.x-d.cx)*(180/Math.PI),v.pointerId=t.pointerId,e.setPointerCapture(t.pointerId),I(l,c);try{u&&u.classList&&u.classList.add("is-rotating")}catch{}}else if(o==="move"){F.active=!0,F.node=l,F.side=c,F.pointerId=t.pointerId;const u=getSvgPoint(s,t.clientX,t.clientY),f=Number(l.getAttribute("x")||l.getAttribute("data-x")||0),d=Number(l.getAttribute("y")||l.getAttribute("data-y")||0);F.offsetX=u.x-f,F.offsetY=u.y-d,e.setPointerCapture(t.pointerId),I(l,c)}return}if((a=(r=t.target).closest)!=null&&a.call(r,".text-field")||(i=(n=t.target).closest)!=null&&i.call(n,".canvas [data-text-node]")){mt(t.target);return}le(),_e("front"),_e("back")}),document.addEventListener("pointerdown",t=>{const e=t.target&&t.target.closest&&t.target.closest(".bounding-box-hit");if(!e)return;const r=e.closest&&e.closest(".bounding-box-handle");if(r)try{const a=new PointerEvent("pointerdown",Object.assign({},t));r.dispatchEvent(a),t.preventDefault(),t.stopPropagation()}catch{}});const Q="http://www.w3.org/2000/svg",te="http://www.w3.org/1999/xlink",Je=.5,Qe=2,Rr=.1,Ce=24,ka=12,Dr=5*1024*1024,kt={front:{defaultSrc:((aa=(ra=Gt.front)==null?void 0:ra.dataset)==null?void 0:aa.defaultSrc)||((na=ot==null?void 0:ot.dataset)==null?void 0:na.defaultImage)||"",currentSrc:""},back:{defaultSrc:((oa=(ia=Gt.back)==null?void 0:ia.dataset)==null?void 0:oa.defaultSrc)||((sa=st==null?void 0:st.dataset)==null?void 0:sa.defaultImage)||"",currentSrc:""}};(function(){if(!Ue)return;const e=document.getElementById("imageUploadInput");e&&e.addEventListener("change",async r=>{const a=e.files&&e.files[0];if(a)try{if(a.size>Dr){alert("Image is too large. Max 5MB allowed."),e.value="";return}const n=URL.createObjectURL(a),i=k||"front";try{Rt(i,n)}catch(o){console.error("applyImage failed",o)}try{const o=T(i),s=document.getElementById("recentImagesList");if(s){const c=document.createElement("button");c.type="button",c.className="recent-image-item",c.dataset.src=n,c.style.backgroundImage=`url('${n}')`,c.title=a.name,c.addEventListener("click",()=>{Rt(i,c.dataset.src)}),s.firstChild&&s.firstChild.classList&&s.firstChild.classList.contains("recent-placeholder")&&(s.innerHTML=""),s.insertBefore(c,s.firstChild||null);const l=s.querySelectorAll(".recent-image-item");l.length>12&&l[l.length-1].remove()}}catch{}try{Nt[i]&&URL.revokeObjectURL(Nt[i])}catch{}Nt[i]=n;try{e.value=""}catch{}}catch(n){console.error("image upload insert failed",n);try{e.value=""}catch{}alert("Failed to insert image.")}})})();const tr={front:null,back:null},$t={front:null,back:null},Nt={front:null,back:null};let gt=1,k="front";const q={front:new Map,back:new Map};let Hr=0;function Ur(t){return String(t||"").trim().replace(/[\s#/]+/g,"-").replace(/[^a-zA-Z0-9_-]+/g,"-").replace(/^-+|-+$/g,"")}function pe(t,e){if(!t)return"";let r=(t.getAttribute("data-text-node")||"").trim();if(r)return r;const a=t.getAttribute("id")||t.getAttribute("name")||"";let n=Ur(a)||Ur((t.textContent||"").split(/\s+/).slice(0,3).join("-"));for(n?n=n.toLowerCase():n=`text-${++Hr}`,r=`${e}-${n}`;q[e]&&q[e].has(r);)r=`${e}-${n}-${++Hr}`;return t.setAttribute("data-text-node",r),r}function Ie(t){if(!t)return"";const e=t.getAttribute("font-family");if(e)return e.replace(/["']/g,"").trim();const a=(t.getAttribute("style")||"").match(/font-family:\s*['"]?([^;'"\n]+)/i);return a&&a[1]?a[1].trim():""}function Fe(t){switch((t||"").toLowerCase()){case"start":return"left";case"end":return"right";case"middle":case"center":return"center";default:return"center"}}function Or(t,e){var c,l;const r=T(e),a=be(r),n=Number.parseFloat((t==null?void 0:t.getAttribute("x"))||((c=t==null?void 0:t.dataset)==null?void 0:c.originalX)||`${a.x+a.width/2}`),i=Number.parseFloat((t==null?void 0:t.getAttribute("y"))||((l=t==null?void 0:t.dataset)==null?void 0:l.originalY)||`${a.y+a.height/2}`),o=Number.isFinite(n)&&a.width?(n-a.x)/a.width*100:50,s=Number.isFinite(i)&&a.height?(i-a.y)/a.height*100:Ce;return{left:Number.isFinite(o)?o.toFixed(2):"50.00",top:Number.isFinite(s)?s.toFixed(2):Number(Ce).toFixed(2)}}let wt=null,E=null,Y=null,Be="",Ct=null,w={active:!1,startY:0,startScale:1,pointerId:null,node:null,side:null},zt=null,v={active:!1,startAngle:0,startPointerAngle:0,pointerId:null,node:null,side:null},F={active:!1,node:null,side:null,pointerId:null,svg:null,offsetX:0,offsetY:0},A=null,V=null;const Mt=[];let yt=-1,ge=null;function Kr(t,e){if(!t)return null;const r=G(t),a=Number.parseFloat(t.getAttribute("x")||t.dataset.originalX||"0"),n=Number.parseFloat(t.getAttribute("y")||t.dataset.originalY||"0"),i=t.getAttribute("font-size")||t.dataset.fontSize||"",o=t.getAttribute("letter-spacing")||t.dataset.letterSpacing||"",s=t.getAttribute("fill")||t.dataset.color||"",c=Ie(t)||t.dataset.fontFamily||"",l=t.parentNode&&t.parentNode.dataset&&t.parentNode.dataset.iwWrapper==="true"?t.parentNode:null,u=l?Number(l.dataset.iwScale||1):1,f=l?Number(l.dataset.iwRotate||0):0;return{text:r,x:a,y:n,fontSize:i,letterSpacing:o,fill:s,fontFamily:c,wrapperScale:u,wrapperRotate:f}}function Wr(t,e,r){var o;if(!r||!t)return;let a=(o=q[e])==null?void 0:o.get(t);if(!a){const s=er(t,e);if(s)a=ae(s);else{const c=T(e);if(!c)return;a=document.createElementNS(Q,"text"),a.setAttribute("data-text-node",t),c.appendChild(a),ve(a,e)}}typeof r.text=="string"&&K(a,r.text),Number.isFinite(Number(r.x))&&Number.isFinite(Number(r.y))&&me(a,e,Number(r.x),Number(r.y));try{r.fontSize&&a.setAttribute("font-size",r.fontSize)}catch{}try{r.letterSpacing!==void 0&&a.setAttribute("letter-spacing",r.letterSpacing)}catch{}try{r.fill&&a.setAttribute("fill",r.fill)}catch{}try{r.fontFamily&&a.setAttribute("style",`font-family: '${r.fontFamily}', system-ui, sans-serif;`)}catch{}const n=ft(a);if(n){const s=Number(r.wrapperScale||1),c=Number(r.wrapperRotate||0);jt(n,s,c,a)}const i=a.getAttribute("data-text-node")||t;ee(i,e,G(a));try{N(e)}catch{}}function Na(t){yt<Mt.length-1&&Mt.splice(yt+1),Mt.push(t),yt=Mt.length-1,Xt()}function Ca(t,e){try{if(!t)return!1;const r=t.getAttribute&&t.getAttribute("data-text-node");if(!r)return!1;if(typeof window.__iw_history_capture=="object"&&window.__iw_history_capture)return!!window.__iw_history_capture[`${r}::${e}`]}catch{}try{if(E===t)return!0}catch{}return!1}function Xt(){const t=document.querySelector(".undo-btn"),e=document.querySelector(".redo-btn");t&&(t.disabled=yt<0),e&&(e.disabled=yt>=Mt.length-1)}function Ia(){if(yt<0)return;const t=Mt[yt];t&&(Wr(t.nodeKey,t.side,t.before),yt-=1,Xt())}function Fa(){if(yt>=Mt.length-1)return;yt+=1;const t=Mt[yt];t&&(Wr(t.nodeKey,t.side,t.after),Xt())}function I(t,e){if(!t)return;ge={nodeKey:t.getAttribute("data-text-node")||pe(t,e),side:e,before:Kr(t)}}function P(t,e){var o;if(!ge)return;const r=ge.nodeKey,a=(o=q[e])==null?void 0:o.get(r),n=a?Kr(a):null,i=ge.before;n&&JSON.stringify(i)!==JSON.stringify(n)&&Na({nodeKey:r,side:e,before:i,after:n}),ge=null}const Xr=ut;let Yt=null;function Ba(){if(!ut||!Xr)return null;if(Yt)return Yt;try{Yt=document.createElement("div"),Yt.className="editor-debug-panel",Yt.innerHTML='<h4>Image debug</h4><pre id="__iw_debug_pre">(no diagnostics yet)</pre>';const t=document.querySelector(".canvas-area");return t&&t.appendChild(Yt),Yt}catch{return null}}function lt(t){if(!(!ut||!Xr))try{const e=Ba();if(!e)return;const r=e.querySelector("#__iw_debug_pre");if(!r)return;const a=Object.assign({},t||{});a.bbox&&typeof a.bbox=="object"&&(a.bbox={x:a.bbox.x,y:a.bbox.y,width:a.bbox.width,height:a.bbox.height}),r.textContent=JSON.stringify(a,null,2)}catch{}}function ye(t){return typeof CSS<"u"&&CSS.escape?CSS.escape(t):String(t).replace(/"/g,'"').replace(/\]/g,"\\]")}function he(t,e,r){if(!t)return{x:0,y:0};const a=t.createSVGPoint();a.x=e,a.y=r;try{const n=t.getScreenCTM();if(!n)return{x:0,y:0};const i=a.matrixTransform(n.inverse());return{x:i.x,y:i.y}}catch{return{x:0,y:0}}}function er(t,e){if(!et||!t)return null;const r=ye(t);return et.querySelector(`input[data-text-node="${r}"][data-card-side="${e}"]`)}function Pa(){const t=document.querySelector(".text-editor-panel");if(!t)return;const e=t.querySelector(".new-text-btn");e&&e.addEventListener("click",()=>{qa()}),t.querySelectorAll(".text-input").forEach(a=>{rr(a)})}function qa(){const t=document.querySelector(".text-fields-container");if(!t)return;const e=document.createElement("div");e.className="text-input-wrapper";const r=document.createElement("input");r.type="text",r.className="text-input",r.value="New Text",r.placeholder="Enter text here...",r.dataset.textNode=`custom-${Date.now()}-${Math.random().toString(36).slice(2,5)}`,r.dataset.cardSide=k||"front",e.appendChild(r),t.appendChild(e),rr(r);const a=document.createElement("button");a.type="button",a.className="delete-text",a.setAttribute("aria-label","Delete text field"),a.innerHTML='<span class="sr-only">Delete text field</span><i class="fa-solid fa-trash-can" aria-hidden="true"></i>',a.addEventListener("click",o=>{o.preventDefault();const s=r.dataset.textNode,c=r.dataset.cardSide||k||"front";s&&ir(s,c),e.remove()}),e.appendChild(a);const n=k||"front",i=ae(r);if(i){K(i,r.value);const o=T(n);if(o){const s=be(o),c=s.x+(s.width||500)*.5,l=s.y+(s.height||700)*.5;me(i,n,c,l)}ve(i,n);try{N(n)}catch{}}setTimeout(()=>{r.focus(),r.select()},10)}function rr(t){var a;if(!t)return;t.addEventListener("input",()=>{var s;const n=t.dataset.cardSide||k||"front",i=t.dataset.textNode;if(!i)return;const o=(s=q[n])==null?void 0:s.get(i);if(o){K(o,t.value);try{N(n)}catch{}Te(o,n)}});const e=t.dataset.cardSide||k||"front",r=t.dataset.textNode;if(r&&((a=q[e])!=null&&a.has(r))){const n=q[e].get(r);if(n){const i=G(n);i!==t.value&&(t.value=i)}}}function ee(t,e,r){if(t){try{const a=`.text-editor-panel .text-input[data-text-node="${CSS&&CSS.escape?CSS.escape(t):t}"][data-card-side="${e}"]`,n=document.querySelector(a);n&&n.value!==r&&(n.value=r,n.dispatchEvent(new Event("input",{bubbles:!0})))}catch{}try{Array.from(document.querySelectorAll(`input[data-text-node="${t}"]`)).forEach(n=>{try{const i=n.dataset.cardSide||n.dataset.cardSide||n.getAttribute("data-card-side")||n.getAttribute("data-card-side")||"";(n.value||"")!==(r||"")&&(n.value=r||"",n.dispatchEvent(new Event("input",{bubbles:!0})))}catch{}})}catch{}}}function Ta(){const t=document.querySelector(".text-fields-container");t&&["front","back"].forEach(e=>{const r=T(e);if(!r)return;Array.from(r.querySelectorAll("text")).forEach(n=>{try{const i=pe(n,e);if(t.querySelector(`.text-input-wrapper[data-text-node="${i}"][data-card-side="${e}"]`))return;const s=G(n)||"",c=Or(n,e),l=document.createElement("div");l.className="text-input-wrapper",l.setAttribute("data-text-node",i),l.setAttribute("data-card-side",e);const u=document.createElement("input");u.type="text",u.className="text-input",u.value=s,u.placeholder="",u.setAttribute("data-text-node",i),u.setAttribute("data-card-side",e),u.setAttribute("data-top-percent",c.top),u.setAttribute("data-left-percent",c.left);try{const d=n.getAttribute("font-size")||n.dataset.fontSize;d&&(u.dataset.fontSize=d)}catch{}try{const d=n.getAttribute("letter-spacing")||n.dataset.letterSpacing;d&&(u.dataset.letterSpacing=d)}catch{}try{const d=Ie(n)||n.dataset.fontFamily;d&&(u.dataset.fontFamily=d,u.style.fontFamily=d)}catch{}l.appendChild(u);const f=document.createElement("button");f.type="button",f.className="delete-text",f.setAttribute("aria-label","Delete text field"),f.innerHTML='<span class="sr-only">Delete text field</span><i class="fa-solid fa-trash-can" aria-hidden="true"></i>',l.appendChild(f),t.appendChild(l),rr(u),f.addEventListener("click",d=>{d.preventDefault(),ir(i,e),l.remove()})}catch{}})})}function Yr(t,e,r,a){if(!t)return;const n=t.getAttribute("data-text-node")||"";if(!n)return;const i=er(n,e);if(!i)return;const o=T(e);if(!o)return;const s=be(o),c=s.width?(r-s.x)/s.width*100:0,l=s.height?(a-s.y)/s.height*100:0;i.dataset.leftPercent=c.toFixed(2),i.dataset.topPercent=l.toFixed(2)}function me(t,e,r,a){if(!t)return;t.setAttribute("x",r),t.dataset.originalX=r,t.setAttribute("y",a),t.dataset.originalY=a,t.querySelectorAll("tspan").forEach((i,o)=>{i.setAttribute("x",r),o===0?(i.setAttribute("y",a),i.removeAttribute("dy")):i.hasAttribute("dy")||i.setAttribute("dy","1.2em")}),Yr(t,e,r,a)}function _(t){var e;return(((e=t==null?void 0:t.dataset)==null?void 0:e.cardSide)||"front").toLowerCase()}function O(t){var e;return(((e=t==null?void 0:t.dataset)==null?void 0:e.textNode)||"").trim()}function T(t){const e=t==="front"?ot:st;return e?e.querySelector("svg"):null}function _a(t){if(!ut)return null;if(tr[t])return tr[t];const e=t==="front"?ot:st;if(!e)return null;try{e.classList.remove("background-fallback"),e.style.removeProperty("background-image"),e.style.backgroundColor||(e.style.backgroundColor="#ffffff")}catch{}const r=T(t);if(!r)return null;function a(s){if(!s)return"";try{return s.getAttribute("href")||s.href&&s.href.baseVal||s.getAttributeNS(te,"href")||""}catch{return""}}function n(){const s=Array.from(r.querySelectorAll("image")).filter(d=>!(!d||!d.tagName||d.tagName.toLowerCase()!=="image"||d.closest&&d.closest("defs, symbol, clipPath, mask, pattern")));if(!s.length)return null;const c=s.find(d=>(d.dataset&&d.dataset.editableImage||"")===t);if(c)return c;const l=s.find(d=>{if(!d.dataset)return!1;const p=(d.dataset.changeable||"").toLowerCase(),b=d.hasAttribute("data-uploaded");return p==="image"||b});if(l)return l;let u=s[0],f=0;return s.forEach(d=>{let p=0;try{const b=d.getBBox();p=b&&Number.isFinite(b.width)&&Number.isFinite(b.height)?b.width*b.height:0}catch{const g=Number(d.getAttribute("width"))||0,h=Number(d.getAttribute("height"))||0;p=g*h}p>f&&(u=d,f=p)}),u||null}const i=Array.from(r.querySelectorAll("image")).filter(s=>!(!s||!s.tagName||s.tagName.toLowerCase()!=="image"||s.closest&&s.closest("defs, symbol, clipPath, mask, pattern")));let o=r.querySelector(`image[data-editable-image="${t}"]`)||n();o?o.getAttribute("data-editable-image")||o.setAttribute("data-editable-image",t):(o=document.createElementNS(Q,"image"),o.setAttribute("data-editable-image",t),o.setAttribute("x","0"),o.setAttribute("y","0"),o.setAttribute("width","100%"),o.setAttribute("height","100%"),o.setAttribute("preserveAspectRatio","xMidYMid slice"),o.style.display="none",r.firstChild?r.insertBefore(o,r.firstChild):r.appendChild(o));try{const s=a(o);s&&i.forEach(c=>{if(c===o)return;const l=a(c);if(l&&l===s)try{c.remove()}catch{}})}catch{}try{Array.from(r.querySelectorAll(`image[data-editable-image="${t}"]`)).filter(c=>c!==o).forEach(c=>{try{c.remove()}catch{}})}catch{}tr[t]=o;try{const s=o.getAttribute&&(o.getAttribute("href")||o.getAttributeNS(te,"href")||o.href&&o.href.baseVal);console.debug("[ensureImageLayer] side:",t,"layer:",o,"href:",s),lt({event:"ensureImageLayer",side:t,href:s})}catch{}return o}function St(t){if(!ut)return null;if(!Z){try{const a=$t[t];a&&a.parentNode&&a.parentNode.removeChild(a)}catch{}return $t[t]=null,null}if($t[t])return $t[t];const e=t==="front"?ot:st;if(!e)return null;let r=e.querySelector(`img[data-image-layer="${t}"]`);if(!r){r=document.createElement("img"),r.setAttribute("data-image-layer",t),r.setAttribute("alt",""),r.setAttribute("aria-hidden","true"),r.decoding="async",r.loading="lazy",r.style.display="none",r.style.visibility="hidden";const a=T(t);a&&a.parentNode===e?e.insertBefore(r,a):e.appendChild(r)}return $t[t]=r,r}function D(t,e){if(ut&&t)try{const r=t.tagName&&t.tagName.toLowerCase()==="img";if(console.debug("[setImageElementSource] element:",t,"src:",e,"isImg:",r),r){const a=t.hasAttribute&&t.hasAttribute("data-image-layer");if(t.dataset.loaded="pending",t.onload=function(){t.dataset.loaded="true",console.debug("[setImageElementSource] <img> load",t.currentSrc,t.naturalWidth,t.naturalHeight),lt({type:"img",src:t.currentSrc,naturalWidth:t.naturalWidth,naturalHeight:t.naturalHeight});const n=t.closest&&t.closest(".card");n&&(n.classList.remove("background-fallback"),n.style.removeProperty("background-image"))},t.onerror=function(n){t.dataset.loaded="error",console.warn("[setImageElementSource] <img> load error",e,n),lt({type:"img",src:e,error:"load failed"});const i=t.closest&&t.closest(".card");if(i&&e)try{i.classList.add("background-fallback"),i.style.backgroundImage=`url("${e}")`}catch{}},e){if(t.src=e,a&&!Z)t.style.display="none",t.style.visibility="hidden";else{try{t.style.removeProperty("display")}catch{}t.style.visibility="visible"}try{t.style.removeProperty("filter")}catch{}try{t.style.removeProperty("image-rendering")}catch{}}else{try{t.removeAttribute("src")}catch{}t.style.display="none",t.style.visibility="hidden";try{t.style.removeProperty("filter")}catch{}try{t.style.removeProperty("image-rendering")}catch{}}lt({type:"img",src:e});return}try{t.removeEventListener&&t.removeEventListener("load",t.__iw_onload)}catch{}try{t.removeEventListener&&t.removeEventListener("error",t.__iw_onerror)}catch{}if(e){try{t.setAttribute("href",e)}catch{}try{t.setAttributeNS(null,"href",e)}catch{}try{t.setAttributeNS(te,"xlink:href",e)}catch{}try{t.setAttribute("xlink:href",e)}catch{}const a=t.closest&&t.closest(".card");a&&(a.classList.remove("background-fallback"),a.style.removeProperty("background-image"));const n=t.getAttribute&&t.getAttribute("data-editable-image");if(n){const i=$t[n];i&&!Z&&(i.style.display="none",i.style.visibility="hidden")}t.__iw_onload=function(){console.debug("[setImageElementSource] svg image load",e);try{t.style.removeProperty("display"),t.style.visibility="visible"}catch{}try{t.style.removeProperty("filter")}catch{}try{t.style.removeProperty("image-rendering")}catch{}const i=t.closest&&t.closest(".card");i&&(i.classList.remove("background-fallback"),i.style.removeProperty("background-image"));const o=t.getAttribute&&t.getAttribute("data-editable-image");if(o){const s=$t[o];s&&!Z&&(s.style.display="none",s.style.visibility="hidden")}lt({type:"svg-image",href:e,status:"loaded"})},t.__iw_onerror=function(i){console.warn("[setImageElementSource] svg image load error",e,i);const o=t.closest&&t.closest(".card");if(o&&e)try{o.classList.add("background-fallback"),o.style.backgroundImage=`url("${e}")`;try{o.style.removeProperty("filter")}catch{}try{o.style.removeProperty("image-rendering")}catch{}}catch{}const s=t.getAttribute&&t.getAttribute("data-editable-image");if(s){const c=$t[s];if(c){try{c.style.removeProperty("display")}catch{}c.style.visibility="visible"}}lt({type:"svg-image",href:e,error:"load failed"})};try{t.addEventListener&&t.addEventListener("load",t.__iw_onload)}catch{}try{t.addEventListener&&t.addEventListener("error",t.__iw_onerror)}catch{}try{t.style.removeProperty("display")}catch{}t.style.visibility="visible"}else{try{t.removeAttribute("href")}catch{}try{t.removeAttributeNS(te,"xlink:href")}catch{}try{t.setAttribute("xlink:href","")}catch{}t.style.display="none",t.style.visibility="hidden"}try{const a=t.getAttribute("href")||t.href&&t.href.baseVal||t.getAttributeNS(te,"href");let n=null;try{n=t.getBBox&&t.getBBox()}catch{}lt({type:"svg-image",href:a,bbox:n})}catch{}}catch(r){console.error("setImageElementSource error",r)}}function jr(t,e){var n;if(!ut)return;const r=Gt[t];if(!r)return;const a=((n=kt[t])==null?void 0:n.defaultSrc)||r.dataset.defaultSrc||r.src;e?(r.src=e,r.style.filter="none"):(r.src=a||"",r.style.filter="none")}function Rt(t,e,{skipPreview:r=!1}={}){if(!ut||!kt[t])return;const a=_a(t);if(!a)return;kt[t].currentSrc=e||"";const n=kt[t].currentSrc||kt[t].defaultSrc||"";console.debug("[applyImage] side:",t,"displaySrc:",n),lt({event:"applyImage",side:t,displaySrc:n});function i(d){if(!d||typeof d!="string")return d;if(d=d.replace(/\\/g,"/"),/^https?:\/\//i.test(d))try{const h=new URL(d,window.location.origin),m=(h.pathname||"")+(h.search||"")+(h.hash||"");if(m.startsWith("/templates/"))return"/storage/templates/"+m.substring(11);const L=m.indexOf("/storage/templates/");return L!==-1?m.substring(L):h.origin===window.location.origin?m:d}catch{return d}if(d.startsWith("/templates/"))return"/storage/templates/"+d.substring(11);if(d.startsWith("/"))return d;const p=d.match(/.*\/public\/(.*)/i);if(p&&p[1])return"/"+p[1];const b=d.match(/.*(storage\/templates\/.*)/i);if(b&&b[1])return"/"+b[1];const g=d.match(/.*templates\/(.+)$/i);return g&&g[1]?"/storage/templates/"+g[1]:d}const o=i(n);try{Nt[t]&&(URL.revokeObjectURL(Nt[t]),Nt[t]=null)}catch{}function s(d){const p=d.split(",");if(!p||p.length<2)return null;const b=p[0],g=p.slice(1).join(","),h=/;base64/i.test(b);let m;try{m=h?atob(g):decodeURIComponent(g)}catch{try{m=atob(g)}catch{m=null}}if(m==null)return null;const L=new Uint8Array(m.length);for(let x=0;x<m.length;x++)L[x]=m.charCodeAt(x);const C=b.match(/data:([^;]+)[;]?/i),y=C?C[1]:"application/octet-stream";return new Blob([L],{type:y})}const c=typeof n=="string"&&n.trim().startsWith("<svg"),l=typeof o=="string"&&o.trim().startsWith("data:"),u=typeof o=="string"&&/\.svg(\?|$)/i.test(o);if(c)try{const d=new Blob([n],{type:"image/svg+xml"}),p=URL.createObjectURL(d);Nt[t]=p,D(a,p);const b=Z?St(t):null;b&&D(b,p),lt({event:"applyImage",side:t,inlined:!0})}catch(d){console.warn("[applyImage] failed to inline raw svg, falling back to direct src",d),D(a,n);const p=Z?St(t):null;p&&D(p,n)}else if(l)try{const d=s(o);if(d){const p=d.type||"";if(/svg/i.test(p)){const b=URL.createObjectURL(d);Nt[t]=b,D(a,b);const g=Z?St(t):null;g&&D(g,b),lt({event:"applyImage",side:t,dataUrl:!0})}else{D(a,o);const b=Z?St(t):null;b&&D(b,o)}}else{D(a,o);const p=Z?St(t):null;p&&D(p,o)}}catch(d){console.warn("[applyImage] data url handling failed",d),D(a,o);const p=Z?St(t):null;p&&D(p,o)}else if(u)o&&fetch(o,{credentials:"same-origin"}).then(d=>{if(!d.ok)throw new Error("fetch failed "+d.status+" for "+o);return d.text()}).then(d=>{try{const p=new Blob([d],{type:"image/svg+xml"}),b=URL.createObjectURL(p);Nt[t]=b,D(a,b);const g=Z?St(t):null;g&&D(g,b),lt({event:"applyImage",side:t,fetched:!0,blobUrl:b})}catch(p){console.warn("[applyImage] failed to inline svg, falling back to direct href",p),D(a,o);const b=Z?St(t):null;b&&D(b,o)}}).catch(d=>{console.warn("[applyImage] fetch svg failed, using direct src",d),D(a,o||n);const p=Z?St(t):null;p&&D(p,o||n)});else{D(a,o||n);const d=Z?St(t):null;d&&D(d,o||n)}const f=t==="front"?ot:st;f&&(f.dataset.currentImage=n,n||(f.classList.remove("background-fallback"),f.style.removeProperty("background-image"))),r?Gt[t]&&!Gt[t].getAttribute("src")&&jr(t,n):jr(t,n)}if(ut)try{["front","back"].forEach(t=>{const e=T(t);if(!e)return;const r=e.querySelector('image[data-editable-image="'+t+'"]');if(!r)return;const a=r.getAttribute("href")||r.getAttributeNS(te,"href")||r.href&&r.href.baseVal||null;console.debug("[init-scan] side:",t,"svg-image-href:",a,"element:",r),lt({event:"init-scan",side:t,href:a})})}catch{}function $a(t){if(!ut||!kt[t])return;kt[t].currentSrc="",Rt(t,"");const e=document.querySelector(`[data-image-input="${t}"]`);e&&(e.value="")}function za(){document.querySelectorAll(".next-form").forEach(t=>{t.dataset.textMetaBound!=="true"&&(t.dataset.textMetaBound="true",t.addEventListener("submit",()=>{t.querySelectorAll('input[name^="text_fields_meta["]').forEach(e=>e.remove()),document.querySelectorAll("input[data-text-node]").forEach(e=>{const a=e.dataset.textNode||e.getAttribute("data-text-node")||"",n={font_size:e.dataset.fontSize||e.getAttribute("data-font-size")||"",font_family:e.dataset.fontFamily||"",color:e.dataset.color||""};Object.keys(n).forEach(i=>{const o=`text_fields_meta[${a}][${i}]`,s=document.createElement("input");s.type="hidden",s.name=o,s.value=n[i],t.appendChild(s)});try{const i=a,o=document.querySelector(`input[data-text-node="${ye(i)}"]`),s=document.querySelector(`[data-text-node="${ye(i)}"]`);if(s){const c=s.parentNode&&s.parentNode.dataset&&s.parentNode.dataset.iwWrapper==="true"?s.parentNode:null;if(c){const l=c.dataset.iwScale||"",u=c.dataset.iwRotate||"",f=document.createElement("input");f.type="hidden",f.name=`text_fields_meta[${a}][wrapper_scale]`,f.value=l,t.appendChild(f);const d=document.createElement("input");d.type="hidden",d.name=`text_fields_meta[${a}][wrapper_rotate]`,d.value=u,t.appendChild(d)}}}catch{}})}))})}function Vr(t){da.forEach(e=>{e.classList.toggle("active",e.dataset.panel===t)})}function be(t){const e=t==null?void 0:t.getAttribute("viewBox");if(!e){const a=(t==null?void 0:t.clientWidth)||0,n=(t==null?void 0:t.clientHeight)||0;return{x:0,y:0,width:a,height:n}}const r=e.trim().split(/\s+/).map(Number);return r.length===4&&r.every(a=>Number.isFinite(a))?{x:r[0],y:r[1],width:r[2],height:r[3]}:{x:0,y:0,width:t.clientWidth||0,height:t.clientHeight||0}}function Gr(t,e,r){if(!t||!e)return;const a=T(r);if(!a)return;const n=be(a),i=Number.parseFloat(e.dataset.topPercent??""),o=Number.parseFloat(e.dataset.leftPercent??""),s=(e.dataset.align||"center").toLowerCase();if(Number.isFinite(o)){const l=n.x+n.width*o/100;t.setAttribute("x",l),t.dataset.originalX=l}if(Number.isFinite(i)){const l=n.y+n.height*i/100;t.setAttribute("y",l),t.dataset.originalY=l}const c={left:"start",center:"middle",right:"end"};t.setAttribute("text-anchor",c[s]||"middle"),t.setAttribute("dominant-baseline","middle"),e.dataset.fontSize&&t.setAttribute("font-size",e.dataset.fontSize),e.dataset.letterSpacing&&t.setAttribute("letter-spacing",e.dataset.letterSpacing)}function K(t,e){if(!t)return;const r=String(e??"").split(/\r?\n/);for(;t.firstChild;)t.removeChild(t.firstChild);const a=t.dataset.originalX||t.getAttribute("x")||null,n=t.dataset.originalY||t.getAttribute("y")||null;r.forEach((i,o)=>{const s=document.createElementNS(Q,"tspan");a&&s.setAttribute("x",a),o===0&&n?s.setAttribute("y",n):o>0&&s.setAttribute("dy","1.2em"),s.textContent=i||" ",t.appendChild(s)});try{if(t.ownerSVGElement){const i=t.ownerSVGElement,o=i.closest&&i.closest(".card"),s=o&&o.dataset&&o.dataset.card?o.dataset.card:i.id==="cardFront"?"front":"back";try{Te(t,s)}catch{}}}catch{}}function G(t){if(!t)return"";const e=t.querySelectorAll("tspan");return e.length===0?(t.textContent??"").replace(/\u00A0/g,""):Array.from(e).map(r=>(r.textContent??"").replace(/\u00A0/g,"")).join(`
`)}function Ma(t,e){if(!et||!t)return null;const r=pe(t,e);if(!r)return null;const a=G(t),{left:n,top:i}=Or(t,e),o=Fe(t.getAttribute("text-anchor")),s=t.getAttribute("font-size")||"",c=t.getAttribute("letter-spacing")||"",l=t.getAttribute("fill")||"",u=Ie(t),f=er(r,e);if(f){f.value||(f.value=a),!f.placeholder&&a&&(f.placeholder=a),f.dataset.cardSide||(f.dataset.cardSide=e),f.dataset.leftPercent||(f.dataset.leftPercent=n),f.dataset.topPercent||(f.dataset.topPercent=i),f.dataset.align||(f.dataset.align=o),s&&!f.dataset.fontSize&&(f.dataset.fontSize=s),c&&!f.dataset.letterSpacing&&(f.dataset.letterSpacing=c),l&&!f.dataset.color&&(f.dataset.color=l),l&&!f.style.color&&(f.style.color=l),u&&!f.dataset.fontFamily&&(f.dataset.fontFamily=u,f.style.fontFamily="'"+u+"', system-ui, sans-serif"),f.name||(f.name=`text_fields[${r}]`),f.dataset.defaultValue=f.dataset.defaultValue||a;const g=f.closest(".text-field");return g&&(g.dataset.cardSide=e,g.dataset.textNode=r),f}const d=document.createElement("div");d.className="text-field",d.dataset.cardSide=e,d.dataset.textNode=r;const p=document.createElement("input");p.type="text",p.name=`text_fields[${r}]`,p.value=a,a&&(p.placeholder=a),p.dataset.cardSide=e,p.dataset.textNode=r,p.dataset.leftPercent=n,p.dataset.topPercent=i,p.dataset.align=o,p.dataset.defaultValue=a,s&&(p.dataset.fontSize=s),c&&(p.dataset.letterSpacing=c),l&&(p.dataset.color=l,p.style.color=l),u&&(p.dataset.fontFamily=u,p.style.fontFamily="'"+u+"', system-ui, sans-serif");const b=document.createElement("button");return b.type="button",b.className="delete-text",b.setAttribute("aria-label","Remove text field"),b.innerHTML='<i class="fa-solid fa-trash-can"></i>',d.appendChild(p),d.appendChild(b),et.appendChild(d),p}function ft(t){if(!t||!t.parentNode)return null;const e=t.parentNode;if(e&&e.tagName&&e.tagName.toLowerCase()==="g"&&e.dataset&&e.dataset.iwWrapper==="true")return e;if(!(t.ownerSVGElement||T("front")||T("back")))return null;const a=document.createElementNS(Q,"g");return a.dataset.iwWrapper="true",t.parentNode.insertBefore(a,t),a.appendChild(t),a.dataset.iwScale=a.dataset.iwScale||"1",a.dataset.iwRotate=a.dataset.iwRotate||"0",jt(a,Number(a.dataset.iwScale),Number(a.dataset.iwRotate),t),a}function jt(t,e,r,a){try{e=Number(e)||1,r=Number(r)||0;const n=a||t&&t.querySelector&&t.querySelector("text");let i=0,o=0;try{const c=n.getBBox();i=c.x+c.width/2,o=c.y+c.height/2}catch{}const s=`translate(${i} ${o}) rotate(${r}) scale(${e}) translate(${-i} ${-o})`;t.setAttribute("transform",s),t.dataset.iwScale=String(e),t.dataset.iwRotate=String(r)}catch{}}function Dt(t=!0){if(!wt)return;const e=wt,r=E,a=Y,n=(r==null?void 0:r.getAttribute("data-text-node"))||"";r&&r.classList.remove("svg-text-focus"),n&&a&&Vt(n,a,!1),e.remove(),wt=null,E=null,Y=null;const i=t?e.value:Be;if(r&&n&&typeof i=="string"){K(r,i),ee(n,a,i);try{N(a)}catch{}}Be="",Ee();try{P(r,a)}catch{}}function re(t,e){if(!t)return;const r=t.getAttribute("data-text-node")||"";if(!r)return;k!==e&&ne(e),Dt(!0),Be=G(t),I(t,e);const a=T(e),n=It||Ft;if(!a||!n)return;const i=t.getBoundingClientRect(),o=n.getBoundingClientRect(),s=gt||1,c=(i.left-o.left)/s,l=(i.top-o.top)/s,u=document.createElement("textarea");u.className="inline-text-editor",u.setAttribute("aria-label","Edit canvas text"),u.value=Be,u.style.position="absolute",u.style.left=`${c}px`,u.style.top=`${l}px`;const f=Math.max(i.width/s,120),d=Math.max(i.height/s,28);u.style.width=`${f}px`,u.style.height=`${d}px`,u.style.padding="6px 8px",u.style.border="2px solid #3B82F6",u.style.borderRadius="6px",u.style.background="rgba(255,255,255,0.98)",u.style.boxShadow="0 4px 12px rgba(15, 23, 42, 0.15)",u.style.zIndex="35",u.style.transform=`scale(${s})`,u.style.transformOrigin="top left",u.style.left=`${c}px`,u.style.top=`${l}px`;const p=t.getAttribute("font-size")||window.getComputedStyle(t).fontSize||"18px",b=/px$/i.test(p)?p:`${p}px`;u.style.fontSize=b,u.style.lineHeight="1.2",u.style.fontFamily=t.dataset.fontFamily?`'${t.dataset.fontFamily}', system-ui, sans-serif`:window.getComputedStyle(t).fontFamily;const g=t.getAttribute("fill")||t.style.fill||"#1f2933";u.style.color=g,u.style.caretColor=g,u.style.resize="none";function h(){try{u.style.height="1px";const y=Math.max(u.scrollHeight,d);u.style.height=y/s+"px"}catch{}}setTimeout(h,0),n.appendChild(u),wt=u,E=t,Y=e,t.classList.add("svg-text-focus"),Vt(r,e,!0),mt(),Wt(t);try{const y=t.getAttribute("letter-spacing")||t.dataset.letterSpacing||"";y&&(u.style.letterSpacing=typeof y=="string"&&y.endsWith("px")?y:`${y}px`)}catch{}try{const y=(t.getAttribute("text-anchor")||"middle").toLowerCase();u.style.textAlign=y==="start"?"left":y==="end"?"right":"center"}catch{}try{const y=t.getAttribute("font-size")||window.getComputedStyle(t).fontSize||"";y&&(u.style.fontSize=/px$/i.test(y)?y:`${y}px`)}catch{}let m=!1,L=null;const C=600;u.addEventListener("compositionstart",()=>{m=!0}),u.addEventListener("compositionend",y=>{m=!1,K(t,u.value),ee(r,e,u.value);try{N(e)}catch{}h()}),u.addEventListener("input",()=>{K(t,u.value),ee(r,e,u.value);try{N(e)}catch{}h();try{Ca(t,e)||I(t,e)}catch{}L&&clearTimeout(L),L=setTimeout(()=>{try{P(t,e)}catch{}L=null},C)}),u.addEventListener("keydown",y=>{if(y.key==="Escape")y.preventDefault(),Dt(!1);else if(y.key==="Enter"&&!y.shiftKey&&!y.ctrlKey){if(m)return;y.preventDefault(),Dt(!0)}}),u.addEventListener("blur",()=>{m||Dt(!0)}),requestAnimationFrame(()=>{var y;try{u.focus({preventScroll:!0})}catch{u.focus()}(y=u.select)==null||y.call(u)})}function ve(t,e){if(!t||!e)return;const r=pe(t,e);if(!r)return;if(t._iwEventListeners?(t._iwEventListeners.forEach(({event:d,handler:p})=>{try{t.removeEventListener(d,p)}catch{}}),t._iwEventListeners=[]):t._iwEventListeners=[],q[e].set(r,t),!t.dataset.originalX&&t.hasAttribute("x")&&(t.dataset.originalX=t.getAttribute("x")),!t.dataset.originalY&&t.hasAttribute("y")&&(t.dataset.originalY=t.getAttribute("y")),t.setAttribute("contenteditable","true"),t.setAttribute("role","textbox"),t.setAttribute("spellcheck","false"),t.setAttribute("tabindex","0"),t.style.cursor="pointer",t.style.userSelect="none",!t.hasAttribute("aria-label"))try{const d=t.getAttribute("data-text-node")||t.getAttribute("id")||"",p=d?`Edit text: ${d}`:t.textContent&&t.textContent.trim()||"Edit canvas text";t.setAttribute("aria-label",p)}catch{t.setAttribute("aria-label","Edit canvas text")}const a=()=>{k!==e&&ne(e),t.classList.add("svg-text-focus"),Vt(r,e,!0),mt(),Wt(t),A=t,V=e,$(t,e)},n=()=>{t.classList.remove("svg-text-focus"),Vt(r,e,!1)};t.addEventListener("focus",a),t.addEventListener("blur",n),t._iwEventListeners.push({event:"focus",handler:a}),t._iwEventListeners.push({event:"blur",handler:n});const i=d=>{if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(d.key)){d.preventDefault();const b=d.shiftKey?5:1;let g=Number.parseFloat(t.getAttribute("x")||t.dataset.originalX||"0"),h=Number.parseFloat(t.getAttribute("y")||t.dataset.originalY||"0");d.key==="ArrowUp"&&(h-=b),d.key==="ArrowDown"&&(h+=b),d.key==="ArrowLeft"&&(g-=b),d.key==="ArrowRight"&&(g+=b),me(t,e,g,h);try{N(e)}catch{}return}if(d.key==="Enter"&&!d.shiftKey){d.preventDefault(),re(t,e);return}else if(d.key==="Backspace"||d.key==="Delete"){d.preventDefault(),re(t,e);return}else if(!d.ctrlKey&&!d.metaKey&&!d.altKey&&d.key.length===1){d.preventDefault(),re(t,e);return}};t.addEventListener("keydown",i),t._iwEventListeners.push({event:"keydown",handler:i});const o=()=>Ra(t,e);t.addEventListener("input",o),t._iwEventListeners.push({event:"input",handler:o});const s=d=>Da(d,t,e);t.addEventListener("pointerdown",s),t._iwEventListeners.push({event:"pointerdown",handler:s}),t.addEventListener("pointermove",Ha),t.addEventListener("pointerup",d=>ar(d,!1)),t.addEventListener("pointercancel",d=>ar(d,!0)),t.addEventListener("lostpointercapture",()=>{F.active&&F.node===t&&ar({pointerId:F.pointerId},!0)});const c=d=>{d.preventDefault(),d.stopPropagation(),re(t,e)};t.addEventListener("dblclick",c),t._iwEventListeners.push({event:"dblclick",handler:c});const l=d=>{d.detail===1&&setTimeout(()=>{(!wt||E!==t)&&re(t,e)},200)};t.addEventListener("click",l),t._iwEventListeners.push({event:"click",handler:l});const u=()=>Zr(t,e),f=()=>Ka();t.addEventListener("focus",u),t.addEventListener("blur",f),t._iwEventListeners.push({event:"focus",handler:u}),t._iwEventListeners.push({event:"blur",handler:f});try{ft(t)}catch{}t.dataset.prepared=e}function Pe(t,e){if(!t)return;t.querySelectorAll("text").forEach(a=>{a.closest&&a.closest("defs, symbol, clipPath, mask, pattern")||a.hasAttribute&&(a.hasAttribute("data-non-editable")||a.getAttribute("aria-hidden")==="true")||!pe(a,e)||(Ma(a,e),ve(a,e))})}function Vt(t,e,r){if(!et)return;const a=ye(t),n=et.querySelector(`input[data-text-node="${a}"][data-card-side="${e}"]`);if(!n)return;const i=n.closest(".text-field");i&&i.classList.toggle("is-active",r)}function Ra(t,e){const r=t.getAttribute("data-text-node")||"",a=G(t);ee(r,e,a),T(e);const n=Number.parseFloat(t.getAttribute("x")||t.dataset.originalX||"0"),i=Number.parseFloat(t.getAttribute("y")||t.dataset.originalY||"0");Yr(t,e,n,i);try{N(e)}catch(o){console.debug("preview-from-svg failed",o)}try{Te(t,e)}catch{}}function ae(t){const e=_(t),r=O(t);if(!r)return null;const a=q[e].get(r);if(a)return a;const n=T(e);if(!n)return null;const i=document.createElementNS(Q,"text");i.setAttribute("data-text-node",r),Gr(i,t,e);try{const o=t.dataset.fontSize||t.getAttribute("data-font-size")||"16",s=t.dataset.letterSpacing||t.getAttribute("data-letter-spacing")||"",c=t.dataset.color||t.style.color||"#1f2933",l=t.dataset.fontFamily||t.style.fontFamily||"",u=(t.dataset.align||"center").toLowerCase(),f=u==="left"?"start":u==="right"?"end":"middle";try{i.setAttribute("font-size",String(o))}catch{}if(s)try{i.setAttribute("letter-spacing",String(s))}catch{}try{i.setAttribute("fill",c)}catch{}if(l)try{i.setAttribute("style",`font-family: '${l}', system-ui, sans-serif;`)}catch{}try{i.setAttribute("text-anchor",f)}catch{}try{i.setAttribute("dominant-baseline","middle")}catch{}}catch{}return K(i,t.value||""),n.appendChild(i),ve(i,e),i}function qe(t,e){const r=_(t);if(!O(t))return;const n=ae(t);if(n){K(n,e),E===n&&wt&&(wt.value=e,wt.dispatchEvent(new Event("input")));try{N(r)}catch(i){console.debug("preview-from-svg failed",i)}}}function Da(t,e,r){if(!e||t.button!==0||t.detail>1)return;const a=T(r);if(!a)return;Dt(!0),t.preventDefault(),t.stopPropagation();const n=he(a,t.clientX,t.clientY),i=Number.parseFloat(e.getAttribute("x")||e.dataset.originalX||"0"),o=Number.parseFloat(e.getAttribute("y")||e.dataset.originalY||"0");F.active=!0,F.node=e,F.side=r,F.svg=a,F.pointerId=t.pointerId,F.offsetX=i-n.x,F.offsetY=o-n.y;try{e.setPointerCapture(t.pointerId)}catch{}e.classList.add("svg-text-dragging"),I(e,r);const s=e.getAttribute("data-text-node");s&&Vt(s,r,!0),mt();try{e.focus({preventScroll:!0})}catch{try{e.focus()}catch{}}}function Ha(t){if(!F.active||t.pointerId!==F.pointerId)return;const{svg:e,node:r,side:a,offsetX:n,offsetY:i}=F;if(!e||!r)return;t.preventDefault();const o=he(e,t.clientX,t.clientY),s=o.x+n,c=o.y+i;me(r,a,s,c),Ct&&w.node===r&&Zr(r,a)}function Ua(){F.active=!1,F.node=null,F.side=null,F.pointerId=null,F.svg=null,F.offsetX=0,F.offsetY=0}function ar(t,e=!1){if(!F.active||t&&F.pointerId!==t.pointerId)return;const r=F.node,a=F.side;if(t&&r)try{r.releasePointerCapture(t.pointerId)}catch{}if(r&&r.classList.remove("svg-text-dragging"),Ua(),!e&&a){try{N(a)}catch{}try{P(r,a)}catch{}Xt()}}function Oa(){if(Ct)return Ct;const t=It||Ft;if(!t)return null;const e=document.createElement("div");return e.className="svg-resize-handle",e.setAttribute("aria-hidden","true"),t.appendChild(e),e.addEventListener("pointerdown",r=>{if(r.preventDefault(),r.stopPropagation(),r.button!==0)return;const a=w.node;if(!a)return;const n=ft(a);w.active=!0,w.pointerId=r.pointerId,w.startY=r.clientY;const i=Number(n&&n.dataset&&n.dataset.iwScale||1)||1;w.startScale=i;const o=parseFloat(a.getAttribute("letter-spacing")||a.dataset.letterSpacing||"0")||0;w.startLetterSpacing=o;try{e.setPointerCapture(r.pointerId)}catch{}I(w.node,w.side)}),e.addEventListener("pointermove",r=>{if(!w.active||r.pointerId!==w.pointerId)return;r.preventDefault();const n=1+(w.startY-r.clientY)/200,i=Math.max(.2,w.startScale*n);if(w.node){const o=ft(w.node);if(o){const c=Number(o.dataset.iwRotate||0)||0;jt(o,i,c,w.node);try{const u=(w.startLetterSpacing||0)/i;if(Number.isFinite(u)){w.node.setAttribute("letter-spacing",String(u));try{w.node.dataset.letterSpacing=String(u)}catch{}}}catch{}}const s=w.node.getAttribute("data-text-node")||"";s&&w.side&&ee(s,w.side,G(w.node));try{N(w.side)}catch{}}}),e.addEventListener("pointerup",r=>{if(!(!w.active||r.pointerId!==w.pointerId)){w.active=!1;try{e.releasePointerCapture(r.pointerId)}catch{}w.pointerId=null;try{P(w.node,w.side)}catch{}Xt()}}),e.addEventListener("pointercancel",r=>{w.active=!1;try{e.releasePointerCapture(r.pointerId)}catch{}w.pointerId=null}),Ct=e,e}function Zr(t,e){const r=It||Ft,a=Oa();if(!t||!a||!r||!T(e))return;const i=t.getBoundingClientRect(),o=r.getBoundingClientRect(),s=i.right-o.left-6,c=i.bottom-o.top-6;a.style.left=`${s}px`,a.style.top=`${c}px`,a.classList.add("is-visible"),w.node=t,w.side=e,Xa(t,e,o)}function Ka(){Ct&&(Ct.classList.remove("is-visible"),w.node=null,w.side=null,Ya())}function Wa(){if(zt)return zt;const t=It||Ft;if(!t)return null;const e=document.createElement("div");return e.className="svg-rotate-handle",e.setAttribute("aria-hidden","true"),t.appendChild(e),e.addEventListener("pointerdown",r=>{if(r.preventDefault(),r.stopPropagation(),r.button!==0)return;const a=v.node;if(!a)return;const n=ft(a);v.active=!0,v.pointerId=r.pointerId,v.startAngle=Number(n&&n.dataset&&n.dataset.iwRotate||0)||0;const i=T(v.side),o=he(i,r.clientX,r.clientY),s=nr(n,a);v.startPointerAngle=Math.atan2(o.y-s.cy,o.x-s.cx)*(180/Math.PI);try{e.setPointerCapture(r.pointerId)}catch{}I(v.node,v.side)}),e.addEventListener("pointermove",r=>{if(!v.active||r.pointerId!==v.pointerId)return;r.preventDefault();const a=T(v.side),n=he(a,r.clientX,r.clientY),i=ft(v.node),o=nr(i,v.node),c=Math.atan2(n.y-o.cy,n.x-o.cx)*(180/Math.PI)-v.startPointerAngle,l=v.startAngle+c;jt(i,Number(i.dataset.iwScale||1)||1,l,v.node);try{N(v.side)}catch{}}),e.addEventListener("pointerup",r=>{if(!(!v.active||r.pointerId!==v.pointerId)){v.active=!1;try{e.releasePointerCapture(r.pointerId)}catch{}v.pointerId=null;try{P(v.node,v.side)}catch{}Xt();try{const a=v.node&&v.node.parentNode&&v.node.parentNode.dataset&&v.node.parentNode.dataset.iwWrapper==="true"?v.node.parentNode:null;a&&a.classList&&a.classList.remove("is-rotating")}catch{}}}),e.addEventListener("pointercancel",r=>{v.active=!1;try{e.releasePointerCapture(r.pointerId)}catch{}v.pointerId=null;try{const a=v.node&&v.node.parentNode&&v.node.parentNode.dataset&&v.node.parentNode.dataset.iwWrapper==="true"?v.node.parentNode:null;a&&a.classList&&a.classList.remove("is-rotating")}catch{}}),zt=e,e}function nr(t,e){let r=0,a=0;try{const n=e.getBBox();r=n.x+n.width/2,a=n.y+n.height/2}catch{}return{cx:r,cy:a,getScreen:function(n){try{const i=n.createSVGPoint();i.x=r,i.y=a;const o=e.ownerSVGElement.getScreenCTM(),s=i.matrixTransform(o);return{x:s.x,y:s.y}}catch{return{x:0,y:0}}},cy:a}}function Xa(t,e,r){const a=It||Ft,n=Wa();if(!t||!n||!a||!T(e))return;const o=t.getBoundingClientRect();r=r||a.getBoundingClientRect();const s=o.left-r.left+o.width/2-8,c=o.top-r.top-18;n.style.left=`${s}px`,n.style.top=`${c}px`,n.classList.add("is-visible"),v.node=t,v.side=e}function Ya(){zt&&(zt.classList.remove("is-visible"),v.node=null,v.side=null)}function $(t,e){const r=T(e);if(!r||!t||(t.tagName?t.tagName.toLowerCase():"")==="image"||t.hasAttribute&&t.hasAttribute("data-uploaded"))return;try{const S=t.getAttribute&&t.getAttribute("data-text-node")||"";S?Array.from(r.querySelectorAll(`[data-iw-target-node="${S}"]`)).forEach(ie=>{try{ie.remove()}catch{}}):_e(e)}catch{try{_e(e)}catch{}}let n={x:0,y:0,width:0,height:0};try{n=t.getBBox()}catch{}const i=8,o=n.x-i,s=n.y-i,c=Math.max(0,n.width+i*2),l=Math.max(0,n.height+i*2),u=document.createElementNS(Q,"rect");u.classList.add("text-bounding-box");try{const S=t.getAttribute&&t.getAttribute("data-text-node")||"";S&&u.setAttribute("data-iw-target-node",S)}catch{}u.setAttribute("x",o),u.setAttribute("y",s),u.setAttribute("width",c),u.setAttribute("height",l),u.setAttribute("fill","none"),u.setAttribute("stroke","#3B82F6"),u.setAttribute("stroke-width","2"),u.setAttribute("pointer-events","none");let f=r;try{const S=t.parentNode&&t.parentNode.dataset&&t.parentNode.dataset.iwWrapper==="true"?t.parentNode:null;S&&(f=S)}catch{f=r}f.appendChild(u);let d=null;try{d=r.querySelector("g[data-iw-handles-layer]"),d||(d=document.createElementNS(Q,"g"),d.setAttribute("data-iw-handles-layer","true"),r.appendChild(d))}catch{d=r}function p(S,nt,ie={}){const{type:Ht="resize",shape:oe="circle",w:z=10,h:ht=10,cursor:M="pointer",rx:X=0,ry:it=0}=ie,H=document.createElementNS(Q,"g");H.classList.add("bounding-box-handle"),H.setAttribute("data-handle-type",Ht);try{if(t&&t.getAttribute){const B=t.getAttribute("data-text-node")||"";B&&H.setAttribute("data-iw-target-node",B)}}catch{}try{H.dataset.targetNodeKey=t.getAttribute&&t.getAttribute("data-text-node")||""}catch{}try{H.style.cursor=M}catch{}if(oe==="circle"){const B=document.createElementNS(Q,"circle");B.setAttribute("cx",S),B.setAttribute("cy",nt),B.setAttribute("r",String(z/2)),B.setAttribute("fill","#fff"),B.setAttribute("stroke","#3B82F6"),B.setAttribute("stroke-width","2"),B.setAttribute("pointer-events","none"),H.appendChild(B)}else{const B=document.createElementNS(Q,"rect");B.setAttribute("x",String(S-z/2)),B.setAttribute("y",String(nt-ht/2)),B.setAttribute("width",String(z)),B.setAttribute("height",String(ht)),X&&B.setAttribute("rx",String(X)),it&&B.setAttribute("ry",String(it)),B.setAttribute("fill","#fff"),B.setAttribute("stroke","#3B82F6"),B.setAttribute("stroke-width","2"),B.setAttribute("pointer-events","none"),H.appendChild(B)}const tt=document.createElementNS(Q,"circle");return tt.setAttribute("cx",S),tt.setAttribute("cy",nt),tt.setAttribute("r",String(Math.max(12,z))),tt.setAttribute("fill","transparent"),tt.setAttribute("pointer-events","visible"),tt.setAttribute("class","bounding-box-hit"),tt.setAttribute("role","button"),tt.setAttribute("aria-label",Ht.charAt(0).toUpperCase()+Ht.slice(1)),tt.setAttribute("tabindex","-1"),H.appendChild(tt),d.appendChild(H),H}const b=[{x:o,y:s,cursor:"nw-resize"},{x:o+c,y:s,cursor:"ne-resize"},{x:o+c,y:s+l,cursor:"se-resize"},{x:o,y:s+l,cursor:"sw-resize"}],g=[{x:o+c/2,y:s,cursor:"n-resize",w:16,h:10},{x:o+c,y:s+l/2,cursor:"e-resize",w:10,h:16},{x:o+c/2,y:s+l,cursor:"s-resize",w:16,h:10},{x:o,y:s+l/2,cursor:"w-resize",w:10,h:16}];b.forEach(S=>p(S.x,S.y,{type:"resize",shape:"circle",w:12,cursor:S.cursor})),g.forEach(S=>p(S.x,S.y,{type:"resize-side",shape:"rect",w:S.w,h:S.h,rx:2,ry:2,cursor:S.cursor}));const h=18,m=o+c+h,L=s-h,C=document.createElementNS(Q,"g");C.classList.add("bounding-box-handle"),C.setAttribute("data-handle-type","rotate");try{const S=t.getAttribute&&t.getAttribute("data-text-node")||"";S&&C.setAttribute("data-iw-target-node",S)}catch{}try{C.dataset.targetNodeKey=t.getAttribute&&t.getAttribute("data-text-node")||""}catch{}try{C.style.cursor="grab"}catch{}const y=document.createElementNS(Q,"circle");y.setAttribute("cx",String(m)),y.setAttribute("cy",String(L)),y.setAttribute("r","10"),y.setAttribute("fill","#fff"),y.setAttribute("stroke","#3B82F6"),y.setAttribute("stroke-width","2"),y.setAttribute("pointer-events","none"),C.appendChild(y);const x=document.createElementNS(Q,"circle");x.setAttribute("cx",String(m)),x.setAttribute("cy",String(L)),x.setAttribute("r","16"),x.setAttribute("fill","transparent"),x.setAttribute("pointer-events","visible"),x.setAttribute("class","bounding-box-hit"),x.setAttribute("role","button"),x.setAttribute("aria-label","Rotate"),x.setAttribute("tabindex","-1"),C.appendChild(x);const W=document.createElementNS(Q,"path");W.setAttribute("d","M12 6 A6 6 0 1 0 8 4"),W.setAttribute("stroke","#3B82F6"),W.setAttribute("stroke-width","1.6"),W.setAttribute("fill","none"),W.setAttribute("transform",`translate(${m-6} ${L-6})`),C.appendChild(W),d.appendChild(C)}function ja(t,e){let r=null;return function(...n){r&&clearTimeout(r),r=setTimeout(()=>{r=null;try{t.apply(this,n)}catch{}},e)}}const Te=ja(function(t,e){try{$(t,e)}catch{}},80);function _e(t){const e=T(t);if(!e)return;let r="";try{A&&V===t&&(r=A.getAttribute&&(A.getAttribute("data-text-node")||"")||"")}catch{r=""}try{Array.from(e.querySelectorAll(".text-bounding-box")).forEach(n=>{try{const i=n.getAttribute("data-iw-target-node")||"";if(r&&i===r)return}catch{}try{n.remove()}catch{}})}catch{}try{Array.from(e.querySelectorAll(".bounding-box-handle")).forEach(n=>{try{const i=n.getAttribute("data-iw-target-node")||"";if(r&&i===r)return}catch{}try{n.remove()}catch{}})}catch{}try{const a=e.querySelector("g[data-iw-handles-layer]");a&&Array.from(a.querySelectorAll(".bounding-box-handle")).forEach(n=>{try{const i=n.getAttribute("data-iw-target-node")||"";if(r&&i===r)return}catch{}try{n.remove()}catch{}})}catch{}try{Array.from(e.querySelectorAll("g[data-iw-wrapper]")).forEach(a=>{Array.from(a.querySelectorAll(".text-bounding-box, .bounding-box-handle")).forEach(n=>{try{const i=n.getAttribute&&n.getAttribute("data-iw-target-node")||"";if(r&&i===r)return}catch{}try{n.remove()}catch{}})})}catch{}try{if(Ct)try{const a=w.node&&w.node.getAttribute&&w.node.getAttribute("data-text-node")||"";(!r||a!==r)&&Ct.classList.remove("is-visible")}catch{Ct.classList.remove("is-visible")}}catch{}try{if(zt)try{const a=v.node&&v.node.getAttribute&&v.node.getAttribute("data-text-node")||"";(!r||a!==r)&&zt.classList.remove("is-visible")}catch{zt.classList.remove("is-visible")}}catch{}}function N(t){const e=T(t),r=Gt[t];if(!e||!r)return;const a=e.cloneNode(!0);try{if(!a.getAttribute("viewBox")){const c=e.getAttribute("width")||e.clientWidth||0,l=e.getAttribute("height")||e.clientHeight||0;c&&l&&a.setAttribute("viewBox",`0 0 ${c} ${l}`)}}catch{}const i=new XMLSerializer().serializeToString(a),o=new Blob([i],{type:"image/svg+xml"}),s=URL.createObjectURL(o);try{const c=r.dataset.__svg_blob_url;c&&URL.revokeObjectURL(c)}catch{}r.dataset.__svg_blob_url=s,r.src=s;try{r.style.removeProperty("filter")}catch{}}function ir(t,e){var a,n;const r=(a=q[e])==null?void 0:a.get(t);r&&r.parentNode&&(E===r&&Dt(!1),r.parentNode.removeChild(r)),(n=q[e])==null||n.delete(t)}function Jr(){et&&et.querySelectorAll(".text-field").forEach(t=>{const e=t.querySelector("input"),r=_(e);t.classList.toggle("is-inactive",r!==k)})}function $e(){if(!et)return;const t=new Map;Array.from(et.querySelectorAll(".text-field")).forEach(e=>{const r=e.querySelector("input");if(!r)return;const a=_(r);t.has(a)||t.set(a,[]),t.get(a).push({wrapper:e,input:r})}),t.forEach((e,r)=>{e.forEach(({input:a},n)=>{const i=Ce+n*ka;a.dataset.topPercent||(a.dataset.topPercent=i),ae(a),Gr(q[r].get(O(a)),a,r)})}),Jr()}function Qr(t){var u;if(!t||t.dataset.textPrepared==="true")return;const e=t.querySelector("input"),r=t.querySelector(".delete-text");if(!e)return;e.dataset.cardSide||(e.dataset.cardSide=k),e.dataset.textNode||(e.dataset.textNode=`field-${Date.now()}-${Math.random().toString(36).slice(2,5)}`);const a=_(e),n=O(e),i=e.dataset.defaultValue??"",o=e.getAttribute("placeholder")||"",s=(u=q[a])==null?void 0:u.get(n),c=G(s);e.value||(c?e.value=c:i&&(e.value=i)),!e.placeholder&&o?e.placeholder=o:!e.placeholder&&i&&(e.placeholder=i);const l=ae(e);!s&&l?K(l,e.value||i||""):s&&e.value&&e.value!==c?K(s,e.value):s&&!c&&(i||e.value)&&K(s,e.value||i||""),e.addEventListener("input",()=>{var f;try{qe(e,e.value);const d=(f=q[_(e)])==null?void 0:f.get(O(e));if(d){Te(d,_(e));try{N(_(e))}catch{}}}catch(d){console.debug("input update failed",d)}}),e.addEventListener("focus",()=>{const f=_(e);k!==f&&ne(f),Vt(O(e),f,!0),mt()}),e.addEventListener("blur",()=>{Vt(O(e),_(e),!1),Ee()}),r&&!r.dataset.bound&&(r.dataset.bound="true",r.addEventListener("click",()=>{const f=_(e),d=O(e);ir(d,f),t.remove(),$e(),Ee()})),t.dataset.textPrepared="true"}function Va(){et&&(Array.from(et.querySelectorAll(".text-field")).forEach(Qr),$e())}function ne(t){Dt(!0),k=t;const e=t==="front";ot&&ot.classList.toggle("active",e),st&&st.classList.toggle("active",!e),ua.forEach(r=>{const n=(r===ze?"front":r===Me?"back":r.dataset.view)===t;r.classList.toggle("active",n),r.setAttribute("aria-pressed",n?"true":"false")}),Jr()}function or(){Re&&(Dt(!0),Re.style.transform=`scale(${gt})`,Re.style.transformOrigin="center center",cr&&(cr.textContent=`${Math.round(gt*100)}%`),Ae&&(Ae.disabled=gt>=Qe),xe&&(xe.disabled=gt<=Je))}if(ze&&ze.addEventListener("click",()=>ne("front")),Me&&Me.addEventListener("click",()=>ne("back")),Ae&&Ae.addEventListener("click",()=>{gt<Qe&&(gt=Math.min(Qe,+(gt+Rr).toFixed(2)),or())}),xe&&xe.addEventListener("click",()=>{gt>Je&&(gt=Math.max(Je,+(gt-Rr).toFixed(2)),or())}),or(),Pe(ot,"front"),Pe(st,"back"),(function(){function e(n,i){if(!i||!n)return;const o=parseFloat(i.getAttribute("width"))||500,s=parseFloat(i.getAttribute("height"))||700;n.style.width=o+"px",n.style.height=s+"px",n.parentNode.style.width=o+"px",n.parentNode.style.height=s+"px"}function r(n){const i=n.getAttribute("viewBox");let o=0,s=0,c=500,l=700;if(i){const f=i.trim().split(/\s+/).map(Number);f.length===4&&(o=f[0],s=f[1],c=f[2],l=f[3])}n.querySelectorAll("text").forEach(f=>{if(f.hasAttribute("data-text-node"))return;let d=parseFloat(f.getAttribute("x")),p=parseFloat(f.getAttribute("y"));(!isFinite(d)||d<o||d>o+c)&&(d=o+c/2),(!isFinite(p)||p<s||p>s+l)&&(p=s+l/2),f.setAttribute("x",String(d)),f.setAttribute("y",String(p)),f.dataset.originalX=String(d),f.dataset.originalY=String(p);const b=f.getAttribute("text-anchor")||"middle";f.setAttribute("text-anchor",b);const g=f.getAttribute("dominant-baseline")||"middle";f.setAttribute("dominant-baseline",g);const h=f.getAttribute("font-size")||window.getComputedStyle(f).fontSize||"16";f.setAttribute("font-size",h);const m=f.getAttribute("letter-spacing")||window.getComputedStyle(f).letterSpacing||"";m&&f.setAttribute("letter-spacing",m);const L=f.getAttribute("font-family")||f.style&&f.style.fontFamily||window.getComputedStyle(f).fontFamily||"";L&&f.setAttribute("style",`font-family: ${L};`);const C=f.querySelectorAll("tspan");C.length>0&&C.forEach((x,W)=>{x.setAttribute("x",String(d)),W===0&&x.setAttribute("y",String(p)),x.setAttribute("font-size",h),m&&x.setAttribute("letter-spacing",m),L&&x.setAttribute("style",`font-family: ${L};`)});const y=f.getAttribute("id")||f.getAttribute("name")||"";if(y){const x=document.querySelector(`input[data-text-node="${y}"]`);x&&(x.dataset.leftPercent=((d-o)/c*100).toFixed(2),x.dataset.topPercent=((p-s)/l*100).toFixed(2),x.dataset.fontSize=h,x.dataset.letterSpacing=m,x.dataset.fontFamily=L,x.style.fontFamily=L,x.style.fontSize=h+"px",m&&(x.style.letterSpacing=m))}})}function a(){["front","back"].forEach(n=>{const i=n==="front"?ot:st,o=T(n);!o||!i||(e(i,o),r(o))}),Pe(ot,"front"),Pe(st,"back"),$e();try{Ta()}catch{}try{N("front"),N("back")}catch{}}window.document.fonts&&window.document.fonts.ready?window.document.fonts.ready.then(a):setTimeout(a,200)})(),ut&&(Rt("front",kt.front.currentSrc,{skipPreview:!1}),Rt("back",kt.back.currentSrc,{skipPreview:!1}),Z))try{["front","back"].forEach(t=>{const e=t==="front"?ot:st;if(!e)return;const r=e.dataset.defaultImage||"",a=e.dataset.currentImage||"";if(r&&!a)try{e.classList.add("background-fallback"),e.style.backgroundImage=`url("${r}")`;const n=document.querySelector(`[data-image-preview="${t}"]`);n&&!n.getAttribute("src")&&(n.src=r),lt({event:"immediate-background-fallback",side:t,defaultSrc:r})}catch(n){console.warn("background fallback apply failed",n)}})}catch{}Va(),za();try{const t=document.querySelector(".undo-btn"),e=document.querySelector(".redo-btn");t&&t.addEventListener("click",r=>{r.preventDefault(),Ia()}),e&&e.addEventListener("click",r=>{r.preventDefault(),Fa()}),Xt()}catch{}lr&&et&&lr.addEventListener("click",()=>{const t=document.createElement("div");t.classList.add("text-field"),t.dataset.cardSide=k;const e=document.createElement("input");e.type="text",e.value="New Text",e.dataset.cardSide=k,e.dataset.textNode=`custom-${Date.now()}`,e.dataset.topPercent=Ce,e.dataset.leftPercent=50,e.dataset.align="center",e.dataset.defaultValue="New Text",e.placeholder="New Text";const r=document.createElement("button");r.classList.add("delete-text"),r.type="button",r.setAttribute("aria-label","Delete text field"),r.innerHTML='<i class="fa-solid fa-trash-can" aria-hidden="true"></i>',t.appendChild(e),t.appendChild(r),et.appendChild(t),Qr(t);const a=ae(e);if(a){K(a,e.value||e.dataset.defaultValue||"New Text");const n=T(k);if(n){const i=be(n),o=i.x+(i.width||500)*.5,s=i.y+(i.height||700)*.5;me(a,k,o,s)}ve(a,k),A=a,V=k,$(a,k);try{Wt(a,k)}catch{}I(a,k),P(a,k);try{re(a,k)}catch{}}$e();try{e.focus({preventScroll:!0})}catch{e.focus()}}),De.forEach(t=>{const e=t.dataset.panel||"text";t.addEventListener("click",()=>{De.forEach(r=>r.classList.remove("active")),t.classList.add("active"),Vr(e)})}),ut&&Ue&&(ur.forEach(t=>{const e=t.dataset.imageInput;t.addEventListener("change",()=>{const r=t.files&&t.files[0];if(!r)return;if(!r.type.startsWith("image/")){t.value="",alert("Please choose an image file.");return}if(r.size>Dr){t.value="",alert("Image is too large. Please upload a file smaller than 5MB.");return}const a=new FileReader;a.onload=n=>{var o;const i=(o=n.target)==null?void 0:o.result;typeof i=="string"&&Rt(e,i)},a.onerror=()=>{console.error("Unable to read selected image file."),alert("Unable to read the selected image file. Please try another image.")},a.readAsDataURL(r)})}),fa.forEach(t=>{const e=t.dataset.resetImage;t.addEventListener("click",()=>$a(e))})),ne("front"),Vr(((la=(ca=De[0])==null?void 0:ca.dataset)==null?void 0:la.panel)||"text"),document.addEventListener("pointerup",()=>{try{document.querySelectorAll("g[data-iw-wrapper].is-rotating").forEach(t=>{try{t.classList.remove("is-rotating")}catch{}})}catch{}}),document.addEventListener("pointercancel",()=>{try{document.querySelectorAll("g[data-iw-wrapper].is-rotating").forEach(t=>{try{t.classList.remove("is-rotating")}catch{}})}catch{}}),(function(){const e=document.getElementById("imagesPanel");if(!e)return;if(!Ue){const g=document.createElement("div");g.className="images-locked-message",g.textContent="Image replacement is disabled for this template.",g.style.padding="16px",g.style.textAlign="center",g.style.color="#4b5563";const h=e.querySelector(".images-body");h&&(h.innerHTML="",h.appendChild(g)),e.querySelectorAll("button, input").forEach(m=>{m.disabled=!0,m.setAttribute("aria-disabled","true")});return}const r=e.querySelectorAll(".images-tab"),a=document.getElementById("imagesFileInput"),n=document.getElementById("btnUploadFiles"),i=document.getElementById("recentUploads"),o="__iw_recent_images_v1";function s(g){r.forEach(h=>{const m=h.dataset.tab,L=e.querySelector(`.images-panel[data-panel="${m}"]`),C=h===g;h.classList.toggle("active",C),L&&(L.style.display=C?"":"none"),h.setAttribute("aria-selected",C?"true":"false")})}r.forEach(g=>g.addEventListener("click",h=>{h.stopPropagation(),s(g)}));function c(){try{const g=localStorage.getItem(o);if(!g)return[];const h=JSON.parse(g);return Array.isArray(h)?h:[]}catch{return[]}}function l(g){try{localStorage.setItem(o,JSON.stringify(g.slice(0,40)))}catch{}}function u(g){i&&(i.innerHTML="",(g||[]).forEach(h=>{const m=document.createElement("div");m.className="thumb-wrapper";const L=document.createElement("button");L.type="button",L.className="thumb",L.setAttribute("aria-label",h.name||"Uploaded image");const C=document.createElement("img");C.alt=h.name||"Uploaded image",C.src=h.data,L.appendChild(C),L.addEventListener("click",()=>{try{Rt(k||"front",h.data)}catch(x){console.debug("applyImage failed",x)}});const y=document.createElement("button");y.type="button",y.className="thumb-delete",y.setAttribute("aria-label","Delete uploaded image"),y.innerHTML='<i class="fa-solid fa-trash-can" aria-hidden="true"></i>',y.addEventListener("click",x=>{x.stopPropagation();try{const S=(c()||[]).filter(nt=>nt.data!==h.data);l(S),u(S)}catch(W){console.error("Failed to delete recent image",W)}}),m.appendChild(L),m.appendChild(y),i.appendChild(m)}))}try{u(c())}catch{}function f(g){if(!g||g.length===0)return;const h=c();Array.from(g).forEach(m=>{const L=new FileReader;L.onload=C=>{const y=C.target&&C.target.result;if(!y)return;h.unshift({name:m.name||"",type:m.type||"",data:y});const x=[],W=new Set;for(const S of h)W.has(S.data)||(x.push(S),W.add(S.data));l(x),u(x)};try{L.readAsDataURL(m)}catch(C){console.error("readFile failed",C)}})}n&&a&&n.addEventListener("click",g=>{g.preventDefault(),a.click()}),a&&a.addEventListener("change",g=>{const h=a.files;f(h);try{a.value=""}catch{}});try{let S=function(z,ht=!1){if(m){if(ht||(m.innerHTML=""),!z||z.length===0){const M=document.createElement("div");M.className="discover-empty",M.textContent="No results",m.appendChild(M);return}z.forEach(M=>{const X=document.createElement("button");X.type="button",X.className="thumb",X.style.padding="0",X.style.border="none",X.style.background="transparent";const it=document.createElement("img");it.alt=M.alt_description||M.description||"Result image",it.src=M.urls&&(M.urls.small||M.urls.thumb)||"",it.style.width="100%",it.style.height="auto",it.loading="lazy",X.appendChild(it),X.addEventListener("click",()=>{try{Rt(k||"front",M.urls&&M.urls.full||M.urls&&M.urls.regular||M.urls&&M.urls.small)}catch(H){console.debug("applyImage failed",H)}}),m.appendChild(X)})}},ie=function(){try{nt&&(nt.style.display="",nt.setAttribute("aria-hidden","false"))}catch{}},Ht=function(){try{nt&&(nt.style.display="none",nt.setAttribute("aria-hidden","true"))}catch{}};var d=S,p=ie,b=Ht;const g=e.querySelector("#discoverSearchInput"),h=e.querySelector("#discoverSearchBtn"),m=e.querySelector("#discoverResults"),L="iFpUZ_6aTnLGz0Voz0MYlprq9i_RBl83ux9DzV6EMOs";let C=null,y="",x=1,W=1;const nt=e.querySelector("#discoverSpinner");async function oe(z,ht=1,M=!1){if(!z||!z.trim()){S([]);return}y=z,x=Number(ht)||1;try{ie();const X=18,it=`https://api.unsplash.com/search/photos?query=${encodeURIComponent(z)}&per_page=${X}&page=${x}`,H=await fetch(it,{headers:{Authorization:`Client-ID ${L}`}});if(!H.ok)throw new Error("Unsplash fetch failed "+H.status);const tt=await H.json(),B=tt.results||[],sr=Number(tt.total||0);W=Math.ceil(sr/X)||1,S(B,M),Ht()}catch(X){console.warn("Discover search failed",X),Ht(),S([])}}h&&g&&(h.addEventListener("click",z=>{z.preventDefault(),oe(g.value,1,!1)}),g.addEventListener("keydown",z=>{z.key==="Enter"&&(z.preventDefault(),oe(g.value,1,!1))}),g.addEventListener("input",z=>{clearTimeout(C),C=setTimeout(()=>{oe(g.value,1,!1)},450)}),(function(){if(!m)return;let ht=!1,M=0;m.addEventListener("scroll",X=>{const it=Date.now();if(it-M<200||(M=it,ht))return;const H=X.target,tt=H.scrollTop,B=H.clientHeight,sr=H.scrollHeight;if((tt+B)/Math.max(1,sr)>=.6){if(!y||x>=W)return;ht=!0,x+=1,oe(y,x,!0).then(()=>{ht=!1}).catch(()=>{ht=!1})}})})())}catch{}})(),Pa()});
