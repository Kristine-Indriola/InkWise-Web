import{r as P,j as d,c as Us,R as Hs}from"./editing-BTZOiJLl.js";import"./vendor-CRB3T2We.js";const da="http://www.w3.org/2000/svg",Vs="http://www.w3.org/1999/xlink";let Ra=class{constructor(i,o={}){console.log("SvgTemplateEditor: Constructor called for SVG element:",i),this.svg=i,this.options={onImageChange:o.onImageChange||null,onTextChange:o.onTextChange||null,...o};const l=document&&document.body&&document.body.dataset?document.body.dataset:{},c=(l.imageReplacementMode||"").toLowerCase();let m="full";c==="panel-only"||c==="disabled"?m=c:l.allowImageReplacement==="false"&&(m="disabled"),this.imageReplacementMode=m,this.allowCanvasImageTools=m!=="disabled",this.changeableImages=[],this.textElements=[],this.imageClassTokens=new Set(["canvas-layer__image","changeable-image","svg-changeable-image","inkwise-image"]),this.init()}init(){console.log("SvgTemplateEditor: Initializing..."),this.parseSvgData(),this.setupImageHandlers(),this.setupTextHandlers(),this.addCssStyles(),console.log("SvgTemplateEditor: Initialization complete")}parseSvgData(){const i=this.svg.dataset.svgData;if(i)try{const o=JSON.parse(i);this.changeableImages=o.changeable_images||[],this.textElements=o.text_elements||[]}catch(o){console.warn("SvgTemplateEditor: Failed to parse data-svg-data payload",o)}}readDatasetTokens(i){return!i||!i.dataset?[]:["changeable","editableType","elementType","layerType","previewType","fieldType"].map(l=>i.dataset[l]).filter(l=>typeof l=="string"&&l.trim()!=="").map(l=>l.trim().toLowerCase())}findImageContentNode(i){return!i||typeof i.querySelector!="function"?null:i.querySelector('[data-changeable="image"], [data-editable-image], .canvas-layer__image, img, image')}nodeRepresentsImage(i){if(!i)return!1;const o=typeof i.tagName=="string"?i.tagName.toLowerCase():"";if(o==="image"||o==="img"||this.readDatasetTokens(i).some(c=>c==="image"||c==="photo"||c==="graphic")||typeof i.hasAttribute=="function"&&(i.hasAttribute("data-editable-image")||i.hasAttribute("data-changeable-image")))return!0;if(i.classList){for(const c of this.imageClassTokens)if(i.classList.contains(c))return!0}return o==="foreignobject"?!!this.findImageContentNode(i):!1}resolveImageNode(i){if(!i)return null;if(this.nodeRepresentsImage(i))return i;if(typeof i.closest=="function"){const o=i.closest("[data-preview-node]");if(o&&o!==i&&this.nodeRepresentsImage(o))return o}return this.findImageContentNode(i)}resolveImageHandleNodes(i){const o=this.resolveImageNode(i);return o?{interactionNode:typeof o.closest=="function"&&o.closest("foreignObject")||o,contentNode:o}:null}applyImageSourceToNode(i,o){if(!i||!o)return null;const l=typeof i.tagName=="string"?i.tagName.toLowerCase():"";if(l==="image")return i.setAttributeNS(Vs,"href",o),i.setAttribute("href",o),i.dataset&&(i.dataset.src=o),i;if(l==="img")return i.setAttribute("src",o),i.dataset&&(i.dataset.src=o),i;if(l==="foreignobject"){const c=this.findImageContentNode(i);return c&&c!==i?this.applyImageSourceToNode(c,o):null}return l==="rect"?this.convertRectToImage(i,o):(i.style&&typeof i.style.setProperty=="function"&&(i.style.backgroundImage=`url('${o}')`),i.dataset&&(i.dataset.src=o,i.dataset.replacedImage="true"),i)}convertRectToImage(i,o){if(!i||!i.parentNode)return null;const l=document.createElementNS(da,"image");return["x","y","width","height","transform","preserveAspectRatio"].forEach(m=>{i.hasAttribute&&i.hasAttribute(m)&&l.setAttribute(m,i.getAttribute(m))}),Array.from(i.attributes||[]).forEach(m=>{(m.name==="id"||m.name.startsWith("data-"))&&l.setAttribute(m.name,m.value)}),i.classList&&i.classList.length&&i.classList.forEach(m=>l.classList.add(m)),l.setAttribute("href",o),l.setAttributeNS(Vs,"href",o),l.hasAttribute("preserveAspectRatio")||l.setAttribute("preserveAspectRatio","xMidYMid slice"),i.parentNode.replaceChild(l,i),l}escapeSelector(i){return typeof i!="string"||!i.length?"":typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(i):i.replace(/([^a-zA-Z0-9_-])/g,"\\$1")}resolveNodeFromMetadata(i){if(!i||typeof i!="object")return null;const o=i.id||i.element_id||i.node_id;if(o){const c=`#${this.escapeSelector(o)}`,m=this.svg.querySelector(c);if(m)return m}const l=i.selector||i.css_selector;if(l)try{const c=this.svg.querySelector(l);if(c)return c}catch(c){console.warn("SvgTemplateEditor: Invalid selector in changeable image metadata",l,c)}return null}collectImageCandidates(){const i=new Set;return this.changeableImages.forEach(l=>{const c=this.resolveNodeFromMetadata(l);c&&i.add(c)}),this.svg.querySelectorAll('[data-changeable="image"], [data-editable-image], .changeable-image, .canvas-layer__image, image, img, foreignObject').forEach(l=>{i.add(l)}),Array.from(i)}getBBoxSafe(i){if(!i||typeof i.getBBox!="function")return null;try{return i.getBBox()}catch(o){return console.warn("SvgTemplateEditor: Unable to compute bounding box for element",o,i),null}}toSvgPoint(i,o){if(!this.svg||typeof this.svg.createSVGPoint!="function")return null;const l=this.svg.createSVGPoint();l.x=i,l.y=o;const c=this.svg.getScreenCTM();return c?l.matrixTransform(c.inverse()):null}setupImageHandlers(){const i=this.collectImageCandidates();if(console.log("SvgTemplateEditor: Found",i.length,"changeable image elements"),!this.allowCanvasImageTools){i.forEach(o=>{const l=this.resolveImageHandleNodes(o);if(!l)return;const{interactionNode:c}=l;if(c.style.cursor="default",c.classList.remove("svg-changeable-image"),c.classList.remove("changeable-image-hover"),c._boundingBox){try{c._boundingBox.remove()}catch{}c._boundingBox=null}});return}setTimeout(()=>{i.forEach((o,l)=>{const c=this.resolveImageHandleNodes(o);if(!c)return;const{interactionNode:m,contentNode:k}=c;if(!m||m.__inkwiseSvgImageBound)return;console.log("SvgTemplateEditor: Setting up element",l,m),m.__inkwiseSvgImageBound=!0,m.__inkwiseImageContent=k||m,m.style.cursor="pointer",m.classList.add("svg-changeable-image"),m.classList.add("changeable-image-hover"),m.addEventListener("mouseenter",()=>{m.classList.add("changeable-image-active")}),m.addEventListener("mouseleave",()=>{m.classList.remove("changeable-image-active")}),m.addEventListener("click",A=>{A.preventDefault(),this.showImageUploadDialog(m)});const v=this.createBoundingBox(m);v&&(m._boundingBox=v),this.makeDraggable(m)})},200)}createBoundingBox(i){const o=this.getBBoxSafe(i);if(!o)return null;const l=document.createElementNS(da,"g");l.classList.add("svg-bounding-box");const c=document.createElementNS(da,"rect");return c.classList.add("svg-bounding-box__rect"),c.setAttribute("fill","none"),c.setAttribute("stroke","#007cba"),c.setAttribute("stroke-width","2"),c.setAttribute("stroke-dasharray","5,5"),c.setAttribute("rx","3"),c.style.pointerEvents="none",l.appendChild(c),this.createResizeHandles().forEach(k=>l.appendChild(k)),this.svg.appendChild(l),this.positionBoundingElements(l,o),l}createResizeHandles(){const i=[];return[{name:"nw",x:0,y:0},{name:"ne",x:1,y:0},{name:"sw",x:0,y:1},{name:"se",x:1,y:1}].forEach(l=>{const c=document.createElementNS(da,"circle");c.setAttribute("r","4"),c.setAttribute("fill","#007cba"),c.setAttribute("stroke","#ffffff"),c.setAttribute("stroke-width","1"),c.classList.add("resize-handle",`handle-${l.name}`),c.style.pointerEvents="all",c.style.cursor=`${l.name}-resize`,i.push(c)}),i}positionBoundingElements(i,o){if(!i||!o)return;const l=i.querySelector(".svg-bounding-box__rect");if(!l)return;const c=5,m=o.x-c,k=o.y-c,v=o.width+c*2,A=o.height+c*2;l.setAttribute("x",m),l.setAttribute("y",k),l.setAttribute("width",Math.max(v,0)),l.setAttribute("height",Math.max(A,0)),i.querySelectorAll(".resize-handle").forEach(T=>{T.classList.contains("handle-nw")?(T.setAttribute("cx",m),T.setAttribute("cy",k)):T.classList.contains("handle-ne")?(T.setAttribute("cx",m+v),T.setAttribute("cy",k)):T.classList.contains("handle-sw")?(T.setAttribute("cx",m),T.setAttribute("cy",k+A)):T.classList.contains("handle-se")?(T.setAttribute("cx",m+v),T.setAttribute("cy",k+A)):T.classList.contains("handle-n")?(T.setAttribute("cx",m+v/2),T.setAttribute("cy",k)):T.classList.contains("handle-s")?(T.setAttribute("cx",m+v/2),T.setAttribute("cy",k+A)):T.classList.contains("handle-e")?(T.setAttribute("cx",m+v),T.setAttribute("cy",k+A/2)):T.classList.contains("handle-w")&&(T.setAttribute("cx",m),T.setAttribute("cy",k+A/2))})}updateBoundingBox(i){if(!i||!i._boundingBox)return;const o=this.getBBoxSafe(i);this.positionBoundingElements(i._boundingBox,o)}focusElementById(i){if(!i||!this.svg)return!1;const o=`#${this.escapeSelector(i)}`;let l=null;try{l=this.svg.querySelector(o)}catch(v){return console.warn("SvgTemplateEditor: Invalid selector generated for element id",i,v),!1}if(l||(l=this.svg.querySelector(`[data-element-id="${i}"]`)),!l)return!1;const m=(this.resolveImageHandleNodes(l)||{interactionNode:l}).interactionNode||l;return this.getBBoxSafe(m)?(this.updateBoundingBox(m),m._boundingBox&&(m._boundingBox.classList.add("svg-bounding-box--pulse"),setTimeout(()=>{m._boundingBox&&m._boundingBox.classList.remove("svg-bounding-box--pulse")},1e3)),typeof m.scrollIntoView=="function"&&m.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),m.classList.add("changeable-image-active"),setTimeout(()=>m.classList.remove("changeable-image-active"),1200),!0):!1}makeDraggable(i){let o=!1,l=0,c=0,m=0,k=0,v=0,A=0;const se=D=>{if(D.target.closest(".resize-handle"))return;const U=this.toSvgPoint(D.clientX,D.clientY);if(!U)return;const H=this.getBBoxSafe(i);if(!H)return;const le=typeof i.getAttribute=="function",Z=typeof i.setAttribute=="function";l=le?parseFloat(i.getAttribute("x")):H.x,c=le?parseFloat(i.getAttribute("y")):H.y,Number.isNaN(l)&&(l=H.x,Z&&i.setAttribute("x",l)),Number.isNaN(c)&&(c=H.y,Z&&i.setAttribute("y",c)),m=U.x-l,k=U.y-c,v=l,A=c,o=!0,i.style.cursor="grabbing",this.svg.style.cursor="grabbing",document.body.style.userSelect="none",D.preventDefault()},T=D=>{if(!o)return;const U=this.toSvgPoint(D.clientX,D.clientY);U&&(v=U.x-m,A=U.y-k,typeof i.removeAttribute=="function"&&i.removeAttribute("transform"),typeof i.setAttribute=="function"&&(i.setAttribute("x",v),i.setAttribute("y",A)),this.updateBoundingBox(i),D.preventDefault())},z=D=>{if(!o)return;o=!1,i.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="",this.updateBoundingBox(i);const U=new CustomEvent("svgImageMoved",{detail:{element:i,x:v,y:A}});this.svg.dispatchEvent(U),D.preventDefault()};i.addEventListener("mousedown",se),document.addEventListener("mousemove",T),document.addEventListener("mouseup",z),i._boundingBox&&i._boundingBox.querySelectorAll(".resize-handle").forEach(U=>{this.makeResizable(i,U)})}makeResizable(i,o){let l=!1,c=null,m=0,k=0,v=0,A=0,se="",T=0;const z=H=>{const le=this.toSvgPoint(H.clientX,H.clientY);if(!le)return;const Z=this.getBBoxSafe(i);if(!Z)return;m=Z.width,k=Z.height;const q=typeof i.getAttribute=="function",ee=typeof i.setAttribute=="function";v=q?parseFloat(i.getAttribute("x")):Z.x,A=q?parseFloat(i.getAttribute("y")):Z.y,Number.isNaN(v)&&(v=Z.x,ee&&i.setAttribute("x",v)),Number.isNaN(A)&&(A=Z.y,ee&&i.setAttribute("y",A)),T=parseFloat(i.getAttribute("font-size"))||parseFloat(window.getComputedStyle(i).fontSize)||16,c=le,se=Array.from(o.classList).find(W=>W.startsWith("handle-"))||"",l=!0,i.style.cursor=o.style.cursor,this.svg.style.cursor=o.style.cursor,document.body.style.userSelect="none",H.preventDefault(),H.stopPropagation()},D=H=>{if(!l)return;const le=this.toSvgPoint(H.clientX,H.clientY);if(!le)return;const Z=le.x-c.x,q=le.y-c.y;let ee=m,W=k,de=v,Ae=A;switch(se){case"handle-se":ee=m+Z,W=k+q;break;case"handle-sw":ee=m-Z,W=k+q,de=v+Z;break;case"handle-ne":ee=m+Z,W=k-q,Ae=A+q;break;case"handle-nw":ee=m-Z,W=k-q,de=v+Z,Ae=A+q;break}ee=Math.max(20,ee),W=Math.max(20,W);const We=i.tagName.toLowerCase();if((We==="image"||We==="rect")&&typeof i.setAttribute=="function")i.setAttribute("width",ee),i.setAttribute("height",W),i.setAttribute("x",de),i.setAttribute("y",Ae);else{const Ce=Math.max(1,m),ht=Math.max(1,k),Qe=ee/Ce,te=W/ht,Te=Math.max(Qe,te),Oe=Math.max(6,T*Te);typeof i.setAttribute=="function"&&i.setAttribute("font-size",Oe)}this.updateBoundingBox(i),H.preventDefault(),H.stopPropagation()},U=H=>{if(!l)return;l=!1,i.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="";const le={element:i,width:parseFloat(i.getAttribute?i.getAttribute("width"):"")||m,height:parseFloat(i.getAttribute?i.getAttribute("height"):"")||k,x:parseFloat(i.getAttribute?i.getAttribute("x"):"")||v,y:parseFloat(i.getAttribute?i.getAttribute("y"):"")||A},Z=new CustomEvent("svgImageResized",{detail:le});this.svg.dispatchEvent(Z),H.preventDefault(),H.stopPropagation()};o.addEventListener("mousedown",z),document.addEventListener("mousemove",D),document.addEventListener("mouseup",U)}setupTextHandlers(){const i=this;this.svg.querySelectorAll('[data-editable="true"]').forEach(l=>{l.style.cursor="pointer",l.classList.add("svg-editable-text"),l.addEventListener("click",function(c){c.preventDefault(),i.showTextEditDialog(l)}),l.addEventListener("mouseenter",function(){l.classList.add("editable-text-hover")}),l.addEventListener("mouseleave",function(){l.classList.remove("editable-text-hover")})})}showImageUploadDialog(i){const o=this,l=document.createElement("input");l.type="file",l.accept="image/*",l.style.display="none",l.addEventListener("change",function(c){const m=c.target.files[0];m&&o.handleImageUpload(m,i),l.parentNode&&l.parentNode.removeChild(l)}),document.body.appendChild(l),l.click()}async handleImageUpload(i,o){var T;const l=this,c=o&&o.__inkwiseImageContent?o.__inkwiseImageContent:o,m=((T=document.querySelector('meta[name="csrf-token"]'))==null?void 0:T.getAttribute("content"))||null,k=new FormData;k.append("image",i),m&&k.append("_token",m);let v=null;try{const z=await fetch("/design/upload-image",{method:"POST",body:k,credentials:"same-origin"});if(!z.ok){const U=await z.text().catch(()=>"");throw new Error(`Upload failed (${z.status}): ${U}`)}const D=await z.json();v=D.url||D.path||null}catch(z){console.error("SvgTemplateEditor: Failed to upload image",z),alert("We could not upload your image. Please try again.");const D=new CustomEvent("svgImageUploadFailed",{detail:{error:z,file:i}});l.svg.dispatchEvent(D);return}if(!v){alert("Upload did not return a usable image URL.");return}const A=l.applyImageSourceToNode(c,v)||c;o&&A&&o.__inkwiseImageContent!==A&&(o.__inkwiseImageContent=A);const se=new CustomEvent("svgImageChanged",{detail:{element:A,imageUrl:v,file:i}});l.svg.dispatchEvent(se),l.options.onImageChange&&l.options.onImageChange(A,v,i),l.updateBoundingBox(o||A)}showTextEditDialog(i){const o=this,l=i.textContent||"",c=document.createElement("input");c.type="text",c.value=l,c.className="svg-text-editor";const m=i.getBoundingClientRect(),k=o.svg.getBoundingClientRect();c.style.position="absolute",c.style.left=m.left-k.left+"px",c.style.top=m.top-k.top+"px",c.style.width=Math.max(m.width,100)+"px",c.style.fontSize=window.getComputedStyle(i).fontSize,c.style.fontFamily=window.getComputedStyle(i).fontFamily,c.style.border="1px solid #007cba",c.style.padding="2px",c.style.background="white",c.style.zIndex="1000",i.style.visibility="hidden",o.svg.parentNode.appendChild(c),c.focus(),c.select();const v=function(){const A=c.value;for(;i.firstChild;)i.removeChild(i.firstChild);i.appendChild(document.createTextNode(A)),i.style.visibility="visible",c.parentNode&&c.parentNode.removeChild(c);const se=new CustomEvent("svgTextChanged",{detail:{element:i,oldText:l,newText:A}});o.svg.dispatchEvent(se),o.options.onTextChange&&o.options.onTextChange(i,l,A)};c.addEventListener("blur",v),c.addEventListener("keydown",function(A){A.key==="Enter"?v():A.key==="Escape"&&(i.style.visibility="visible",c.parentNode&&c.parentNode.removeChild(c))})}addCssStyles(){if(document.getElementById("svg-editor-styles"))return;const i=document.createElement("style");i.id="svg-editor-styles",i.textContent=`
            .svg-changeable-image {
                transition: all 0.2s ease;
            }

            .changeable-image-hover:hover {
                filter: brightness(0.8);
                stroke: #007cba !important;
                stroke-width: 2px !important;
            }

            .changeable-image-active {
                filter: brightness(0.7);
                stroke: #007cba !important;
                stroke-width: 3px !important;
            }

            .svg-bounding-box {
                transition: all 0.2s ease;
            }

            .svg-bounding-box__rect {
                pointer-events: none;
            }

            .resize-handle {
                transition: all 0.2s ease;
                pointer-events: all !important;
            }

            .resize-handle:hover {
                fill: #005a87;
                r: 6px;
            }

            .svg-editable-text {
                transition: all 0.2s ease;
            }

            .editable-text-hover:hover {
                fill: #007cba !important;
                text-decoration: underline;
            }

            .uploaded-image {
                transition: all 0.2s ease;
            }

            .svg-text-editor {
                box-sizing: border-box;
                outline: none;
            }

            .svg-text-editor:focus {
                box-shadow: 0 0 5px rgba(0, 124, 186, 0.5);
            }
                .svg-bounding-box--pulse .svg-bounding-box__rect {
                    animation: svgBoundingBoxPulse 1s ease-out;
                }

                @keyframes svgBoundingBoxPulse {
                    0% {
                        stroke-width: 2;
                        opacity: 1;
                    }
                    50% {
                        stroke-width: 4;
                        opacity: 0.4;
                    }
                    100% {
                        stroke-width: 2;
                        opacity: 1;
                    }
                }
        `,document.head.appendChild(i)}getSvgString(){const i=this.svg.cloneNode(!0);i.querySelectorAll('.svg-bounding-box, .inkwise-editor-marker, [data-editor-only="true"]').forEach(c=>{var m;(m=c.parentNode)==null||m.removeChild(c)}),i.setAttribute("xmlns","http://www.w3.org/2000/svg"),i.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),i.style.width="",i.style.height="",i.style.maxWidth="",i.style.maxHeight="",i.removeAttribute("preserveAspectRatio");const o=document.createElementNS(da,"style");return o.id="inkwise-export-styles",o.textContent=`
            @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
            text { white-space: pre; }
        `,i.insertBefore(o,i.firstChild),new XMLSerializer().serializeToString(i)}getSvgDataUrl(){const i=this.getSvgString();return"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(i)))}async saveSvg(i,o="front"){const l=this.getSvgString();try{const c=await fetch(`/staff/templates/${i}/save-svg`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({svg_content:l,side:o})});if(!c.ok){const k=await c.text().catch(()=>"");throw new Error(k||`Request failed with status ${c.status}`)}let m;try{m=await c.json()}catch(k){console.warn("SvgTemplateEditor: Failed to parse save response",k),m={success:!1,error:"Invalid response from server"}}return m}catch(c){return console.error("Failed to save SVG:",c),{success:!1,error:c.message}}}};function or(){const J=()=>{const i=document.querySelectorAll("svg[data-svg-editor]");console.log("SvgTemplateEditor: Found",i.length,"SVGs with data-svg-editor attribute"),i.forEach((o,l)=>{o.__inkwiseSvgTemplateEditor||(console.log("SvgTemplateEditor: Initializing editor",l,"for SVG:",o),o.__inkwiseSvgTemplateEditor=new Ra(o))})};if(document.readyState==="complete"||document.readyState==="interactive"?J():document.addEventListener("DOMContentLoaded",J,{once:!0}),!window.__inkwiseSvgTemplateEditorObserver){const i=new MutationObserver(o=>{o.forEach(l=>{l.addedNodes.forEach(c=>{c.nodeType===1&&c.matches&&c.matches("svg[data-svg-editor]")&&(c.__inkwiseSvgTemplateEditor||(c.__inkwiseSvgTemplateEditor=new Ra(c)))})})});i.observe(document.body,{childList:!0,subtree:!0}),window.__inkwiseSvgTemplateEditorObserver=i}}typeof window<"u"&&(window.SvgTemplateEditor=Ra,window.__inkwiseSvgTemplateEditorAutoInit||(window.__inkwiseSvgTemplateEditorAutoInit=!0,or()));function lr(J={}){const{collectSnapshot:i,routes:o={},statusLabel:l=null,statusDot:c=null,csrfToken:m=null,debounce:k=1200,onAfterSave:v=null}=J;if(typeof i!="function")throw new Error("createAutosaveController requires a collectSnapshot function");let A=null,se=null,T=null,z=null;const D=(q,ee={})=>{const W=c instanceof HTMLElement&&c.parentElement||l instanceof HTMLElement&&l.parentElement;if(W instanceof HTMLElement&&(W.classList.remove("topbar-status--saving","topbar-status--error","topbar-status--dirty"),q==="saving"?W.classList.add("topbar-status--saving"):q==="error"?W.classList.add("topbar-status--error"):q==="dirty"&&W.classList.add("topbar-status--dirty")),c instanceof HTMLElement&&c.setAttribute("data-state",q),l instanceof HTMLElement)switch(q){case"saving":l.textContent="Saving…";break;case"dirty":l.textContent="Unsaved changes";break;case"error":l.textContent="Save failed";break;case"saved":{const Ae=(ee.timestamp instanceof Date?ee.timestamp:new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});l.textContent=`Saved ${Ae}`;break}default:l.textContent="Saved";break}},U=async q=>{const ee=o.autosave;if(!ee)return console.warn("[InkWise Studio] Autosave endpoint is not configured."),null;const W=await fetch(ee,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest",...m?{"X-CSRF-TOKEN":m}:{}},credentials:"same-origin",body:JSON.stringify(q)});if(!W.ok){const de=new Error(`Autosave responded with ${W.status}`);throw de.status=W.status,de.responseText=await W.text().catch(()=>null),de}try{return await W.json()}catch{return{}}},H=async q=>{if(console.log("[Autosave] Saving",q),T)try{await T}catch{}se=null,D("saving");let ee;try{ee=await i(q)}catch(W){throw console.error("[InkWise Studio] Failed to collect autosave snapshot.",W),D("error"),W}if(!ee||typeof ee!="object")return D("saved",{timestamp:new Date}),null;T=U(ee);try{const W=await T;if(z=new Date,D("saved",{timestamp:z}),typeof v=="function")try{v(W,ee)}catch(de){console.warn("[InkWise Studio] Autosave onAfterSave callback failed.",de)}return W}catch(W){throw console.error("[InkWise Studio] Autosave request failed.",W),D("error"),W}finally{T=null}};return{schedule:(q="change")=>{console.log("[Autosave] Scheduling",q),se=q,A&&clearTimeout(A),D("dirty"),A=window.setTimeout(()=>{A=null,H(se).catch(()=>{})},Math.max(250,k))},flush:async(q="flush")=>(A&&(clearTimeout(A),A=null),T&&await T,se!==null?H(q):null),isSaving:()=>!!T,getLastSavedAt:()=>z,notifyError:()=>D("error"),markDirty:()=>D("dirty")}}function cr(){if(typeof window<"u"){if(window.__inkwiseCustomerStudioInitialized)return;window.__inkwiseCustomerStudioInitialized=!0}const J=()=>{var Es,Cs,Is;const i=document.querySelectorAll("[data-preview-target]"),o=document.querySelector(".preview-card-bg"),l=document.getElementById("preview-svg"),c=document.querySelectorAll("[data-card-thumb]"),m=document.querySelectorAll("[data-card-view]"),k=document.getElementById("extraPreviewContainer"),v=document.getElementById("textFieldList"),A=document.querySelector("[data-add-text-field]"),se=document.querySelectorAll(".sidenav-btn"),T=document.querySelector(".canvas-stage"),z="http://www.w3.org/2000/svg",D=document.querySelector(".canvas-measure-horizontal .measure-value"),U=document.querySelector(".canvas-measure-vertical .measure-value"),H=document.querySelector(".preview-canvas-wrapper");let le=1;const Z=new Set(["canvas-layer__image","changeable-image","svg-changeable-image","inkwise-image"]),q=e=>!e||!e.dataset?[]:["changeable","editableType","elementType","layerType","previewType","fieldType"].map(a=>e.dataset[a]).filter(a=>typeof a=="string"&&a.trim()!=="").map(a=>a.trim().toLowerCase()),ee=e=>!e||typeof e.querySelector!="function"?null:e.querySelector('[data-changeable="image"], [data-editable-image], .canvas-layer__image, img, image'),W=e=>{if(!e)return!1;const t=typeof e.tagName=="string"?e.tagName.toLowerCase():"";if(t==="image"||t==="img"||q(e).some(s=>s==="image"||s==="photo"||s==="graphic")||typeof e.hasAttribute=="function"&&(e.hasAttribute("data-editable-image")||e.hasAttribute("data-changeable-image")))return!0;if(e.classList){for(const s of Z)if(e.classList.contains(s))return!0}return!!(t==="foreignobject"&&ee(e))},de=e=>{if(!e||W(e))return!1;const t=typeof e.tagName=="string"?e.tagName.toLowerCase():"";if(t==="style"||t==="script"||t==="defs"||t==="title"||t==="metadata")return!1;if(t==="text"||t==="tspan"||q(e).some(r=>r.includes("text")||r==="names"||r==="heading"))return!0;const s=(e.textContent||"").trim();return!(!s||/\{[^}]*\}|;/.test(s)&&s.length>80)},Ae=e=>{if(!e)return"";const t=e.querySelectorAll("tspan");return t&&t.length>0?xe(Array.from(t).map(a=>a.textContent||"").join(`
`)):xe(e.textContent||"")},We=(e,t)=>{if(!e)return;const a=xe(t),s=e.querySelectorAll("tspan");if(s&&s.length>0){const n=String(a??"").split(/\r?\n/);s.forEach((r,u)=>{r.textContent=n[u]??""})}else e.textContent=a??"";e.dataset&&(e.dataset.currentText=a??"")},Ce=e=>{if(!e)return null;if(W(e))return e;if(typeof e.closest=="function"){const a=e.closest("[data-preview-node]");if(a&&a!==e&&W(a))return a}const t=ee(e);return t||null},ht=(e,t)=>{if(!e||!t)return!1;const a=typeof e.tagName=="string"?e.tagName.toLowerCase():"";if(a==="image")return e.setAttributeNS("http://www.w3.org/1999/xlink","href",t),e.setAttribute("href",t),e.dataset.src=t,!0;if(a==="img")return e.setAttribute("src",t),e.dataset.src=t,!0;if(a==="foreignobject"){const s=ee(e);return s&&s!==e?ht(s,t):!1}return e.style&&(e.style.backgroundImage=`url('${t}')`),e.dataset&&(e.dataset.src=t,e.dataset.replacedImage="true"),!0},Qe=e=>{if(!e||typeof e.insertBefore!="function"||e.querySelector('[data-inkwise-bg="true"]'))return;const a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x","0"),a.setAttribute("y","0"),a.setAttribute("width","100%"),a.setAttribute("height","100%"),a.setAttribute("fill","#ffffff"),a.setAttribute("data-inkwise-bg","true"),e.insertBefore(a,e.firstChild)},te=typeof window<"u"&&window.inkwiseStudioBootstrap?window.inkwiseStudioBootstrap:{};console.log("[InkWise Studio] Bootstrap payload:",te);const Te=(te==null?void 0:te.routes)??{};console.log("[InkWise Studio] Routes:",Te);const Oe=((Es=document.querySelector('meta[name="csrf-token"]'))==null?void 0:Es.getAttribute("content"))||((Cs=document.head.querySelector('meta[name="csrf-token"]'))==null?void 0:Cs.getAttribute("content"))||null,fa=document.querySelector(".topbar-status-label"),Nt=document.querySelector(".topbar-status-dot"),ot=e=>{if(e==null||e==="")return null;const t=Number(e);return Number.isFinite(t)?t:null},Mt=e=>{if(!e||typeof e!="string")return null;try{const t=e.startsWith("<?xml")?e:`<?xml version="1.0" encoding="UTF-8"?>${e}`;return`data:image/svg+xml;base64,${window.btoa(unescape(encodeURIComponent(t)))}`}catch(t){return console.warn("[InkWise Studio] Failed to encode SVG preview.",t),null}},Bt=e=>{var r,u;if(!o)return null;const t=window.getComputedStyle(o),s=((t==null?void 0:t.backgroundImage)||"").match(/url\((['"]?)(.*?)\1\)/i);if(s&&s[2])return s[2];const n=e?`${e}Image`:null;return n&&((r=o.dataset)!=null&&r[n])?o.dataset[n]:((u=o.dataset)==null?void 0:u.frontImage)||null},jt=e=>{!e||!Y||(e.texts&&Array.isArray(e.texts)&&e.texts.forEach(t=>{const{key:a,value:s,fontFamily:n,fontSize:r,color:u}=t,f=Y.querySelector(`[data-preview-node="${a}"]`);if(f){if(s!==void 0){We(f,s);const p=document.querySelector(`input[data-preview-target="${a}"]`);p&&(p.value=s)}if(n){f.setAttribute("font-family",n),f.style.fontFamily=n;try{f.dataset.fontFamily=n}catch{}}if(r){f.setAttribute("font-size",r),f.style.fontSize=r;try{f.dataset.fontSize=r}catch{}}if(u){f.setAttribute("fill",u),f.style.fill=u;try{f.dataset.color=u}catch{}}}}),e.images&&Array.isArray(e.images)&&e.images.forEach(t=>{const{key:a,href:s,x:n,y:r,width:u,height:f}=t,p=Y.querySelector(`[data-preview-node="${a}"]`);p&&(s&&(p.setAttribute("href",s),p.setAttribute("xlink:href",s)),n!==void 0&&p.setAttribute("x",n),r!==void 0&&p.setAttribute("y",r),u!==void 0&&p.setAttribute("width",u),f!==void 0&&p.setAttribute("height",f))}))},pa=()=>v?Array.from(v.querySelectorAll("input[data-preview-target]")).map(e=>{var p,x;const t=e.closest(".text-field-item"),a=((x=(p=t==null?void 0:t.querySelector(".text-field-label"))==null?void 0:p.textContent)==null?void 0:x.trim())||e.dataset.previewTarget||"",s=e.dataset.previewTarget||"",n=Y==null?void 0:Y.querySelector(`[data-preview-node="${s}"]`);let r=null,u=null,f=null;return n&&(r=n.getAttribute("font-family")||n.style.fontFamily||n.dataset.fontFamily,u=n.getAttribute("font-size")||n.style.fontSize||n.dataset.fontSize,f=n.getAttribute("fill")||n.style.fill||n.dataset.color),{key:s,label:a,value:e.value||"",defaultValue:e.dataset.defaultValue||"",fontFamily:r,fontSize:u,color:f}}):[],lt=e=>{if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="string"){const t=e.trim();if(!t)return Number.NaN;const a=t.match(/^[-+]?\d*\.?\d+(?:[eE][-+]?\d+)?/);return a?parseFloat(a[0]):Number.NaN}return Number.NaN},Rt=e=>{if(!e)return null;if(typeof e=="string"){const p=e.trim();if(!p)return null;try{const x=JSON.parse(p);return Rt(x)}catch{return null}}if(typeof e!="object")return null;const t=Array.isArray(e)?e.reduce((p,x)=>x&&typeof x=="object"?Object.assign(p,x):p,{}):Object.assign({},e),a=t.width??t.Width??t.canvasWidth??t.w??t.maxWidth??t.naturalWidth,s=t.height??t.Height??t.canvasHeight??t.h??t.maxHeight??t.naturalHeight,n=lt(a),r=lt(s);if(!Number.isFinite(n)||n<=0||!Number.isFinite(r)||r<=0)return null;const u=t.shape??t.Shape??t.canvasShape??null,f=t.unit??t.Unit??t.canvasUnit??null;return{width:n,height:r,shape:typeof u=="string"&&u.trim()!==""?u.trim():null,unit:typeof f=="string"&&f.trim()!==""?f.trim():"px"}},Ue=(e,t="px")=>{if(!Number.isFinite(e))return Number.NaN;switch((t||"px").toString().toLowerCase()){case"in":case"inch":case"inches":return e;case"mm":return e/25.4;case"cm":return e/2.54;case"pt":return e/72;default:return e/96}},ma=Rt(H==null?void 0:H.dataset);let V=Rt(((Is=te==null?void 0:te.template)==null?void 0:Is.canvas)??null)||ma||null;const Se=720,Pt=920,$t=new Map;let Re=null;const Ne=new Map,et=new Map;let zt=null,we=null,Y=null,ga=null,Dt=()=>{},_e="front",tt=null,at=null,E=null,Et=null,be=null,ye=null,Pe=!1,$e=null;const ha=8,Qt=4,xe=e=>{const a=(e||"").toString().trim();return/::before|\{[^}]*\}|;/.test(a)&&a.length>120?"":a},ea=e=>{if(!e||e==="front"||e!=="back")return!0;if(!o)return!1;if(at)return!0;const t=o.dataset||{};return t.hasBack==="true"?!0:!!(t.backImage||t.backSvg)},ta=async e=>{if(!e||typeof e!="string")return null;if(e.startsWith("data:"))return e;try{const t=new Image;if(t.crossOrigin="anonymous",await new Promise(s=>{t.onload=()=>s(!0),t.onerror=()=>s(!1);const n=e.includes("?")?"&":"?";t.src=e+n+"_t="+Date.now()})&&t.naturalWidth>0&&t.naturalHeight>0){const s=document.createElement("canvas");s.width=t.naturalWidth,s.height=t.naturalHeight,s.getContext("2d").drawImage(t,0,0);try{const r=s.toDataURL("image/png");if(r&&r!=="data:,")return r}catch{console.warn("[InkWise Studio] Canvas tainted, trying fetch approach:",e)}}}catch(t){console.warn("[InkWise Studio] Canvas approach failed:",e,t)}try{const t=await fetch(e,{credentials:"include",mode:"cors"});if(!t.ok)return console.warn("[InkWise Studio] Failed to fetch image for base64 conversion:",e,t.status),null;const a=await t.blob();return new Promise(s=>{const n=new FileReader;n.onloadend=()=>s(n.result),n.onerror=()=>s(null),n.readAsDataURL(a)})}catch(t){console.warn("[InkWise Studio] Fetch approach also failed:",e,t)}try{const a=await(await fetch(e,{mode:"no-cors"})).blob();if(a.size>0)return new Promise(s=>{const n=new FileReader;n.onloadend=()=>s(n.result),n.onerror=()=>s(null),n.readAsDataURL(a)})}catch(t){console.warn("[InkWise Studio] No-cors fetch also failed:",e,t)}return null},Me=async e=>{[".svg-bounding-box",".resize-handle",".selection-indicator",".inkwise-selection",".inkwise-overlay",'[data-ui-element="true"]','[data-temp-element="true"]',"g.svg-bounding-box"].forEach(r=>{e.querySelectorAll(r).forEach(u=>u.remove())}),e.querySelectorAll("text").forEach(r=>{r.removeAttribute("contenteditable"),r.style.cursor="",r.style.userSelect=""}),e.querySelectorAll("image").forEach(r=>{r.style.cursor="",r.style.pointerEvents=""});const a=r=>{if(!r||r.startsWith("data:"))return r;try{const u=new URL(r,window.location.origin),f=[/\/InkWise-Web\/ink-wise\/public\/storage\//gi,/\/ink-wise\/public\/storage\//gi,/\/public\/storage\//gi];let p=u.pathname;for(const x of f)if(x.test(p)){p=p.replace(x,"/storage/");break}return u.pathname=p,(u.hostname==="localhost"||u.hostname==="127.0.0.1")&&(u.hostname=window.location.hostname,u.port=window.location.port,u.protocol=window.location.protocol),u.href}catch{return r}},s=e.querySelectorAll("image");console.log("[InkWise Studio] Found",s.length,"image elements to convert");const n=Array.from(s).map(async r=>{let u=r.getAttribute("href")||r.getAttribute("xlink:href")||r.getAttributeNS("http://www.w3.org/1999/xlink","href");if(console.log("[InkWise Studio] Processing image with href:",u),!u||u.startsWith("data:")){console.log("[InkWise Studio] Image already embedded or no href, skipping");return}const f=a(u);console.log("[InkWise Studio] Normalized URL:",f);const p=await ta(f);p?(console.log("[InkWise Studio] Successfully converted image to base64, length:",p.length),r.removeAttribute("href"),r.removeAttribute("xlink:href"),r.removeAttributeNS("http://www.w3.org/1999/xlink","href"),r.removeAttribute("data-src"),r.setAttribute("href",p),r.setAttribute("xlink:href",p),r.setAttributeNS("http://www.w3.org/1999/xlink","href",p),console.log("[InkWise Studio] Image href attributes updated to base64")):console.warn("[InkWise Studio] Failed to embed image, keeping original URL:",f)});await Promise.all(n),console.log("[InkWise Studio] All image conversions completed")},yt=async(e,t=null)=>{var b,C,g;if(!o)return null;const a=new Date,s=t||_e||"front";let n=Y;if(t&&t!==_e){const S=o.dataset[`${t}Svg`]||"";if(S&&fs(S))try{let I="";if(S.startsWith("data:image/svg+xml")){const $=S.indexOf(","),re=$>=0?S.slice(0,$):S,ae=$>=0?S.slice($+1):"";if(/;base64/i.test(re))try{const G=ae.replace(/\s+/g,"");I=typeof window<"u"&&typeof window.atob=="function"?window.atob(G):atob(G)}catch(G){try{I=decodeURIComponent(ae)}catch(j){console.warn("[InkWise Studio] Failed to decode inline SVG data URI.",G,j),I=""}}else try{I=decodeURIComponent(ae)}catch{I=ae}}else{const $=await fetch(S,{cache:"no-store"});$.ok&&(I=await $.text())}if(I){const ae=new DOMParser().parseFromString(I,"image/svg+xml").documentElement;ae&&ae.tagName==="svg"&&(n=ae)}}catch(I){console.warn("[InkWise Studio] Failed to load SVG for side:",t,I)}}let r=null;if(n)try{const S=n.cloneNode(!0),I=(b=o==null?void 0:o.dataset)==null?void 0:b.canvasWidth,$=(C=o==null?void 0:o.dataset)==null?void 0:C.canvasHeight;I&&$&&(S.setAttribute("width",I),S.setAttribute("height",$),S.style.width=I+"px",S.style.height=$+"px"),S.setAttribute("preserveAspectRatio","xMidYMid meet"),await Me(S);let re=S.querySelector("style#inkwise-export-styles");re||(re=document.createElementNS(z,"style"),re.id="inkwise-export-styles",S.insertBefore(re,S.firstChild)),re.textContent=`
            @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
            text { white-space: pre; }
          `,r=new XMLSerializer().serializeToString(S),r&&!/xmlns=/i.test(r)&&(r=r.replace("<svg",'<svg xmlns="http://www.w3.org/2000/svg"'))}catch(S){console.warn("[InkWise Studio] Unable to serialize current SVG.",S),r=null}const u=r?Mt(r):Bt(s),f=pa(),p=f.filter(S=>{const I=(S.value||"").trim(),$=(S.defaultValue||"").trim();return I===""||$!==""&&I===$}).map(S=>S.label||S.key).map(S=>(S||"").trim()).filter((S,I,$)=>S!==""&&$.indexOf(S)===I),x=[];if(n){const S=new Set;n.querySelectorAll('image,img,[data-changeable="image"]').forEach(I=>{const $=I.getAttribute("href")||I.getAttribute("xlink:href")||I.getAttributeNS("http://www.w3.org/1999/xlink","href")||I.getAttribute("data-src");if(!$)return;const re=I.getAttribute("data-preview-node")||I.id||`image-${x.length+1}`;S.has(re)||(S.add(re),x.push({key:re,href:$,x:I.getAttribute("x")||null,y:I.getAttribute("y")||null,width:I.getAttribute("width")||null,height:I.getAttribute("height")||null}))})}const L=o?{width:ot(o.dataset.canvasWidth),height:ot(o.dataset.canvasHeight),unit:o.dataset.canvasUnit||null,shape:o.dataset.canvasShape||null}:null,y=u?[u]:[];return{design:{updated_at:a.toISOString(),sides:{[s]:{svg:r,preview:u}},texts:f,images:x,canvas:L,placeholders:p},preview:{image:u,images:y},svg_markup:r,placeholders:p,product_id:((g=te==null?void 0:te.product)==null?void 0:g.id)??null}},aa=(e={},t={})=>{var p,x;const a=e&&e.summary?e.summary:{},s=Array.isArray(a.previewImages)?a.previewImages.filter(Boolean):Array.isArray(a.preview_images)?a.preview_images.filter(Boolean):[],n=Array.isArray((p=t==null?void 0:t.preview)==null?void 0:p.images)?t.preview.images.filter(Boolean):[],r=s.length?s:n,u=a.previewImage||a.preview_image||a.preview||((x=t==null?void 0:t.preview)==null?void 0:x.image)||r[0]||null;if(!u&&!r.length)return;const f={templateName:a.productName||a.templateName||document.title||"Saved template",previewImage:u||"",previewImages:r.length?r:u?[u]:[],metadata:{template:{name:a.productName||a.templateName||"Saved template"}}};try{window.sessionStorage.setItem("inkwise-finalstep",JSON.stringify(f))}catch{}try{const L={id:null,name:f.templateName,preview:f.previewImage};window.sessionStorage.setItem("inkwise-saved-template",JSON.stringify(L)),window.savedCustomerTemplate=L}catch{}},ze=async e=>{try{const t=await fetch("/design/load-autosave?side="+encodeURIComponent(e),{method:"GET",headers:{"X-CSRF-TOKEN":Oe,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to load autosave data");return await t.json()}catch(t){return console.warn("[InkWise Studio] Failed to load autosave data for side:",e,t),null}},st=e=>{E?E.schedule(e):typeof window<"u"&&window.inkwiseAutosaveController&&window.inkwiseAutosaveController.schedule(e)};try{E=lr({collectSnapshot:collectSnapshotWithPersist,routes:Te,csrfToken:Oe,statusLabel:fa,statusDot:Nt,debounce:0,onAfterSave:(s,n)=>{try{aa(s,n)}catch{}}}),typeof window<"u"&&(window.inkwiseAutosaveController=E),console.log("[InkWise Studio] Autosave initialized",E);const e=s=>{if(E)try{E.flush(s)}catch(n){console.debug("[InkWise Studio] Autosave flush skipped.",n)}},t=()=>{document.visibilityState==="hidden"&&e("visibility-hidden")},a=()=>{e("page-hide")};document.addEventListener("visibilitychange",t),window.addEventListener("pagehide",a),window.addEventListener("beforeunload",a),Et=window.setInterval(()=>{e("heartbeat")},6e4),window.addEventListener("unload",()=>{Et&&(window.clearInterval(Et),Et=null),document.removeEventListener("visibilitychange",t),window.removeEventListener("pagehide",a),window.removeEventListener("beforeunload",a)}),setInterval(()=>{E&&(console.log("[InkWise Studio] Periodic autosave trigger"),E.schedule("periodic"))},1e4)}catch(e){console.warn("[InkWise Studio] Autosave controller failed to initialize.",e),E=null}const ya=async()=>{var g,S,I,$,re,ae;console.log("[InkWise Studio] Building review save payload..."),console.log("[InkWise Studio] Bootstrap payload:",te),console.log("[InkWise Studio] Template in bootstrap:",te==null?void 0:te.template);const e=await yt(),t=(e==null?void 0:e.design)||{},a=t.sides||{},s=Object.keys(a)[0],n=s?a[s]:null,r=JSON.parse(JSON.stringify(t||{})),u=(n==null?void 0:n.svg)||(e==null?void 0:e.svg_markup)||null,f=(n==null?void 0:n.preview)||((g=e==null?void 0:e.preview)==null?void 0:g.image)||Bt(s||"front")||null,p=(Array.isArray((S=e==null?void 0:e.preview)==null?void 0:S.images)?e.preview.images:[]).filter(me=>typeof me=="string"&&me.trim()!=="");f&&!p.length&&p.push(f);const x=r.canvas||{},L=x.width??(o?ot(o.dataset.canvasWidth):null),y=x.height??(o?ot(o.dataset.canvasHeight):null),b=(()=>{var me,G;try{if(!o)return null;const j=window.getComputedStyle(o);return(j==null?void 0:j.backgroundColor)||((me=o.dataset)==null?void 0:me.backgroundColor)||((G=o.style)==null?void 0:G.backgroundColor)||null}catch{return null}})(),C={design_svg:u,design_json:r,preview_image:f,preview_images:p,canvas_width:L,canvas_height:y,background_color:b,template_id:((I=te==null?void 0:te.template)==null?void 0:I.id)??(te==null?void 0:te.template_id)??null,order_item_id:(($=te==null?void 0:te.orderSummary)==null?void 0:$.order_item_id)??((re=te==null?void 0:te.orderSummary)==null?void 0:re.orderItemId)??((ae=te==null?void 0:te.orderSummary)==null?void 0:ae.item_id)??null};return console.log("[InkWise Studio] Built payload:",C),console.log("[InkWise Studio] Template ID:",C.template_id),C},sa=async(e,t)=>{var C,g;const a=(e==null?void 0:e.design)||{},n=(a.sides||{})[t]||null,r=JSON.parse(JSON.stringify(a||{})),u=(n==null?void 0:n.svg)||(e==null?void 0:e.svg_markup)||null,f=(n==null?void 0:n.preview)||((C=e==null?void 0:e.preview)==null?void 0:C.image)||Bt(t)||null,p=(Array.isArray((g=e==null?void 0:e.preview)==null?void 0:g.images)?e.preview.images:[]).filter(S=>typeof S=="string"&&S.trim()!=="");f&&!p.length&&p.push(f);const x=r.canvas||{},L=x.width??(o?ot(o.dataset.canvasWidth):null),y=x.height??(o?ot(o.dataset.canvasHeight):null),b=(()=>{var S,I;try{if(!o)return null;const $=window.getComputedStyle(o);return($==null?void 0:$.backgroundColor)||((S=o.dataset)==null?void 0:S.backgroundColor)||((I=o.style)==null?void 0:I.backgroundColor)||null}catch{return null}})();return{design_svg:u,design_json:r,preview_image:f,preview_images:p,canvas_width:L,canvas_height:y,background_color:b}},He=document.querySelector('[data-action="proceed-review"]');if(He){const e=He.dataset.destination||Te.review||He.getAttribute("href")||window.location.href,t=Te.saveReview||Te.reviewSave||Te.review_design||Te.reviewDesign||null;He.addEventListener("click",async a=>{if(a.preventDefault(),He.dataset.navigating==="1")return;He.dataset.navigating="1",He.disabled=!0;const s=()=>{window.location.href=e},n=()=>{He.disabled=!1,He.dataset.navigating="0"};try{console.log("[InkWise Studio] Proceeding to review..."),E&&await E.flush("navigate");const r=await ya();if(console.log("[InkWise Studio] Payload built:",r),!r.template_id)throw console.error("[InkWise Studio] Missing template_id in payload:",r),new Error("Missing template identifier.");if(!t)throw new Error("Save endpoint unavailable.");const u={"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"};Oe&&(u["X-CSRF-TOKEN"]=Oe);const f=await fetch(t,{method:"POST",headers:u,credentials:"same-origin",body:JSON.stringify(r)});if(!f.ok){const p=await f.text().catch(()=>"");throw new Error(`Save failed (${f.status}): ${p}`)}try{const p=await yt("proceed-review","back");if(p){const x=await sa(p,"back");await fetch("/design/save-to-review",{method:"POST",headers:u,credentials:"same-origin",body:JSON.stringify(x)})}}catch(p){console.warn("[InkWise Studio] Failed to save to REVIEW2",p)}s()}catch(r){console.error("[InkWise Studio] Unable to save before navigating.",r),E&&E.notifyError(),alert("We could not save your latest design. Please try again before continuing."),n()}})}const Ye=document.getElementById("save-template-btn");Ye&&Ye.addEventListener("click",async e=>{if(e.preventDefault(),Ye.disabled)return;const t=prompt("Enter a name for your template:");if(!(!t||t.trim()==="")){Ye.disabled=!0,Ye.textContent="Saving…";try{E&&await E.flush("save-template");const a=await yt("save-template"),s=Object.assign({},a&&a.design?a.design:{}),n=o&&o.dataset.hasBack==="true",r=r||"front",u=r==="front"?"back":"front";if(n&&!s.sides[u]){const g=await yt("save-template",u);g&&g.design&&g.design.sides&&g.design.sides[u]&&(s.sides=s.sides||{},s.sides[u]=g.design.sides[u])}const f=a&&Array.isArray(a.placeholders)?a.placeholders:[];s.placeholders=f,a&&a.product_id&&(s.product_id=a.product_id);const p=a&&a.preview&&a.preview.image||null,x=a&&a.preview&&Array.isArray(a.preview.images)?a.preview.images.filter(Boolean):[],L={template_name:t.trim(),design:s,preview_image:p,preview_images:x,placeholders:f,svg_markup:a.svg_markup},y={"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"};Oe&&(y["X-CSRF-TOKEN"]=Oe);const b=await fetch(Te.saveTemplate,{method:"POST",headers:y,credentials:"same-origin",body:JSON.stringify(L)});if(!b.ok)throw new Error(`Server responded with ${b.status}`);const C=await b.json();alert(`Template "${C.template_name}" saved successfully!`)}catch(a){console.error("[InkWise Studio] Failed to save template.",a),alert("Failed to save template. Please try again.")}finally{Ye.disabled=!1,Ye.textContent="Save Template"}}});const bt=e=>{const t=Ce(e);if(!t)return;const a=document.createElement("input");a.type="file",a.accept="image/*",a.onchange=s=>{const n=s.target.files&&s.target.files[0];if(!n)return;const r=new FileReader;r.onload=u=>{var x;const f=(x=u.target)==null?void 0:x.result;if(!f)return;ht(t,f)&&(ie(),st("image-replace"))},r.readAsDataURL(n)},a.click()},ct=()=>o?((!Re||!Re.isConnected)&&(Re=document.createElement("div"),Re.className="canvas-overlay-layer",o.appendChild(Re)),Re):null,qt=()=>{Ne.forEach(({overlay:e})=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),Ne.clear(),et.clear(),Re&&(Re.innerHTML=""),be=null,ye=null,na(),document.body.classList.remove("text-toolbar-visible"),oa()},dt=(e,t)=>{if(e==null)return t;const a=e.toString().split(/[\s,]+/).filter(Boolean);if(a.length===0)return t;const s=parseFloat(a[0]);return Number.isFinite(s)?s:t},Ve=e=>{if(!o)return;const t=Ne.get(e);if(!t||!t.overlay)return;const a=t.overlay,s=o.getBoundingClientRect(),n=e.getBoundingClientRect();if(s.width===0||s.height===0)return;const r=t.type==="text"?18:12,u=Math.max(r,n.width),f=Math.max(r,n.height);a.style.left=`${n.left-s.left}px`,a.style.top=`${n.top-s.top}px`,a.style.width=`${u}px`,a.style.height=`${f}px`},ba=()=>{Ne.forEach((e,t)=>{Ve(t)})},ie=()=>{Ne.size!==0&&(zt&&cancelAnimationFrame(zt),zt=window.requestAnimationFrame(()=>{zt=null,ba()}))},Ct=(e=3)=>{e<=0||requestAnimationFrame(()=>{ie(),Ct(e-1)})};window.addEventListener("resize",ie),document.addEventListener("scroll",ie,!0),window.addEventListener("load",ie);const ia=(e,t)=>{const a=Y||l;if(!a||typeof a.createSVGPoint!="function")return null;const s=a.createSVGPoint();s.x=e,s.y=t;const n=a.getScreenCTM();return n?s.matrixTransform(n.inverse()):null},Pa=(e,t,a)=>{const s=ia(a.clientX,a.clientY);if(!s)return null;const{node:n}=e,r=n.getBBox?n.getBBox():{x:0,y:0,width:0,height:0},u={data:e,overlay:e.overlay,node:n,type:e.type,handle:t,mode:t?"resize":"move",pointerId:a.pointerId,startPoint:s,startClient:{x:a.clientX,y:a.clientY},initialBBox:r,moved:!1};if(e.type==="text"){u.fontSize=parseFloat(n.getAttribute("font-size"))||parseFloat(window.getComputedStyle(n).fontSize)||16,u.x=dt(n.getAttribute("x"),r.x);const f=r.y+r.height;u.y=dt(n.getAttribute("y"),f)}else u.x=dt(n.getAttribute("x"),r.x),u.y=dt(n.getAttribute("y"),r.y),u.width=dt(n.getAttribute("width"),Math.max(1,r.width)),u.height=dt(n.getAttribute("height"),Math.max(1,r.height));return u},va=(e,t,a)=>{if(e.type==="text"){const s=e.x+t,n=e.y+a;Number.isFinite(s)&&e.node.setAttribute("x",s),Number.isFinite(n)&&e.node.setAttribute("y",n)}else e.node.setAttribute("x",e.x+t),e.node.setAttribute("y",e.y+a)},it=(e,t,a,s=!1)=>{if(e.type==="image"){let n=e.x,r=e.y,u=e.width,f=e.height;const p=["nw","ne","sw","se"].some(b=>e.handle===b),x=s||p,L=e.width/e.height;if(x&&p){const b=Math.abs(t),C=Math.abs(a);b>C?(e.handle.includes("e")?u=e.width+t:e.handle.includes("w")&&(u=e.width-t,n=e.x+t),f=u/L,e.handle.includes("n")&&(r=e.y+(e.height-f))):(e.handle.includes("s")?f=e.height+a:e.handle.includes("n")&&(f=e.height-a,r=e.y+a),u=f*L,e.handle.includes("w")&&(n=e.x+(e.width-u)))}else e.handle.includes("e")&&(u=e.width+t),e.handle.includes("w")&&(u=e.width-t,n=e.x+t),e.handle.includes("s")&&(f=e.height+a),e.handle.includes("n")&&(f=e.height-a,r=e.y+a);const y=4;u<y&&(n+=u-y,u=y),f<y&&(r+=f-y,f=y),e.node.setAttribute("x",n),e.node.setAttribute("y",r),e.node.setAttribute("width",u),e.node.setAttribute("height",f)}else if(e.type==="text"){const n=Math.max(1,e.initialBBox.width),r=Math.max(1,e.initialBBox.height);let u=0,f=0;e.handle.includes("e")?u=t:e.handle.includes("w")&&(u=-t),e.handle.includes("s")?f=a:e.handle.includes("n")&&(f=-a);const p=Math.max(4,n+u),x=Math.max(4,r+f),L=p/n,y=x/r,b=Math.max(L,y),C=Math.max(6,e.fontSize*b);e.node.setAttribute("font-size",C)}},wa=e=>{if(!we||e.pointerId!==we.pointerId)return;const t=ia(e.clientX,e.clientY);if(!t)return;const a=t.x-we.startPoint.x,s=t.y-we.startPoint.y;!we.moved&&(Math.abs(a)>.5||Math.abs(s)>.5)&&(we.moved=!0),we.mode==="move"?va(we,a,s):it(we,a,s),ie()},It=e=>{if(!we||e.pointerId!==we.pointerId)return;try{we.overlay.releasePointerCapture(we.pointerId)}catch{}we.overlay.classList.remove("editor-overlay--active"),document.removeEventListener("pointermove",wa),document.removeEventListener("pointerup",It),document.removeEventListener("pointercancel",It);const t=we;we=null,ie(),t.moved?st("element-transform"):t.type==="text"?Dt(t.data.previewKey):t.type==="image"&&bt(t.node)},ut=e=>{if(!e.isPrimary||e.button!==0)return;const t=e.target.closest(".editor-overlay");if(!t||t.dataset.cropSessionActive==="true")return;const a=et.get(t);if(!a)return;a.type==="text"?xt(a.previewKey||null):a.type==="image"&&St(a.previewKey||null);const s=Pa(a,e.target.dataset.handle||null,e);if(s){e.preventDefault(),we=s,t.classList.add("editor-overlay--active");try{t.setPointerCapture(e.pointerId)}catch{}document.addEventListener("pointermove",wa),document.addEventListener("pointerup",It),document.addEventListener("pointercancel",It)}},Xe=e=>{const t=ct();if(!t)return null;let a=Ne.get(e);if(a)return a;const s=W(e)?"image":"text",n=e.getAttribute("data-preview-node")||"",r=document.createElement("div");return r.className=`editor-overlay editor-overlay--${s}`,r.dataset.previewNode=n,r.tabIndex=0,r.style.touchAction="none",["nw","n","ne","e","se","s","sw","w"].forEach(f=>{const p=document.createElement("div");p.className=`editor-overlay__handle editor-overlay__handle--${f}`,p.dataset.handle=f,r.appendChild(p)}),r.addEventListener("pointerdown",ut),r.addEventListener("dblclick",()=>{s==="text"?Dt(n):s==="image"&&bt(e)}),r.addEventListener("keydown",f=>{f.key==="Enter"&&(f.preventDefault(),s==="text"?Dt(n):s==="image"&&bt(e))}),t.appendChild(r),a={overlay:r,node:e,type:s,previewKey:n},Ne.set(e,a),et.set(r,a),e.dataset.locked==="true"&&(r.classList.add("editor-overlay--locked"),r.style.pointerEvents="none"),na(),ie(),a},Wt=(e,t,a={})=>{if(!o)return;const s=o.closest(".preview-canvas-wrapper"),n=Number(e),r=Number(t),u=a.persist===void 0?!0:!!a.persist,f=typeof a.unit=="string"&&a.unit?a.unit:(V==null?void 0:V.unit)??"px",p=typeof a.shape=="string"&&a.shape?a.shape:(V==null?void 0:V.shape)??null;if(!s||!Number.isFinite(n)||!Number.isFinite(r)||n<=0||r<=0)return;const x=Se/n,L=Pt/r,y=Math.min(1,x,L),b=Math.max(1,Math.round(n*y)),C=Math.max(1,Math.round(r*y));s.style.setProperty("--canvas-width",`${b}px`),s.style.setProperty("--canvas-height",`${C}px`),s.dataset.sourceWidth=n.toString(),s.dataset.sourceHeight=r.toString(),s.dataset.displayScale=y.toString(),s.dataset.canvasWidth=n.toString(),s.dataset.canvasHeight=r.toString(),s.dataset.canvasUnit=f,p&&(s.dataset.canvasShape=p),o.dataset.canvasWidth=n.toString(),o.dataset.canvasHeight=r.toString(),o.dataset.canvasUnit=f,p&&(o.dataset.canvasShape=p),l&&(l.setAttribute("viewBox",`0 0 ${n} ${r}`),l.setAttribute("preserveAspectRatio","xMidYMid meet")),Y&&!Y.getAttribute("viewBox")&&(Y.setAttribute("viewBox",`0 0 ${n} ${r}`),Y.setAttribute("preserveAspectRatio","xMidYMid meet")),T&&T.style.setProperty("--stage-width",`${b+112}px`),u&&(V={width:n,height:r,unit:f,shape:p}),ie()},Ot=(e,t,a,s=0)=>{D&&(Number.isFinite(e)?D.textContent=`${e.toFixed(s)}${a}`:D.textContent="—"),U&&(Number.isFinite(t)?U.textContent=`${t.toFixed(s)}${a}`:U.textContent="—")};V&&(Wt(V.width,V.height,{unit:V.unit,shape:V.shape}),Ot(Ue(V.width,V.unit),Ue(V.height,V.unit),"in",2));const w=e=>{if(typeof e!="string"||!e.trim())return Number.NaN;const t=e.trim(),a=t.match(/^([-+]?[0-9]*\.?[0-9]+)/);if(!a)return Number.NaN;const s=parseFloat(a[1]);if(!Number.isFinite(s))return Number.NaN;const n=t.match(/([a-z%]+)$/i);switch(n?n[1].toLowerCase():""){case"":case"px":return s;case"mm":return s*(96/25.4);case"cm":return s*(96/2.54);case"in":return s*96;case"pt":return s*(96/72);default:return s}},F=()=>!!(V&&Number.isFinite(V.width)&&V.width>0&&Number.isFinite(V.height)&&V.height>0),Q=e=>{if(!e||F())return;if($t.has(e)){const a=$t.get(e);if(a){const s=a.unit||"px";Wt(a.width,a.height,{unit:s,shape:V==null?void 0:V.shape}),Ot(Ue(a.width,s),Ue(a.height,s),"in",2)}return}const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{const a={width:t.naturalWidth,height:t.naturalHeight,unit:"px"};$t.set(e,a),Wt(a.width,a.height,{unit:a.unit,shape:V==null?void 0:V.shape}),Ot(Ue(a.width,a.unit),Ue(a.height,a.unit),"in",2),ie()},t.onerror=()=>{$t.set(e,null)},t.src=e},he={text:document.getElementById("text-modal"),uploads:document.getElementById("uploads-modal"),graphics:document.getElementById("graphics-modal"),template:document.getElementById("template-modal"),color:document.getElementById("color-modal"),qr:document.getElementById("qr-modal"),background:document.getElementById("background-modal"),product:document.getElementById("product-modal"),tables:document.getElementById("tables-modal")},Ie=document.querySelectorAll("[data-modal-close]"),Le=e=>{if(!e)return[];const t=new Map;let a=0;const s=(y,b,C="node")=>{let g=(y||"").toString().trim();g||(g=`${C}-${a+=1}`);let S=g,I=2;for(;t.has(S)&&t.get(S)!==b;)S=`${g}-${I}`,I+=1;return S},n=(y,b,C=null,g=null,S="node")=>{if(!y)return;const I=s(b,y,S);return y.setAttribute("data-preview-node",I),C&&!y.dataset.previewLabel&&(y.dataset.previewLabel=C),g&&!y.dataset.defaultText&&(y.dataset.defaultText=g),t.set(I,y),I};e.querySelectorAll("[data-preview-node]").forEach(y=>{var C,g;const b=y.getAttribute("data-preview-node");b&&n(y,b,((C=y.dataset)==null?void 0:C.previewLabel)||null,((g=y.dataset)==null?void 0:g.defaultText)||null,"node")});const u=[];e.querySelectorAll(".canvas-layer[data-layer-id]").forEach(y=>{const b=y.getAttribute("data-layer-id");if(!b)return;const C=(y.getAttribute("aria-label")||b).replace(/\s+layer$/i,"")||b,g=y.querySelector(".canvas-layer__text");if(g){if(g.hasAttribute("data-preview-node")||g.setAttribute("data-preview-node",b),g.dataset.previewLabel||(g.dataset.previewLabel=C),!g.dataset.defaultText){const I=(g.textContent||"").trim();I&&(g.dataset.defaultText=I)}u.push(g)}const S=y.querySelector("img, image");if(S){const I=`${b}-image`;S.hasAttribute("data-preview-node")||S.setAttribute("data-preview-node",I),S.dataset.previewLabel||(S.dataset.previewLabel=C),u.push(S)}if(!g&&!S){if(y.hasAttribute("data-preview-node")||y.setAttribute("data-preview-node",b),y.dataset.previewLabel||(y.dataset.previewLabel=C),!y.dataset.defaultText){const I=(y.textContent||"").trim();I&&(y.dataset.defaultText=I)}u.push(y)}}),e.querySelectorAll("image, img").forEach((y,b)=>{var g;const C=y.getAttribute("data-preview-node")||`auto-image-${b+1}`;n(y,C,((g=y.dataset)==null?void 0:g.previewLabel)||null,null,"image")}),e.querySelectorAll("text, tspan").forEach((y,b)=>{var S,I;const C=(((S=y.dataset)==null?void 0:S.defaultText)||y.textContent||"").trim()||null,g=y.getAttribute("data-preview-node")||`auto-text-${b+1}`;n(y,g,((I=y.dataset)==null?void 0:I.previewLabel)||null,C,"text")}),u.length>0&&u.forEach((y,b)=>{var g,S;const C=y.getAttribute("data-preview-node")||`fallback-${b+1}`;n(y,C,((g=y.dataset)==null?void 0:g.previewLabel)||null,((S=y.dataset)==null?void 0:S.defaultText)||null,"node")});const L=[];return e.querySelectorAll("text[data-preview-node], tspan[data-preview-node]").forEach(y=>{const b=y.getAttribute("data-preview-node");if(b&&t.has(b)){const C=t.get(b);C&&!L.includes(C)&&L.push(C)}}),L.length>0?L:Array.from(t.values())},Be=e=>{if(!e)return;e.classList.remove("is-open"),e.setAttribute("aria-hidden","true");const t=e.dataset.section;if(t){const a=document.querySelector(`.sidenav-btn[data-nav="${t}"]`);a==null||a.classList.remove("active"),t==="background"&&Pe&&(Pe=!1,ra(),oa())}},Ke=()=>{Object.values(he).forEach(e=>Be(e))},rt=e=>{const t=he[e];if(!t)return;t.classList.add("is-open"),t.setAttribute("aria-hidden","false");const a=t.querySelector('input:not([type="hidden"])');if(a==null||a.focus({preventScroll:!0}),e==="background"&&ri(),e==="graphics"){const s=document.querySelector('.graphics-category-button[data-category="image"]');s?ns(s):(qa(),Da())}};se.length&&se.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.nav||"text",a=he[t],s=a==null?void 0:a.classList.contains("is-open");Ke(),se.forEach(n=>n.classList.remove("active")),s||(rt(t),e.classList.add("active"))})}),Ie.forEach(e=>{e.addEventListener("click",()=>{const t=e.closest(".modal");Be(t)})}),window.addEventListener("click",e=>{e.target.classList.contains("modal")&&e.target.classList.contains("is-open")&&Be(e.target)}),document.addEventListener("keydown",e=>{if(e.key==="Escape"){const t=document.querySelector(".modal.is-open");t&&Be(t)}});async function $a(e){if(!e||!e.fullUrl){console.error("[InkWise Studio] Invalid graphic item:",e);return}const t=document.getElementById("background-modal");if(t&&t.classList.contains("is-open")&&Pe){try{const n=await fetch(e.fullUrl);if(!n.ok)throw new Error(`Failed to fetch background image: ${n.status}`);const r=await n.blob(),u=await bi(r);yi(u),console.log("[InkWise Studio] Applied graphic as background image")}catch(n){console.error("[InkWise Studio] Failed to apply background graphic:",n),alert("Failed to apply background image. Please try again.")}return}const s=getSvgRoot(_e);if(!s){console.error("[InkWise Studio] No SVG root found for side:",_e);return}try{const r=`graphic-${`graphic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}`;if(e.fullUrl.includes(".svg")||e.id.startsWith("iconify-")){const f=await fetch(e.fullUrl);if(!f.ok)throw new Error(`Failed to fetch SVG: ${f.status}`);const p=await f.text(),x=document.createElementNS("http://www.w3.org/2000/svg","g");x.setAttribute("data-preview-node",r),x.setAttribute("data-preview-label",e.alt||"Graphic"),x.setAttribute("class","inserted-graphic"),x.setAttribute("data-editable-image","true"),x.setAttribute("transform","translate(100, 100) scale(0.5)");const b=new DOMParser().parseFromString(p,"image/svg+xml").documentElement;for(;b.firstChild;)x.appendChild(b.firstChild);s.appendChild(x);const C=Xe(x);C&&(x.style.cursor="pointer",x.addEventListener("click",g=>{g.stopPropagation(),ft();const S=Ua(C.overlay,x);S&&($e=S)})),console.log("[InkWise Studio] Inserted SVG graphic:",r)}else{const f=document.createElementNS("http://www.w3.org/2000/svg","image");f.setAttribute("data-preview-node",r),f.setAttribute("data-preview-label",e.alt||"Graphic"),f.setAttribute("class","inserted-graphic"),f.setAttribute("data-editable-image","true"),f.setAttribute("x","100"),f.setAttribute("y","100"),f.setAttribute("width","200"),f.setAttribute("height","200"),f.setAttribute("preserveAspectRatio","xMidYMid meet"),f.setAttributeNS("http://www.w3.org/1999/xlink","href",e.fullUrl),s.appendChild(f);const p=Xe(f);p&&(f.style.cursor="pointer",f.addEventListener("click",x=>{x.stopPropagation(),ft();const L=Ua(p.overlay,f);L&&($e=L)})),console.log("[InkWise Studio] Inserted raster graphic:",r)}updatePreview(_e),console.log("[InkWise Studio] Graphic inserted successfully")}catch(n){console.error("[InkWise Studio] Failed to insert graphic:",n),alert("Failed to insert graphic. Please try again.")}}const Ut=document.querySelector(".graphics-categories-labels"),M=document.getElementById("graphics-browser-samples"),xa=document.querySelectorAll(".graphics-category-button"),vt=document.getElementById("graphics-search-form"),wt=document.getElementById("graphics-search-input"),is="53250708-d3f88461e75cb0c2c5366a181",Xs={shapes:{provider:"iconify",baseUrl:"https://api.iconify.design",perPage:36,query:"circle",prefix:"",label:"Shapes",searchPlaceholder:"Search shapes"},image:{provider:"unsplash",apiKey:"iFpUZ_6aTnLGz0Voz0MYlprq9i_RBl83ux9DzV6EMOs",perPage:12,query:"wedding invitation design",label:"Images",searchPlaceholder:"Search images"},icons:{provider:"flaticon",apiKey:"FPSX2c99579cb6ea5314189561ca375a1648",perPage:48,query:"wedding icon",label:"Icons",searchPlaceholder:"Search icons"},illustrations:{provider:"pixabay",apiKey:is,perPage:18,query:"wedding illustration",imageType:"illustration",label:"Illustrations",searchPlaceholder:"Search illustrations"},patterns:{provider:"pixabay",apiKey:is,perPage:18,query:"seamless pattern",imageType:"vector",label:"Patterns",searchPlaceholder:"Search patterns"}},rs=new Map;let za=0;function Sa(e,t){const a=(t||"").trim();return a||e.query||e.defaultQuery||""}function Da(){M&&(M.innerHTML="",M.dataset.category="",M.dataset.page="0",M.dataset.loading="0",M.dataset.hasMore="0",M.dataset.searchTerm="",M.dataset.requestToken="")}function qa(){if(!Ut||!M)return;Ut.querySelectorAll(".category-row").forEach(t=>{t.style.display="flex",t.dataset.expanded="0"}),xa.forEach(t=>{t.setAttribute("aria-expanded","false"),t.classList.remove("is-open")}),M.scrollTop=0,M.innerHTML="",M.dataset.category="",M.dataset.page="0",M.dataset.loading="0",M.dataset.hasMore="0",M.dataset.searchTerm="",M.dataset.requestToken="",vt&&(vt.classList.add("is-hidden"),vt.dataset.category=""),wt&&(wt.value="",wt.blur())}function Wa(e){return Xs[e]||null}async function ns(e){var y,b,C;const t=e.dataset.category;if(!t||!M||!Ut)return;if(e.getAttribute("aria-expanded")==="true"){qa(),Da();return}const s=Wa(t);if(!s){console.warn(`[InkWise Studio] No graphics configuration found for category "${t}".`);return}qa();const n=rs.get(t)||"",r=s.label||"",u=(C=(b=(y=e.closest(".category-row"))==null?void 0:y.querySelector(".category-label"))==null?void 0:b.textContent)==null?void 0:C.trim(),f=r||u||t,p=s.searchPlaceholder||`Search ${f.toLowerCase()}`;vt&&(vt.classList.remove("is-hidden"),vt.dataset.category=t),wt&&(wt.placeholder=p,wt.value=n),e.setAttribute("aria-expanded","true"),e.classList.add("is-open"),Ut.querySelectorAll(".category-row").forEach(g=>{g.dataset.categoryRow===t?(g.style.display="flex",g.dataset.expanded="1"):g.style.display="none"}),M.innerHTML="",M.dataset.category=t,M.dataset.page="0",M.dataset.loading="0",M.dataset.hasMore="1",M.dataset.searchTerm=n,M.scrollTop=0;const L=String(++za);M.dataset.requestToken=L,os(),await Oa(t,1,n,L)}function os(){if(!M)return;const e=M.querySelector(".graphics-loading");if(e){e.style.display="flex";return}const t=document.createElement("div");t.className="graphics-loading",t.textContent="Loading assets…",M.appendChild(t)}function ls(){if(!M)return;const e=M.querySelector(".graphics-loading");e&&e.remove()}function cs(e){if(!M)return;M.innerHTML="";const t=document.createElement("div");t.className="graphics-error",t.textContent=e||"Unable to load assets at the moment.",M.appendChild(t)}function Ks(e){if(!M||!Array.isArray(e))return;const t=document.createDocumentFragment();e.forEach(a=>{if(!a||!a.thumbUrl)return;const s=document.createElement("div");s.className="graphics-sample",s.title=a.alt||"Graphic sample";const n=document.createElement("img");if(n.src=a.thumbUrl,n.alt=a.alt||"Graphic sample",n.loading="lazy",s.appendChild(n),a.label){const r=document.createElement("span");r.className="sample-label",r.textContent=a.label,s.appendChild(r)}s.addEventListener("click",async()=>{console.log("Selected asset",a);try{await $a(a)}catch(r){console.error("[InkWise Studio] Failed to insert graphic:",r)}}),t.appendChild(s)}),ls(),M.appendChild(t)}async function Oa(e,t,a,s){if(!M)return;const n=Wa(e);if(!n)return;const r=M.dataset.requestToken||"",u=s||r||String(++za);if(!(M.dataset.loading==="1"&&u===r)){M.dataset.loading="1",os();try{const f=typeof a=="string"?a:M.dataset.searchTerm||"",p=await Js(n,t,f);if(M.dataset.requestToken!==u)return;if(M.dataset.loading="0",ls(),!p.length&&t===1){cs("No assets found for this category right now. Try again in a moment."),M.dataset.hasMore="0";return}Ks(p),M.dataset.page=String(t);const x=n.perPage||12;M.dataset.hasMore=p.length>=x?"1":"0"}catch(f){if(console.error("[InkWise Studio] Failed to load graphics assets:",f),M.dataset.requestToken!==u)return;M.dataset.loading="0",cs("We ran into a problem loading assets. Please try again."),M.dataset.hasMore="0"}}}async function Js(e,t,a){switch(e.provider){case"unsplash":return Zs(e,t,a);case"pixabay":return Qs(e,t,a);case"flaticon":return ei(e,t,a);case"iconify":return ti(e,t,a);default:return console.warn("[InkWise Studio] Unknown graphics provider:",e.provider),[]}}async function Zs(e,t,a){const s=e.perPage||12,n=Sa(e,a),r=n?"https://api.unsplash.com/search/photos":"https://api.unsplash.com/photos",u=new URLSearchParams({per_page:String(s),page:String(t),client_id:e.apiKey});n&&(u.set("query",n),u.set("orientation","portrait"));const f=`${r}?${u.toString()}`,p=await fetch(f);if(!p.ok)throw new Error(`Unsplash API error: ${p.status}`);const x=await p.json();return(Array.isArray(x)?x:Array.isArray(x.results)?x.results:[]).map(y=>{const b=y.urls||{};return{id:`unsplash-${y.id}`,thumbUrl:b.small||b.thumb||b.regular||"",fullUrl:b.full||b.regular||b.raw||"",alt:y.alt_description||y.description||y.slug||"Unsplash image"}}).filter(y=>!!y.thumbUrl)}async function Qs(e,t,a){const s=e.perPage||18,n=new URLSearchParams({key:e.apiKey,q:Sa(e,a),per_page:String(s),page:String(t),safesearch:"true",order:"popular"});e.imageType&&n.set("image_type",e.imageType),e.category&&n.set("category",e.category);const r=await fetch(`https://pixabay.com/api/?${n.toString()}`);if(!r.ok)throw new Error(`Pixabay API error: ${r.status}`);const u=await r.json();return(Array.isArray(u==null?void 0:u.hits)?u.hits:[]).map(p=>({id:`pixabay-${p.id}`,thumbUrl:p.previewURL||p.webformatURL||"",fullUrl:p.largeImageURL||p.webformatURL||"",alt:p.tags||"Pixabay asset",label:p.user?`@${p.user}`:null})).filter(p=>!!p.thumbUrl)}async function ei(e,t,a){const s=e.perPage||48,n=new URLSearchParams({q:Sa(e,a)||"icon",limit:String(s),page:String(t)});n.set("apikey",e.apiKey);const r=await fetch(`https://api.flaticon.com/v3/search/icons?${n.toString()}`,{headers:{Accept:"application/json",apikey:e.apiKey,Authorization:`Bearer ${e.apiKey}`}});if(!r.ok)throw new Error(`Flaticon API error: ${r.status}`);const u=await r.json();return(Array.isArray(u==null?void 0:u.data)?u.data:Array.isArray(u==null?void 0:u.icons)?u.icons:Array.isArray(u==null?void 0:u.result)?u.result:[]).map(p=>{var g;const x=(p==null?void 0:p.images)||p,L=(x==null?void 0:x.png)||{},y=(x==null?void 0:x.svg)||(x==null?void 0:x.svg)||null,b=L[128]||L[256]||y||(x==null?void 0:x["64"])||null,C=L[512]||L[256]||y||b;return b?{id:`flaticon-${(p==null?void 0:p.id)||(p==null?void 0:p.icon_id)||(p==null?void 0:p.id_icon)||Math.random().toString(36).slice(2)}`,thumbUrl:b,fullUrl:C,alt:(p==null?void 0:p.description)||(Array.isArray(p==null?void 0:p.tags)?p.tags.join(", "):"Icon asset"),label:((g=p==null?void 0:p.uploader)==null?void 0:g.name)||(p==null?void 0:p.category)||null}:null}).filter(Boolean)}async function ti(e,t,a){const s=e.perPage||36,n=Math.max(0,(t-1)*s),r=new URLSearchParams({query:Sa(e,a)||"shape",limit:String(s),offset:String(n)});e.prefix&&r.set("prefix",e.prefix);const u=(e.baseUrl||"https://api.iconify.design").replace(/\/$/,""),f=await fetch(`${u}/search?${r.toString()}`,{headers:{Accept:"application/json"}});if(!f.ok)throw new Error(`Iconify API error: ${f.status}`);const p=await f.json(),x=Array.isArray(p==null?void 0:p.icons)?p.icons:[],L=Array.isArray(p==null?void 0:p.prefixes)&&p.prefixes.length===1?p.prefixes[0]:(p==null?void 0:p.prefix)||e.prefix||"";return x.map(y=>{if(typeof y=="string"){const b=y.includes(":")?y:L?`${L}:${y}`:y;if(!b)return null;const C=b.split(":").map(S=>encodeURIComponent(S)).join(":"),g=b.split(":").pop()||b;return{id:`iconify-${b.replace(/[^a-zA-Z0-9:]/g,"-")}-${t}`,thumbUrl:`${u}/${C}.svg?height=120&width=120`,fullUrl:`${u}/${C}.svg`,alt:g.replace(/[-_]/g," "),label:g.replace(/[-_]/g," ")}}if(y&&typeof y=="object"){const b=y.name||y.icon||y.id||"";if(!b)return null;const C=y.prefix||L,g=C?`${C}:${b}`:b,S=g.split(":").map($=>encodeURIComponent($)).join(":"),I=y.label||b;return{id:`iconify-${g.replace(/[^a-zA-Z0-9:]/g,"-")}-${t}`,thumbUrl:`${u}/${S}.svg?height=120&width=120`,fullUrl:`${u}/${S}.svg`,alt:I.replace(/[-_]/g," "),label:I.replace(/[-_]/g," ")}}return null}).filter(y=>!!(y!=null&&y.thumbUrl))}async function ai(){if(!M)return;const e=M.dataset.category;if(!e||M.dataset.loading==="1"||M.dataset.hasMore==="0")return;if(M.scrollTop+M.clientHeight>=M.scrollHeight-180){const a=Number(M.dataset.page||"1")+1,s=M.dataset.searchTerm||"";await Oa(e,a,s)}}xa.forEach(e=>{e.addEventListener("click",()=>ns(e))}),M&&(M.addEventListener("scroll",()=>{ai().catch(e=>{console.error("[InkWise Studio] graphics scroll handler error:",e)})}),Da()),vt&&wt&&vt.addEventListener("submit",async e=>{if(e.preventDefault(),!M)return;const t=M.dataset.category;if(!t||!Wa(t))return;const a=wt.value.trim();rs.set(t,a),M.scrollTop=0,M.innerHTML="",M.dataset.page="0",M.dataset.hasMore="1",M.dataset.searchTerm=a,M.dataset.loading="0";const s=String(++za);M.dataset.requestToken=s;try{await Oa(t,1,a,s)}catch(n){console.error("[InkWise Studio] graphics search failed:",n)}});const ds=e=>!e||!v?null:v.querySelector(`input[data-preview-target="${e}"]`),si=e=>!e||!k?null:k.querySelector(`[data-preview-node="${e}"]`),us=(()=>{let e=!1;return()=>{if(e||typeof document>"u")return;const t=document.createElement("style");t.id="inkwise-crop-overlay-styles",t.textContent=`
.crop-overlay {
  position: absolute;
  inset: 0;
  z-index: 12;
}

.crop-overlay__scrim {
  position: absolute;
  background: rgba(15, 23, 42, 0.35);
  backdrop-filter: blur(10px);
  pointer-events: none;
  transition: transform 0.18s ease, opacity 0.18s ease;
}

.crop-frame {
  position: absolute;
  border-radius: 18px;
  border: 1.5px solid rgba(255, 255, 255, 0.92);
  box-shadow: 0 18px 36px rgba(15, 23, 42, 0.3);
  pointer-events: auto;
  cursor: grab;
  background: rgba(15, 23, 42, 0.08);
  transition: box-shadow 0.24s ease, border-color 0.24s ease;
}

.crop-frame:active {
  cursor: grabbing;
  box-shadow: 0 24px 48px rgba(15, 23, 42, 0.34);
}

.crop-frame::after {
  content: '';
  position: absolute;
  inset: 0;
  border: 1px solid rgba(255, 255, 255, 0.45);
  border-radius: inherit;
  pointer-events: none;
  mix-blend-mode: screen;
}

.crop-frame__corner {
  position: absolute;
  width: 28px;
  height: 28px;
  pointer-events: auto;
}

.crop-frame__corner .corner-arm {
  position: absolute;
  background: rgba(255, 255, 255, 0.98);
  box-shadow: 0 6px 14px rgba(15, 23, 42, 0.28);
  border-radius: 999px;
  pointer-events: none;
}

.crop-frame__corner .corner-arm--horizontal {
  width: 18px;
  height: 3px;
}

.crop-frame__corner .corner-arm--vertical {
  width: 3px;
  height: 18px;
}

.crop-frame__corner--top-left {
  top: -4px;
  left: -4px;
}

.crop-frame__corner--top-right {
  top: -4px;
  right: -4px;
}

.crop-frame__corner--bottom-left {
  bottom: -4px;
  left: -4px;
}

.crop-frame__corner--bottom-right {
  bottom: -4px;
  right: -4px;
}

.crop-frame__corner--top-left .corner-arm--horizontal,
.crop-frame__corner--bottom-left .corner-arm--horizontal {
  top: 0;
  left: 0;
}

.crop-frame__corner--top-left .corner-arm--vertical,
.crop-frame__corner--top-right .corner-arm--vertical {
  top: 0;
}

.crop-frame__corner--top-right .corner-arm--horizontal,
.crop-frame__corner--bottom-right .corner-arm--horizontal {
  top: 0;
  right: 0;
}

.crop-frame__corner--bottom-left .corner-arm--horizontal,
.crop-frame__corner--bottom-right .corner-arm--horizontal {
  bottom: 0;
}

.crop-frame__corner--bottom-left .corner-arm--vertical,
.crop-frame__corner--bottom-right .corner-arm--vertical {
  bottom: 0;
}

.crop-frame__corner--top-right .corner-arm--vertical,
.crop-frame__corner--bottom-right .corner-arm--vertical {
  right: 0;
}

.crop-frame__corner--top-left .corner-arm--vertical,
.crop-frame__corner--bottom-left .corner-arm--vertical {
  left: 0;
}

.crop-frame__edge-handle {
  position: absolute;
  width: 16px;
  height: 16px;
  border-radius: 999px;
  border: 2px solid rgba(255, 255, 255, 0.92);
  background: rgba(15, 23, 42, 0.55);
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.32);
  pointer-events: none;
}

.crop-frame__edge-handle--top {
  top: -10px;
  left: 50%;
  transform: translate(-50%, 0);
}

.crop-frame__edge-handle--right {
  right: -10px;
  top: 50%;
  transform: translate(0, -50%);
}

.crop-frame__edge-handle--bottom {
  bottom: -10px;
  left: 50%;
  transform: translate(-50%, 0);
}

.crop-frame__edge-handle--left {
  left: -10px;
  top: 50%;
  transform: translate(0, -50%);
}

.editor-overlay--crop-active {
  border-color: transparent !important;
  box-shadow: none !important;
  background: transparent !important;
}

.editor-overlay--crop-active .editor-overlay__handle {
  display: none !important;
}

.editor-overlay--crop-active::after {
  display: none !important;
}

.editor-overlay--hidden-for-crop {
  opacity: 0;
  pointer-events: none;
}

.crop-overlay__controls {
  position: absolute;
  left: 50%;
  bottom: 24px;
  transform: translateX(-50%);
  display: flex;
  gap: 12px;
  pointer-events: auto;
  z-index: 5;
}

.crop-overlay__button {
  border: none;
  border-radius: 999px;
  padding: 9px 20px;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: #ffffff;
  cursor: pointer;
  background: rgba(15, 23, 42, 0.82);
  box-shadow: 0 16px 36px rgba(15, 23, 42, 0.35);
  transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
}

.crop-overlay__button:hover {
  background: rgba(15, 23, 42, 0.92);
  transform: translateY(-1px);
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.4);
}

.crop-overlay__button:active {
  transform: translateY(0);
  box-shadow: 0 12px 28px rgba(15, 23, 42, 0.34);
}

.crop-overlay__button:focus-visible {
  outline: 2px solid rgba(96, 165, 250, 0.95);
  outline-offset: 2px;
}

.crop-overlay__button--cancel {
  background: rgba(148, 163, 184, 0.74);
  color: rgba(15, 23, 42, 0.92);
}

.crop-overlay__button--cancel:hover {
  background: rgba(226, 232, 240, 0.92);
  color: rgba(15, 23, 42, 0.95);
}

.crop-overlay__button--apply {
  background: linear-gradient(135deg, rgba(14, 165, 233, 0.92), rgba(59, 130, 246, 0.9));
}

.crop-overlay__button--apply:hover {
  background: linear-gradient(135deg, rgba(14, 165, 233, 1), rgba(37, 99, 235, 0.98));
}

@media (prefers-reduced-motion: reduce) {
  .crop-overlay__scrim,
  .crop-frame {
    transition: none;
  }
}
        `,document.head.appendChild(t),e=!0}})(),ft=()=>{$e&&($e.teardown(),$e=null)},Ua=(e,t)=>{if(!e||!t)return null;us(),getComputedStyle(e).position==="static"&&(e.style.position="relative");const a=(h,N,O)=>Math.min(Math.max(h,N),O);(()=>{if(t.dataset.cropSourceWidth&&t.dataset.cropSourceHeight)return;let h=null;try{h=t.getBBox()}catch{h=null}const N=h&&Number.isFinite(h.width)&&h.width>0?h.width:parseFloat(t.getAttribute("width"))||0,O=h&&Number.isFinite(h.height)&&h.height>0?h.height:parseFloat(t.getAttribute("height"))||0,B=h&&Number.isFinite(h.x)?h.x:parseFloat(t.getAttribute("x"))||0,ce=h&&Number.isFinite(h.y)?h.y:parseFloat(t.getAttribute("y"))||0;N>0&&O>0&&(t.dataset.cropSourceWidth=N,t.dataset.cropSourceHeight=O,t.dataset.cropSourceX=B,t.dataset.cropSourceY=ce)})();const n=document.createElement("div");n.className="crop-overlay";const r=(()=>{const h=typeof t.dataset.cropRect=="string"?t.dataset.cropRect:"",N=t.getAttribute("clip-path")||"",O=t.style&&typeof t.style.clipPath=="string"?t.style.clipPath:"",B=t.style&&typeof t.style.webkitClipPath=="string"?t.style.webkitClipPath:"",ce=t.dataset.cropClipId||"",fe=(()=>{const ne=N.match(/^url\(#(.+)\)$/);return ne?ne[1]:""})(),pe=ce||fe;let oe=null;if(pe){const ne=Ft(t.ownerSVGElement||null),X=ne==null?void 0:ne.querySelector(`#${pe}`),K=X==null?void 0:X.querySelector("rect");K&&(oe={x:K.getAttribute("x")||"",y:K.getAttribute("y")||"",width:K.getAttribute("width")||"",height:K.getAttribute("height")||""})}return{rectString:h,clipPathAttr:N,clipId:pe,clipRect:oe,clipPathStyle:O,webkitClipPathStyle:B}})(),u=[],f=document.createElement("div");f.className="crop-overlay__scrim crop-overlay__scrim--top";const p=document.createElement("div");p.className="crop-overlay__scrim crop-overlay__scrim--right";const x=document.createElement("div");x.className="crop-overlay__scrim crop-overlay__scrim--bottom";const L=document.createElement("div");L.className="crop-overlay__scrim crop-overlay__scrim--left",[f,p,x,L].forEach(h=>{h.style.pointerEvents="none",n.appendChild(h)});const b=document.createElement("div");b.className="crop-frame",n.appendChild(b);const C=document.createElement("div");C.className="crop-overlay__controls";const g=document.createElement("button");g.type="button",g.className="crop-overlay__button crop-overlay__button--cancel",g.textContent="Cancel";const S=document.createElement("button");S.type="button",S.className="crop-overlay__button crop-overlay__button--apply",S.textContent="Crop",C.appendChild(g),C.appendChild(S),n.appendChild(C);const I=["top-left","top-right","bottom-left","bottom-right"],$=[],re={"top-left":"nwse-resize","bottom-right":"nwse-resize","top-right":"nesw-resize","bottom-left":"nesw-resize"};I.forEach(h=>{const N=document.createElement("div");N.className=`crop-frame__corner crop-frame__corner--${h}`,N.dataset.corner=h,N.style.pointerEvents="auto",N.style.cursor=re[h]||"nwse-resize";const O=document.createElement("span");O.className="corner-arm corner-arm--horizontal",O.style.pointerEvents="none";const B=document.createElement("span");B.className="corner-arm corner-arm--vertical",B.style.pointerEvents="none",N.appendChild(O),N.appendChild(B),b.appendChild(N),$.push(N)});const ae=["top","right","bottom","left"],me=[];ae.forEach(h=>{const N=document.createElement("div");N.className=`crop-frame__edge-handle crop-frame__edge-handle--${h}`,N.dataset.edge=h,N.style.pointerEvents="auto",N.style.cursor=h==="top"||h==="bottom"?"ns-resize":"ew-resize",b.appendChild(N),me.push(N)}),e.appendChild(n);let G=e.getBoundingClientRect(),j=G.width||e.offsetWidth,R=G.height||e.offsetHeight,qe=j,At=R;if(!j||!R)return n.remove(),null;Ne.forEach(h=>{!h||!h.overlay||h.overlay!==e&&(h.overlay.classList.contains("editor-overlay--hidden-for-crop")||(h.overlay.classList.add("editor-overlay--hidden-for-crop"),u.push(h.overlay)))}),e.classList.add("editor-overlay--crop-active"),e.dataset.cropSessionActive="true",ie(),n.style.pointerEvents="none",b.style.pointerEvents="auto";const nt=(()=>{const h=t.dataset.cropRect;if(!h)return null;const N=h.split(",").map(O=>Number(O));return N.length!==4||N.some(O=>!Number.isFinite(O))?null:{left:a(N[0],0,1),top:a(N[1],0,1),width:a(N[2],0,1),height:a(N[3],0,1)}})(),Xt=parseFloat(t.dataset.cropSourceWidth)||0,_a=parseFloat(t.dataset.cropSourceHeight)||0;let ge,ve;const Kt=()=>{ve=Math.min(j,Math.max(48,j*.08)),ge=Math.min(R,Math.max(48,R*.08))};Kt();const _={left:0,top:0,width:0,height:0};if(nt&&nt.width>0&&nt.height>0){const h=nt.width*j,N=nt.height*R;_.width=a(h,ve,j),_.height=a(N,ge,R),_.left=a(nt.left*j,0,j-_.width),_.top=a(nt.top*R,0,R-_.height)}else{const h=Xt>0&&_a>0?Xt/_a:j>0&&R>0?j/R:1;let N,O;h>=1?(N=j*.85,O=N/h):(O=R*.85,N=O*h),_.width=a(N,ve,j),_.height=a(O,ge,R),_.left=Math.max(0,(j-_.width)/2),_.top=Math.max(0,(R-_.height)/2)}_.width=a(_.width,ve,j),_.height=a(_.height,ge,R),_.left=a(_.left,0,j-_.width),_.top=a(_.top,0,R-_.height);const Zi=()=>{const h=_.left+_.width,N=_.top+_.height;f.style.top="0px",f.style.left="0px",f.style.width="100%",f.style.height=`${Math.max(0,_.top)}px`,f.style.display=_.top>0?"block":"none",x.style.top=`${N}px`,x.style.left="0px",x.style.width="100%",x.style.height=`${Math.max(0,R-N)}px`,x.style.display=N<R?"block":"none",L.style.top=`${_.top}px`,L.style.left="0px",L.style.width=`${Math.max(0,_.left)}px`,L.style.height=`${_.height}px`,L.style.display=_.left>0?"block":"none",p.style.top=`${_.top}px`,p.style.left=`${h}px`,p.style.width=`${Math.max(0,j-h)}px`,p.style.height=`${_.height}px`,p.style.display=h<j?"block":"none"},Ls=(h,N,O,B)=>{const ce=t.ownerSVGElement;if(!ce)return;const fe=parseFloat(t.dataset.cropSourceWidth)||0,pe=parseFloat(t.dataset.cropSourceHeight)||0,oe=parseFloat(t.dataset.cropSourceX)||0,ne=parseFloat(t.dataset.cropSourceY)||0;let X=fe,K=pe,Ge=oe,ja=ne;if(!X||!K){let Ee=null;try{Ee=t.getBBox()}catch{Ee=null}X=Ee&&Number.isFinite(Ee.width)&&Ee.width>0?Ee.width:parseFloat(t.getAttribute("width"))||0,K=Ee&&Number.isFinite(Ee.height)&&Ee.height>0?Ee.height:parseFloat(t.getAttribute("height"))||0,Ge=Ee&&Number.isFinite(Ee.x)?Ee.x:parseFloat(t.getAttribute("x"))||0,ja=Ee&&Number.isFinite(Ee.y)?Ee.y:parseFloat(t.getAttribute("y"))||0}if(!X||!K)return;if(t instanceof HTMLImageElement){const Ee=a(N,0,1)*100,Os=a(h,0,1)*100,rr=a(1-(N+B),0,1)*100,nr=a(1-(h+O),0,1)*100,es=`inset(${Ee}% ${nr}% ${rr}% ${Os}%)`;t.style.clipPath=es,t.style.webkitClipPath=es,delete t.dataset.cropClipId,t.dataset.cropCssClip=es;return}const Zt=Ft(ce);if(!Zt)return;const gt=t.dataset.cropClipId||`inkwiseCrop_${Date.now()}_${Math.floor(Math.random()*1e3)}`;let Je=Zt.querySelector(`#${gt}`);Je||(Je=document.createElementNS(z,"clipPath"),Je.id=gt,Je.setAttribute("clipPathUnits","userSpaceOnUse"),Zt.appendChild(Je));let Ze=Je.querySelector("rect");Ze||(Ze=document.createElementNS(z,"rect"),Je.appendChild(Ze));const tr=X*O,ar=K*B,sr=Ge+X*h,ir=ja+K*N;Ze.setAttribute("x",sr),Ze.setAttribute("y",ir),Ze.setAttribute("width",tr),Ze.setAttribute("height",ar),t.dataset.cropClipId=gt,t.setAttribute("clip-path",`url(#${gt})`),t.style.removeProperty("clip-path"),t.style.removeProperty("-webkit-clip-path"),delete t.dataset.cropCssClip},Qi=()=>{if(!j||!R)return;const h=t.dataset.cropRect||"",N=typeof t.getAttribute("clip-path")=="string"&&t.getAttribute("clip-path").length>0,O=t.ownerSVGElement,B=_.left/j,ce=_.top/R,fe=_.width/j,pe=_.height/R,oe=a(B,0,1),ne=a(ce,0,1),X=a(fe,0,1-oe),K=a(pe,0,1-ne),Ge=oe+X,ja=ne+K;if(oe<=.001&&ne<=.001&&Ge>=.999&&ja>=.999){const gt=t.dataset.cropClipId;if(gt){const Je=Ft(O),Ze=Je==null?void 0:Je.querySelector(`#${gt}`);Ze==null||Ze.remove(),delete t.dataset.cropClipId}t.removeAttribute("clip-path"),t.style.removeProperty("clip-path"),t.style.removeProperty("-webkit-clip-path"),delete t.dataset.cropCssClip,delete t.dataset.cropRect,(h||N)&&(E==null||E.schedule("image-crop"),ie());return}const Zt=[oe,ne,X,K].map(gt=>gt.toFixed(6)).join(",");t.dataset.cropRect=Zt,Ls(oe,ne,X,K),h!==Zt&&(E==null||E.schedule("image-crop"),ie())},Ts=()=>{var ne;const h=t.dataset.cropRect||"",N=t.getAttribute("clip-path")||"",O=t.dataset.cropClipId||"",B=t.ownerSVGElement,ce=t.dataset.cropClipId;if(ce&&ce!==r.clipId){const X=Ft(B);(ne=X==null?void 0:X.querySelector(`#${ce}`))==null||ne.remove()}if(r.rectString){t.dataset.cropRect=r.rectString,r.clipId?t.dataset.cropClipId=r.clipId:delete t.dataset.cropClipId;const X=r.rectString.split(",").map(K=>Number(K));X.length===4&&X.every(K=>Number.isFinite(K))&&Ls(X[0],X[1],X[2],X[3]),r.clipPathAttr?t.setAttribute("clip-path",r.clipPathAttr):t.removeAttribute("clip-path"),r.clipPathStyle?(t.style.clipPath=r.clipPathStyle,t.dataset.cropCssClip=r.clipPathStyle):(t.style.removeProperty("clip-path"),delete t.dataset.cropCssClip),r.webkitClipPathStyle?t.style.webkitClipPath=r.webkitClipPathStyle:t.style.removeProperty("-webkit-clip-path")}else{if(delete t.dataset.cropRect,r.clipId){if(t.dataset.cropClipId=r.clipId,r.clipRect){const X=Ft(B);if(X){let K=X.querySelector(`#${r.clipId}`);K||(K=document.createElementNS(z,"clipPath"),K.id=r.clipId,K.setAttribute("clipPathUnits","userSpaceOnUse"),X.appendChild(K));let Ge=K.querySelector("rect");Ge||(Ge=document.createElementNS(z,"rect"),K.appendChild(Ge)),Ge.setAttribute("x",r.clipRect.x),Ge.setAttribute("y",r.clipRect.y),Ge.setAttribute("width",r.clipRect.width),Ge.setAttribute("height",r.clipRect.height)}}r.clipPathAttr&&t.setAttribute("clip-path",r.clipPathAttr)}else delete t.dataset.cropClipId,r.clipPathAttr?t.setAttribute("clip-path",r.clipPathAttr):t.removeAttribute("clip-path");r.clipPathStyle?(t.style.clipPath=r.clipPathStyle,t.dataset.cropCssClip=r.clipPathStyle):(t.style.removeProperty("clip-path"),delete t.dataset.cropCssClip),r.webkitClipPathStyle?t.style.webkitClipPath=r.webkitClipPathStyle:t.style.removeProperty("-webkit-clip-path")}const fe=t.dataset.cropRect||"",pe=t.getAttribute("clip-path")||"",oe=t.dataset.cropClipId||"";(h!==fe||N!==pe||O!==oe)&&(E==null||E.schedule("image-crop"),ie())},mt=()=>{b.style.left=`${_.left}px`,b.style.top=`${_.top}px`,b.style.width=`${_.width}px`,b.style.height=`${_.height}px`,Zi(),Qi()};mt();let ke=null,ue=null;const Za=()=>{const h=j||(G==null?void 0:G.width)||(o==null?void 0:o.clientWidth)||0,N=R||(G==null?void 0:G.height)||(o==null?void 0:o.clientHeight)||0,O=Math.min(h,N);return Math.max(8,Math.round(O*.02))},Jt=(h,N)=>{const O=[],B=Math.round(h/ha)*ha;O.push(B),Number.isFinite(N)&&N>0&&O.push(N/2);let ce=h,fe=Number.POSITIVE_INFINITY;return O.forEach(pe=>{const oe=Math.abs(pe-h);oe<fe&&oe<=Qt&&(ce=pe,fe=oe)}),ce},_s=h=>{if(h.button!==0||h.target!==b)return;h.preventDefault(),G=e.getBoundingClientRect();const N=G.width||j,O=G.height||R;ke={pointerId:h.pointerId,startX:h.clientX,startY:h.clientY,widthLimit:N,heightLimit:O,startLeft:_.left,startTop:_.top},b.setPointerCapture(h.pointerId)},Fs=h=>{if(!ke||h.pointerId!==ke.pointerId)return;h.preventDefault();const N=h.clientX-ke.startX,O=h.clientY-ke.startY,B=Za(),ce=Math.max(0,ke.widthLimit-_.width-B*2),fe=Math.max(0,ke.heightLimit-_.height-B*2),pe=ke.startLeft+N,oe=ke.startTop+O,ne=Jt(pe,ke.widthLimit),X=Jt(oe,ke.heightLimit);_.left=a(ne,B,B+ce),_.top=a(X,B,B+fe),mt()},Fa=h=>{if(!(!ke||h.pointerId!==ke.pointerId)){try{b.releasePointerCapture(h.pointerId)}catch{}ke=null}};b.addEventListener("pointerdown",_s),b.addEventListener("pointermove",Fs),b.addEventListener("pointerup",Fa),b.addEventListener("pointercancel",Fa);const Ms=()=>{ke=null};b.addEventListener("lostpointercapture",Ms);const Bs=h=>{h.button===0&&(h.preventDefault(),h.stopPropagation(),G=e.getBoundingClientRect(),j=G.width||e.offsetWidth||j,R=G.height||e.offsetHeight||R,Kt(),ue={pointerId:h.pointerId,mode:"edge",edge:h.currentTarget.dataset.edge,anchor:{left:_.left,top:_.top,right:_.left+_.width,bottom:_.top+_.height},target:h.currentTarget},h.currentTarget.setPointerCapture(h.pointerId))},js=h=>{if(!ue||h.pointerId!==ue.pointerId||ue.mode!=="edge")return;h.preventDefault(),G=e.getBoundingClientRect(),j=G.width||e.offsetWidth||j,R=G.height||e.offsetHeight||R,Kt();const N=h.clientX-G.left,O=h.clientY-G.top,B=ue.anchor,ce=Za();let fe=B.left,pe=B.top,oe=a(B.right-B.left,ve,j),ne=a(B.bottom-B.top,ge,R);if(ue.edge==="top"){const X=Math.min(B.bottom-ge,R-ge),K=a(O,0,Math.max(0,X));pe=K,ne=Math.max(ge,B.bottom-K)}else if(ue.edge==="bottom"){const X=B.top+ge,K=a(O,X,R);pe=B.top,ne=Math.max(ge,K-B.top)}else if(ue.edge==="left"){const X=Math.min(B.right-ve,j-ve),K=a(N,0,Math.max(0,X));fe=K,oe=Math.max(ve,B.right-K)}else if(ue.edge==="right"){const X=B.left+ve,K=a(N,X,j);fe=B.left,oe=Math.max(ve,K-B.left)}oe=a(oe,ve,j),ne=a(ne,ge,R),fe=Jt(a(fe,ce,j-ce-oe),j),pe=Jt(a(pe,ce,R-ce-ne),R),_.left=fe,_.top=pe,_.width=oe,_.height=ne,mt()},Ma=h=>{var N;if(!(!ue||h.pointerId!==ue.pointerId)){try{(N=ue.target)==null||N.releasePointerCapture(h.pointerId)}catch{}ue=null,mt()}},Rs=()=>{ue=null},Ps=h=>{h.button===0&&(h.preventDefault(),h.stopPropagation(),G=e.getBoundingClientRect(),j=G.width||e.offsetWidth||j,R=G.height||e.offsetHeight||R,Kt(),ue={pointerId:h.pointerId,mode:"corner",corner:h.currentTarget.dataset.corner,anchor:{left:_.left,top:_.top,right:_.left+_.width,bottom:_.top+_.height},target:h.currentTarget},h.currentTarget.setPointerCapture(h.pointerId))},$s=h=>{if(!ue||h.pointerId!==ue.pointerId||ue.mode!=="corner")return;h.preventDefault(),G=e.getBoundingClientRect(),j=G.width||e.offsetWidth||j,R=G.height||e.offsetHeight||R,Kt();const N=h.clientX-G.left,O=h.clientY-G.top,B=ue.anchor,ce=Za();let fe=B.left,pe=B.top,oe=a(B.right-B.left,ve,j),ne=a(B.bottom-B.top,ge,R);switch(ue.corner){case"top-left":{const X=a(N,0,B.right-ve),K=a(O,0,B.bottom-ge);fe=X,pe=K,oe=Math.max(ve,B.right-X),ne=Math.max(ge,B.bottom-K);break}case"top-right":{const X=a(N,B.left+ve,j),K=a(O,0,B.bottom-ge);fe=B.left,pe=K,oe=Math.max(ve,X-B.left),ne=Math.max(ge,B.bottom-K);break}case"bottom-left":{const X=a(N,0,B.right-ve),K=a(O,B.top+ge,R);fe=X,pe=B.top,oe=Math.max(ve,B.right-X),ne=Math.max(ge,K-B.top);break}case"bottom-right":{const X=a(N,B.left+ve,j),K=a(O,B.top+ge,R);fe=B.left,pe=B.top,oe=Math.max(ve,X-B.left),ne=Math.max(ge,K-B.top);break}default:return}oe=a(oe,ve,j),ne=a(ne,ge,R),fe=Jt(a(fe,ce,j-ce-oe),j),pe=Jt(a(pe,ce,R-ce-ne),R),_.left=fe,_.top=pe,_.width=oe,_.height=ne,mt()},Ba=h=>{var N;if(!(!ue||h.pointerId!==ue.pointerId)){try{(N=ue.target)==null||N.releasePointerCapture(h.pointerId)}catch{}ue=null,mt()}},zs=()=>{ue=null};me.forEach(h=>{h.addEventListener("pointerdown",Bs),h.addEventListener("pointermove",js),h.addEventListener("pointerup",Ma),h.addEventListener("pointercancel",Ma),h.addEventListener("lostpointercapture",Rs)}),$.forEach(h=>{h.addEventListener("pointerdown",Ps),h.addEventListener("pointermove",$s),h.addEventListener("pointerup",Ba),h.addEventListener("pointercancel",Ba),h.addEventListener("lostpointercapture",zs)});const Ds=h=>{h.preventDefault(),h.stopPropagation(),Ts(),ft()},qs=h=>{h.preventDefault(),h.stopPropagation(),mt()};g.addEventListener("click",Ds),S.addEventListener("click",qs);const Ws=h=>{h.key==="Escape"&&(h.preventDefault(),Ts(),ft()),h.key==="Enter"&&(h.metaKey||h.ctrlKey)&&(h.preventDefault(),mt(),ft())};document.addEventListener("keydown",Ws);const Qa=()=>{if(G=e.getBoundingClientRect(),j=G.width||e.offsetWidth||j,R=G.height||e.offsetHeight||R,!j||!R)return;Kt();const h=t.dataset.cropRect||null;if(h){const N=h.split(",").map(O=>Number(O));if(N.length===4&&N.every(O=>Number.isFinite(O))){const O=a(N[2]*j,ve,j),B=a(N[3]*R,ge,R),ce=a(N[0]*j,0,j-O),fe=a(N[1]*R,0,R-B);_.left=ce,_.top=fe,_.width=O,_.height=B}}else{const N=qe?_.width/qe:1,O=At?_.height/At:1,B=qe?_.left/qe:0,ce=At?_.top/At:0;_.width=a(N*j,ve,j),_.height=a(O*R,ge,R),_.left=a(B*j,0,j-_.width),_.top=a(ce*R,0,R-_.height)}qe=j,At=R,mt()};return window.addEventListener("resize",Qa),{overlay:e,refresh:Qa,teardown:()=>{var h;if(ke&&typeof ke.pointerId<"u"){try{b.releasePointerCapture(ke.pointerId)}catch{}ke=null}if(ue&&typeof ue.pointerId<"u"){try{(h=ue.target)==null||h.releasePointerCapture(ue.pointerId)}catch{}ue=null}window.removeEventListener("resize",Qa),b.removeEventListener("pointerdown",_s),b.removeEventListener("pointermove",Fs),b.removeEventListener("pointerup",Fa),b.removeEventListener("pointercancel",Fa),b.removeEventListener("lostpointercapture",Ms),me.forEach(N=>{N.removeEventListener("pointerdown",Bs),N.removeEventListener("pointermove",js),N.removeEventListener("pointerup",Ma),N.removeEventListener("pointercancel",Ma),N.removeEventListener("lostpointercapture",Rs)}),$.forEach(N=>{N.removeEventListener("pointerdown",Ps),N.removeEventListener("pointermove",$s),N.removeEventListener("pointerup",Ba),N.removeEventListener("pointercancel",Ba),N.removeEventListener("lostpointercapture",zs)}),g.removeEventListener("click",Ds),S.removeEventListener("click",qs),document.removeEventListener("keydown",Ws),e.classList.remove("editor-overlay--crop-active"),delete e.dataset.cropSessionActive,u.forEach(N=>N.classList.remove("editor-overlay--hidden-for-crop")),u.length=0,ie(),n.parentNode===e?e.removeChild(n):n.remove()}}},ra=()=>{be||ye||Pe?document.body.classList.add("text-toolbar-visible"):document.body.classList.remove("text-toolbar-visible")},na=()=>{Ne.forEach(({overlay:e,type:t})=>{var r;if(!e)return;const a=((r=e.dataset)==null?void 0:r.previewNode)||"",s=!!be&&a===be&&t==="text",n=!!ye&&a===ye&&t==="image";e.classList.toggle("editor-overlay--selected",s||n)})},De=()=>Pe?"background":ye?"image":be?"text":null,Ha=e=>{if(typeof e!="string")return null;const t=e.match(/rgba?\s*\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})/i);if(!t)return null;const a=Number(t[1]),s=Number(t[2]),n=Number(t[3]);if([a,s,n].some(u=>Number.isNaN(u)||u<0||u>255))return null;const r=u=>u.toString(16).padStart(2,"0");return`#${r(a)}${r(s)}${r(n)}`.toUpperCase()};function ii(e){var t;try{if(e==="background"){if(!o)return null;const s=window.getComputedStyle(o).backgroundColor||o.style.backgroundColor||"";return _t(s)||Ha(s)||null}if(e==="text"){const a=Ht();if(!a.length)return null;const s=a[0],n=s.getAttribute("fill")||s.style.fill||s.dataset.color||"";return _t(n)||Ha(n)||null}if(e==="image"){const a=Lt();if(!a.length)return null;const n=((t=a[0].dataset)==null?void 0:t.tintColor)||"";return _t(n)||null}}catch{return null}return null}const oa=()=>{if(typeof window>"u")return;const e=De(),t=e==="text"?be:e==="image"?ye:null,a=ii(e);try{const s=new CustomEvent("inkwise:active-element",{detail:{type:e,key:t,color:a}});window.dispatchEvent(s)}catch{if(typeof document<"u"&&document.createEvent){const n=document.createEvent("CustomEvent");n.initCustomEvent("inkwise:active-element",!0,!0,{type:e,key:t,color:a}),window.dispatchEvent(n)}}},xt=e=>{const t=typeof e=="string"&&e.trim()!==""?e.trim():null;be===t&&!ye||(ft(),be=t,t&&(ye=null,Pe=!1),na(),ra(),oa())},St=e=>{const t=typeof e=="string"&&e.trim()!==""?e.trim():null;ye===t&&!be||(ye!==t&&ft(),ye=t,t&&(be=null,Pe=!1),na(),ra(),oa())},ri=()=>{Pe||(ft(),Pe=!0,be=null,ye=null,na(),ra(),oa())},Ht=()=>{if(!be)return[];const e=Y||l||document;if(!e)return[];const t=`[data-preview-node="${be}"]`,a=new Set;return e.querySelectorAll(t).forEach(s=>{if(!s||W(s))return;const n=(s.tagName||"").toLowerCase();if(n==="tspan"||n==="g"){const r=s.closest("text");if(r){a.add(r);return}}a.add(s)}),Array.from(a)},Lt=()=>{if(!ye)return[];const e=Y||l||document;if(!e)return[];const t=`[data-preview-node="${ye}"]`;let a=new Set;return e.querySelectorAll(t).forEach(s=>{const n=Ce(s);n&&a.add(n)}),a.size===0&&e!==document&&document.querySelectorAll(t).forEach(s=>{const n=Ce(s);n&&a.add(n)}),Array.from(a)},Vt=()=>ds(be),Tt=(e,t,a)=>{const s=Number(e);return Number.isFinite(s)?Math.min(Math.max(s,t),a):t},_t=e=>{if(typeof e!="string")return null;let t=e.trim();return!t||(t.startsWith("#")||(t=`#${t}`),/^#([0-9a-f]{3})$/i.test(t)&&(t=`#${t[1]}${t[1]}${t[2]}${t[2]}${t[3]}${t[3]}`),!/^#([0-9a-f]{6})$/i.test(t))?null:t.toUpperCase()},ka=e=>{var r,u;if(!e||typeof e.getBBox!="function")return;const t=[],a=Number(((r=e.dataset)==null?void 0:r.rotation)||e.getAttribute("data-rotation")||0);if(Number.isFinite(a)&&a!==0)try{const f=e.getBBox(),p=f.x+f.width/2,x=f.y+f.height/2;t.push(`rotate(${a} ${p} ${x})`)}catch{t.push(`rotate(${a})`)}((u=e.dataset)==null?void 0:u.effectShape)==="curve"&&t.push("skewX(-8) skewY(4)");const n=t.join(" ").trim();n?e.setAttribute("transform",n):e.removeAttribute("transform")},Fe=(e,t={})=>{const a=Ht();if(!a.length)return!1;if(a.forEach(s=>{try{e(s)}catch(n){console.warn("[InkWise Studio] Toolbar mutation failed.",n)}}),t.skipTransformUpdate||a.forEach(s=>{try{ka(s)}catch{}}),t.skipOverlaySync||ie(),t.autosaveReason!==!1){const s=typeof t.autosaveReason=="string"&&t.autosaveReason.trim()!==""?t.autosaveReason:"text-style";E==null||E.schedule(s)}return!0},pt=(e,t={})=>{const a=Lt();if(!a.length)return!1;if(a.forEach(s=>{try{e(s)}catch(n){console.warn("[InkWise Studio] Image mutation failed.",n)}}),t.skipTransformUpdate||a.forEach(s=>{try{ka(s)}catch{}}),t.skipOverlaySync||ie(),t.autosaveReason!==!1){const s=typeof t.autosaveReason=="string"&&t.autosaveReason.trim()!==""?t.autosaveReason:"image-style";E==null||E.schedule(s)}return!0},Ft=(e=null)=>{var s;let t=Y;if(!t&&e&&(t=e),!t)return null;if(typeof t.tagName=="string"&&t.tagName.toLowerCase()!=="svg"){const n=(s=t.closest)==null?void 0:s.call(t,"svg");n?t=n:e&&e!==t&&(t=e)}if(!t)return null;let a=t.querySelector('defs[data-inkwise-runtime="true"]');return a||(a=document.createElementNS(z,"defs"),a.setAttribute("data-inkwise-runtime","true"),t.insertBefore(a,t.firstChild||null)),a},Aa=e=>{const t=e.dataset.previewTarget;if(!t)return;const a=document.querySelector(`[data-preview-node="${t}"]`),s=a?a.dataset.defaultText||a.textContent:"",n=()=>{if(!a)return;const r=e.value.trim();a.textContent=r||s||"",ie()};e.dataset.defaultValue||(e.dataset.defaultValue=s||""),e.addEventListener("focus",()=>{xt(t)}),e.addEventListener("input",()=>{n(),st("text-change")}),n()};i.forEach(Aa);const ni=(e,t="")=>{const a=normalizeSideKey(_e),s=xe(t),n=document.createElement("div");n.className="text-field-item";const r=document.createElement("span");r.className="text-field-label",r.textContent="Custom",n.appendChild(r);const u=document.createElement("input");u.type="text",u.className="text-field-input",u.placeholder="Add your text",u.dataset.previewTarget=e,u.dataset.templateSide=a,u.value=s,u.dataset.defaultValue=s||"",setStoredTextValue(a,e,s),captureDefaultTextValue(a,e,s),n.appendChild(u);const f=document.createElement("button");if(f.type="button",f.className="text-field-delete",f.setAttribute("aria-label","Delete field"),f.innerHTML='<i class="fa-regular fa-trash-can"></i>',n.appendChild(f),v.appendChild(n),k){const p=document.createElement("div");p.className="pill",p.dataset.previewNode=e,p.dataset.defaultText=t||"CUSTOM TEXT",p.textContent=t||"CUSTOM TEXT",k.appendChild(p)}return Aa(u),Na(n),st("add-text-field"),u},la=()=>{l&&(qt(),Y=null,ga=null,l.innerHTML="",l.style.display="none")},fs=e=>{if(typeof e!="string")return!1;const t=e.trim();return t?t.startsWith("data:image/svg+xml")?!0:/\.svg($|\?)/i.test(t):!1},ps=e=>{if(!e)return;const t=s=>{var r,u,f;let n=(s==null?void 0:s.parentNode)||null;for(;n;){const p=typeof n.getAttribute=="function"?n.getAttribute("fill"):null,x=(r=n.style)==null?void 0:r.fill,L=((u=n.dataset)==null?void 0:u.color)||((f=n.dataset)==null?void 0:f.defaultColor)||null,y=p||x||L;if(y&&y!=="none"&&y!=="transparent")return y;n=n.parentNode||null}return null};e.querySelectorAll("text, tspan").forEach(s=>{var b,C;s.removeAttribute("opacity"),s.style.opacity="1",s.style&&s.style.mixBlendMode&&(s.style.mixBlendMode="normal");const n=s.getAttribute("fill"),r=(b=s.style)==null?void 0:b.fill,u=(C=s.dataset)==null?void 0:C.color;let f=n&&n!=="none"?n:null;if((!f||f==="transparent")&&r&&r!=="none"&&(f=r),(!f||f==="transparent")&&u&&u!=="none"&&(f=u),(!f||f==="transparent")&&typeof window<"u"&&typeof window.getComputedStyle=="function")try{const g=window.getComputedStyle(s).fill;g&&g!=="none"&&g!=="transparent"&&(f=g)}catch{}if(!f||f==="transparent"||f==="none"){const g=t(s);g&&g!=="none"&&g!=="transparent"&&(f=g)}const p=_t(f||"")||Ha(f||"")||(f&&f!=="none"&&f!=="transparent"?f:null),L=p||"#111111";s.setAttribute("fill",L),s.style&&(s.style.fill=L,s.style.fillOpacity="1",s.style.strokeOpacity="1"),s.dataset&&(s.dataset.color=L,p&&(s.dataset.defaultColor=p)),s.removeAttribute("fill-opacity"),s.removeAttribute("stroke-opacity"),s.getAttribute("stroke")||s.setAttribute("stroke","none"),s.getAttribute("paint-order")||s.setAttribute("paint-order","stroke fill");const y=s.getAttribute("font-family")||s.style.fontFamily;if(y){const g=y.toLowerCase().replace(/[^a-z]/g,"");g.includes("greatvibes")?s.setAttribute("font-family","Great Vibes"):g.includes("poppins")&&s.setAttribute("font-family","Poppins")}})},oi=async e=>{var t,a;if(!l||!e)return la(),!1;try{let s="";if(e.startsWith("data:image/svg+xml")){const g=e.indexOf(","),S=g>=0?e.slice(0,g):e,I=g>=0?e.slice(g+1):"";if(/;base64/i.test(S))try{const re=I.replace(/\s+/g,"");s=typeof window<"u"&&typeof window.atob=="function"?window.atob(re):atob(re)}catch(re){try{s=decodeURIComponent(I)}catch(ae){console.warn("[InkWise Studio] Failed to decode inline SVG data URI.",re,ae),s=""}}else try{s=decodeURIComponent(I)}catch{s=I}}else{const g=await fetch(e,{cache:"no-store"});if(!g.ok)return console.warn("Failed to fetch SVG:",g.status),la(),!1;s=await g.text()}if(!s)return la(),!1;l.innerHTML=s,l.style.display="block";const n=document.getElementById("canvas-loading");n&&(n.style.display="none"),l.setAttribute("preserveAspectRatio","xMidYMid meet"),l.setAttribute("width","100%"),l.setAttribute("height","100%"),l.style.width="100%",l.style.height="100%",l.style.maxWidth="100%",l.style.maxHeight="100%";const r=l.querySelector("svg");r?(r.setAttribute("preserveAspectRatio","xMidYMid meet"),r.setAttribute("width","100%"),r.setAttribute("height","100%"),r.style.width="100%",r.style.height="100%",r.style.maxWidth="100%",r.style.maxHeight="100%",Y=r):Y=l,Y&&(Qe(Y),ps(Y)),Y&&(Y.setAttribute("data-svg-editor","true"),Y.__inkwiseSvgTemplateEditor||(Y.__inkwiseSvgTemplateEditor=new Ra(Y)),ga=Y.__inkwiseSvgTemplateEditor);const f=new DOMParser().parseFromString(s,"image/svg+xml").documentElement;let p=w(f==null?void 0:f.getAttribute("width")),x=w(f==null?void 0:f.getAttribute("height"));if(!Number.isFinite(p)||!Number.isFinite(x)){const g=f==null?void 0:f.getAttribute("viewBox");if(g){const S=g.split(/[\s,]+/).map(Number),I=S[2],$=S[3];!Number.isNaN(I)&&!Number.isNaN($)&&I>0&&$>0&&(p=I,x=$)}}let L=Number.isFinite(p)?p:Number.NaN,y=Number.isFinite(x)?x:Number.NaN;if(V&&Number.isFinite(V.width)&&Number.isFinite(V.height)){const g=V.width/V.height,S=Number.isFinite(L)&&Number.isFinite(y)?L/y:g,I=Math.abs(S-g)/g,$=Number.isFinite(L)?Math.abs(L-V.width)/V.width:Number.POSITIVE_INFINITY,re=Number.isFinite(y)?Math.abs(y-V.height)/V.height:Number.POSITIVE_INFINITY;(!Number.isFinite(L)||!Number.isFinite(y)||I>.02||$>.05&&re>.05)&&(L=V.width,y=V.height)}if(Number.isFinite(L)&&Number.isFinite(y)){const g=(V==null?void 0:V.unit)??"px";Wt(L,y,{unit:g,shape:V==null?void 0:V.shape}),Ot(Ue(L,g),Ue(y,g),"in",2)}const b=Le(l);if(qt(),v){v.innerHTML="";const g=(I,$="",re="")=>{const ae=document.createElement("div");ae.className="text-field-item";const me=document.createElement("span");me.className="text-field-label",me.textContent=re||I,ae.appendChild(me);const G=document.createElement("input");G.type="text",G.className="text-field-input",G.dataset.previewTarget=I,G.value=$||"",G.dataset.defaultValue=$||"",ae.appendChild(G);const j=document.createElement("button");return j.type="button",j.className="text-field-delete",j.setAttribute("aria-label","Delete field"),j.innerHTML='<i class="fa-regular fa-trash-can"></i>',ae.appendChild(j),v.appendChild(ae),Aa(G),Na(ae),G},S=()=>{[["date","Date"],["heading","Heading"],["accent","Accent"],["subheading","Subheading"],["names","Names"],["location","Location"]].forEach(([$,re])=>g($,"",re))};if(b.length>0){let I=!1;const $=new Set,re=new Set;b.forEach(ae=>{var R,qe;const me=ae.getAttribute("data-preview-node");if(!me||$.has(me))return;$.add(me);const G=W(ae);if(de(ae)){I=!0;const At=((R=ae.dataset)==null?void 0:R.previewLabel)||me,nt=((qe=ae.dataset)==null?void 0:qe.defaultText)||Ae(ae)||"",Xt=(At||"").toString().trim().toLowerCase(),_a=(nt||"").toString().trim().toLowerCase(),ge=`${Xt}|${_a}`;if(Xt&&re.has(ge))return;Xt&&re.add(ge),g(me,nt,At)}}),I||S()}else S()}const C=(a=(t=te==null?void 0:te.orderSummary)==null?void 0:t.metadata)==null?void 0:a.design;return C&&jt(C),b.forEach(g=>{const S=g.getAttribute("data-preview-node");if(!S)return;const I=W(g),$=de(g);I&&g.setAttribute("data-changeable","image"),Xe(g)&&Ve(g),$?(g.setAttribute("contenteditable","true"),g.style.cursor="text",g.style.userSelect="text",g.addEventListener("input",()=>{const me=document.querySelector(`#textFieldList input[data-preview-target="${S}"]`);me&&(me.value=Ae(g)),g.dataset.currentText=Ae(g)||"",ie(),E==null||E.schedule("text-edit")}),g.addEventListener("click",()=>{xt(S),Ea(S)})):I&&(g.style.cursor="pointer",g.addEventListener("click",()=>{g.dataset.locked!=="true"&&(St(S),bt(g))}));const ae=document.querySelector(`#textFieldList input[data-preview-target="${S}"]`);ae&&$&&(ae.addEventListener("input",()=>{We(g,ae.value),E==null||E.schedule("text-change")}),ae.value&&ae.value.trim()!==""?We(g,ae.value):ae.value=Ae(g)||"")}),requestAnimationFrame(()=>ie()),Ct(10),!0}catch(s){return console.warn("Could not load SVG for binding:",s),la(),!1}},li=async(e={})=>{var ae,me,G,j;const{scale:t=3,filename:a="inkwise-template.png",download:s=!0}=e,n=Y||l;if(!n)throw new Error("No active canvas to export.");Qe(n);const u=new XMLSerializer().serializeToString(n),f=R=>{const qe=Number(R);return Number.isFinite(qe)?qe:null},p=(n.getAttribute("viewBox")||"").split(/[\s,]+/).map(f),x=p.length===4?p[2]:null,L=p.length===4?p[3]:null,y=f((ae=o==null?void 0:o.dataset)==null?void 0:ae.canvasWidth)||f((me=H==null?void 0:H.dataset)==null?void 0:me.canvasWidth)||x||1080,b=f((G=o==null?void 0:o.dataset)==null?void 0:G.canvasHeight)||f((j=H==null?void 0:H.dataset)==null?void 0:j.canvasHeight)||L||1527,C=Math.max(1,Math.round(y*Math.max(1,t))),g=Math.max(1,Math.round(b*Math.max(1,t))),S=new Image;S.crossOrigin="anonymous",S.src=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(u)}`,await new Promise((R,qe)=>{S.onload=R,S.onerror=qe});const I=document.createElement("canvas");I.width=C,I.height=g;const $=I.getContext("2d");$.fillStyle="#ffffff",$.fillRect(0,0,C,g),$.drawImage(S,0,0,C,g);const re=I.toDataURL("image/png",1);if(s){const R=document.createElement("a");R.href=re,R.download=a,R.click()}return{dataUrl:re,width:C,height:g}};typeof window<"u"&&(window.inkwiseExportCurrentSide=(e={})=>li(e));const Na=e=>{if(!e)return;const t=e.querySelector(".text-field-delete"),a=e.querySelector("input[data-preview-target]");if(!t||!a||t.disabled||t.getAttribute("aria-disabled")==="true")return;t.replaceWith(t.cloneNode(!0)),e.querySelector(".text-field-delete").addEventListener("click",()=>{const n=a.dataset.previewTarget;if(e.remove(),k){const r=k.querySelector(`[data-preview-node="${n}"]`);r==null||r.remove()}if(Y){const r=Y.querySelector(`[data-preview-node="${n}"]`);r==null||r.remove()}deleteStoredTextValue(normalizeSideKey(_e),n),E==null||E.schedule("remove-text-field")})};document.querySelectorAll("#textFieldList .text-field-item").forEach(e=>Na(e));const Ea=e=>{if(!e)return;Ke(),rt("text"),se.forEach(a=>a.classList.remove("active"));const t=document.querySelector('.sidenav-btn[data-nav="text"]');t==null||t.classList.add("active"),setTimeout(()=>{const a=document.querySelector(`#textFieldList input[data-preview-target="${e}"]`);if(a){try{a.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{const r=document.getElementById("textFieldList");r&&(r.scrollTop=a.offsetTop-12)}a.focus({preventScroll:!1});return}const s=document.querySelector("[data-add-text-field]");s==null||s.focus({preventScroll:!1})},60)};Dt=Ea;const Gt=async e=>{if(!ea(e))return;if(E&&_e!==e)try{await E.flush("side-switch")}catch(r){console.debug("[InkWise Studio] Autosave flush failed during side switch.",r)}if(_e=e,!o)return;let t=null;try{t=await ze(e)}catch{console.debug("[InkWise Studio] No autosave data for side:",e)}let a="",s="";t!=null&&t.png?(a=t.png,s=t.svg||""):e==="front"&&tt?(a=tt,s=tt):e==="back"&&at?(a=at,s=at):(s=o.dataset[`${e}Svg`]||"",a=o.dataset[`${e}Image`]||"");let n=!1;if(s&&fs(s)&&await oi(s)&&(n=!0,o.style.backgroundImage="none",o.style.backgroundSize="",ps(Y)),!n){const r=a||o.dataset[`${e}Image`]||"";window!=null&&window.console&&console.debug("[InkWise Studio] Using raster preview for",e,r||"<empty>"),la(),o.style.backgroundImage=r?`url('${r}')`:"",o.style.backgroundSize=r?"cover":"",o.style.backgroundPosition=r?"center center":"",o.style.backgroundRepeat=r?"no-repeat":"",r&&Q(r),qt(),Y=null}m.forEach(r=>{r.classList.toggle("active",r.dataset.cardView===e)}),c.forEach(r=>{const u=r.dataset.cardThumb===e;r.classList.toggle("active",u),r.setAttribute("aria-pressed",u?"true":"false")})};m.forEach(e=>{e.addEventListener("click",()=>{Gt(e.dataset.cardView)})}),c.forEach(e=>{e.addEventListener("click",()=>{Gt(e.dataset.cardThumb)})});const Va=Gt("front");Va&&typeof Va.then=="function"?Va.catch(()=>{}).then(()=>{Ct(6),st("initial-load")}):(Ct(6),st("initial-load"));const ms=document.querySelector(".preview-overlay")||document.querySelector(".preview-canvas-wrapper");ms&&ms.addEventListener("click",e=>{const t=e.target.closest("[data-preview-node]");if(t){e.stopPropagation();const a=t.dataset.previewNode;a&&(W(t)?St(a):(xt(a),Ea(a)))}}),A&&v&&A.addEventListener("click",()=>{console.log("[InkWise Studio] New Text Field button clicked");const e=`custom_${Date.now()}_${le}`;le+=1;const t=document.createElement("div");t.className="text-field-item";const a=document.createElement("span");a.className="text-field-label",a.textContent="Custom",t.appendChild(a);const s=document.createElement("input");s.type="text",s.className="text-field-input",s.placeholder="Add your text",s.dataset.previewTarget=e,t.appendChild(s);const n=document.createElement("button");if(n.type="button",n.className="text-field-delete",n.setAttribute("aria-label","Delete field"),n.innerHTML='<i class="fa-regular fa-trash-can"></i>',t.appendChild(n),v.appendChild(t),k){const u=document.createElement("div");u.className="pill",u.dataset.previewNode=e,u.dataset.defaultText="CUSTOM TEXT",u.textContent="CUSTOM TEXT",k.appendChild(u)}let r=null;console.log("[InkWise Studio] currentSvgRoot:",Y),Y?(console.log("[InkWise Studio] Creating SVG text element"),r=document.createElementNS("http://www.w3.org/2000/svg","text"),r.setAttribute("id",e),r.setAttribute("data-preview-node",e),r.setAttribute("data-default-text","CUSTOM TEXT"),r.setAttribute("x","50%"),r.setAttribute("y","50%"),r.setAttribute("text-anchor","middle"),r.setAttribute("dominant-baseline","middle"),r.setAttribute("font-family","Arial, sans-serif"),r.setAttribute("font-size","24"),r.setAttribute("fill","#000000"),r.textContent="CUSTOM TEXT",r.setAttribute("contenteditable","true"),r.style.cursor="text",r.style.userSelect="text",r.addEventListener("input",()=>{s&&(s.value=r.textContent),r.dataset.currentText=r.textContent||"",ie(),E==null||E.schedule("text-edit")}),r.addEventListener("click",()=>{xt(e),Ea(e)}),Y.appendChild(r),Xe(r)&&Ve(r),console.log("[InkWise Studio] SVG text element created and appended")):console.log("[InkWise Studio] No currentSvgRoot found, skipping SVG text creation"),Aa(s),s.addEventListener("input",()=>{r&&(r.textContent=s.value,r.dataset.currentText=s.value),E==null||E.schedule("text-change")}),xt(e),r&&r.textContent&&r.textContent.trim()!==""?s.value=r.textContent:(s.value="CUSTOM TEXT",r&&(r.textContent="CUSTOM TEXT")),Na(t),setTimeout(()=>{try{v.scrollHeight>v.clientHeight&&v.scrollTo({top:v.scrollHeight,behavior:"smooth"})}catch{v.scrollTop=v.scrollHeight}s.focus({preventScroll:!1})},60)}),tt=null,at=null,_e="front";const ca=document.getElementById("image-upload"),gs=document.getElementById("upload-button"),hs=document.getElementById("quick-upload-button"),Ca=document.getElementById("recentUploadsGrid"),Ia=document.getElementById("quickRecentUploads"),Ga="inkwise_recent_uploads",ys=12,Ya=()=>{try{const e=localStorage.getItem(Ga);return e?JSON.parse(e):[]}catch{return[]}},ci=(e,t,a)=>{const s=Ya(),n={id:Date.now(),dataUrl:e,filename:t,side:a,timestamp:new Date().toISOString()},r=s.filter(f=>f.filename!==t);r.unshift(n);const u=r.slice(0,ys);try{localStorage.setItem(Ga,JSON.stringify(u))}catch{const p=u.slice(0,Math.floor(ys/2));localStorage.setItem(Ga,JSON.stringify(p))}vs(),ws()},bs=(e,t,a="front")=>{var s;if(e&&(ci(e,t||`upload-${Date.now()}`,a),!(ye&&pt(r=>{r.setAttribute("href",e),r.setAttributeNS("http://www.w3.org/1999/xlink","href",e)},{autosaveReason:"image-upload"})))){if(Y){const n=((s=Y.tagName)==null?void 0:s.toLowerCase())==="svg"?Y:Y.closest("svg");if(n){const r=n.getAttribute("viewBox");let u=200,f=200,p=150;if(r){const b=r.split(/[\s,]+/).map(Number);b.length===4&&b.every(Number.isFinite)&&(u=b[0]+b[2]/2,f=b[1]+b[3]/2,p=Math.min(b[2],b[3])*.3)}const x=`uploaded_${Date.now()}`,L=document.createElementNS("http://www.w3.org/2000/svg","image");L.setAttribute("id",x),L.setAttribute("data-preview-node",x),L.setAttribute("href",e),L.setAttributeNS("http://www.w3.org/1999/xlink","href",e),L.setAttribute("x",String(u-p/2)),L.setAttribute("y",String(f-p/2)),L.setAttribute("width",String(p)),L.setAttribute("height",String(p)),L.setAttribute("preserveAspectRatio","xMidYMid meet"),n.appendChild(L),Xe(L)&&Ve(L),St(x),E==null||E.schedule("image-upload");return}}a==="front"?tt=e:a==="back"&&(at=e),_e===a&&Gt(a),E==null||E.schedule("image-upload")}},vs=()=>{if(!Ca)return;const e=Ya();if(e.length===0){Ca.innerHTML=`
                <div class="no-recent-uploads">
                    <p>No recent uploads found. Upload some images above to see them here.</p>
                </div>
            `;return}const t=e.map(s=>`
            <div class="recent-upload-item" data-upload-id="${s.id}" data-image-url="${s.dataUrl}" data-side="${s.side}">
                <img src="${s.dataUrl}" alt="${s.filename}" loading="lazy">
                <div class="upload-info">
                    <span>${s.filename}</span>
                </div>
            </div>
        `).join("");Ca.innerHTML=t;const a=Ca.querySelectorAll(".recent-upload-item");a.forEach(s=>{s.addEventListener("click",()=>{var u;const n=s.dataset.imageUrl;if(a.forEach(f=>f.classList.remove("selected")),s.classList.add("selected"),ye&&pt(p=>{p.setAttribute("href",n),p.setAttributeNS("http://www.w3.org/1999/xlink","href",n)},{autosaveReason:"image-select"})){s.style.transform="scale(0.95)",setTimeout(()=>{s.style.transform=""},150);return}if(Y){const f=((u=Y.tagName)==null?void 0:u.toLowerCase())==="svg"?Y:Y.closest("svg");if(f){const p=f.getAttribute("viewBox");let x=200,L=200,y=150;if(p){const S=p.split(/[\s,]+/).map(Number);S.length===4&&S.every(Number.isFinite)&&(x=S[0]+S[2]/2,L=S[1]+S[3]/2,y=Math.min(S[2],S[3])*.3)}const b=`uploaded_${Date.now()}`,C=document.createElementNS("http://www.w3.org/2000/svg","image");C.setAttribute("id",b),C.setAttribute("data-preview-node",b),C.setAttribute("href",n),C.setAttributeNS("http://www.w3.org/1999/xlink","href",n),C.setAttribute("x",String(x-y/2)),C.setAttribute("y",String(L-y/2)),C.setAttribute("width",String(y)),C.setAttribute("height",String(y)),C.setAttribute("preserveAspectRatio","xMidYMid meet"),f.appendChild(C),Xe(C)&&Ve(C),St(b),E==null||E.schedule("image-select"),s.style.transform="scale(0.95)",setTimeout(()=>{s.style.transform=""},150);return}}const r=s.dataset.side;r==="front"?tt=n:at=n,_e===r&&Gt(r),s.style.transform="scale(0.95)",setTimeout(()=>{s.style.transform=""},150),E==null||E.schedule("image-select")})})},ws=()=>{if(!Ia)return;const t=Ya().slice(0,5);if(t.length===0){Ia.innerHTML="";return}const a=t.map(n=>`
            <div class="quick-recent-upload-item" data-upload-id="${n.id}" data-image-url="${n.dataUrl}" data-side="${n.side}" title="${n.filename}">
                <img src="${n.dataUrl}" alt="${n.filename}" loading="lazy">
            </div>
        `).join("");Ia.innerHTML=a;const s=Ia.querySelectorAll(".quick-recent-upload-item");s.forEach(n=>{n.addEventListener("click",()=>{var f;const r=n.dataset.imageUrl;if(s.forEach(p=>p.classList.remove("selected")),n.classList.add("selected"),ye&&pt(x=>{x.setAttribute("href",r),x.setAttributeNS("http://www.w3.org/1999/xlink","href",r)},{autosaveReason:"image-select"})){n.style.transform="scale(0.9)",setTimeout(()=>{n.style.transform=""},150);return}if(Y){const p=((f=Y.tagName)==null?void 0:f.toLowerCase())==="svg"?Y:Y.closest("svg");if(p){const x=p.getAttribute("viewBox");let L=200,y=200,b=150;if(x){const I=x.split(/[\s,]+/).map(Number);I.length===4&&I.every(Number.isFinite)&&(L=I[0]+I[2]/2,y=I[1]+I[3]/2,b=Math.min(I[2],I[3])*.3)}const C=`uploaded_${Date.now()}`,g=document.createElementNS("http://www.w3.org/2000/svg","image");g.setAttribute("id",C),g.setAttribute("data-preview-node",C),g.setAttribute("href",r),g.setAttributeNS("http://www.w3.org/1999/xlink","href",r),g.setAttribute("x",String(L-b/2)),g.setAttribute("y",String(y-b/2)),g.setAttribute("width",String(b)),g.setAttribute("height",String(b)),g.setAttribute("preserveAspectRatio","xMidYMid meet"),p.appendChild(g),Xe(g)&&Ve(g),St(C),E==null||E.schedule("image-select"),n.style.transform="scale(0.9)",setTimeout(()=>{n.style.transform=""},150);return}}const u=n.dataset.side;u==="front"?tt=r:at=r,_e===u&&Gt(u),n.style.transform="scale(0.9)",setTimeout(()=>{n.style.transform=""},150),E==null||E.schedule("image-select")})})},di=e=>{const t=e.files[0];if(!t)return;const a=new FileReader;a.onload=s=>{const n=s.target.result;bs(n,t.name,"front")},a.readAsDataURL(t)};ca&&ca.addEventListener("change",()=>di(ca)),gs&&gs.addEventListener("click",()=>{ca.click()}),hs&&hs.addEventListener("click",()=>{ca.click()});const ui=e=>{var a;const t=(a=e.clipboardData)==null?void 0:a.items;if(!(!t||t.length===0))for(const s of t){if(!s||typeof s.type!="string"||!s.type.startsWith("image/"))continue;const n=s.getAsFile();if(!n)continue;const r=new FileReader;r.onload=u=>{const f=u.target.result,p=n.name||`pasted-${Date.now()}.png`;bs(f,p,_e||"front")},r.readAsDataURL(n),e.preventDefault();break}};vs(),ws(),document.addEventListener("paste",ui);const Xa=document.querySelectorAll(".pill-with-tooltip"),Ka=document.querySelector(".preview-canvas-wrapper"),Ja=document.querySelector(".preview-guides"),xs=(e,t)=>{e==="safety-pill"&&(Ka==null||Ka.classList.toggle("highlight-safety",t)),e==="bleed-pill"&&(Ja==null||Ja.classList.toggle("highlight-bleed",t))},La=e=>{const t=e==null?void 0:e.querySelector(".canvas-pill"),a=e==null?void 0:e.querySelector(".tooltip");!t||!a||(e.classList.remove("is-active"),t.setAttribute("aria-expanded","false"),a.setAttribute("aria-hidden","true"),xs(t.id,!1))};Xa.forEach(e=>{const t=e.querySelector(".canvas-pill"),a=e.querySelector(".tooltip");!t||!a||(t.addEventListener("click",s=>{s.preventDefault();const n=!e.classList.contains("is-active");Xa.forEach(r=>{r!==e&&La(r)}),n?(e.classList.add("is-active"),t.setAttribute("aria-expanded","true"),a.setAttribute("aria-hidden","false"),xs(t.id,!0)):La(e)}),t.addEventListener("mouseenter",()=>{a.setAttribute("aria-hidden","false")}),t.addEventListener("focus",()=>{a.setAttribute("aria-hidden","false")}),e.addEventListener("mouseleave",()=>{e.classList.contains("is-active")||a.setAttribute("aria-hidden","true")}),t.addEventListener("blur",()=>{!e.contains(document.activeElement)&&!e.classList.contains("is-active")&&a.setAttribute("aria-hidden","true")}),t.addEventListener("keydown",s=>{s.key==="Escape"&&(La(e),t.blur())}))}),document.addEventListener("click",e=>{e.target.closest(".pill-with-tooltip")||Xa.forEach(a=>La(a))});const fi=e=>{if(!e)return!1;const t=Fe(a=>{a.setAttribute("font-family",e),a.style.fontFamily=e},{autosaveReason:"text-font",skipTransformUpdate:!0});if(t){const a=Vt();a&&(a.dataset.fontFamily=e)}return t},pi=e=>{const t=Tt(e,6,400),a=Fe(s=>{s.setAttribute("font-size",t),s.style.fontSize=`${t}px`},{autosaveReason:"text-size"});if(a){const s=Vt();s&&(s.dataset.fontSize=String(t))}return a},mi=e=>{const t=Tt(e,8,400),a=39;return pt(s=>{const n=typeof s.getBBox=="function"?s.getBBox():null,r=parseFloat(s.getAttribute("width")),u=parseFloat(s.getAttribute("height")),f=Number(s.dataset.baseWidth)||(Number.isFinite(r)?r:(n==null?void 0:n.width)||1),p=Number(s.dataset.baseHeight)||(Number.isFinite(u)?u:(n==null?void 0:n.height)||1);s.dataset.baseWidth||(s.dataset.baseWidth=f),s.dataset.baseHeight||(s.dataset.baseHeight=p);const x=t/a,L=Math.max(1,f*x),y=Math.max(1,p*x);s.setAttribute("width",L),s.setAttribute("height",y)},{autosaveReason:"image-scale"})},gi=e=>{const t=_t(e);if(!t)return!1;const a=Fe(s=>{s.setAttribute("fill",t),s.style.fill=t},{autosaveReason:"text-color",skipTransformUpdate:!0});if(a){const s=Vt();s&&(s.dataset.color=t)}return a},hi=e=>{const t=_t(e);if(!t||!o)return!1;try{return o.style.backgroundColor=t,o.dataset.backgroundColor=t,E==null||E.schedule("background-color"),!0}catch(a){return console.warn("[InkWise Studio] Failed to apply background color",a),!1}},yi=e=>{if(!e||!o)return!1;try{return o.style.backgroundImage=`url(${e})`,o.style.backgroundSize="cover",o.style.backgroundPosition="center",o.style.backgroundRepeat="no-repeat",o.dataset.backgroundImage=e,E==null||E.schedule("background-image"),!0}catch(t){return console.warn("[InkWise Studio] Failed to apply background image",t),!1}},bi=e=>new Promise((t,a)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=a,s.readAsDataURL(e)}),vi=e=>{const t=_t(e);return t?pt(a=>{if(t==="#FFFFFF"){const b=a.dataset.tintFilterId;if(b){const C=Ft(a.ownerSVGElement||null),g=C==null?void 0:C.querySelector(`#${b}`);g==null||g.remove(),delete a.dataset.tintFilterId}a.removeAttribute("filter");try{delete a.dataset.tintColor}catch{}return}const s=Ft(a.ownerSVGElement||null);if(!s)return;const n=a.dataset.tintFilterId||`inkwiseImageTint_${Date.now()}_${Math.floor(Math.random()*1e3)}`,r=parseInt(t.slice(1,3),16)/255,u=parseInt(t.slice(3,5),16)/255,f=parseInt(t.slice(5,7),16)/255;let p=s.querySelector(`#${n}`);if(!p){p=document.createElementNS(z,"filter"),p.id=n,p.setAttribute("color-interpolation-filters","sRGB");const b=document.createElementNS(z,"feColorMatrix");b.setAttribute("type","matrix"),b.setAttribute("values","0.2126 0.7152 0.0722 0 0  0.2126 0.7152 0.0722 0 0  0.2126 0.7152 0.0722 0 0  0 0 0 1 0"),p.appendChild(b);const C=document.createElementNS(z,"feComponentTransfer"),g=document.createElementNS(z,"feFuncR");g.setAttribute("type","linear"),C.appendChild(g);const S=document.createElementNS(z,"feFuncG");S.setAttribute("type","linear"),C.appendChild(S);const I=document.createElementNS(z,"feFuncB");I.setAttribute("type","linear"),C.appendChild(I);const $=document.createElementNS(z,"feFuncA");$.setAttribute("type","identity"),C.appendChild($),p.appendChild(C),s.appendChild(p)}const x=p.querySelector("feFuncR"),L=p.querySelector("feFuncG"),y=p.querySelector("feFuncB");x&&x.setAttribute("slope",r.toString()),L&&L.setAttribute("slope",u.toString()),y&&y.setAttribute("slope",f.toString()),a.dataset.tintFilterId=n,a.setAttribute("filter",`url(#${n})`);try{a.dataset.tintColor=t}catch{}},{autosaveReason:"image-color",skipTransformUpdate:!0}):!1},wi=()=>Fe(e=>{const t=e.getAttribute("font-weight")||e.style.fontWeight||"",a=Number(t);t==="bold"||a>=600?(e.setAttribute("font-weight","400"),e.style.fontWeight="400"):(e.setAttribute("font-weight","700"),e.style.fontWeight="700")},{autosaveReason:"text-style",skipTransformUpdate:!0}),xi=()=>Fe(e=>{const t=e.getAttribute("font-style")||e.style.fontStyle||"normal";t==="italic"||t==="oblique"?(e.setAttribute("font-style","normal"),e.style.fontStyle="normal"):(e.setAttribute("font-style","italic"),e.style.fontStyle="italic")},{autosaveReason:"text-style",skipTransformUpdate:!0}),Ss=e=>Fe(t=>{const s=(t.style.textDecoration||t.getAttribute("text-decoration")||"").split(/\s+/).filter(Boolean),n=new Set(s);n.has(e)?n.delete(e):n.add(e);const r=Array.from(n).join(" ");r?(t.style.textDecoration=r,t.setAttribute("text-decoration",r)):(t.style.textDecoration="",t.removeAttribute("text-decoration"))},{autosaveReason:"text-style",skipTransformUpdate:!0}),Si=e=>{const t={"align-left":"start","align-center":"middle","align-right":"end","align-justify":"start"},a={"align-left":"left","align-center":"center","align-right":"right","align-justify":"justify"},s=t[e]||"start",n=a[e]||"left",r=Fe(u=>{u.setAttribute("text-anchor",s);const f=u.getAttribute("x");f&&u.querySelectorAll("tspan").forEach(p=>p.setAttribute("x",f)),u.style.textAlign=n},{autosaveReason:"text-align",skipTransformUpdate:!0});if(r){const u=Vt();u&&(u.dataset.align=n)}return r},ki=e=>{let t=null;const a=Fe(s=>{const n=s.textContent||"";let r=n;e==="uppercase"?r=n.toUpperCase():e==="lowercase"&&(r=n.toLowerCase()),s.textContent=r,s.dataset.currentText=r,t=r},{autosaveReason:"text-transform",skipTransformUpdate:!0});if(a){const s=Vt();s&&t!==null&&(s.value=t)}return a},Ai=()=>{const e=Vt();return Fe(t=>{const s=(t.textContent||"").split(/\r?\n/),n=t.dataset.listType==="bullet"||s.every(u=>u.trim().startsWith("•")),r=n?s.map(u=>u.replace(/^\s*•\s*/u,"")).join(`
`):s.map(u=>{const f=u.trim();return f?`• ${f}`:"•"}).join(`
`);n?delete t.dataset.listType:t.dataset.listType="bullet",t.textContent=r,t.dataset.currentText=r,e&&e.dataset.previewTarget===be&&(e.value=r)},{autosaveReason:"text-list",skipTransformUpdate:!0})},Ni=e=>{const t=Tt(e,.5,5);return Fe(a=>{a.dataset.lineHeight=t,a.style.lineHeight=t},{autosaveReason:"text-spacing",skipTransformUpdate:!0})},Ei=e=>{if(e==null)return!1;const t=Number(e);return Number.isFinite(t)?Fe(a=>{if(Math.abs(t)<1e-4)a.style.letterSpacing="",a.removeAttribute("letter-spacing"),delete a.dataset.letterSpacing;else{const s=`${t.toFixed(2)}em`;a.style.letterSpacing=s,a.setAttribute("letter-spacing",s),a.dataset.letterSpacing=t.toFixed(2)}},{autosaveReason:"text-spacing",skipTransformUpdate:!0}):!1},Ci=e=>{const t=typeof e=="string"?e:"none";return Fe(a=>{switch(t){case"shadow":a.dataset.effectStyle="shadow",a.style.filter="drop-shadow(2px 4px 8px rgba(15, 23, 42, 0.35))",a.style.stroke="",a.style.strokeWidth="",a.style.paintOrder="";break;case"highlight":a.dataset.effectStyle="highlight",a.style.filter="none",a.style.paintOrder="stroke fill",a.style.stroke="rgba(253, 224, 71, 0.85)",a.style.strokeWidth=6;break;case"glitch":a.dataset.effectStyle="glitch",a.style.filter="drop-shadow(-2px 0 rgba(236, 72, 153, 0.5)) drop-shadow(2px 0 rgba(56, 189, 248, 0.5))",a.style.stroke="",a.style.strokeWidth="",a.style.paintOrder="";break;case"echo":a.dataset.effectStyle="echo",a.style.filter="drop-shadow(3px 3px rgba(15, 23, 42, 0.4))",a.style.stroke="",a.style.strokeWidth="",a.style.paintOrder="";break;default:delete a.dataset.effectStyle,a.style.filter="",a.style.stroke="",a.style.strokeWidth="",a.style.paintOrder="";break}},{autosaveReason:"text-effect",skipTransformUpdate:!0})},Ii=e=>{const t=e==="curve"?"curve":"none";return Fe(a=>{t==="curve"?a.dataset.effectShape="curve":delete a.dataset.effectShape},{autosaveReason:"text-effect",skipTransformUpdate:!1})},Li=e=>{const t=Tt(e,0,100)/100;return Fe(a=>{a.style.opacity=t,a.setAttribute("opacity",t)},{autosaveReason:"text-opacity",skipTransformUpdate:!0})},Ti=e=>{const t=Tt(e,0,100)/100;return pt(a=>{a.style.opacity=t,a.setAttribute("opacity",t)},{autosaveReason:"image-opacity",skipTransformUpdate:!0})},_i=e=>{const t=Tt(e,-180,180);return Fe(a=>{Math.abs(t)<1e-4?(delete a.dataset.rotation,a.removeAttribute("data-rotation")):(a.dataset.rotation=t,a.setAttribute("data-rotation",t))},{autosaveReason:"text-rotation",skipTransformUpdate:!1})},Fi=e=>{const t=Tt(e,-180,180);return pt(a=>{Math.abs(t)<1e-4?(delete a.dataset.rotation,a.removeAttribute("data-rotation")):(a.dataset.rotation=t,a.setAttribute("data-rotation",t))},{autosaveReason:"image-rotation",skipTransformUpdate:!1})},ks=(e="text")=>{const t=e.replace(/[^a-z0-9_-]+/gi,"")||"text";let a=`${t}_${Date.now()}`,s=1;for(;document.querySelector(`[data-preview-node="${a}"]`);)a=`${t}_${Date.now()}_${s}`,s+=1;return a},Mi=()=>{const e=Ht();if(e.length===0)return!1;const t=e[0];if(!t||!t.parentNode)return!1;const a=ks(be||"text"),s=t.cloneNode(!0);s.setAttribute("data-preview-node",a),s.dataset.previewNode=a,s.id=a,s.dataset.defaultText=s.dataset.defaultText||s.textContent||"",t.parentNode.appendChild(s),ka(s),Xe(s)&&Ve(s);const r=ni(a,s.textContent||"");return r&&(r.value=s.textContent||"",setTimeout(()=>{try{r.focus({preventScroll:!1})}catch{}},0)),xt(a),ie(),E==null||E.schedule("duplicate-text-node"),!0},Bi=()=>{const e=Ht();if(!e.length)return!1;const t=be;if(e.forEach(a=>{var n;const s=(n=Ne.get(a))==null?void 0:n.overlay;s&&(s.remove(),et.delete(s)),Ne.delete(a),a.remove()}),t){const a=ds(t),s=a==null?void 0:a.closest(".text-field-item");s&&s.remove();const n=si(t);n==null||n.remove()}return xt(null),ie(),E==null||E.schedule("remove-text-node"),!0},ji=()=>{const e=Lt();if(!e.length)return!1;const t=e[0];if(!t||!t.parentNode)return!1;const a=ks(ye||"image"),s=t.cloneNode(!0);s.setAttribute("data-preview-node",a),s.dataset.previewNode=a,s.id=a;const n=parseFloat(t.getAttribute("x"))||0,r=parseFloat(t.getAttribute("y"))||0;return s.setAttribute("x",n+10),s.setAttribute("y",r+10),s.dataset.tintFilterId&&(delete s.dataset.tintFilterId,s.removeAttribute("filter")),t.parentNode.appendChild(s),ka(s),Xe(s)&&Ve(s),St(a),ie(),E==null||E.schedule("duplicate-image-node"),!0},Ri=()=>{const e=Lt();return e.length?(e.forEach(t=>{var s;const a=(s=Ne.get(t))==null?void 0:s.overlay;a&&(a.remove(),et.delete(a)),Ne.delete(t),t.remove()}),St(null),ie(),E==null||E.schedule("remove-image-node"),!0):!1},Pi=()=>{const e=De();if(e==="text"){const t=Fe(a=>{var u;const n=!(a.dataset.locked==="true");n?a.dataset.locked="true":delete a.dataset.locked;const r=(u=Ne.get(a))==null?void 0:u.overlay;r&&(r.classList.toggle("editor-overlay--locked",n),r.style.pointerEvents=n?"none":"")},{autosaveReason:"text-lock",skipTransformUpdate:!0,skipOverlaySync:!0});return t&&ie(),t}if(e==="image"){const t=pt(a=>{var u;const n=!(a.dataset.locked==="true");n?a.dataset.locked="true":delete a.dataset.locked;const r=(u=Ne.get(a))==null?void 0:u.overlay;r&&(r.classList.toggle("editor-overlay--locked",n),r.style.pointerEvents=n?"none":"")},{autosaveReason:"image-lock",skipTransformUpdate:!0,skipOverlaySync:!0});return t&&ie(),t}return!1},$i=()=>{var a;const e=Ht();if(!e.length)return!1;const t=e[0].textContent||"";if(!t)return!1;if((a=navigator==null?void 0:navigator.clipboard)!=null&&a.writeText)return navigator.clipboard.writeText(t).catch(s=>{console.warn("[InkWise Studio] Clipboard write failed.",s)}),!0;try{const s=document.createElement("textarea");return s.value=t,s.style.position="fixed",s.style.opacity="0",document.body.appendChild(s),s.focus(),s.select(),document.execCommand("copy"),s.remove(),!0}catch(s){return console.warn("[InkWise Studio] Clipboard fallback failed.",s),!1}},zi=()=>{var s;const e=Lt();if(!e.length)return!1;const t=e[0],a=t.getAttribute("href")||t.getAttribute("xlink:href")||t.getAttributeNS("http://www.w3.org/1999/xlink","href")||t.dataset.src||"";if(!a)return!1;if((s=navigator==null?void 0:navigator.clipboard)!=null&&s.writeText)return navigator.clipboard.writeText(a).catch(n=>{console.warn("[InkWise Studio] Clipboard write failed for image.",n)}),!0;try{const n=document.createElement("textarea");return n.value=a,n.style.position="fixed",n.style.opacity="0",document.body.appendChild(n),n.focus(),n.select(),document.execCommand("copy"),n.remove(),!0}catch(n){return console.warn("[InkWise Studio] Clipboard fallback failed for image.",n),!1}},Di=()=>{const e=De();return e==="text"?$i():e==="image"?zi():!1},qi=()=>{const e=De();return e==="text"?Mi():e==="image"?ji():!1},Wi=()=>{const e=De();return e==="text"?Bi():e==="image"?Ri():!1},Oi=e=>{const t=De();return t==="text"?Yi(e):t==="image"?Xi(e):!1},Ui=e=>{const t=De();return t==="text"?Li(e):t==="image"?Ti(e):!1},Hi=e=>{const t=De();return t==="text"?_i(e):t==="image"?Fi(e):!1},Vi=e=>{const t=De();return t==="text"?gi(e):t==="image"?vi(e):t==="background"?hi(e):!1},Gi=e=>{const t=De();return t==="text"?pi(e):t==="image"?mi(e):!1},Yi=e=>{const t=Ht();if(!t.length)return!1;const a=t[0],s=a.parentNode;if(!s)return!1;const n=Array.from(s.children),r=n.indexOf(a);if(r===-1)return!1;if(e==="bring-to-front")s.appendChild(a);else if(e==="send-to-back")s.insertBefore(a,n[0]);else if(e==="bring-forward"){const u=Math.min(n.length-1,r+1);if(u!==r){const f=n[u+1]||null;s.insertBefore(a,f)}}else if(e==="send-backward"){const u=Math.max(0,r-1);if(u!==r){const f=n[u];s.insertBefore(a,f)}}else return!1;return ie(),E==null||E.schedule("text-layer"),!0},Xi=e=>{const t=Lt();if(!t.length)return!1;const a=t[0],s=a.parentNode;if(!s)return!1;const n=Array.from(s.children),r=n.indexOf(a);if(r===-1)return!1;if(e==="bring-to-front")s.appendChild(a);else if(e==="send-to-back")s.insertBefore(a,n[0]);else if(e==="bring-forward"){const u=Math.min(n.length-1,r+1);if(u!==r){const f=n[u+1]||null;s.insertBefore(a,f)}}else if(e==="send-backward"){const u=Math.max(0,r-1);if(u!==r){const f=n[u];s.insertBefore(a,f)}}else return!1;return ie(),E==null||E.schedule("image-layer"),!0},Ki={setFontFamily:e=>De()!=="text"?!1:fi(e),setFontSize:e=>Gi(e),setColor:e=>Vi(e),getActiveKey:()=>be,getSelection:()=>{const e=De();return{type:e,key:e==="text"?be:e==="image"?ye:null,textKey:be,imageKey:ye}},dispatch(e,t){const a=De();switch(e){case"bold":a==="text"&&wi();break;case"italic":a==="text"&&xi();break;case"underline":a==="text"&&Ss("underline");break;case"strikethrough":a==="text"&&Ss("line-through");break;case"align-left":case"align-center":case"align-right":case"align-justify":a==="text"&&Si(e);break;case"list-bullets":a==="text"&&Ai();break;case"line-spacing":a==="text"&&Ni(t);break;case"letter-spacing":a==="text"&&Ei(t);break;case"uppercase":case"lowercase":a==="text"&&ki(e);break;case"effect-style":a==="text"&&Ci(t);break;case"effect-shape":a==="text"&&Ii(t);break;case"opacity":Ui(t);break;case"rotation":Hi(t);break;case"layer":Oi(t);break;case"more":t==="duplicate"?qi():t==="delete"?Wi():t==="lock"?Pi():t==="copy"&&Di();break;case"replace-image":const s=document.createElement("input");s.type="file",s.accept="image/*",s.onchange=n=>{const r=n.target.files[0];if(r){const u=new FileReader;u.onload=f=>{const p=f.target.result;pt(x=>{x.setAttribute("href",p),x.setAttributeNS("http://www.w3.org/1999/xlink","href",p)}),E==null||E.schedule("image-replace")},u.readAsDataURL(r)}},s.click();break;case"crop":{const n=Lt();if(!n.length)break;const r=Ne.get(n[0]),u=r==null?void 0:r.overlay;if(!u)break;if(us(),($e==null?void 0:$e.overlay)===u)$e.refresh();else{ft();const f=Ua(u,n[0]);f&&($e=f)}break}default:console.debug("[InkWise Studio] Unhandled toolbar action",e,t);break}}};typeof window<"u"&&(window.inkwiseToolbar=Ki);const Yt=document.getElementById("canvas-zoom-select"),As=document.getElementById("canvas-zoom-display"),Ji=document.querySelectorAll("[data-zoom-step]"),Ns=document.querySelector(".preview-canvas-wrapper"),Ta=T,kt=[.25,.5,.75,1,1.5,2,3];if(Yt&&Ns&&Ta){const e=a=>{Ta.style.setProperty("--canvas-scale",a.toString()),Ns.style.removeProperty("transform"),Yt.value=a.toString(),As&&(As.textContent=`${Math.round(a*100)}%`),ie()},t=a=>{const s=parseFloat(Yt.value)||1,n=kt.indexOf(s);if(n===-1)return;let r=n;a==="up"&&n<kt.length-1&&(r=n+1),a==="down"&&n>0&&(r=n-1),r!==n&&e(kt[r])};Yt.addEventListener("change",a=>{const s=parseFloat(a.target.value)||1;e(s)}),Ji.forEach(a=>{a.addEventListener("click",()=>{const s=a.dataset.zoomStep;s&&t(s==="up"?"up":"down")})}),Ta&&Ta.addEventListener("wheel",a=>{a.preventDefault();const s=parseFloat(Yt.value)||1;let n=s;if(a.deltaY>0){const r=kt.indexOf(s);r>0&&(n=kt[r-1])}else{const r=kt.indexOf(s);r<kt.length-1&&(n=kt[r+1])}n!==s&&e(n)},{passive:!1}),e(parseFloat(Yt.value)||1)}document.addEventListener("focusin",e=>{e.target.matches("#textFieldList input")&&document.body.classList.add("text-toolbar-visible")}),document.addEventListener("focusout",e=>{e.target.matches("#textFieldList input")&&setTimeout(()=>{const t=document.activeElement,a=t&&typeof t.matches=="function"&&t.matches("#textFieldList input"),s=t&&typeof t.closest=="function"&&t.closest(".studio-react-widgets");!a&&!s&&(be||ye||Pe?ra():document.body.classList.remove("text-toolbar-visible"))},100)})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",J,{once:!0}):J()}const ts=[{name:"Lobster",family:"Lobster",weight:"400",style:"normal"},{name:"Fredoka One",family:"Fredoka One",weight:"400",style:"normal"},{name:"Pacifico",family:"Pacifico",weight:"400",style:"normal"},{name:"Baloo 2",family:"Baloo 2",weight:"400",style:"normal"},{name:"Poppins Bold",family:"Poppins",weight:"700",style:"normal"},{name:"Anton",family:"Anton",weight:"400",style:"normal"},{name:"Gochi Hand",family:"Gochi Hand",weight:"400",style:"normal"},{name:"Bangers",family:"Bangers",weight:"400",style:"normal"},{name:"Chewy",family:"Chewy",weight:"400",style:"normal"},{name:"Rubik ExtraBold",family:"Rubik",weight:"800",style:"normal"},{name:"Comic Neue Bold",family:"Comic Neue",weight:"700",style:"normal"},{name:"Amatic SC Bold",family:"Amatic SC",weight:"700",style:"normal"},{name:"Luckiest Guy",family:"Luckiest Guy",weight:"400",style:"normal"},{name:"Kalam Bold",family:"Kalam",weight:"700",style:"normal"},{name:"Bubblegum Sans",family:"Bubblegum Sans",weight:"400",style:"normal"},{name:"Shrikhand",family:"Shrikhand",weight:"400",style:"normal"},{name:"Jua",family:"Jua",weight:"400",style:"normal"},{name:"DynaPuff",family:"DynaPuff",weight:"400",style:"normal"},{name:"Cabin Sketch",family:"Cabin Sketch",weight:"400",style:"normal"},{name:"Titan One",family:"Titan One",weight:"400",style:"normal"},{name:"Montserrat SemiBold",family:"Montserrat",weight:"600",style:"normal"},{name:"Helvetica Neue",family:"Helvetica Neue",weight:"400",style:"normal"},{name:"Lato Bold",family:"Lato",weight:"700",style:"normal"},{name:"Source Sans Pro",family:"Source Sans Pro",weight:"400",style:"normal"},{name:"Poppins Medium",family:"Poppins",weight:"500",style:"normal"},{name:"Roboto Condensed",family:"Roboto Condensed",weight:"400",style:"normal"},{name:"Open Sans",family:"Open Sans",weight:"400",style:"normal"},{name:"Oswald",family:"Oswald",weight:"400",style:"normal"},{name:"Nunito Sans",family:"Nunito Sans",weight:"400",style:"normal"},{name:"Inter SemiBold",family:"Inter",weight:"600",style:"normal"},{name:"Futura PT",family:"Futura PT",weight:"400",style:"normal"},{name:"Avenir Next",family:"Avenir Next",weight:"400",style:"normal"},{name:"Work Sans Medium",family:"Work Sans",weight:"500",style:"normal"},{name:"Proxima Nova",family:"Proxima Nova",weight:"400",style:"normal"},{name:"IBM Plex Sans",family:"IBM Plex Sans",weight:"400",style:"normal"},{name:"Barlow SemiCondensed",family:"Barlow Semi Condensed",weight:"400",style:"normal"},{name:"Sora",family:"Sora",weight:"400",style:"normal"},{name:"Metropolis",family:"Metropolis",weight:"400",style:"normal"},{name:"Urbanist",family:"Urbanist",weight:"400",style:"normal"},{name:"Manrope",family:"Manrope",weight:"400",style:"normal"},{name:"Quicksand Light",family:"Quicksand",weight:"300",style:"normal"},{name:"Great Vibes",family:"Great Vibes",weight:"400",style:"normal"},{name:"Parisienne",family:"Parisienne",weight:"400",style:"normal"},{name:"Nunito Light",family:"Nunito",weight:"300",style:"normal"},{name:"Cormorant Garamond",family:"Cormorant Garamond",weight:"400",style:"normal"},{name:"Playfair Display",family:"Playfair Display",weight:"400",style:"normal"},{name:"Allura",family:"Allura",weight:"400",style:"normal"},{name:"DM Sans",family:"DM Sans",weight:"400",style:"normal"},{name:"Satisfy",family:"Satisfy",weight:"400",style:"normal"},{name:"Karla",family:"Karla",weight:"400",style:"normal"},{name:"Josefin Light",family:"Josefin Sans",weight:"300",style:"normal"},{name:"Merriweather Light",family:"Merriweather",weight:"300",style:"normal"},{name:"Sacramento",family:"Sacramento",weight:"400",style:"normal"},{name:"Dancing Script",family:"Dancing Script",weight:"400",style:"normal"},{name:"Marcellus",family:"Marcellus",weight:"400",style:"normal"},{name:"Crimson Pro",family:"Crimson Pro",weight:"400",style:"normal"},{name:"ABeeZee",family:"ABeeZee",weight:"400",style:"normal"},{name:"GFS Didot",family:"GFS Didot",weight:"400",style:"normal"},{name:"Overlock Light",family:"Overlock",weight:"300",style:"normal"},{name:"Hind Soft",family:"Hind",weight:"400",style:"normal"},{name:"Cinzel",family:"Cinzel",weight:"400",style:"normal"},{name:"Cormorant Infant",family:"Cormorant Infant",weight:"400",style:"normal"},{name:"Playfair Display Italic",family:"Playfair Display",weight:"400",style:"italic"},{name:"Alex Brush",family:"Alex Brush",weight:"400",style:"normal"},{name:"Montserrat Light",family:"Montserrat",weight:"300",style:"normal"},{name:"Bodoni Moda",family:"Bodoni Moda",weight:"400",style:"normal"},{name:"Cormorant Upright",family:"Cormorant Upright",weight:"400",style:"normal"},{name:"Libre Baskerville Italic",family:"Libre Baskerville",weight:"400",style:"italic"},{name:"Tangerine",family:"Tangerine",weight:"400",style:"normal"},{name:"Cinzel Decorative",family:"Cinzel Decorative",weight:"400",style:"normal"},{name:"Forum",family:"Forum",weight:"400",style:"normal"},{name:"Cardo Italic",family:"Cardo",weight:"400",style:"italic"},{name:"Unna Italic",family:"Unna",weight:"400",style:"italic"},{name:"Prata",family:"Prata",weight:"400",style:"normal"},{name:"Gilda Display",family:"Gilda Display",weight:"400",style:"normal"},{name:"Cormorant SC",family:"Cormorant SC",weight:"400",style:"normal"},{name:"Quattrocento",family:"Quattrocento",weight:"400",style:"normal"},{name:"Marcellus SC",family:"Marcellus SC",weight:"400",style:"normal"}],dr=[12,14,16,18,24,32,36,39,42,48,60];function as(J,i,o){return Math.min(Math.max(J,i),o)}function ur({onFontChange:J=()=>{},onSizeChange:i=()=>{},onAction:o=()=>{},onColorChange:l=()=>{},activeElementType:c=null}){const m=P.useMemo(()=>ts[0],[]),[k,v]=P.useState(m),[A,se]=P.useState(39),[T,z]=P.useState(!1),[D,U]=P.useState(!1),H=P.useRef(null),le=P.useRef(null),[Z,q]=P.useState(!1),ee=P.useRef(null),[W,de]=P.useState(!1),Ae=P.useRef(null),[We,Ce]=P.useState(!1),ht=P.useRef(null),[Qe,te]=P.useState("#FFFFFF"),[Te,Oe]=P.useState([]),fa=P.useMemo(()=>[{label:"Grayscale",colors:["#FFFFFF","#E5E7EB","#9CA3AF","#4B5563","#111827"]},{label:"Blues",colors:["#DCEEFB","#A8D1FF","#4DA1FF","#2563EB","#0B3D91"]},{label:"Greens",colors:["#DEF7EC","#BFEBD3","#34D399","#059669","#064E3B"]},{label:"Yellows",colors:["#FFFBEB","#FEF3C7","#FBBF24","#F59E0B","#B45309"]},{label:"Oranges",colors:["#FFF1E6","#FFD8B5","#FB923C","#F97316","#7C2D12"]},{label:"Reds",colors:["#FFEFF2","#FFD6DD","#EF4444","#DC2626","#58151C"]}],[]),[Nt,ot]=P.useState(0),[Mt,Bt]=P.useState(0),[jt,pa]=P.useState(100),[lt,Rt]=P.useState("swatches"),Ue=P.useRef(null),ma=P.useRef(!1),je=c==="text",V=c==="image",Se=je||V,[Pt,$t]=P.useState(0),[Re,Ne]=P.useState(0),[et,zt]=P.useState(0),[we,Y]=P.useState(0);function ga(w,F,Q,he){const Ie=w/100,Le=F/100,Be=Q/100,Ke=he/100,rt=Math.round(255*(1-Ie)*(1-Ke)),$a=Math.round(255*(1-Le)*(1-Ke)),Ut=Math.round(255*(1-Be)*(1-Ke)),M=xa=>xa.toString(16).padStart(2,"0").toUpperCase();return`#${M(rt)}${M($a)}${M(Ut)}`}P.useEffect(()=>{try{const w=typeof window<"u"?window.inkwiseToolbar:null;if(w&&typeof w.getSelection=="function"){const F=w.getSelection();if(F){if(F.fontFamily){const Q=ts.find(he=>he.family===F.fontFamily||he.name===F.fontFamily);Q&&v(Q)}Number.isFinite(Number(F.fontSize))&&se(Number(F.fontSize)),F.color&&te(String(F.color))}}}catch{}if(lt==="cmyk")try{const w=ga(Pt,Re,et,we);te(w),l(w)}catch{}},[Pt,Re,et,we,lt]);function Dt(w){const F=w.replace("#",""),Q=parseInt(F,16),he=Q>>16&255,Ie=Q>>8&255,Le=Q&255;return{r:he,g:Ie,b:Le}}function _e(w,F,Q){w/=255,F/=255,Q/=255;const he=Math.max(w,F,Q),Ie=Math.min(w,F,Q);let Le=0,Be=0,Ke=(he+Ie)/2;if(he!==Ie){const rt=he-Ie;switch(Be=Ke>.5?rt/(2-he-Ie):rt/(he+Ie),he){case w:Le=(F-Q)/rt+(F<Q?6:0);break;case F:Le=(Q-w)/rt+2;break;case Q:Le=(w-F)/rt+4;break}Le/=6}return{h:Math.round(Le*360),s:Math.round(Be*100),l:Math.round(Ke*100)}}function tt(w,F,Q){F/=100,Q/=100;const he=Be=>(Be+w/30)%12,Ie=F*Math.min(Q,1-Q),Le=Be=>{const Ke=Q-Ie*Math.max(-1,Math.min(he(Be)-3,Math.min(9-he(Be),1)));return Math.round(255*Ke).toString(16).padStart(2,"0")};return`#${Le(0)}${Le(8)}${Le(4)}`.toUpperCase()}P.useEffect(()=>{try{const w=Dt(Qe.replace("#","")),{h:F,s:Q,l:he}=_e(w.r,w.g,w.b);ot(F),Bt(Q),pa(he)}catch{}},[Qe]),P.useEffect(()=>{const w=tt(Nt,Mt,jt);te(w)},[Nt,Mt,jt]);const at=w=>{ma.current=!0,E(w),window.addEventListener("mousemove",E),window.addEventListener("mouseup",Et)},E=w=>{if(!Ue.current)return;const F=Ue.current.getBoundingClientRect(),Q=Math.min(Math.max(0,(w.clientX-F.left)/F.width),1),he=Math.min(Math.max(0,(w.clientY-F.top)/F.height),1),Ie=Math.round(Q*100),Le=Math.round((1-he)*100);Bt(Ie),pa(Le)},Et=()=>{ma.current=!1,window.removeEventListener("mousemove",E),window.removeEventListener("mouseup",Et)};P.useEffect(()=>{const w=Q=>{(T&&H.current&&!H.current.contains(Q.target)||D&&le.current&&!le.current.contains(Q.target)||Z&&ee.current&&!ee.current.contains(Q.target)||W&&Ae.current&&!Ae.current.contains(Q.target)||Qt&&ea.current&&!ea.current.contains(Q.target)||ta&&yt.current&&!yt.current.contains(Q.target)||aa&&st.current&&!st.current.contains(Q.target)||bt&&Ve.current&&!Ve.current.contains(Q.target))&&(z(!1),U(!1),q(!1),de(!1),xe(!1),Me(!1),ze(!1),ct(!1))},F=Q=>{(Q.key==="Escape"||Q.key==="Esc")&&(z(!1),U(!1),q(!1),de(!1),xe(!1),Me(!1),ze(!1),ct(!1),ie(!1),it(!1),ut(!1),Ce(!1))};return(T||D||Z||W||Qt||ta||aa||We||bt||ba||va||It)&&(document.addEventListener("mousedown",w),document.addEventListener("keydown",F)),()=>{document.removeEventListener("mousedown",w),document.removeEventListener("keydown",F)}},[T,D]);const be=w=>{je&&(v(w),J(w.family),z(!1))},ye=w=>{const F=(w||"#FFFFFF").toUpperCase();te(F),l(F),Oe(Q=>[F,...Q.filter(Ie=>Ie!==F)].slice(0,8)),U(!1)},Pe=w=>{const F=as(w,8,96);se(F),i(F)},$e=w=>{Se&&Pe(A+w)},ha=w=>{if(!Se)return;const F=Number(w.target.value);Number.isFinite(F)&&Pe(F)},[Qt,xe]=P.useState(!1),ea=P.useRef(null),[ta,Me]=P.useState(!1),yt=P.useRef(null),[aa,ze]=P.useState(!1),st=P.useRef(null),[ya,sa]=P.useState(1.4),[He,Ye]=P.useState(.12),[bt,ct]=P.useState(!1),[qt,dt]=P.useState(100),Ve=P.useRef(null),[ba,ie]=P.useState(!1),[Ct,ia]=P.useState(0),Pa=P.useRef(null),[va,it]=P.useState(!1),wa=P.useRef(null),[It,ut]=P.useState(!1),Xe=P.useRef(null);P.useEffect(()=>{je||(z(!1),q(!1),de(!1),xe(!1),Me(!1),ze(!1),Ce(!1))},[je]),P.useEffect(()=>{Se||(U(!1),ct(!1),ie(!1),it(!1),ut(!1))},[Se]);const Wt=()=>{je&&(sa(1.4),o("line-spacing")(1.4))},Ot=()=>{je&&(Ye(.12),o("letter-spacing")(.12))};return d.jsxs("div",{className:`text-mini-toolbar ${Se?"floating":""}`,role:"toolbar","aria-label":V?"Image editing toolbar":"Text editing toolbar",children:[d.jsxs("div",{className:"toolbar-group toolbar-group--font",children:[V?d.jsxs(d.Fragment,{children:[d.jsx("button",{type:"button",className:"ghost-button",onClick:()=>o("replace-image"),children:"Replace Image"}),d.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),d.jsxs("button",{type:"button",className:"ghost-button",onClick:()=>o("crop"),children:[d.jsx("i",{className:"fa-solid fa-crop-simple"})," Crop"]})]}):d.jsxs("button",{type:"button",className:"font-select-button",onClick:()=>{je&&z(w=>!w)},"aria-label":je?"Choose font family":"Font selection available for text elements","aria-haspopup":"listbox","aria-expanded":T,disabled:!je,children:[je?k.name:"Select element"," ",d.jsx("i",{className:"fa-solid fa-chevron-down","aria-hidden":"true"})]}),je&&T&&d.jsx("div",{className:"font-modal",ref:H,children:d.jsx("div",{className:"font-modal-content",children:ts.map(w=>d.jsx("button",{type:"button",className:"font-option",onClick:()=>be(w),style:{fontFamily:w.family,fontWeight:w.weight,fontStyle:w.style},children:w.name},w.name))})})]}),d.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),d.jsxs("div",{className:"toolbar-group toolbar-group--size",role:"group","aria-label":V?"Image scale":"Font size",children:[d.jsx("button",{type:"button",className:"ghost-button","aria-label":V?"Decrease image scale":"Decrease font size",onClick:()=>$e(-2),disabled:!Se,children:d.jsx("i",{className:"fa-solid fa-minus","aria-hidden":"true"})}),d.jsx("label",{className:"sr-only",htmlFor:"mini-toolbar-size",children:V?"Image scale":"Font size"}),d.jsx("select",{id:"mini-toolbar-size",className:"size-select",value:A,onChange:ha,disabled:!Se,children:dr.map(w=>d.jsx("option",{value:w,children:w},w))}),d.jsx("button",{type:"button",className:"ghost-button","aria-label":V?"Increase image scale":"Increase font size",onClick:()=>$e(2),disabled:!Se,children:d.jsx("i",{className:"fa-solid fa-plus","aria-hidden":"true"})})]}),d.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),d.jsxs("div",{style:{position:"relative"},children:[d.jsx("button",{type:"button",className:"color-swatch","aria-label":V?"Choose image tint":"Choose text color",onClick:()=>{Se&&(z(!1),U(w=>!w))},disabled:!Se,"aria-expanded":D,children:d.jsx("span",{className:"color-swatch__chip",style:{background:Qe}})}),D&&d.jsx("div",{className:"color-modal",ref:le,children:d.jsxs("div",{className:"color-modal-content",children:[d.jsxs("div",{className:"color-modal-header",children:[d.jsx("div",{className:"color-modal-title",children:V?"Image tint":"Text color"}),d.jsx("button",{type:"button",className:"ghost-button",onClick:()=>U(!1),"aria-label":"Close color picker",children:d.jsx("i",{className:"fa-solid fa-x"})})]}),d.jsx("div",{className:"color-picker-area",children:d.jsx("div",{className:"inline-color-picker",children:d.jsxs("div",{className:"spectrum-picker",children:[d.jsx("div",{className:"spectrum-area",ref:Ue,onMouseDown:at,style:{background:`linear-gradient(to right, #fff, hsl(${Nt}, 100%, 50%)), linear-gradient(to top, rgba(0,0,0,0), rgba(0,0,0,1))`},role:"application","aria-label":"Color spectrum",children:d.jsx("div",{className:"spectrum-handle",style:{left:`${Mt}%`,top:`${100-jt}%`},"aria-hidden":"true"})}),d.jsx("div",{className:"hue-row",children:d.jsx("input",{className:"hue-range",type:"range",min:"0",max:"360",value:Nt,onChange:w=>ot(Number(w.target.value)),style:{background:`linear-gradient(to right, ${Array.from({length:13}).map((w,F)=>`hsl(${F*30},100%,50%)`).join(",")})`},"aria-label":"Hue"})}),d.jsxs("div",{className:"hex-row",children:[d.jsx("input",{type:"text",className:"hex-input",value:tt(Nt,Mt,jt),onChange:w=>te(w.target.value),"aria-label":"Hex color value"}),d.jsx("button",{type:"button",className:"eyedropper-button",title:"Eyedropper","aria-label":"Eyedropper",children:d.jsx("i",{className:"fa-solid fa-eye-dropper"})})]})]})})}),d.jsxs("div",{className:"swatch-sections",children:[d.jsxs("div",{className:"tabs",children:[d.jsx("div",{className:`tab ${lt==="swatches"?"active":""}`,onClick:()=>Rt("swatches"),children:"Swatches"}),d.jsx("div",{className:`tab ${lt==="cmyk"?"active":""}`,onClick:()=>Rt("cmyk"),children:"CMYK"})]}),d.jsx("div",{className:"section-divider","aria-hidden":"true"}),lt==="swatches"&&d.jsxs(d.Fragment,{children:[Te.length>0&&d.jsxs("div",{className:"swatch-section",children:[d.jsx("div",{className:"swatch-title",children:"Recent colors"}),d.jsx("div",{className:"swatches-grid",children:Te.map(w=>d.jsx("button",{type:"button",className:"swatch",style:{background:w},onClick:()=>ye(w)},w))})]}),Te.length>0&&fa.length>0&&d.jsx("div",{className:"section-divider","aria-hidden":"true"}),d.jsx("div",{className:"swatch-section",children:d.jsx("div",{className:"preset-groups",children:fa.map((w,F)=>d.jsx("div",{className:"swatch-group",children:d.jsx("div",{className:"swatches-grid preset",children:w.colors.map(Q=>d.jsx("button",{type:"button",className:"swatch",style:{background:Q},onClick:()=>ye(Q)},Q))})},F))})})]}),lt==="cmyk"&&d.jsxs("div",{className:"swatch-section cmyk-section",children:[d.jsx("div",{className:"swatch-title",children:"CMYK (preview)"}),d.jsxs("div",{className:"cmyk-row",children:[d.jsx("div",{className:"cmyk-label",children:"C"}),d.jsx("input",{type:"range",min:"0",max:"100",value:Pt,onChange:w=>$t(Number(w.target.value)),className:"cmyk-range c-range","aria-label":"Cyan"}),d.jsxs("div",{className:"cmyk-value",children:[Pt,"%"]})]}),d.jsxs("div",{className:"cmyk-row",children:[d.jsx("div",{className:"cmyk-label",children:"M"}),d.jsx("input",{type:"range",min:"0",max:"100",value:Re,onChange:w=>Ne(Number(w.target.value)),className:"cmyk-range m-range","aria-label":"Magenta"}),d.jsxs("div",{className:"cmyk-value",children:[Re,"%"]})]}),d.jsxs("div",{className:"cmyk-row",children:[d.jsx("div",{className:"cmyk-label",children:"Y"}),d.jsx("input",{type:"range",min:"0",max:"100",value:et,onChange:w=>zt(Number(w.target.value)),className:"cmyk-range y-range","aria-label":"Yellow"}),d.jsxs("div",{className:"cmyk-value",children:[et,"%"]})]}),d.jsxs("div",{className:"cmyk-row",children:[d.jsx("div",{className:"cmyk-label",children:"K"}),d.jsx("input",{type:"range",min:"0",max:"100",value:we,onChange:w=>Y(Number(w.target.value)),className:"cmyk-range k-range","aria-label":"Key Black"}),d.jsxs("div",{className:"cmyk-value",children:[we,"%"]})]})]})]})]})})]}),je&&d.jsxs(d.Fragment,{children:[d.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),d.jsxs("div",{className:"toolbar-group toolbar-group--actions",role:"group","aria-label":"Text format actions",style:{position:"relative"},children:[d.jsx("button",{type:"button",className:"ghost-button","aria-label":"Bold",onClick:()=>{q(w=>!w),U(!1),z(!1)},children:d.jsx("span",{className:"toolbar-label",children:"B"})}),Z&&d.jsx("div",{className:"format-modal",ref:ee,role:"dialog","aria-label":"Text formatting options",children:d.jsxs("div",{className:"format-modal-content",children:[d.jsx("button",{type:"button",className:"format-option",title:"Bold",onClick:()=>{o("bold"),q(!1)},children:d.jsx("i",{className:"fi fi-ss-bold","aria-hidden":"true"})}),d.jsx("button",{type:"button",className:"format-option",title:"Italic",onClick:()=>{o("italic"),q(!1)},children:d.jsx("i",{className:"fi fi-br-italic","aria-hidden":"true"})}),d.jsx("button",{type:"button",className:"format-option",title:"Underline",onClick:()=>{o("underline"),q(!1)},children:d.jsx("i",{className:"fi fi-br-underline","aria-hidden":"true"})}),d.jsx("button",{type:"button",className:"format-option",title:"Strikethrough",onClick:()=>{o("strikethrough"),q(!1)},children:d.jsx("i",{className:"fi fi-br-strikethrough","aria-hidden":"true"})})]})}),d.jsx("button",{type:"button",className:"ghost-button","aria-label":"Align center",onClick:()=>{xe(w=>!w),q(!1),U(!1),z(!1)},children:d.jsx("i",{className:"fa-solid fa-align-center","aria-hidden":"true"})}),Qt&&d.jsx("div",{className:"align-modal",ref:ea,role:"dialog","aria-label":"Alignment options",children:d.jsxs("div",{className:"align-modal-content",children:[d.jsx("button",{type:"button",className:"align-option",title:"Align-justify",onClick:()=>{o("align-justify"),xe(!1)},children:d.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[d.jsx("rect",{x:"3",y:"4",width:"18",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"3",y:"9",width:"18",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"3",y:"14",width:"18",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1",fill:"currentColor"})]})}),d.jsx("button",{type:"button",className:"align-option",title:"Align-center",onClick:()=>{o("align-center"),xe(!1)},children:d.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[d.jsx("rect",{x:"5",y:"4",width:"14",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"3",y:"9",width:"18",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"5",y:"14",width:"14",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1",fill:"currentColor"})]})}),d.jsx("button",{type:"button",className:"align-option",title:"Align-left",onClick:()=>{o("align-left"),xe(!1)},children:d.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[d.jsx("rect",{x:"3",y:"4",width:"12",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"3",y:"9",width:"18",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"3",y:"14",width:"12",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1",fill:"currentColor"})]})}),d.jsx("button",{type:"button",className:"align-option",title:"Align-right",onClick:()=>{o("align-right"),xe(!1)},children:d.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[d.jsx("rect",{x:"9",y:"4",width:"12",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"3",y:"9",width:"18",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"9",y:"14",width:"12",height:"2",rx:"1",fill:"currentColor"}),d.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1",fill:"currentColor"})]})})]})}),d.jsx("button",{type:"button",className:"ghost-button","aria-label":"Bulleted list",onClick:()=>{Me(w=>!w),xe(!1),q(!1),U(!1),z(!1)},children:d.jsx("i",{className:"fa-solid fa-list-ul","aria-hidden":"true"})}),ta&&d.jsx("div",{className:"list-modal",ref:yt,role:"dialog","aria-label":"List options",children:d.jsxs("div",{className:"list-modal-content",children:[d.jsx("button",{type:"button",className:"list-option",title:"Numbered list",onClick:()=>{Me(!1),ze(!0)},children:d.jsx("i",{className:"fa-solid fa-list-ol","aria-hidden":"true"})}),d.jsx("button",{type:"button",className:"list-option",title:"Bulleted list",onClick:()=>{o("list-bullets"),Me(!1)},children:d.jsx("i",{className:"fa-solid fa-list-ul","aria-hidden":"true"})})]})}),d.jsx("button",{type:"button",className:"ghost-button","aria-label":"Numbered list",onClick:()=>{ze(w=>!w),Me(!1),xe(!1),q(!1),U(!1),z(!1)},children:d.jsx("i",{className:"fa-solid fa-text-height","aria-hidden":"true"})}),aa&&d.jsx("div",{className:"number-modal",ref:st,role:"dialog","aria-label":"Text spacing options",children:d.jsxs("div",{className:"number-modal-content",children:[d.jsxs("div",{className:"slider-row number-row",children:[d.jsx("label",{className:"slider-label",children:"Line spacing"}),d.jsx("input",{type:"range",min:"0.8",max:"3",step:"0.01",value:ya,onChange:w=>{const F=Number(w.target.value);sa(F),o("line-spacing")(F)},className:"number-range line-range","aria-label":"Line spacing"}),d.jsx("button",{type:"button",className:"reset-button",title:"Reset",onClick:Wt,"aria-label":"Reset line spacing",children:"⟲"}),d.jsx("input",{className:"slider-value-input",type:"number",step:"0.01",value:ya,onChange:w=>{const F=Number(w.target.value);sa(F),o("line-spacing")(F)}})]}),d.jsxs("div",{className:"slider-row number-row",children:[d.jsx("label",{className:"slider-label",children:"Letter spacing"}),d.jsx("input",{type:"range",min:"-0.5",max:"1",step:"0.01",value:He,onChange:w=>{const F=Number(w.target.value);Ye(F),o("letter-spacing")(F)},className:"number-range letter-range","aria-label":"Letter spacing"}),d.jsx("button",{type:"button",className:"reset-button",title:"Reset",onClick:Ot,"aria-label":"Reset letter spacing",children:"⟲"}),d.jsx("input",{className:"slider-value-input",type:"number",step:"0.01",value:He,onChange:w=>{const F=Number(w.target.value);Ye(F),o("letter-spacing")(F)}})]})]})})]}),d.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),d.jsxs("div",{className:"toolbar-group toolbar-group--menu",role:"group","aria-label":"Text styles",style:{position:"relative"},children:[d.jsx("button",{type:"button",className:"text-button",onClick:()=>{de(w=>!w),Me(!1),xe(!1),U(!1),z(!1),ze(!1),q(!1),Ce(!1)},"aria-label":"Format",children:"Format"}),W&&d.jsx("div",{className:"case-modal format-modal",ref:Ae,role:"dialog","aria-label":"Case options",children:d.jsxs("div",{className:"format-modal-content",children:[d.jsx("button",{type:"button",className:"format-option ",title:"Lowercase",onClick:()=>{o("lowercase"),de(!1)},children:d.jsx("span",{className:"format-text-icon","aria-hidden":"true",children:"a"})}),d.jsx("button",{type:"button",className:"format-option ",title:"Uppercase",onClick:()=>{o("uppercase"),de(!1)},children:d.jsx("span",{className:"format-text-icon","aria-hidden":"true",children:"A"})})]})}),d.jsxs("button",{type:"button",className:"text-button",onClick:()=>{Ce(w=>!w),de(!1),Me(!1),xe(!1),q(!1),U(!1),z(!1),ze(!1)},children:["T",d.jsx("span",{className:"text-button__super",children:"+"})," Effects"]}),We&&d.jsxs("div",{className:"effects-modal",ref:ht,role:"dialog","aria-label":"Text effects",children:[d.jsx("button",{type:"button",className:"modal-close-btn","aria-label":"Close effects",onClick:()=>Ce(!1),children:d.jsx("i",{className:"fa-solid fa-x","aria-hidden":"true"})}),d.jsxs("div",{className:"effects-modal-content",children:[d.jsxs("div",{className:"effects-section",children:[d.jsx("div",{className:"effects-section-title",children:"Style"}),d.jsxs("div",{className:"effects-grid",children:[d.jsx("button",{type:"button",className:"effect-option",title:"None",onClick:()=>{o("effect-style")("none")},children:d.jsx("div",{className:"effect-preview none",children:d.jsx("i",{className:"fa-solid fa-ban","aria-hidden":"true"})})}),d.jsx("button",{type:"button",className:"effect-option",title:"Shadow",onClick:()=>{o("effect-style")("shadow")},children:d.jsx("div",{className:"effect-preview shadow",children:d.jsx("i",{className:"fi fi-rr-text-shadow","aria-hidden":"true"})})}),d.jsx("button",{type:"button",className:"effect-option",title:"Highlight",onClick:()=>{o("effect-style")("highlight")},children:d.jsx("div",{className:"effect-preview highlight",children:d.jsx("i",{className:"fa-solid fa-highlighter","aria-hidden":"true"})})}),d.jsx("button",{type:"button",className:"effect-option",title:"Glitch",onClick:()=>{o("effect-style")("glitch")},children:d.jsx("div",{className:"effect-preview glitch",children:d.jsx("span",{className:"glitch-mark",children:"/A"})})}),d.jsx("button",{type:"button",className:"effect-option",title:"Echo",onClick:()=>{o("effect-style")("echo")},children:d.jsx("div",{className:"effect-preview echo",children:d.jsx("span",{className:"echo-mark",children:"//A"})})})]})]}),d.jsxs("div",{className:"effects-section",children:[d.jsx("div",{className:"effects-section-title",children:"Shape"}),d.jsxs("div",{className:"effects-grid two",children:[d.jsx("button",{type:"button",className:"effect-option",title:"None",onClick:()=>{o("effect-shape")("none")},children:d.jsx("div",{className:"effect-preview none",children:"None"})}),d.jsx("button",{type:"button",className:"effect-option",title:"Curve",onClick:()=>{o("effect-shape")("curve")},children:d.jsx("div",{className:"effect-preview curve",children:"Curve"})})]})]})]})]})]})]}),d.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),d.jsxs("div",{className:"toolbar-group toolbar-group--utility",role:"group","aria-label":"Utility actions",style:{position:"relative"},children:[d.jsxs("div",{style:{display:"inline-block",position:"relative"},children:[d.jsx("button",{type:"button",className:"ghost-button","aria-label":"Spacing",onClick:()=>{Se&&(ct(w=>!w),Ce(!1),de(!1),Me(!1),xe(!1),q(!1),U(!1),z(!1),ze(!1))},disabled:!Se,children:d.jsx("i",{className:"fi fi-rr-chess-board","aria-hidden":"true"})}),bt&&d.jsx("div",{className:"opacity-modal",ref:Ve,role:"dialog","aria-label":"Opacity",style:{position:"absolute",right:0,top:"42px",zIndex:1200},children:d.jsxs("div",{className:"opacity-modal-content",children:[d.jsxs("div",{className:"opacity-row",children:[d.jsx("label",{className:"opacity-label",children:"Opacity"}),d.jsx("input",{className:"opacity-input",type:"number",min:"0",max:"100",value:qt,onChange:w=>{const F=as(Number(w.target.value)||0,0,100);dt(F),o("opacity")(F)},"aria-label":"Opacity percent"})]}),d.jsx("div",{className:"opacity-slider-row",children:d.jsx("input",{type:"range",min:"0",max:"100",value:qt,onChange:w=>{const F=Number(w.target.value);dt(F),o("opacity")(F)},className:"opacity-slider","aria-label":"Opacity slider",style:{background:"linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,1))"}})})]})})]}),d.jsxs("div",{style:{display:"inline-block",position:"relative"},children:[d.jsx("button",{type:"button",className:"ghost-button","aria-label":"Layers",onClick:()=>{Se&&(it(w=>!w),ie(!1),ct(!1),Ce(!1),de(!1),Me(!1),xe(!1),q(!1),U(!1),z(!1),ze(!1))},disabled:!Se,children:d.jsx("i",{className:"fa-solid fa-layer-group","aria-hidden":"true"})}),va&&d.jsx("div",{className:"layers-modal",ref:wa,role:"dialog","aria-label":"Layer management",style:{position:"absolute",right:0,top:"42px",zIndex:1200},children:d.jsxs("div",{className:"layers-modal-content",children:[d.jsxs("button",{type:"button",className:"layer-option",title:"Bring to front",onClick:()=>{o("layer")("bring-to-front"),it(!1)},children:[d.jsx("i",{className:"fi fi-rr-chevron-double-up","aria-hidden":"true"}),d.jsx("span",{className:"layer-label",children:"Bring to front"})]}),d.jsxs("button",{type:"button",className:"layer-option",title:"Bring forward",onClick:()=>{o("layer")("bring-forward"),it(!1)},children:[d.jsx("i",{className:"fi fi-rr-angle-up","aria-hidden":"true"}),d.jsx("span",{className:"layer-label",children:"Bring forward"})]}),d.jsxs("button",{type:"button",className:"layer-option",title:"Send backward",onClick:()=>{o("layer")("send-backward"),it(!1)},children:[d.jsx("i",{className:"fi fi-rr-angle-down","aria-hidden":"true"}),d.jsx("span",{className:"layer-label",children:"Send backward"})]}),d.jsxs("button",{type:"button",className:"layer-option",title:"Send to back",onClick:()=>{o("layer")("send-to-back"),it(!1)},children:[d.jsx("i",{className:"fi fi-rr-chevron-double-down","aria-hidden":"true"}),d.jsx("span",{className:"layer-label",children:"Send to back"})]})]})})]}),d.jsxs("div",{style:{display:"inline-block",position:"relative"},children:[d.jsx("button",{type:"button",className:"ghost-button","aria-label":"Share / Rotation",onClick:()=>{Se&&(ie(w=>!w),ct(!1),Ce(!1),de(!1),Me(!1),xe(!1),q(!1),U(!1),z(!1),ze(!1))},disabled:!Se,children:d.jsx("i",{className:"fi fi-rr-refresh","aria-hidden":"true"})}),ba&&d.jsx("div",{className:"rotation-modal",ref:Pa,role:"dialog","aria-label":"Rotation",style:{position:"absolute",right:0,top:"42px",zIndex:1200},children:d.jsxs("div",{className:"rotation-modal-content",children:[d.jsxs("div",{className:"rotation-row",children:[d.jsx("label",{className:"rotation-label",children:"Rotation"}),d.jsx("input",{className:"rotation-input",type:"number",min:"-180",max:"180",value:Ct,onChange:w=>{const F=as(Number(w.target.value)||0,-180,180);ia(F),o("rotation")(F)},"aria-label":"Rotation degrees"})]}),d.jsxs("div",{className:"rotation-slider-row",children:[d.jsx("input",{type:"range",min:"-180",max:"180",value:Ct,onChange:w=>{const F=Number(w.target.value);ia(F),o("rotation")(F)},className:"rotation-slider","aria-label":"Rotation slider"}),d.jsx("i",{className:"fa-solid fa-rotate-right rotation-icon","aria-hidden":"true"})]})]})})]}),d.jsxs("div",{style:{display:"inline-block",position:"relative"},children:[d.jsx("button",{type:"button",className:"ghost-button","aria-label":"More options",onClick:()=>{Se&&(ut(w=>!w),it(!1),ie(!1),ct(!1),Ce(!1),de(!1),Me(!1),xe(!1),q(!1),U(!1),z(!1),ze(!1))},disabled:!Se,children:d.jsx("i",{className:"fa-solid fa-ellipsis","aria-hidden":"true"})}),It&&d.jsx("div",{className:"more-modal",ref:Xe,role:"dialog","aria-label":"More options",style:{position:"absolute",right:0,top:"42px",zIndex:1200},children:d.jsxs("div",{className:"more-modal-content",children:[d.jsxs("button",{type:"button",className:"more-option",title:"Duplicate",onClick:()=>{o("more")("duplicate"),ut(!1)},children:[d.jsx("i",{className:"fa-solid fa-clone","aria-hidden":"true"}),d.jsx("span",{className:"more-label",children:"Duplicate"})]}),d.jsxs("button",{type:"button",className:"more-option",title:"Delete",onClick:()=>{o("more")("delete"),ut(!1)},children:[d.jsx("i",{className:"fi fi-rr-trash","aria-hidden":"true"}),d.jsx("span",{className:"more-label",children:"Delete"})]}),d.jsxs("button",{type:"button",className:"more-option",title:"Lock",onClick:()=>{o("more")("lock"),ut(!1)},children:[d.jsx("i",{className:"fi fi-rr-unlock","aria-hidden":"true"}),d.jsx("span",{className:"more-label",children:"Lock"})]}),d.jsxs("button",{type:"button",className:"more-option",title:"Copy",onClick:()=>{o("more")("copy"),ut(!1)},children:[d.jsx("i",{className:"fa-solid fa-copy","aria-hidden":"true"}),d.jsx("span",{className:"more-label",children:"Copy"})]})]})})]})]})]})}function Ys(){const J=document.getElementById("inkwise-customer-studio-bootstrap");if(J)try{const i=JSON.parse(J.textContent||"{}");if(i&&typeof i=="object")return typeof window<"u"&&(window.inkwiseStudioBootstrap=i),i}catch(i){console.error("[InkWise Studio] Failed to parse bootstrap payload.",i)}return typeof window<"u"&&window.inkwiseStudioBootstrap?window.inkwiseStudioBootstrap:{}}function fr({template:J}){if(!J)return d.jsx("span",{className:"studio-status__message",children:"Template data unavailable"});const i=J.updated_at?new Date(J.updated_at):null,o=i&&!Number.isNaN(i.getTime())?i.toLocaleString():"Not yet saved";return d.jsxs("div",{className:"studio-status__summary",children:[d.jsx("span",{className:"studio-status__template-name",title:J.name||"Untitled Template",children:J.name||"Untitled Template"}),J.svg_path&&d.jsx("span",{className:"studio-status__badge studio-status__badge--svg",children:"SVG ready"}),J.preview&&d.jsx("span",{className:"studio-status__badge studio-status__badge--preview",children:"Preview loaded"}),d.jsxs("span",{className:"studio-status__meta",children:["Updated: ",o]})]})}function pr({bootstrap:J,status:i}){const o=(J==null?void 0:J.template)??null,l=(J==null?void 0:J.product)??null,c=i==="ready"?"Design canvas ready":i==="initializing"?"Preparing editor…":i;return d.jsxs("div",{className:"studio-status",role:"status","aria-live":"polite",children:[d.jsxs("div",{className:"studio-status__header",children:[d.jsx("span",{className:"studio-status__dot","data-state":i}),d.jsx("span",{className:"studio-status__label",children:c})]}),d.jsx(fr,{template:o}),l&&d.jsxs("div",{className:"studio-status__product",children:["Editing: ",l.name||`Product #${l.id}`]})]})}function mr(){const J=P.useMemo(()=>Ys(),[]),[i,o]=P.useState("initializing"),[l,c]=P.useState(null);return P.useEffect(()=>{if(typeof document>"u")return;const m=l==="text"||l==="image";return document.body.classList.toggle("text-toolbar-visible",!!m),()=>{document.body.classList.remove("text-toolbar-visible")}},[l]),P.useEffect(()=>{cr(),o("ready")},[]),P.useEffect(()=>{if(typeof window>"u")return;const m=v=>{const A=(v==null?void 0:v.detail)||{};c(A.type||null)};window.addEventListener("inkwise:active-element",m);const k=window.inkwiseToolbar;if(k&&typeof k.getSelection=="function")try{const v=k.getSelection();v&&v.type&&c(v.type)}catch(v){console.debug("[InkWise Studio] Unable to read initial toolbar selection.",v)}return()=>{window.removeEventListener("inkwise:active-element",m)}},[]),!J||Object.keys(J).length===0?null:d.jsx("div",{className:"studio-status-wrapper",children:d.jsx(pr,{bootstrap:J,status:i})})}function gr(){P.useMemo(()=>Ys(),[]);const[J,i]=P.useState(null);P.useEffect(()=>{if(typeof window>"u")return;const k=A=>{const se=(A==null?void 0:A.detail)||{};i(se.type||null)};window.addEventListener("inkwise:active-element",k);const v=typeof window<"u"?window.inkwiseToolbar:null;if(v&&typeof v.getSelection=="function")try{const A=v.getSelection();A&&A.type&&i(A.type)}catch{}return()=>window.removeEventListener("inkwise:active-element",k)},[]),P.useEffect(()=>{if(typeof document>"u")return;const k=J==="text"||J==="image";return document.body.classList.toggle("text-toolbar-visible",!!k),()=>document.body.classList.remove("text-toolbar-visible")},[J]);const o=k=>{const v=typeof window<"u"?window.inkwiseToolbar:null;!v||typeof v.setFontFamily!="function"||v.setFontFamily(k)},l=k=>{const v=typeof window<"u"?window.inkwiseToolbar:null;!v||typeof v.setFontSize!="function"||v.setFontSize(k)},c=k=>{const v=typeof window<"u"?window.inkwiseToolbar:null;!v||typeof v.setColor!="function"||v.setColor(k)},m=k=>{const v=typeof window<"u"?window.inkwiseToolbar:null;return!v||typeof v.dispatch!="function"?()=>{}:new Set(["line-spacing","letter-spacing","effect-style","effect-shape","opacity","rotation","layer","more"]).has(k)?se=>v.dispatch(k,se):(v.dispatch(k),()=>{})};return d.jsx("div",{className:"studio-react-widgets","aria-hidden":!1,children:d.jsx(ur,{onAction:m,onFontChange:o,onSizeChange:l,onColorChange:c,activeElementType:J})})}function hr(){const J=()=>{const i=document.getElementById("inkwise-customer-studio-root");if(!i)return;Us.createRoot(i).render(d.jsx(Hs.StrictMode,{children:d.jsx(mr,{})}));try{const l=document.querySelector(".preview-canvas-wrapper");let m=document.getElementById("inkwise-mini-toolbar-root");!m&&l&&(m=document.createElement("div"),m.id="inkwise-mini-toolbar-root",m.className="studio-react-widgets",l.parentNode.insertBefore(m,l.nextSibling)),m&&Us.createRoot(m).render(d.jsx(Hs.StrictMode,{children:d.jsx(gr,{})}))}catch(l){console.debug("[InkWise Studio] Failed to mount toolbar in preview area",l)}};if(document.readyState==="complete"||document.readyState==="interactive"){J();return}document.addEventListener("DOMContentLoaded",J,{once:!0})}hr();const ua="http://www.w3.org/2000/svg",Gs="http://www.w3.org/1999/xlink";class ss{constructor(i,o={}){console.log("SvgTemplateEditor: Constructor called for SVG element:",i),this.svg=i,this.options={onImageChange:o.onImageChange||null,onTextChange:o.onTextChange||null,...o};const l=document&&document.body&&document.body.dataset?document.body.dataset:{},c=(l.imageReplacementMode||"").toLowerCase();let m="full";c==="panel-only"||c==="disabled"?m=c:l.allowImageReplacement==="false"&&(m="disabled"),this.imageReplacementMode=m,this.allowCanvasImageTools=m!=="disabled",this.changeableImages=[],this.textElements=[],this.imageClassTokens=new Set(["canvas-layer__image","changeable-image","svg-changeable-image","inkwise-image"]),this.init()}init(){console.log("SvgTemplateEditor: Initializing..."),this.parseSvgData(),this.setupImageHandlers(),this.setupTextHandlers(),this.addCssStyles(),console.log("SvgTemplateEditor: Initialization complete")}parseSvgData(){const i=this.svg.dataset.svgData;if(i)try{const o=JSON.parse(i);this.changeableImages=o.changeable_images||[],this.textElements=o.text_elements||[]}catch(o){console.warn("SvgTemplateEditor: Failed to parse data-svg-data payload",o)}}readDatasetTokens(i){return!i||!i.dataset?[]:["changeable","editableType","elementType","layerType","previewType","fieldType"].map(l=>i.dataset[l]).filter(l=>typeof l=="string"&&l.trim()!=="").map(l=>l.trim().toLowerCase())}findImageContentNode(i){return!i||typeof i.querySelector!="function"?null:i.querySelector('[data-changeable="image"], [data-editable-image], .canvas-layer__image, img, image')}nodeRepresentsImage(i){if(!i)return!1;const o=typeof i.tagName=="string"?i.tagName.toLowerCase():"";if(o==="image"||o==="img"||this.readDatasetTokens(i).some(c=>c==="image"||c==="photo"||c==="graphic")||typeof i.hasAttribute=="function"&&(i.hasAttribute("data-editable-image")||i.hasAttribute("data-changeable-image")))return!0;if(i.classList){for(const c of this.imageClassTokens)if(i.classList.contains(c))return!0}return o==="foreignobject"?!!this.findImageContentNode(i):!1}resolveImageNode(i){if(!i)return null;if(this.nodeRepresentsImage(i))return i;if(typeof i.closest=="function"){const o=i.closest("[data-preview-node]");if(o&&o!==i&&this.nodeRepresentsImage(o))return o}return this.findImageContentNode(i)}resolveImageHandleNodes(i){const o=this.resolveImageNode(i);return o?{interactionNode:typeof o.closest=="function"&&o.closest("foreignObject")||o,contentNode:o}:null}applyImageSourceToNode(i,o){if(!i||!o)return null;const l=typeof i.tagName=="string"?i.tagName.toLowerCase():"";if(l==="image")return i.setAttributeNS(Gs,"href",o),i.setAttribute("href",o),i.dataset&&(i.dataset.src=o),i;if(l==="img")return i.setAttribute("src",o),i.dataset&&(i.dataset.src=o),i;if(l==="foreignobject"){const c=this.findImageContentNode(i);return c&&c!==i?this.applyImageSourceToNode(c,o):null}return l==="rect"?this.convertRectToImage(i,o):(i.style&&typeof i.style.setProperty=="function"&&(i.style.backgroundImage=`url('${o}')`),i.dataset&&(i.dataset.src=o,i.dataset.replacedImage="true"),i)}convertRectToImage(i,o){if(!i||!i.parentNode)return null;const l=document.createElementNS(ua,"image");return["x","y","width","height","transform","preserveAspectRatio"].forEach(m=>{i.hasAttribute&&i.hasAttribute(m)&&l.setAttribute(m,i.getAttribute(m))}),Array.from(i.attributes||[]).forEach(m=>{(m.name==="id"||m.name.startsWith("data-"))&&l.setAttribute(m.name,m.value)}),i.classList&&i.classList.length&&i.classList.forEach(m=>l.classList.add(m)),l.setAttribute("href",o),l.setAttributeNS(Gs,"href",o),l.hasAttribute("preserveAspectRatio")||l.setAttribute("preserveAspectRatio","xMidYMid slice"),i.parentNode.replaceChild(l,i),l}escapeSelector(i){return typeof i!="string"||!i.length?"":typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(i):i.replace(/([^a-zA-Z0-9_-])/g,"\\$1")}resolveNodeFromMetadata(i){if(!i||typeof i!="object")return null;const o=i.id||i.element_id||i.node_id;if(o){const c=`#${this.escapeSelector(o)}`,m=this.svg.querySelector(c);if(m)return m}const l=i.selector||i.css_selector;if(l)try{const c=this.svg.querySelector(l);if(c)return c}catch(c){console.warn("SvgTemplateEditor: Invalid selector in changeable image metadata",l,c)}return null}collectImageCandidates(){const i=new Set;return this.changeableImages.forEach(l=>{const c=this.resolveNodeFromMetadata(l);c&&i.add(c)}),this.svg.querySelectorAll('[data-changeable="image"], [data-editable-image], .changeable-image, .canvas-layer__image, image, img, foreignObject').forEach(l=>{i.add(l)}),Array.from(i)}getBBoxSafe(i){if(!i||typeof i.getBBox!="function")return null;try{return i.getBBox()}catch(o){return console.warn("SvgTemplateEditor: Unable to compute bounding box for element",o,i),null}}toSvgPoint(i,o){if(!this.svg||typeof this.svg.createSVGPoint!="function")return null;const l=this.svg.createSVGPoint();l.x=i,l.y=o;const c=this.svg.getScreenCTM();return c?l.matrixTransform(c.inverse()):null}setupImageHandlers(){const i=this.collectImageCandidates();if(console.log("SvgTemplateEditor: Found",i.length,"changeable image elements"),!this.allowCanvasImageTools){i.forEach(o=>{const l=this.resolveImageHandleNodes(o);if(!l)return;const{interactionNode:c}=l;if(c.style.cursor="default",c.classList.remove("svg-changeable-image"),c.classList.remove("changeable-image-hover"),c._boundingBox){try{c._boundingBox.remove()}catch{}c._boundingBox=null}});return}setTimeout(()=>{i.forEach((o,l)=>{const c=this.resolveImageHandleNodes(o);if(!c)return;const{interactionNode:m,contentNode:k}=c;if(!m||m.__inkwiseSvgImageBound)return;console.log("SvgTemplateEditor: Setting up element",l,m),m.__inkwiseSvgImageBound=!0,m.__inkwiseImageContent=k||m,m.style.cursor="pointer",m.classList.add("svg-changeable-image"),m.classList.add("changeable-image-hover"),m.addEventListener("mouseenter",()=>{m.classList.add("changeable-image-active")}),m.addEventListener("mouseleave",()=>{m.classList.remove("changeable-image-active")}),m.addEventListener("click",A=>{A.preventDefault(),this.showImageUploadDialog(m)});const v=this.createBoundingBox(m);v&&(m._boundingBox=v),this.makeDraggable(m)})},200)}createBoundingBox(i){const o=this.getBBoxSafe(i);if(!o)return null;const l=document.createElementNS(ua,"g");l.classList.add("svg-bounding-box");const c=document.createElementNS(ua,"rect");return c.classList.add("svg-bounding-box__rect"),c.setAttribute("fill","none"),c.setAttribute("stroke","#007cba"),c.setAttribute("stroke-width","2"),c.setAttribute("stroke-dasharray","5,5"),c.setAttribute("rx","3"),c.style.pointerEvents="none",l.appendChild(c),this.createResizeHandles().forEach(k=>l.appendChild(k)),this.svg.appendChild(l),this.positionBoundingElements(l,o),l}createResizeHandles(){const i=[];return[{name:"nw",x:0,y:0},{name:"ne",x:1,y:0},{name:"sw",x:0,y:1},{name:"se",x:1,y:1}].forEach(l=>{const c=document.createElementNS(ua,"circle");c.setAttribute("r","4"),c.setAttribute("fill","#007cba"),c.setAttribute("stroke","#ffffff"),c.setAttribute("stroke-width","1"),c.classList.add("resize-handle",`handle-${l.name}`),c.style.pointerEvents="all",c.style.cursor=`${l.name}-resize`,i.push(c)}),i}positionBoundingElements(i,o){if(!i||!o)return;const l=i.querySelector(".svg-bounding-box__rect");if(!l)return;const c=5,m=o.x-c,k=o.y-c,v=o.width+c*2,A=o.height+c*2;l.setAttribute("x",m),l.setAttribute("y",k),l.setAttribute("width",Math.max(v,0)),l.setAttribute("height",Math.max(A,0)),i.querySelectorAll(".resize-handle").forEach(T=>{T.classList.contains("handle-nw")?(T.setAttribute("cx",m),T.setAttribute("cy",k)):T.classList.contains("handle-ne")?(T.setAttribute("cx",m+v),T.setAttribute("cy",k)):T.classList.contains("handle-sw")?(T.setAttribute("cx",m),T.setAttribute("cy",k+A)):T.classList.contains("handle-se")?(T.setAttribute("cx",m+v),T.setAttribute("cy",k+A)):T.classList.contains("handle-n")?(T.setAttribute("cx",m+v/2),T.setAttribute("cy",k)):T.classList.contains("handle-s")?(T.setAttribute("cx",m+v/2),T.setAttribute("cy",k+A)):T.classList.contains("handle-e")?(T.setAttribute("cx",m+v),T.setAttribute("cy",k+A/2)):T.classList.contains("handle-w")&&(T.setAttribute("cx",m),T.setAttribute("cy",k+A/2))})}updateBoundingBox(i){if(!i||!i._boundingBox)return;const o=this.getBBoxSafe(i);this.positionBoundingElements(i._boundingBox,o)}focusElementById(i){if(!i||!this.svg)return!1;const o=`#${this.escapeSelector(i)}`;let l=null;try{l=this.svg.querySelector(o)}catch(v){return console.warn("SvgTemplateEditor: Invalid selector generated for element id",i,v),!1}if(l||(l=this.svg.querySelector(`[data-element-id="${i}"]`)),!l)return!1;const m=(this.resolveImageHandleNodes(l)||{interactionNode:l}).interactionNode||l;return this.getBBoxSafe(m)?(this.updateBoundingBox(m),m._boundingBox&&(m._boundingBox.classList.add("svg-bounding-box--pulse"),setTimeout(()=>{m._boundingBox&&m._boundingBox.classList.remove("svg-bounding-box--pulse")},1e3)),typeof m.scrollIntoView=="function"&&m.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),m.classList.add("changeable-image-active"),setTimeout(()=>m.classList.remove("changeable-image-active"),1200),!0):!1}makeDraggable(i){let o=!1,l=0,c=0,m=0,k=0,v=0,A=0;const se=D=>{if(D.target.closest(".resize-handle"))return;const U=this.toSvgPoint(D.clientX,D.clientY);if(!U)return;const H=this.getBBoxSafe(i);if(!H)return;const le=typeof i.getAttribute=="function",Z=typeof i.setAttribute=="function";l=le?parseFloat(i.getAttribute("x")):H.x,c=le?parseFloat(i.getAttribute("y")):H.y,Number.isNaN(l)&&(l=H.x,Z&&i.setAttribute("x",l)),Number.isNaN(c)&&(c=H.y,Z&&i.setAttribute("y",c)),m=U.x-l,k=U.y-c,v=l,A=c,o=!0,i.style.cursor="grabbing",this.svg.style.cursor="grabbing",document.body.style.userSelect="none",D.preventDefault()},T=D=>{if(!o)return;const U=this.toSvgPoint(D.clientX,D.clientY);U&&(v=U.x-m,A=U.y-k,typeof i.removeAttribute=="function"&&i.removeAttribute("transform"),typeof i.setAttribute=="function"&&(i.setAttribute("x",v),i.setAttribute("y",A)),this.updateBoundingBox(i),D.preventDefault())},z=D=>{if(!o)return;o=!1,i.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="",this.updateBoundingBox(i);const U=new CustomEvent("svgImageMoved",{detail:{element:i,x:v,y:A}});this.svg.dispatchEvent(U),D.preventDefault()};i.addEventListener("mousedown",se),document.addEventListener("mousemove",T),document.addEventListener("mouseup",z),i._boundingBox&&i._boundingBox.querySelectorAll(".resize-handle").forEach(U=>{this.makeResizable(i,U)})}makeResizable(i,o){let l=!1,c=null,m=0,k=0,v=0,A=0,se="",T=0;const z=H=>{const le=this.toSvgPoint(H.clientX,H.clientY);if(!le)return;const Z=this.getBBoxSafe(i);if(!Z)return;m=Z.width,k=Z.height;const q=typeof i.getAttribute=="function",ee=typeof i.setAttribute=="function";v=q?parseFloat(i.getAttribute("x")):Z.x,A=q?parseFloat(i.getAttribute("y")):Z.y,Number.isNaN(v)&&(v=Z.x,ee&&i.setAttribute("x",v)),Number.isNaN(A)&&(A=Z.y,ee&&i.setAttribute("y",A)),T=parseFloat(i.getAttribute("font-size"))||parseFloat(window.getComputedStyle(i).fontSize)||16,c=le,se=Array.from(o.classList).find(W=>W.startsWith("handle-"))||"",l=!0,i.style.cursor=o.style.cursor,this.svg.style.cursor=o.style.cursor,document.body.style.userSelect="none",H.preventDefault(),H.stopPropagation()},D=H=>{if(!l)return;const le=this.toSvgPoint(H.clientX,H.clientY);if(!le)return;const Z=le.x-c.x,q=le.y-c.y;let ee=m,W=k,de=v,Ae=A;switch(se){case"handle-se":ee=m+Z,W=k+q;break;case"handle-sw":ee=m-Z,W=k+q,de=v+Z;break;case"handle-ne":ee=m+Z,W=k-q,Ae=A+q;break;case"handle-nw":ee=m-Z,W=k-q,de=v+Z,Ae=A+q;break}ee=Math.max(20,ee),W=Math.max(20,W);const We=i.tagName.toLowerCase();if((We==="image"||We==="rect")&&typeof i.setAttribute=="function")i.setAttribute("width",ee),i.setAttribute("height",W),i.setAttribute("x",de),i.setAttribute("y",Ae);else{const Ce=Math.max(1,m),ht=Math.max(1,k),Qe=ee/Ce,te=W/ht,Te=Math.max(Qe,te),Oe=Math.max(6,T*Te);typeof i.setAttribute=="function"&&i.setAttribute("font-size",Oe)}this.updateBoundingBox(i),H.preventDefault(),H.stopPropagation()},U=H=>{if(!l)return;l=!1,i.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="";const le={element:i,width:parseFloat(i.getAttribute?i.getAttribute("width"):"")||m,height:parseFloat(i.getAttribute?i.getAttribute("height"):"")||k,x:parseFloat(i.getAttribute?i.getAttribute("x"):"")||v,y:parseFloat(i.getAttribute?i.getAttribute("y"):"")||A},Z=new CustomEvent("svgImageResized",{detail:le});this.svg.dispatchEvent(Z),H.preventDefault(),H.stopPropagation()};o.addEventListener("mousedown",z),document.addEventListener("mousemove",D),document.addEventListener("mouseup",U)}setupTextHandlers(){const i=this;this.svg.querySelectorAll('[data-editable="true"]').forEach(l=>{l.style.cursor="pointer",l.classList.add("svg-editable-text"),l.addEventListener("click",function(c){c.preventDefault(),i.showTextEditDialog(l)}),l.addEventListener("mouseenter",function(){l.classList.add("editable-text-hover")}),l.addEventListener("mouseleave",function(){l.classList.remove("editable-text-hover")})})}showImageUploadDialog(i){const o=this,l=document.createElement("input");l.type="file",l.accept="image/*",l.style.display="none",l.addEventListener("change",function(c){const m=c.target.files[0];m&&o.handleImageUpload(m,i),l.parentNode&&l.parentNode.removeChild(l)}),document.body.appendChild(l),l.click()}async handleImageUpload(i,o){var T;const l=this,c=o&&o.__inkwiseImageContent?o.__inkwiseImageContent:o,m=((T=document.querySelector('meta[name="csrf-token"]'))==null?void 0:T.getAttribute("content"))||null,k=new FormData;k.append("image",i),m&&k.append("_token",m);let v=null;try{const z=await fetch("/design/upload-image",{method:"POST",body:k,credentials:"same-origin"});if(!z.ok){const U=await z.text().catch(()=>"");throw new Error(`Upload failed (${z.status}): ${U}`)}const D=await z.json();v=D.url||D.path||null}catch(z){console.error("SvgTemplateEditor: Failed to upload image",z),alert("We could not upload your image. Please try again.");const D=new CustomEvent("svgImageUploadFailed",{detail:{error:z,file:i}});l.svg.dispatchEvent(D);return}if(!v){alert("Upload did not return a usable image URL.");return}const A=l.applyImageSourceToNode(c,v)||c;o&&A&&o.__inkwiseImageContent!==A&&(o.__inkwiseImageContent=A);const se=new CustomEvent("svgImageChanged",{detail:{element:A,imageUrl:v,file:i}});l.svg.dispatchEvent(se),l.options.onImageChange&&l.options.onImageChange(A,v,i),l.updateBoundingBox(o||A)}showTextEditDialog(i){const o=this,l=i.textContent||"",c=document.createElement("input");c.type="text",c.value=l,c.className="svg-text-editor";const m=i.getBoundingClientRect(),k=o.svg.getBoundingClientRect();c.style.position="absolute",c.style.left=m.left-k.left+"px",c.style.top=m.top-k.top+"px",c.style.width=Math.max(m.width,100)+"px",c.style.fontSize=window.getComputedStyle(i).fontSize,c.style.fontFamily=window.getComputedStyle(i).fontFamily,c.style.border="1px solid #007cba",c.style.padding="2px",c.style.background="white",c.style.zIndex="1000",i.style.visibility="hidden",o.svg.parentNode.appendChild(c),c.focus(),c.select();const v=function(){const A=c.value;for(;i.firstChild;)i.removeChild(i.firstChild);i.appendChild(document.createTextNode(A)),i.style.visibility="visible",c.parentNode&&c.parentNode.removeChild(c);const se=new CustomEvent("svgTextChanged",{detail:{element:i,oldText:l,newText:A}});o.svg.dispatchEvent(se),o.options.onTextChange&&o.options.onTextChange(i,l,A)};c.addEventListener("blur",v),c.addEventListener("keydown",function(A){A.key==="Enter"?v():A.key==="Escape"&&(i.style.visibility="visible",c.parentNode&&c.parentNode.removeChild(c))})}addCssStyles(){if(document.getElementById("svg-editor-styles"))return;const i=document.createElement("style");i.id="svg-editor-styles",i.textContent=`
            .svg-changeable-image {
                transition: all 0.2s ease;
            }

            .changeable-image-hover:hover {
                filter: brightness(0.8);
                stroke: #007cba !important;
                stroke-width: 2px !important;
            }

            .changeable-image-active {
                filter: brightness(0.7);
                stroke: #007cba !important;
                stroke-width: 3px !important;
            }

            .svg-bounding-box {
                transition: all 0.2s ease;
            }

            .svg-bounding-box__rect {
                pointer-events: none;
            }

            .resize-handle {
                transition: all 0.2s ease;
                pointer-events: all !important;
            }

            .resize-handle:hover {
                fill: #005a87;
                r: 6px;
            }

            .svg-editable-text {
                transition: all 0.2s ease;
            }

            .editable-text-hover:hover {
                fill: #007cba !important;
                text-decoration: underline;
            }

            .uploaded-image {
                transition: all 0.2s ease;
            }

            .svg-text-editor {
                box-sizing: border-box;
                outline: none;
            }

            .svg-text-editor:focus {
                box-shadow: 0 0 5px rgba(0, 124, 186, 0.5);
            }
                .svg-bounding-box--pulse .svg-bounding-box__rect {
                    animation: svgBoundingBoxPulse 1s ease-out;
                }

                @keyframes svgBoundingBoxPulse {
                    0% {
                        stroke-width: 2;
                        opacity: 1;
                    }
                    50% {
                        stroke-width: 4;
                        opacity: 0.4;
                    }
                    100% {
                        stroke-width: 2;
                        opacity: 1;
                    }
                }
        `,document.head.appendChild(i)}getSvgString(){const i=this.svg.cloneNode(!0);i.querySelectorAll('.svg-bounding-box, .inkwise-editor-marker, [data-editor-only="true"]').forEach(c=>{var m;(m=c.parentNode)==null||m.removeChild(c)}),i.setAttribute("xmlns","http://www.w3.org/2000/svg"),i.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),i.style.width="",i.style.height="",i.style.maxWidth="",i.style.maxHeight="",i.removeAttribute("preserveAspectRatio");const o=document.createElementNS(ua,"style");return o.id="inkwise-export-styles",o.textContent=`
            @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
            text { white-space: pre; }
        `,i.insertBefore(o,i.firstChild),new XMLSerializer().serializeToString(i)}getSvgDataUrl(){const i=this.getSvgString();return"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(i)))}async saveSvg(i,o="front"){const l=this.getSvgString();try{const c=await fetch(`/staff/templates/${i}/save-svg`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({svg_content:l,side:o})});if(!c.ok){const k=await c.text().catch(()=>"");throw new Error(k||`Request failed with status ${c.status}`)}let m;try{m=await c.json()}catch(k){console.warn("SvgTemplateEditor: Failed to parse save response",k),m={success:!1,error:"Invalid response from server"}}return m}catch(c){return console.error("Failed to save SVG:",c),{success:!1,error:c.message}}}}function yr(){const J=()=>{const i=document.querySelectorAll("svg[data-svg-editor]");console.log("SvgTemplateEditor: Found",i.length,"SVGs with data-svg-editor attribute"),i.forEach((o,l)=>{o.__inkwiseSvgTemplateEditor||(console.log("SvgTemplateEditor: Initializing editor",l,"for SVG:",o),o.__inkwiseSvgTemplateEditor=new ss(o))})};if(document.readyState==="complete"||document.readyState==="interactive"?J():document.addEventListener("DOMContentLoaded",J,{once:!0}),!window.__inkwiseSvgTemplateEditorObserver){const i=new MutationObserver(o=>{o.forEach(l=>{l.addedNodes.forEach(c=>{c.nodeType===1&&c.matches&&c.matches("svg[data-svg-editor]")&&(c.__inkwiseSvgTemplateEditor||(c.__inkwiseSvgTemplateEditor=new ss(c)))})})});i.observe(document.body,{childList:!0,subtree:!0}),window.__inkwiseSvgTemplateEditorObserver=i}}typeof window<"u"&&(window.SvgTemplateEditor=ss,window.__inkwiseSvgTemplateEditorAutoInit||(window.__inkwiseSvgTemplateEditorAutoInit=!0,yr()));export{ss as S};
