import{r as P,j as n,c as Xr,R as Kr}from"./client-Cv0X-2PX.js";const da="http://www.w3.org/2000/svg",Jr="http://www.w3.org/1999/xlink";class ua{constructor(o,c={}){console.log("SvgTemplateEditor: Constructor called for SVG element:",o),this.svg=o,this.options={onImageChange:c.onImageChange||null,onTextChange:c.onTextChange||null,...c};const f=document&&document.body&&document.body.dataset?document.body.dataset:{},g=(f.imageReplacementMode||"").toLowerCase();let S="full";g==="panel-only"||g==="disabled"?S=g:f.allowImageReplacement==="false"&&(S="disabled"),this.imageReplacementMode=S,this.allowCanvasImageTools=S!=="disabled",this.changeableImages=[],this.textElements=[],this.imageClassTokens=new Set(["canvas-layer__image","changeable-image","svg-changeable-image","inkwise-image"]),this.init()}init(){console.log("SvgTemplateEditor: Initializing..."),this.parseSvgData(),this.setupImageHandlers(),this.setupTextHandlers(),this.addCssStyles(),console.log("SvgTemplateEditor: Initialization complete")}parseSvgData(){const o=this.svg.dataset.svgData;if(o)try{const c=JSON.parse(o);this.changeableImages=c.changeable_images||[],this.textElements=c.text_elements||[]}catch(c){console.warn("SvgTemplateEditor: Failed to parse data-svg-data payload",c)}}readDatasetTokens(o){return!o||!o.dataset?[]:["changeable","editableType","elementType","layerType","previewType","fieldType"].map(f=>o.dataset[f]).filter(f=>typeof f=="string"&&f.trim()!=="").map(f=>f.trim().toLowerCase())}findImageContentNode(o){return!o||typeof o.querySelector!="function"?null:o.querySelector('[data-changeable="image"], [data-editable-image], .canvas-layer__image, img, image')}nodeRepresentsImage(o){if(!o)return!1;const c=typeof o.tagName=="string"?o.tagName.toLowerCase():"";if(c==="image"||c==="img"||this.readDatasetTokens(o).some(g=>g==="image"||g==="photo"||g==="graphic")||typeof o.hasAttribute=="function"&&(o.hasAttribute("data-editable-image")||o.hasAttribute("data-changeable-image")))return!0;if(o.classList){for(const g of this.imageClassTokens)if(o.classList.contains(g))return!0}return c==="foreignobject"?!!this.findImageContentNode(o):!1}resolveImageNode(o){if(!o)return null;if(this.nodeRepresentsImage(o))return o;if(typeof o.closest=="function"){const c=o.closest("[data-preview-node]");if(c&&c!==o&&this.nodeRepresentsImage(c))return c}return this.findImageContentNode(o)}resolveImageHandleNodes(o){const c=this.resolveImageNode(o);return c?{interactionNode:typeof c.closest=="function"&&c.closest("foreignObject")||c,contentNode:c}:null}applyImageSourceToNode(o,c){if(!o||!c)return null;const f=typeof o.tagName=="string"?o.tagName.toLowerCase():"";if(f==="image")return o.setAttributeNS(Jr,"href",c),o.setAttribute("href",c),o.dataset&&(o.dataset.src=c),o;if(f==="img")return o.setAttribute("src",c),o.dataset&&(o.dataset.src=c),o;if(f==="foreignobject"){const g=this.findImageContentNode(o);return g&&g!==o?this.applyImageSourceToNode(g,c):null}return f==="rect"?this.convertRectToImage(o,c):(o.style&&typeof o.style.setProperty=="function"&&(o.style.backgroundImage=`url('${c}')`),o.dataset&&(o.dataset.src=c,o.dataset.replacedImage="true"),o)}convertRectToImage(o,c){if(!o||!o.parentNode)return null;const f=document.createElementNS(da,"image");return["x","y","width","height","transform","preserveAspectRatio"].forEach(S=>{o.hasAttribute&&o.hasAttribute(S)&&f.setAttribute(S,o.getAttribute(S))}),Array.from(o.attributes||[]).forEach(S=>{(S.name==="id"||S.name.startsWith("data-"))&&f.setAttribute(S.name,S.value)}),o.classList&&o.classList.length&&o.classList.forEach(S=>f.classList.add(S)),f.setAttribute("href",c),f.setAttributeNS(Jr,"href",c),f.hasAttribute("preserveAspectRatio")||f.setAttribute("preserveAspectRatio","xMidYMid slice"),o.parentNode.replaceChild(f,o),f}escapeSelector(o){return typeof o!="string"||!o.length?"":typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(o):o.replace(/([^a-zA-Z0-9_-])/g,"\\$1")}resolveNodeFromMetadata(o){if(!o||typeof o!="object")return null;const c=o.id||o.element_id||o.node_id;if(c){const g=`#${this.escapeSelector(c)}`,S=this.svg.querySelector(g);if(S)return S}const f=o.selector||o.css_selector;if(f)try{const g=this.svg.querySelector(f);if(g)return g}catch(g){console.warn("SvgTemplateEditor: Invalid selector in changeable image metadata",f,g)}return null}collectImageCandidates(){const o=new Set;return this.changeableImages.forEach(f=>{const g=this.resolveNodeFromMetadata(f);g&&o.add(g)}),this.svg.querySelectorAll('[data-changeable="image"], [data-editable-image], .changeable-image, .canvas-layer__image, image, img, foreignObject').forEach(f=>{o.add(f)}),Array.from(o)}getBBoxSafe(o){if(!o||typeof o.getBBox!="function")return null;try{return o.getBBox()}catch(c){return console.warn("SvgTemplateEditor: Unable to compute bounding box for element",c,o),null}}toSvgPoint(o,c){if(!this.svg||typeof this.svg.createSVGPoint!="function")return null;const f=this.svg.createSVGPoint();f.x=o,f.y=c;const g=this.svg.getScreenCTM();return g?f.matrixTransform(g.inverse()):null}setupImageHandlers(){const o=this.collectImageCandidates();if(console.log("SvgTemplateEditor: Found",o.length,"changeable image elements"),!this.allowCanvasImageTools){o.forEach(c=>{const f=this.resolveImageHandleNodes(c);if(!f)return;const{interactionNode:g}=f;if(g.style.cursor="default",g.classList.remove("svg-changeable-image"),g.classList.remove("changeable-image-hover"),g._boundingBox){try{g._boundingBox.remove()}catch{}g._boundingBox=null}});return}setTimeout(()=>{o.forEach((c,f)=>{const g=this.resolveImageHandleNodes(c);if(!g)return;const{interactionNode:S,contentNode:F}=g;if(!S||S.__inkwiseSvgImageBound)return;console.log("SvgTemplateEditor: Setting up element",f,S),S.__inkwiseSvgImageBound=!0,S.__inkwiseImageContent=F||S,S.style.cursor="pointer",S.classList.add("svg-changeable-image"),S.classList.add("changeable-image-hover"),S.addEventListener("mouseenter",()=>{S.classList.add("changeable-image-active")}),S.addEventListener("mouseleave",()=>{S.classList.remove("changeable-image-active")}),S.addEventListener("click",R=>{R.preventDefault(),this.showImageUploadDialog(S)});const N=this.createBoundingBox(S);N&&(S._boundingBox=N),this.makeDraggable(S)})},200)}createBoundingBox(o){const c=this.getBBoxSafe(o);if(!c)return null;const f=document.createElementNS(da,"g");f.classList.add("svg-bounding-box");const g=document.createElementNS(da,"rect");return g.classList.add("svg-bounding-box__rect"),g.setAttribute("fill","none"),g.setAttribute("stroke","#007cba"),g.setAttribute("stroke-width","2"),g.setAttribute("stroke-dasharray","5,5"),g.setAttribute("rx","3"),g.style.pointerEvents="none",f.appendChild(g),this.createResizeHandles().forEach(F=>f.appendChild(F)),this.svg.appendChild(f),this.positionBoundingElements(f,c),f}createResizeHandles(){const o=[];return[{name:"nw",x:0,y:0},{name:"ne",x:1,y:0},{name:"sw",x:0,y:1},{name:"se",x:1,y:1}].forEach(f=>{const g=document.createElementNS(da,"circle");g.setAttribute("r","4"),g.setAttribute("fill","#007cba"),g.setAttribute("stroke","#ffffff"),g.setAttribute("stroke-width","1"),g.classList.add("resize-handle",`handle-${f.name}`),g.style.pointerEvents="all",g.style.cursor=`${f.name}-resize`,o.push(g)}),o}positionBoundingElements(o,c){if(!o||!c)return;const f=o.querySelector(".svg-bounding-box__rect");if(!f)return;const g=5,S=c.x-g,F=c.y-g,N=c.width+g*2,R=c.height+g*2;f.setAttribute("x",S),f.setAttribute("y",F),f.setAttribute("width",Math.max(N,0)),f.setAttribute("height",Math.max(R,0)),o.querySelectorAll(".resize-handle").forEach(D=>{D.classList.contains("handle-nw")?(D.setAttribute("cx",S),D.setAttribute("cy",F)):D.classList.contains("handle-ne")?(D.setAttribute("cx",S+N),D.setAttribute("cy",F)):D.classList.contains("handle-sw")?(D.setAttribute("cx",S),D.setAttribute("cy",F+R)):D.classList.contains("handle-se")?(D.setAttribute("cx",S+N),D.setAttribute("cy",F+R)):D.classList.contains("handle-n")?(D.setAttribute("cx",S+N/2),D.setAttribute("cy",F)):D.classList.contains("handle-s")?(D.setAttribute("cx",S+N/2),D.setAttribute("cy",F+R)):D.classList.contains("handle-e")?(D.setAttribute("cx",S+N),D.setAttribute("cy",F+R/2)):D.classList.contains("handle-w")&&(D.setAttribute("cx",S),D.setAttribute("cy",F+R/2))})}updateBoundingBox(o){if(!o||!o._boundingBox)return;const c=this.getBBoxSafe(o);this.positionBoundingElements(o._boundingBox,c)}focusElementById(o){if(!o||!this.svg)return!1;const c=`#${this.escapeSelector(o)}`;let f=null;try{f=this.svg.querySelector(c)}catch(N){return console.warn("SvgTemplateEditor: Invalid selector generated for element id",o,N),!1}if(f||(f=this.svg.querySelector(`[data-element-id="${o}"]`)),!f)return!1;const S=(this.resolveImageHandleNodes(f)||{interactionNode:f}).interactionNode||f;return this.getBBoxSafe(S)?(this.updateBoundingBox(S),S._boundingBox&&(S._boundingBox.classList.add("svg-bounding-box--pulse"),setTimeout(()=>{S._boundingBox&&S._boundingBox.classList.remove("svg-bounding-box--pulse")},1e3)),typeof S.scrollIntoView=="function"&&S.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),S.classList.add("changeable-image-active"),setTimeout(()=>S.classList.remove("changeable-image-active"),1200),!0):!1}makeDraggable(o){let c=!1,f=0,g=0,S=0,F=0,N=0,R=0;const de=K=>{if(K.target.closest(".resize-handle"))return;const X=this.toSvgPoint(K.clientX,K.clientY);if(!X)return;const Z=this.getBBoxSafe(o);if(!Z)return;const ke=typeof o.getAttribute=="function",ue=typeof o.setAttribute=="function";f=ke?parseFloat(o.getAttribute("x")):Z.x,g=ke?parseFloat(o.getAttribute("y")):Z.y,Number.isNaN(f)&&(f=Z.x,ue&&o.setAttribute("x",f)),Number.isNaN(g)&&(g=Z.y,ue&&o.setAttribute("y",g)),S=X.x-f,F=X.y-g,N=f,R=g,c=!0,o.style.cursor="grabbing",this.svg.style.cursor="grabbing",document.body.style.userSelect="none",K.preventDefault()},D=K=>{if(!c)return;const X=this.toSvgPoint(K.clientX,K.clientY);X&&(N=X.x-S,R=X.y-F,typeof o.removeAttribute=="function"&&o.removeAttribute("transform"),typeof o.setAttribute=="function"&&(o.setAttribute("x",N),o.setAttribute("y",R)),this.updateBoundingBox(o),K.preventDefault())},H=K=>{if(!c)return;c=!1,o.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="",this.updateBoundingBox(o);const X=new CustomEvent("svgImageMoved",{detail:{element:o,x:N,y:R}});this.svg.dispatchEvent(X),K.preventDefault()};o.addEventListener("mousedown",de),document.addEventListener("mousemove",D),document.addEventListener("mouseup",H),o._boundingBox&&o._boundingBox.querySelectorAll(".resize-handle").forEach(X=>{this.makeResizable(o,X)})}makeResizable(o,c){let f=!1,g=null,S=0,F=0,N=0,R=0,de="",D=0;const H=Z=>{const ke=this.toSvgPoint(Z.clientX,Z.clientY);if(!ke)return;const ue=this.getBBoxSafe(o);if(!ue)return;S=ue.width,F=ue.height;const V=typeof o.getAttribute=="function",ie=typeof o.setAttribute=="function";N=V?parseFloat(o.getAttribute("x")):ue.x,R=V?parseFloat(o.getAttribute("y")):ue.y,Number.isNaN(N)&&(N=ue.x,ie&&o.setAttribute("x",N)),Number.isNaN(R)&&(R=ue.y,ie&&o.setAttribute("y",R)),D=parseFloat(o.getAttribute("font-size"))||parseFloat(window.getComputedStyle(o).fontSize)||16,g=ke,de=Array.from(c.classList).find(Y=>Y.startsWith("handle-"))||"",f=!0,o.style.cursor=c.style.cursor,this.svg.style.cursor=c.style.cursor,document.body.style.userSelect="none",Z.preventDefault(),Z.stopPropagation()},K=Z=>{if(!f)return;const ke=this.toSvgPoint(Z.clientX,Z.clientY);if(!ke)return;const ue=ke.x-g.x,V=ke.y-g.y;let ie=S,Y=F,ce=N,Oe=R;switch(de){case"handle-se":ie=S+ue,Y=F+V;break;case"handle-sw":ie=S-ue,Y=F+V,ce=N+ue;break;case"handle-ne":ie=S+ue,Y=F-V,Oe=R+V;break;case"handle-nw":ie=S-ue,Y=F-V,ce=N+ue,Oe=R+V;break}ie=Math.max(20,ie),Y=Math.max(20,Y);const rt=o.tagName.toLowerCase();if((rt==="image"||rt==="rect")&&typeof o.setAttribute=="function")o.setAttribute("width",ie),o.setAttribute("height",Y),o.setAttribute("x",ce),o.setAttribute("y",Oe);else{const _e=Math.max(1,S),Ft=Math.max(1,F),mt=ie/_e,J=Y/Ft,Me=Math.max(mt,J),it=Math.max(6,D*Me);typeof o.setAttribute=="function"&&o.setAttribute("font-size",it)}this.updateBoundingBox(o),Z.preventDefault(),Z.stopPropagation()},X=Z=>{if(!f)return;f=!1,o.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="";const ke={element:o,width:parseFloat(o.getAttribute?o.getAttribute("width"):"")||S,height:parseFloat(o.getAttribute?o.getAttribute("height"):"")||F,x:parseFloat(o.getAttribute?o.getAttribute("x"):"")||N,y:parseFloat(o.getAttribute?o.getAttribute("y"):"")||R},ue=new CustomEvent("svgImageResized",{detail:ke});this.svg.dispatchEvent(ue),Z.preventDefault(),Z.stopPropagation()};c.addEventListener("mousedown",H),document.addEventListener("mousemove",K),document.addEventListener("mouseup",X)}setupTextHandlers(){const o=this;this.svg.querySelectorAll('[data-editable="true"]').forEach(f=>{f.style.cursor="pointer",f.classList.add("svg-editable-text"),f.addEventListener("click",function(g){g.preventDefault(),o.showTextEditDialog(f)}),f.addEventListener("mouseenter",function(){f.classList.add("editable-text-hover")}),f.addEventListener("mouseleave",function(){f.classList.remove("editable-text-hover")})})}showImageUploadDialog(o){const c=this,f=document.createElement("input");f.type="file",f.accept="image/*",f.style.display="none",f.addEventListener("change",function(g){const S=g.target.files[0];S&&c.handleImageUpload(S,o),f.parentNode&&f.parentNode.removeChild(f)}),document.body.appendChild(f),f.click()}async handleImageUpload(o,c){var D;const f=this,g=c&&c.__inkwiseImageContent?c.__inkwiseImageContent:c,S=((D=document.querySelector('meta[name="csrf-token"]'))==null?void 0:D.getAttribute("content"))||null,F=new FormData;F.append("image",o),S&&F.append("_token",S);let N=null;try{const H=await fetch("/design/upload-image",{method:"POST",body:F,credentials:"same-origin"});if(!H.ok){const X=await H.text().catch(()=>"");throw new Error(`Upload failed (${H.status}): ${X}`)}const K=await H.json();N=K.url||K.path||null}catch(H){console.error("SvgTemplateEditor: Failed to upload image",H),alert("We could not upload your image. Please try again.");const K=new CustomEvent("svgImageUploadFailed",{detail:{error:H,file:o}});f.svg.dispatchEvent(K);return}if(!N){alert("Upload did not return a usable image URL.");return}const R=f.applyImageSourceToNode(g,N)||g;c&&R&&c.__inkwiseImageContent!==R&&(c.__inkwiseImageContent=R);const de=new CustomEvent("svgImageChanged",{detail:{element:R,imageUrl:N,file:o}});f.svg.dispatchEvent(de),f.options.onImageChange&&f.options.onImageChange(R,N,o),f.updateBoundingBox(c||R)}showTextEditDialog(o){const c=this,f=o.textContent||"",g=document.createElement("input");g.type="text",g.value=f,g.className="svg-text-editor";const S=o.getBoundingClientRect(),F=c.svg.getBoundingClientRect();g.style.position="absolute",g.style.left=S.left-F.left+"px",g.style.top=S.top-F.top+"px",g.style.width=Math.max(S.width,100)+"px",g.style.fontSize=window.getComputedStyle(o).fontSize,g.style.fontFamily=window.getComputedStyle(o).fontFamily,g.style.border="1px solid #007cba",g.style.padding="2px",g.style.background="white",g.style.zIndex="1000",o.style.visibility="hidden",c.svg.parentNode.appendChild(g),g.focus(),g.select();const N=function(){const R=g.value;for(;o.firstChild;)o.removeChild(o.firstChild);o.appendChild(document.createTextNode(R)),o.style.visibility="visible",g.parentNode&&g.parentNode.removeChild(g);const de=new CustomEvent("svgTextChanged",{detail:{element:o,oldText:f,newText:R}});c.svg.dispatchEvent(de),c.options.onTextChange&&c.options.onTextChange(o,f,R)};g.addEventListener("blur",N),g.addEventListener("keydown",function(R){R.key==="Enter"?N():R.key==="Escape"&&(o.style.visibility="visible",g.parentNode&&g.parentNode.removeChild(g))})}addCssStyles(){if(document.getElementById("svg-editor-styles"))return;const o=document.createElement("style");o.id="svg-editor-styles",o.textContent=`
            .svg-changeable-image {
                transition: all 0.2s ease;
            }

            .changeable-image-hover:hover {
                filter: brightness(0.8);
                stroke: #007cba !important;
                stroke-width: 2px !important;
            }

            .changeable-image-active {
                filter: brightness(0.7);
                stroke: #007cba !important;
                stroke-width: 3px !important;
            }

            .svg-bounding-box {
                transition: all 0.2s ease;
            }

            .svg-bounding-box__rect {
                pointer-events: none;
            }

            .resize-handle {
                transition: all 0.2s ease;
                pointer-events: all !important;
            }

            .resize-handle:hover {
                fill: #005a87;
                r: 6px;
            }

            .svg-editable-text {
                transition: all 0.2s ease;
            }

            .editable-text-hover:hover {
                fill: #007cba !important;
                text-decoration: underline;
            }

            .uploaded-image {
                transition: all 0.2s ease;
            }

            .svg-text-editor {
                box-sizing: border-box;
                outline: none;
            }

            .svg-text-editor:focus {
                box-shadow: 0 0 5px rgba(0, 124, 186, 0.5);
            }
                .svg-bounding-box--pulse .svg-bounding-box__rect {
                    animation: svgBoundingBoxPulse 1s ease-out;
                }

                @keyframes svgBoundingBoxPulse {
                    0% {
                        stroke-width: 2;
                        opacity: 1;
                    }
                    50% {
                        stroke-width: 4;
                        opacity: 0.4;
                    }
                    100% {
                        stroke-width: 2;
                        opacity: 1;
                    }
                }
        `,document.head.appendChild(o)}getSvgString(){const o=this.svg.cloneNode(!0);o.querySelectorAll('.svg-bounding-box, .inkwise-editor-marker, [data-editor-only="true"]').forEach(g=>{var S;(S=g.parentNode)==null||S.removeChild(g)}),o.setAttribute("xmlns","http://www.w3.org/2000/svg"),o.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),o.style.width="",o.style.height="",o.style.maxWidth="",o.style.maxHeight="",o.removeAttribute("preserveAspectRatio");const c=document.createElementNS(da,"style");return c.id="inkwise-export-styles",c.textContent=`
            @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
            text { white-space: pre; }
        `,o.insertBefore(c,o.firstChild),new XMLSerializer().serializeToString(o)}getSvgDataUrl(){const o=this.getSvgString();return"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(o)))}async saveSvg(o,c="front"){const f=this.getSvgString();try{const g=await fetch(`/staff/templates/${o}/save-svg`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({svg_content:f,side:c})});if(!g.ok){const F=await g.text().catch(()=>"");throw new Error(F||`Request failed with status ${g.status}`)}let S;try{S=await g.json()}catch(F){console.warn("SvgTemplateEditor: Failed to parse save response",F),S={success:!1,error:"Invalid response from server"}}return S}catch(g){return console.error("Failed to save SVG:",g),{success:!1,error:g.message}}}}function ps(){const G=()=>{const o=document.querySelectorAll("svg[data-svg-editor]");console.log("SvgTemplateEditor: Found",o.length,"SVGs with data-svg-editor attribute"),o.forEach((c,f)=>{c.__inkwiseSvgTemplateEditor||(console.log("SvgTemplateEditor: Initializing editor",f,"for SVG:",c),c.__inkwiseSvgTemplateEditor=new ua(c))})};if(document.readyState==="complete"||document.readyState==="interactive"?G():document.addEventListener("DOMContentLoaded",G,{once:!0}),!window.__inkwiseSvgTemplateEditorObserver){const o=new MutationObserver(c=>{c.forEach(f=>{f.addedNodes.forEach(g=>{g.nodeType===1&&g.matches&&g.matches("svg[data-svg-editor]")&&(g.__inkwiseSvgTemplateEditor||(g.__inkwiseSvgTemplateEditor=new ua(g)))})})});o.observe(document.body,{childList:!0,subtree:!0}),window.__inkwiseSvgTemplateEditorObserver=o}}typeof window<"u"&&(window.SvgTemplateEditor=ua,window.__inkwiseSvgTemplateEditorAutoInit||(window.__inkwiseSvgTemplateEditorAutoInit=!0,ps()));function ms(G={}){const{collectSnapshot:o,routes:c={},statusLabel:f=null,statusDot:g=null,csrfToken:S=null,debounce:F=1200,onAfterSave:N=null}=G;if(typeof o!="function")throw new Error("createAutosaveController requires a collectSnapshot function");let R=null,de=null,D=null,H=null;const K=(V,ie={})=>{if(g instanceof HTMLElement&&g.setAttribute("data-state",V),f instanceof HTMLElement)switch(V){case"saving":f.textContent="Saving…";break;case"dirty":f.textContent="Unsaved changes";break;case"error":f.textContent="Save failed";break;case"saved":{const ce=(ie.timestamp instanceof Date?ie.timestamp:new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});f.textContent=`Saved ${ce}`;break}default:f.textContent="Saved";break}},X=async V=>{const ie=c.autosave;if(!ie)return console.warn("[InkWise Studio] Autosave endpoint is not configured."),null;const Y=await fetch(ie,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest",...S?{"X-CSRF-TOKEN":S}:{}},credentials:"same-origin",body:JSON.stringify(V)});if(!Y.ok){const ce=new Error(`Autosave responded with ${Y.status}`);throw ce.status=Y.status,ce.responseText=await Y.text().catch(()=>null),ce}try{return await Y.json()}catch{return{}}},Z=async V=>{if(console.log("[Autosave] Saving",V),D)try{await D}catch{}de=null,K("saving");let ie;try{ie=await o(V)}catch(Y){throw console.error("[InkWise Studio] Failed to collect autosave snapshot.",Y),K("error"),Y}if(!ie||typeof ie!="object")return K("saved",{timestamp:new Date}),null;D=X(ie);try{const Y=await D;if(H=new Date,K("saved",{timestamp:H}),typeof N=="function")try{N(Y,ie)}catch(ce){console.warn("[InkWise Studio] Autosave onAfterSave callback failed.",ce)}return Y}catch(Y){throw console.error("[InkWise Studio] Autosave request failed.",Y),K("error"),Y}finally{D=null}};return{schedule:(V="change")=>{console.log("[Autosave] Scheduling",V),de=V,R&&clearTimeout(R),K("dirty"),R=window.setTimeout(()=>{R=null,Z(de).catch(()=>{})},F)},flush:async(V="flush")=>(R&&(clearTimeout(R),R=null),D&&await D,de!==null?Z(V):null),isSaving:()=>!!D,getLastSavedAt:()=>H,notifyError:()=>K("error"),markDirty:()=>K("dirty")}}function hs(){if(typeof window<"u"){if(window.__inkwiseCustomerStudioInitialized)return;window.__inkwiseCustomerStudioInitialized=!0}const G=()=>{var Fr,_r,jr;const o=document.querySelectorAll("[data-preview-target]"),c=document.querySelector(".preview-card-bg"),f=document.getElementById("preview-svg"),g=document.querySelectorAll("[data-card-thumb]"),S=document.querySelectorAll("[data-card-view]"),F=document.getElementById("extraPreviewContainer"),N=document.getElementById("textFieldList"),R=document.querySelector("[data-add-text-field]"),de=document.querySelectorAll(".sidenav-btn"),D=document.querySelector(".canvas-stage"),H="http://www.w3.org/2000/svg",K=document.querySelector(".canvas-measure-horizontal .measure-value"),X=document.querySelector(".canvas-measure-vertical .measure-value"),Z=document.querySelector(".preview-canvas-wrapper");let ke=1;const ue=new Set(["canvas-layer__image","changeable-image","svg-changeable-image","inkwise-image"]),V=e=>!e||!e.dataset?[]:["changeable","editableType","elementType","layerType","previewType","fieldType"].map(a=>e.dataset[a]).filter(a=>typeof a=="string"&&a.trim()!=="").map(a=>a.trim().toLowerCase()),ie=e=>!e||typeof e.querySelector!="function"?null:e.querySelector('[data-changeable="image"], [data-editable-image], .canvas-layer__image, img, image'),Y=e=>{if(!e)return!1;const t=typeof e.tagName=="string"?e.tagName.toLowerCase():"";if(t==="image"||t==="img"||V(e).some(r=>r==="image"||r==="photo"||r==="graphic")||typeof e.hasAttribute=="function"&&(e.hasAttribute("data-editable-image")||e.hasAttribute("data-changeable-image")))return!0;if(e.classList){for(const r of ue)if(e.classList.contains(r))return!0}return!!(t==="foreignobject"&&ie(e))},ce=e=>{if(!e||Y(e))return!1;const t=typeof e.tagName=="string"?e.tagName.toLowerCase():"";if(t==="style"||t==="script"||t==="defs"||t==="title"||t==="metadata")return!1;if(t==="text"||t==="tspan"||V(e).some(s=>s.includes("text")||s==="names"||s==="heading"))return!0;const r=(e.textContent||"").trim();return!(!r||/\{[^}]*\}|;/.test(r)&&r.length>80)},Oe=e=>{if(!e)return"";const t=e.querySelectorAll("tspan");return t&&t.length>0?gt(Array.from(t).map(a=>a.textContent||"").join(`
`)):gt(e.textContent||"")},rt=(e,t)=>{if(!e)return;const a=gt(t),r=e.querySelectorAll("tspan");if(r&&r.length>0){const i=String(a??"").split(/\r?\n/);r.forEach((s,l)=>{s.textContent=i[l]??""})}else e.textContent=a??"";e.dataset&&(e.dataset.currentText=a??"")},_e=e=>{if(!e)return null;if(Y(e))return e;if(typeof e.closest=="function"){const a=e.closest("[data-preview-node]");if(a&&a!==e&&Y(a))return a}const t=ie(e);return t||null},Ft=(e,t)=>{if(!e||!t)return!1;const a=typeof e.tagName=="string"?e.tagName.toLowerCase():"";if(a==="image")return e.setAttributeNS("http://www.w3.org/1999/xlink","href",t),e.setAttribute("href",t),e.dataset.src=t,!0;if(a==="img")return e.setAttribute("src",t),e.dataset.src=t,!0;if(a==="foreignobject"){const r=ie(e);return r&&r!==e?Ft(r,t):!1}return e.style&&(e.style.backgroundImage=`url('${t}')`),e.dataset&&(e.dataset.src=t,e.dataset.replacedImage="true"),!0},mt=e=>{if(!e||typeof e.insertBefore!="function"||e.querySelector('[data-inkwise-bg="true"]'))return;const a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x","0"),a.setAttribute("y","0"),a.setAttribute("width","100%"),a.setAttribute("height","100%"),a.setAttribute("fill","#ffffff"),a.setAttribute("data-inkwise-bg","true"),e.insertBefore(a,e.firstChild)},J=typeof window<"u"&&window.inkwiseStudioBootstrap?window.inkwiseStudioBootstrap:{};console.log("[InkWise Studio] Bootstrap payload:",J);const Me=(J==null?void 0:J.routes)??{};console.log("[InkWise Studio] Routes:",Me);const it=((Fr=document.querySelector('meta[name="csrf-token"]'))==null?void 0:Fr.getAttribute("content"))||((_r=document.head.querySelector('meta[name="csrf-token"]'))==null?void 0:_r.getAttribute("content"))||null,fa=document.querySelector(".topbar-status-label"),kt=document.querySelector(".topbar-status-dot"),Nt=e=>{if(e==null||e==="")return null;const t=Number(e);return Number.isFinite(t)?t:null},_t=e=>{if(!e||typeof e!="string")return null;try{const t=e.startsWith("<?xml")?e:`<?xml version="1.0" encoding="UTF-8"?>${e}`;return`data:image/svg+xml;base64,${window.btoa(unescape(encodeURIComponent(t)))}`}catch(t){return console.warn("[InkWise Studio] Failed to encode SVG preview.",t),null}},Xt=e=>{var s,l;if(!c)return null;const t=window.getComputedStyle(c),r=((t==null?void 0:t.backgroundImage)||"").match(/url\((['"]?)(.*?)\1\)/i);if(r&&r[2])return r[2];const i=e?`${e}Image`:null;return i&&((s=c.dataset)!=null&&s[i])?c.dataset[i]:((l=c.dataset)==null?void 0:l.frontImage)||null},jt=e=>{!e||!_||(e.texts&&Array.isArray(e.texts)&&e.texts.forEach(t=>{const{key:a,value:r,fontFamily:i,fontSize:s,color:l}=t,d=_.querySelector(`[data-preview-node="${a}"]`);if(d){if(r!==void 0){rt(d,r);const u=document.querySelector(`input[data-preview-target="${a}"]`);u&&(u.value=r)}if(i){d.setAttribute("font-family",i),d.style.fontFamily=i;try{d.dataset.fontFamily=i}catch{}}if(s){d.setAttribute("font-size",s),d.style.fontSize=s;try{d.dataset.fontSize=s}catch{}}if(l){d.setAttribute("fill",l),d.style.fill=l;try{d.dataset.color=l}catch{}}}}),e.images&&Array.isArray(e.images)&&e.images.forEach(t=>{const{key:a,href:r,x:i,y:s,width:l,height:d}=t,u=_.querySelector(`[data-preview-node="${a}"]`);u&&(r&&(u.setAttribute("href",r),u.setAttribute("xlink:href",r)),i!==void 0&&u.setAttribute("x",i),s!==void 0&&u.setAttribute("y",s),l!==void 0&&u.setAttribute("width",l),d!==void 0&&u.setAttribute("height",d))}))},pa=()=>N?Array.from(N.querySelectorAll("input[data-preview-target]")).map(e=>{var u,x;const t=e.closest(".text-field-item"),a=((x=(u=t==null?void 0:t.querySelector(".text-field-label"))==null?void 0:u.textContent)==null?void 0:x.trim())||e.dataset.previewTarget||"",r=e.dataset.previewTarget||"",i=_==null?void 0:_.querySelector(`[data-preview-node="${r}"]`);let s=null,l=null,d=null;return i&&(s=i.getAttribute("font-family")||i.style.fontFamily||i.dataset.fontFamily,l=i.getAttribute("font-size")||i.style.fontSize||i.dataset.fontSize,d=i.getAttribute("fill")||i.style.fill||i.dataset.color),{key:r,label:a,value:e.value||"",defaultValue:e.dataset.defaultValue||"",fontFamily:s,fontSize:l,color:d}}):[],st=e=>{if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="string"){const t=e.trim();if(!t)return Number.NaN;const a=t.match(/^[-+]?\d*\.?\d+(?:[eE][-+]?\d+)?/);return a?parseFloat(a[0]):Number.NaN}return Number.NaN},Mt=e=>{if(!e)return null;if(typeof e=="string"){const u=e.trim();if(!u)return null;try{const x=JSON.parse(u);return Mt(x)}catch{return null}}if(typeof e!="object")return null;const t=Array.isArray(e)?e.reduce((u,x)=>x&&typeof x=="object"?Object.assign(u,x):u,{}):Object.assign({},e),a=t.width??t.Width??t.canvasWidth??t.w??t.maxWidth??t.naturalWidth,r=t.height??t.Height??t.canvasHeight??t.h??t.maxHeight??t.naturalHeight,i=st(a),s=st(r);if(!Number.isFinite(i)||i<=0||!Number.isFinite(s)||s<=0)return null;const l=t.shape??t.Shape??t.canvasShape??null,d=t.unit??t.Unit??t.canvasUnit??null;return{width:i,height:s,shape:typeof l=="string"&&l.trim()!==""?l.trim():null,unit:typeof d=="string"&&d.trim()!==""?d.trim():"px"}},We=(e,t="px")=>{if(!Number.isFinite(e))return Number.NaN;switch((t||"px").toString().toLowerCase()){case"in":case"inch":case"inches":return e;case"mm":return e/25.4;case"cm":return e/2.54;case"pt":return e/72;default:return e/96}},ma=Mt(Z==null?void 0:Z.dataset);let z=Mt(((jr=J==null?void 0:J.template)==null?void 0:jr.canvas)??null)||ma||null;const xe=720,Bt=920,Rt=new Map;let Pe=null;const Ae=new Map,Qe=new Map;let Pt=null,ve=null,_=null,Kt=null,$t=()=>{},Le="front",et=null,tt=null,v=null,At=null,he=null,me=null,$e=!1,ze=null;const He=[],nt=[],Ce=50;let ht=!0;const ot=()=>{if(!ht||!_)return;const t=new XMLSerializer().serializeToString(_);He.length>0&&He[He.length-1]===t||(He.push(t),nt.length=0,He.length>Ce&&He.shift(),Te())},je=()=>{if(He.length<2)return;const t=new XMLSerializer().serializeToString(_);nt.push(t);const a=He.pop();zt(a),Te()},Jt=()=>{if(nt.length===0)return;const t=new XMLSerializer().serializeToString(_);He.push(t);const a=nt.pop();zt(a),Te()},zt=e=>{if(!_||!e)return;const t=ht;ht=!1;try{const r=new DOMParser().parseFromString(e,"image/svg+xml").documentElement;for(;_.firstChild;)_.removeChild(_.firstChild);for(;r.firstChild;)_.appendChild(r.firstChild.cloneNode(!0));for(let i of r.attributes)_.setAttribute(i.name,i.value);_.__inkwiseSvgTemplateEditor&&(_.__inkwiseSvgTemplateEditor=null),_.setAttribute("data-svg-editor","true"),_.__inkwiseSvgTemplateEditor=new ua(_,{onTextChange:(i,s,l)=>{ot(),v&&v.schedule("text-change")},onImageChange:(i,s,l)=>{ot(),v&&v.schedule("image-change")}}),Kt=_.__inkwiseSvgTemplateEditor,updatePreview()}catch(a){console.error("Failed to restore SVG state:",a)}finally{ht=t}},Te=()=>{const e=document.querySelector('button[aria-label="Undo"]'),t=document.querySelector('button[aria-label="Redo"]');e&&(e.disabled=He.length<2),t&&(t.disabled=nt.length===0)},Dt=8,ha=4,gt=e=>{const a=(e||"").toString().trim();return/::before|\{[^}]*\}|;/.test(a)&&a.length>120?"":a},ga=e=>{if(!e||e==="front"||e!=="back")return!0;if(!c)return!1;if(tt)return!0;const t=c.dataset||{};return t.hasBack==="true"?!0:!!(t.backImage||t.backSvg)},Zt=async e=>{if(!e||typeof e!="string")return null;if(e.startsWith("data:"))return e;try{const t=new Image;if(t.crossOrigin="anonymous",await new Promise(r=>{t.onload=()=>r(!0),t.onerror=()=>r(!1);const i=e.includes("?")?"&":"?";t.src=e+i+"_t="+Date.now()})&&t.naturalWidth>0&&t.naturalHeight>0){const r=document.createElement("canvas");r.width=t.naturalWidth,r.height=t.naturalHeight,r.getContext("2d").drawImage(t,0,0);try{const s=r.toDataURL("image/png");if(s&&s!=="data:,")return s}catch{console.warn("[InkWise Studio] Canvas tainted, trying fetch approach:",e)}}}catch(t){console.warn("[InkWise Studio] Canvas approach failed:",e,t)}try{const t=await fetch(e,{credentials:"include",mode:"cors"});if(!t.ok)return console.warn("[InkWise Studio] Failed to fetch image for base64 conversion:",e,t.status),null;const a=await t.blob();return new Promise(r=>{const i=new FileReader;i.onloadend=()=>r(i.result),i.onerror=()=>r(null),i.readAsDataURL(a)})}catch(t){console.warn("[InkWise Studio] Fetch approach also failed:",e,t)}try{const a=await(await fetch(e,{mode:"no-cors"})).blob();if(a.size>0)return new Promise(r=>{const i=new FileReader;i.onloadend=()=>r(i.result),i.onerror=()=>r(null),i.readAsDataURL(a)})}catch(t){console.warn("[InkWise Studio] No-cors fetch also failed:",e,t)}return null},Qt=async e=>{[".svg-bounding-box",".resize-handle",".selection-indicator",".inkwise-selection",".inkwise-overlay",'[data-ui-element="true"]','[data-temp-element="true"]',"g.svg-bounding-box"].forEach(s=>{e.querySelectorAll(s).forEach(l=>l.remove())}),e.querySelectorAll("text").forEach(s=>{s.removeAttribute("contenteditable"),s.style.cursor="",s.style.userSelect=""}),e.querySelectorAll("image").forEach(s=>{s.style.cursor="",s.style.pointerEvents=""});const a=s=>{if(!s||s.startsWith("data:"))return s;try{const l=new URL(s,window.location.origin),d=[/\/InkWise-Web\/ink-wise\/public\/storage\//gi,/\/ink-wise\/public\/storage\//gi,/\/public\/storage\//gi];let u=l.pathname;for(const x of d)if(x.test(u)){u=u.replace(x,"/storage/");break}return l.pathname=u,(l.hostname==="localhost"||l.hostname==="127.0.0.1")&&(l.hostname=window.location.hostname,l.port=window.location.port,l.protocol=window.location.protocol),l.href}catch{return s}},r=e.querySelectorAll("image");console.log("[InkWise Studio] Found",r.length,"image elements to convert");const i=Array.from(r).map(async s=>{let l=s.getAttribute("href")||s.getAttribute("xlink:href")||s.getAttributeNS("http://www.w3.org/1999/xlink","href");if(console.log("[InkWise Studio] Processing image with href:",l),!l||l.startsWith("data:")){console.log("[InkWise Studio] Image already embedded or no href, skipping");return}const d=a(l);console.log("[InkWise Studio] Normalized URL:",d);const u=await Zt(d);u?(console.log("[InkWise Studio] Successfully converted image to base64, length:",u.length),s.removeAttribute("href"),s.removeAttribute("xlink:href"),s.removeAttributeNS("http://www.w3.org/1999/xlink","href"),s.removeAttribute("data-src"),s.setAttribute("href",u),s.setAttribute("xlink:href",u),s.setAttributeNS("http://www.w3.org/1999/xlink","href",u),console.log("[InkWise Studio] Image href attributes updated to base64")):console.warn("[InkWise Studio] Failed to embed image, keeping original URL:",d)});await Promise.all(i),console.log("[InkWise Studio] All image conversions completed")},Xe=async()=>{var E,h,w;if(!c)return null;const e=new Date,t=Le||"front",a=_;let r=null;if(a)try{const y=a.cloneNode(!0),p=(E=c==null?void 0:c.dataset)==null?void 0:E.canvasWidth,A=(h=c==null?void 0:c.dataset)==null?void 0:h.canvasHeight;p&&A&&(y.setAttribute("width",p),y.setAttribute("height",A),y.style.width=p+"px",y.style.height=A+"px"),y.setAttribute("preserveAspectRatio","xMidYMid meet"),await Qt(y);let L=y.querySelector("style#inkwise-export-styles");L||(L=document.createElementNS(H,"style"),L.id="inkwise-export-styles",y.insertBefore(L,y.firstChild)),L.textContent=`
            @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
            text { white-space: pre; }
          `,r=new XMLSerializer().serializeToString(y),r&&!/xmlns=/i.test(r)&&(r=r.replace("<svg",'<svg xmlns="http://www.w3.org/2000/svg"'))}catch(y){console.warn("[InkWise Studio] Unable to serialize current SVG.",y),r=null}const i=r?_t(r):Xt(t),s=pa(),l=s.filter(y=>{const p=(y.value||"").trim(),A=(y.defaultValue||"").trim();return p===""||A!==""&&p===A}).map(y=>y.label||y.key).map(y=>(y||"").trim()).filter((y,p,A)=>y!==""&&A.indexOf(y)===p),d=[];if(a){const y=new Set;a.querySelectorAll('image,img,[data-changeable="image"]').forEach(p=>{const A=p.getAttribute("href")||p.getAttribute("xlink:href")||p.getAttributeNS("http://www.w3.org/1999/xlink","href")||p.getAttribute("data-src");if(!A)return;const L=p.getAttribute("data-preview-node")||p.id||`image-${d.length+1}`;y.has(L)||(y.add(L),d.push({key:L,href:A,x:p.getAttribute("x")||null,y:p.getAttribute("y")||null,width:p.getAttribute("width")||null,height:p.getAttribute("height")||null}))})}const u=c?{width:Nt(c.dataset.canvasWidth),height:Nt(c.dataset.canvasHeight),unit:c.dataset.canvasUnit||null,shape:c.dataset.canvasShape||null}:null,x=i?[i]:[];return{design:{updated_at:e.toISOString(),sides:{[t]:{svg:r,preview:i}},texts:s,images:d,canvas:u,placeholders:l},preview:{image:i,images:x},svg_markup:r,placeholders:l,product_id:((w=J==null?void 0:J.product)==null?void 0:w.id)??null}},ea=(e={},t={})=>{var u,x;const a=e&&e.summary?e.summary:{},r=Array.isArray(a.previewImages)?a.previewImages.filter(Boolean):Array.isArray(a.preview_images)?a.preview_images.filter(Boolean):[],i=Array.isArray((u=t==null?void 0:t.preview)==null?void 0:u.images)?t.preview.images.filter(Boolean):[],s=r.length?r:i,l=a.previewImage||a.preview_image||a.preview||((x=t==null?void 0:t.preview)==null?void 0:x.image)||s[0]||null;if(!l&&!s.length)return;const d={templateName:a.productName||a.templateName||document.title||"Saved template",previewImage:l||"",previewImages:s.length?s:l?[l]:[],metadata:{template:{name:a.productName||a.templateName||"Saved template"}}};try{window.sessionStorage.setItem("inkwise-finalstep",JSON.stringify(d))}catch{}try{const E={id:null,name:d.templateName,preview:d.previewImage};window.sessionStorage.setItem("inkwise-saved-template",JSON.stringify(E)),window.savedCustomerTemplate=E}catch{}},ya=async(...e)=>{const t=await Xe(...e);try{ea({},t)}catch{}return t};try{v=ms({collectSnapshot:ya,routes:Me,csrfToken:it,statusLabel:fa,statusDot:kt,debounce:0,onAfterSave:(r,i)=>{try{ea(r,i)}catch{}}}),console.log("[InkWise Studio] Autosave initialized",v);const e=r=>{if(v)try{v.flush(r)}catch(i){console.debug("[InkWise Studio] Autosave flush skipped.",i)}},t=()=>{document.visibilityState==="hidden"&&e("visibility-hidden")},a=()=>{e("page-hide")};document.addEventListener("visibilitychange",t),window.addEventListener("pagehide",a),window.addEventListener("beforeunload",a),At=window.setInterval(()=>{e("heartbeat")},6e4),window.addEventListener("unload",()=>{At&&(window.clearInterval(At),At=null),document.removeEventListener("visibilitychange",t),window.removeEventListener("pagehide",a),window.removeEventListener("beforeunload",a)}),setInterval(()=>{v&&(console.log("[InkWise Studio] Periodic autosave trigger"),v.schedule("periodic"))},1e4)}catch(e){console.warn("[InkWise Studio] Autosave controller failed to initialize.",e),v=null}const ta=async()=>{var y,p,A,L,te,ye;const e=await Xe(),t=(e==null?void 0:e.design)||{},a=t.sides||{},r=Object.keys(a)[0],i=r?a[r]:null,s=JSON.parse(JSON.stringify(t||{})),l=(i==null?void 0:i.svg)||(e==null?void 0:e.svg_markup)||null,d=(i==null?void 0:i.preview)||((y=e==null?void 0:e.preview)==null?void 0:y.image)||Xt(r||"front")||null,u=(Array.isArray((p=e==null?void 0:e.preview)==null?void 0:p.images)?e.preview.images:[]).filter(Q=>typeof Q=="string"&&Q.trim()!=="");d&&!u.length&&u.push(d);const x=s.canvas||{},E=x.width??(c?Nt(c.dataset.canvasWidth):null),h=x.height??(c?Nt(c.dataset.canvasHeight):null),w=(()=>{var Q,we;try{if(!c)return null;const U=window.getComputedStyle(c);return(U==null?void 0:U.backgroundColor)||((Q=c.dataset)==null?void 0:Q.backgroundColor)||((we=c.style)==null?void 0:we.backgroundColor)||null}catch{return null}})();return{design_svg:l,design_json:s,preview_image:d,preview_images:u,canvas_width:E,canvas_height:h,background_color:w,template_id:((A=J==null?void 0:J.template)==null?void 0:A.id)??(J==null?void 0:J.template_id)??null,order_item_id:((L=J==null?void 0:J.orderSummary)==null?void 0:L.order_item_id)??((te=J==null?void 0:J.orderSummary)==null?void 0:te.orderItemId)??((ye=J==null?void 0:J.orderSummary)==null?void 0:ye.item_id)??null}},Ve=document.querySelector('[data-action="proceed-review"]');if(Ve){const e=Ve.dataset.destination||Me.review||Ve.getAttribute("href")||window.location.href,t=Me.saveReview||Me.reviewSave||Me.review_design||Me.reviewDesign||null;Ve.addEventListener("click",async a=>{if(a.preventDefault(),Ve.dataset.navigating==="1")return;Ve.dataset.navigating="1",Ve.disabled=!0;const r=()=>{window.location.href=e},i=()=>{Ve.disabled=!1,Ve.dataset.navigating="0"};try{v&&await v.flush("navigate");const s=await ta();if(!s.template_id)throw new Error("Missing template identifier.");if(!t)throw new Error("Save endpoint unavailable.");const l={"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"};it&&(l["X-CSRF-TOKEN"]=it);const d=await fetch(t,{method:"POST",headers:l,credentials:"same-origin",body:JSON.stringify(s)});if(!d.ok){const u=await d.text().catch(()=>"");throw new Error(`Save failed (${d.status}): ${u}`)}r()}catch(s){console.error("[InkWise Studio] Unable to save before navigating.",s),v&&v.notifyError(),alert("We could not save your latest design. Please try again before continuing."),i()}})}const De=document.getElementById("save-template-btn");De&&De.addEventListener("click",async e=>{if(e.preventDefault(),De.disabled)return;const t=prompt("Enter a name for your template:");if(!(!t||t.trim()==="")){De.disabled=!0,De.textContent="Saving…";try{v&&await v.flush("save-template");const a=await Xe("save-template"),r=Object.assign({},a&&a.design?a.design:{}),i=a&&Array.isArray(a.placeholders)?a.placeholders:[];r.placeholders=i,a&&a.product_id&&(r.product_id=a.product_id);const s=a&&a.preview&&a.preview.image||null,l=a&&a.preview&&Array.isArray(a.preview.images)?a.preview.images.filter(Boolean):[],d={template_name:t.trim(),design:r,preview_image:s,preview_images:l,placeholders:i,svg_markup:a.svg_markup},u={"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"};it&&(u["X-CSRF-TOKEN"]=it);const x=await fetch(Me.saveTemplate,{method:"POST",headers:u,credentials:"same-origin",body:JSON.stringify(d)});if(!x.ok)throw new Error(`Server responded with ${x.status}`);const E=await x.json();alert(`Template "${E.template_name}" saved successfully!`)}catch(a){console.error("[InkWise Studio] Failed to save template.",a),alert("Failed to save template. Please try again.")}finally{De.disabled=!1,De.textContent="Save Template"}}});const Ct=e=>{const t=_e(e);if(!t)return;const a=document.createElement("input");a.type="file",a.accept="image/*",a.onchange=r=>{const i=r.target.files&&r.target.files[0];if(!i)return;const s=new FileReader;s.onload=l=>{var x;const d=(x=l.target)==null?void 0:x.result;if(!d)return;Ft(t,d)&&(re(),v==null||v.schedule("image-replace"))},s.readAsDataURL(i)},a.click()},ba=()=>c?((!Pe||!Pe.isConnected)&&(Pe=document.createElement("div"),Pe.className="canvas-overlay-layer",c.appendChild(Pe)),Pe):null,aa=()=>{Ae.forEach(({overlay:e})=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),Ae.clear(),Qe.clear(),Pe&&(Pe.innerHTML=""),he=null,me=null,na(),document.body.classList.remove("text-toolbar-visible"),oa()},lt=(e,t)=>{if(e==null)return t;const a=e.toString().split(/[\s,]+/).filter(Boolean);if(a.length===0)return t;const r=parseFloat(a[0]);return Number.isFinite(r)?r:t},Ie=e=>{if(!c)return;const t=Ae.get(e);if(!t||!t.overlay)return;const a=t.overlay,r=c.getBoundingClientRect(),i=e.getBoundingClientRect();if(r.width===0||r.height===0)return;const s=t.type==="text"?18:12,l=Math.max(s,i.width),d=Math.max(s,i.height);a.style.left=`${i.left-r.left}px`,a.style.top=`${i.top-r.top}px`,a.style.width=`${l}px`,a.style.height=`${d}px`},Ra=()=>{Ae.forEach((e,t)=>{Ie(t)})},re=()=>{Ae.size!==0&&(Pt&&cancelAnimationFrame(Pt),Pt=window.requestAnimationFrame(()=>{Pt=null,Ra()}))},Ge=(e=3)=>{e<=0||requestAnimationFrame(()=>{re(),Ge(e-1)})};window.addEventListener("resize",re),document.addEventListener("scroll",re,!0),window.addEventListener("load",re);const va=(e,t)=>{const a=_||f;if(!a||typeof a.createSVGPoint!="function")return null;const r=a.createSVGPoint();r.x=e,r.y=t;const i=a.getScreenCTM();return i?r.matrixTransform(i.inverse()):null},Pa=(e,t,a)=>{const r=va(a.clientX,a.clientY);if(!r)return null;const{node:i}=e,s=i.getBBox?i.getBBox():{x:0,y:0,width:0,height:0},l={data:e,overlay:e.overlay,node:i,type:e.type,handle:t,mode:t?"resize":"move",pointerId:a.pointerId,startPoint:r,startClient:{x:a.clientX,y:a.clientY},initialBBox:s,moved:!1};if(e.type==="text"){l.fontSize=parseFloat(i.getAttribute("font-size"))||parseFloat(window.getComputedStyle(i).fontSize)||16,l.x=lt(i.getAttribute("x"),s.x);const d=s.y+s.height;l.y=lt(i.getAttribute("y"),d)}else l.x=lt(i.getAttribute("x"),s.x),l.y=lt(i.getAttribute("y"),s.y),l.width=lt(i.getAttribute("width"),Math.max(1,s.width)),l.height=lt(i.getAttribute("height"),Math.max(1,s.height));return l},$a=(e,t,a)=>{if(e.type==="text"){const r=e.x+t,i=e.y+a;Number.isFinite(r)&&e.node.setAttribute("x",r),Number.isFinite(i)&&e.node.setAttribute("y",i)}else e.node.setAttribute("x",e.x+t),e.node.setAttribute("y",e.y+a)},b=(e,t,a,r=!1)=>{if(e.type==="image"){let i=e.x,s=e.y,l=e.width,d=e.height;const u=["nw","ne","sw","se"].some(w=>e.handle===w),x=r||u,E=e.width/e.height;if(x&&u){const w=Math.abs(t),y=Math.abs(a);w>y?(e.handle.includes("e")?l=e.width+t:e.handle.includes("w")&&(l=e.width-t,i=e.x+t),d=l/E,e.handle.includes("n")&&(s=e.y+(e.height-d))):(e.handle.includes("s")?d=e.height+a:e.handle.includes("n")&&(d=e.height-a,s=e.y+a),l=d*E,e.handle.includes("w")&&(i=e.x+(e.width-l)))}else e.handle.includes("e")&&(l=e.width+t),e.handle.includes("w")&&(l=e.width-t,i=e.x+t),e.handle.includes("s")&&(d=e.height+a),e.handle.includes("n")&&(d=e.height-a,s=e.y+a);const h=4;l<h&&(i+=l-h,l=h),d<h&&(s+=d-h,d=h),e.node.setAttribute("x",i),e.node.setAttribute("y",s),e.node.setAttribute("width",l),e.node.setAttribute("height",d)}else if(e.type==="text"){const i=Math.max(1,e.initialBBox.width),s=Math.max(1,e.initialBBox.height);let l=0,d=0;e.handle.includes("e")?l=t:e.handle.includes("w")&&(l=-t),e.handle.includes("s")?d=a:e.handle.includes("n")&&(d=-a);const u=Math.max(4,i+l),x=Math.max(4,s+d),E=u/i,h=x/s,w=Math.max(E,h),y=Math.max(6,e.fontSize*w);e.node.setAttribute("font-size",y)}},I=e=>{if(!ve||e.pointerId!==ve.pointerId)return;const t=va(e.clientX,e.clientY);if(!t)return;const a=t.x-ve.startPoint.x,r=t.y-ve.startPoint.y;!ve.moved&&(Math.abs(a)>.5||Math.abs(r)>.5)&&(ve.moved=!0),ve.mode==="move"?$a(ve,a,r):b(ve,a,r),re()},q=e=>{if(!ve||e.pointerId!==ve.pointerId)return;try{ve.overlay.releasePointerCapture(ve.pointerId)}catch{}ve.overlay.classList.remove("editor-overlay--active"),document.removeEventListener("pointermove",I),document.removeEventListener("pointerup",q),document.removeEventListener("pointercancel",q);const t=ve;ve=null,re(),t.moved?v==null||v.schedule("element-transform"):t.type==="text"?$t(t.data.previewKey):t.type==="image"&&Ct(t.node)},ge=e=>{if(!e.isPrimary||e.button!==0)return;const t=e.target.closest(".editor-overlay");if(!t||t.dataset.cropSessionActive==="true")return;const a=Qe.get(t);if(!a)return;a.type==="text"?vt(a.previewKey||null):a.type==="image"&&wt(a.previewKey||null);const r=Pa(a,e.target.dataset.handle||null,e);if(r){e.preventDefault(),ve=r,t.classList.add("editor-overlay--active");try{t.setPointerCapture(e.pointerId)}catch{}document.addEventListener("pointermove",I),document.addEventListener("pointerup",q),document.addEventListener("pointercancel",q)}},pe=e=>{const t=ba();if(!t)return null;let a=Ae.get(e);if(a)return a;const r=Y(e)?"image":"text",i=e.getAttribute("data-preview-node")||"",s=document.createElement("div");return s.className=`editor-overlay editor-overlay--${r}`,s.dataset.previewNode=i,s.tabIndex=0,s.style.touchAction="none",["nw","n","ne","e","se","s","sw","w"].forEach(d=>{const u=document.createElement("div");u.className=`editor-overlay__handle editor-overlay__handle--${d}`,u.dataset.handle=d,s.appendChild(u)}),s.addEventListener("pointerdown",ge),s.addEventListener("dblclick",()=>{r==="text"?$t(i):r==="image"&&Ct(e)}),s.addEventListener("keydown",d=>{d.key==="Enter"&&(d.preventDefault(),r==="text"?$t(i):r==="image"&&Ct(e))}),t.appendChild(s),a={overlay:s,node:e,type:r,previewKey:i},Ae.set(e,a),Qe.set(s,a),e.dataset.locked==="true"&&(s.classList.add("editor-overlay--locked"),s.style.pointerEvents="none"),na(),re(),a},Se=(e,t,a={})=>{if(!c)return;const r=c.closest(".preview-canvas-wrapper"),i=Number(e),s=Number(t),l=a.persist===void 0?!0:!!a.persist,d=typeof a.unit=="string"&&a.unit?a.unit:(z==null?void 0:z.unit)??"px",u=typeof a.shape=="string"&&a.shape?a.shape:(z==null?void 0:z.shape)??null;if(!r||!Number.isFinite(i)||!Number.isFinite(s)||i<=0||s<=0)return;const x=xe/i,E=Bt/s,h=Math.min(1,x,E),w=Math.max(1,Math.round(i*h)),y=Math.max(1,Math.round(s*h));r.style.setProperty("--canvas-width",`${w}px`),r.style.setProperty("--canvas-height",`${y}px`),r.dataset.sourceWidth=i.toString(),r.dataset.sourceHeight=s.toString(),r.dataset.displayScale=h.toString(),r.dataset.canvasWidth=i.toString(),r.dataset.canvasHeight=s.toString(),r.dataset.canvasUnit=d,u&&(r.dataset.canvasShape=u),c.dataset.canvasWidth=i.toString(),c.dataset.canvasHeight=s.toString(),c.dataset.canvasUnit=d,u&&(c.dataset.canvasShape=u),f&&(f.setAttribute("viewBox",`0 0 ${i} ${s}`),f.setAttribute("preserveAspectRatio","xMidYMid meet")),_&&!_.getAttribute("viewBox")&&(_.setAttribute("viewBox",`0 0 ${i} ${s}`),_.setAttribute("preserveAspectRatio","xMidYMid meet")),D&&D.style.setProperty("--stage-width",`${w+112}px`),l&&(z={width:i,height:s,unit:d,shape:u}),re()},Be=(e,t,a,r=0)=>{K&&(Number.isFinite(e)?K.textContent=`${e.toFixed(r)}${a}`:K.textContent="—"),X&&(Number.isFinite(t)?X.textContent=`${t.toFixed(r)}${a}`:X.textContent="—")};z&&(Se(z.width,z.height,{unit:z.unit,shape:z.shape}),Be(We(z.width,z.unit),We(z.height,z.unit),"in",2));const Ke=e=>{if(typeof e!="string"||!e.trim())return Number.NaN;const t=e.trim(),a=t.match(/^([-+]?[0-9]*\.?[0-9]+)/);if(!a)return Number.NaN;const r=parseFloat(a[1]);if(!Number.isFinite(r))return Number.NaN;const i=t.match(/([a-z%]+)$/i);switch(i?i[1].toLowerCase():""){case"":case"px":return r;case"mm":return r*(96/25.4);case"cm":return r*(96/2.54);case"in":return r*96;case"pt":return r*(96/72);default:return r}},ct=()=>!!(z&&Number.isFinite(z.width)&&z.width>0&&Number.isFinite(z.height)&&z.height>0),za=e=>{if(!e||ct())return;if(Rt.has(e)){const a=Rt.get(e);if(a){const r=a.unit||"px";Se(a.width,a.height,{unit:r,shape:z==null?void 0:z.shape}),Be(We(a.width,r),We(a.height,r),"in",2)}return}const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{const a={width:t.naturalWidth,height:t.naturalHeight,unit:"px"};Rt.set(e,a),Se(a.width,a.height,{unit:a.unit,shape:z==null?void 0:z.shape}),Be(We(a.width,a.unit),We(a.height,a.unit),"in",2),re()},t.onerror=()=>{Rt.set(e,null)},t.src=e},ra={text:document.getElementById("text-modal"),uploads:document.getElementById("uploads-modal"),graphics:document.getElementById("graphics-modal"),template:document.getElementById("template-modal"),color:document.getElementById("color-modal"),qr:document.getElementById("qr-modal"),background:document.getElementById("background-modal"),product:document.getElementById("product-modal"),tables:document.getElementById("tables-modal")},ia=document.querySelectorAll("[data-modal-close]"),Da=e=>{if(!e)return[];const t=new Map;let a=0;const r=(h,w,y="node")=>{let p=(h||"").toString().trim();p||(p=`${y}-${a+=1}`);let A=p,L=2;for(;t.has(A)&&t.get(A)!==w;)A=`${p}-${L}`,L+=1;return A},i=(h,w,y=null,p=null,A="node")=>{if(!h)return;const L=r(w,h,A);return h.setAttribute("data-preview-node",L),y&&!h.dataset.previewLabel&&(h.dataset.previewLabel=y),p&&!h.dataset.defaultText&&(h.dataset.defaultText=p),t.set(L,h),L};e.querySelectorAll("[data-preview-node]").forEach(h=>{var y,p;const w=h.getAttribute("data-preview-node");w&&i(h,w,((y=h.dataset)==null?void 0:y.previewLabel)||null,((p=h.dataset)==null?void 0:p.defaultText)||null,"node")});const l=[];e.querySelectorAll(".canvas-layer[data-layer-id]").forEach(h=>{const w=h.getAttribute("data-layer-id");if(!w)return;const y=(h.getAttribute("aria-label")||w).replace(/\s+layer$/i,"")||w,p=h.querySelector(".canvas-layer__text");if(p){if(p.hasAttribute("data-preview-node")||p.setAttribute("data-preview-node",w),p.dataset.previewLabel||(p.dataset.previewLabel=y),!p.dataset.defaultText){const L=(p.textContent||"").trim();L&&(p.dataset.defaultText=L)}l.push(p)}const A=h.querySelector("img, image");if(A){const L=`${w}-image`;A.hasAttribute("data-preview-node")||A.setAttribute("data-preview-node",L),A.dataset.previewLabel||(A.dataset.previewLabel=y),l.push(A)}if(!p&&!A){if(h.hasAttribute("data-preview-node")||h.setAttribute("data-preview-node",w),h.dataset.previewLabel||(h.dataset.previewLabel=y),!h.dataset.defaultText){const L=(h.textContent||"").trim();L&&(h.dataset.defaultText=L)}l.push(h)}}),e.querySelectorAll("image, img").forEach((h,w)=>{var p;const y=h.getAttribute("data-preview-node")||`auto-image-${w+1}`;i(h,y,((p=h.dataset)==null?void 0:p.previewLabel)||null,null,"image")}),e.querySelectorAll("text, tspan").forEach((h,w)=>{var A,L;const y=(((A=h.dataset)==null?void 0:A.defaultText)||h.textContent||"").trim()||null,p=h.getAttribute("data-preview-node")||`auto-text-${w+1}`;i(h,p,((L=h.dataset)==null?void 0:L.previewLabel)||null,y,"text")}),l.length>0&&l.forEach((h,w)=>{var p,A;const y=h.getAttribute("data-preview-node")||`fallback-${w+1}`;i(h,y,((p=h.dataset)==null?void 0:p.previewLabel)||null,((A=h.dataset)==null?void 0:A.defaultText)||null,"node")});const E=[];return e.querySelectorAll("text[data-preview-node], tspan[data-preview-node]").forEach(h=>{const w=h.getAttribute("data-preview-node");if(w&&t.has(w)){const y=t.get(w);y&&!E.includes(y)&&E.push(y)}}),E.length>0?E:Array.from(t.values())},wa=e=>{if(!e)return;e.classList.remove("is-open"),e.setAttribute("aria-hidden","true");const t=e.dataset.section;if(t){const a=document.querySelector(`.sidenav-btn[data-nav="${t}"]`);a==null||a.classList.remove("active"),t==="background"&&$e&&($e=!1,sa(),oa())}},sr=()=>{Object.values(ra).forEach(e=>wa(e))},nr=e=>{const t=ra[e];if(!t)return;t.classList.add("is-open"),t.setAttribute("aria-hidden","false");const a=t.querySelector('input:not([type="hidden"])');if(a==null||a.focus({preventScroll:!0}),e==="background"&&di(),e==="graphics"){const r=document.querySelector('.graphics-category-button[data-category="image"]');r?fr(r):(Oa(),Ua())}};de.length&&de.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.nav||"text",a=ra[t],r=a==null?void 0:a.classList.contains("is-open");sr(),de.forEach(i=>i.classList.remove("active")),r||(nr(t),e.classList.add("active"))})});const or=document.querySelector('button[aria-label="Undo"]'),lr=document.querySelector('button[aria-label="Redo"]');or&&or.addEventListener("click",je),lr&&lr.addEventListener("click",Jt),Te(),ia.forEach(e=>{e.addEventListener("click",()=>{const t=e.closest(".modal");wa(t)})}),window.addEventListener("click",e=>{e.target.classList.contains("modal")&&e.target.classList.contains("is-open")&&wa(e.target)}),document.addEventListener("keydown",e=>{if(e.key==="Escape"){const t=document.querySelector(".modal.is-open");t&&wa(t)}});async function Qr(e){if(!e||!e.fullUrl){console.error("[InkWise Studio] Invalid graphic item:",e);return}const t=document.getElementById("background-modal");if(t&&t.classList.contains("is-open")&&$e){try{const i=await fetch(e.fullUrl);if(!i.ok)throw new Error(`Failed to fetch background image: ${i.status}`);const s=await i.blob(),l=await Ni(s);ki(l),console.log("[InkWise Studio] Applied graphic as background image")}catch(i){console.error("[InkWise Studio] Failed to apply background graphic:",i),alert("Failed to apply background image. Please try again.")}return}const r=getSvgRoot(Le);if(!r){console.error("[InkWise Studio] No SVG root found for side:",Le);return}try{const s=`graphic-${`graphic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}`;if(e.fullUrl.includes(".svg")||e.id.startsWith("iconify-")){const d=await fetch(e.fullUrl);if(!d.ok)throw new Error(`Failed to fetch SVG: ${d.status}`);const u=await d.text(),x=document.createElementNS("http://www.w3.org/2000/svg","g");x.setAttribute("data-preview-node",s),x.setAttribute("data-preview-label",e.alt||"Graphic"),x.setAttribute("class","inserted-graphic"),x.setAttribute("data-editable-image","true"),x.setAttribute("transform","translate(100, 100) scale(0.5)");const w=new DOMParser().parseFromString(u,"image/svg+xml").documentElement;for(;w.firstChild;)x.appendChild(w.firstChild);r.appendChild(x);const y=pe(x);y&&(x.style.cursor="pointer",x.addEventListener("click",p=>{p.stopPropagation(),dt();const A=Va(y.overlay,x);A&&(ze=A)})),console.log("[InkWise Studio] Inserted SVG graphic:",s)}else{const d=document.createElementNS("http://www.w3.org/2000/svg","image");d.setAttribute("data-preview-node",s),d.setAttribute("data-preview-label",e.alt||"Graphic"),d.setAttribute("class","inserted-graphic"),d.setAttribute("data-editable-image","true"),d.setAttribute("x","100"),d.setAttribute("y","100"),d.setAttribute("width","200"),d.setAttribute("height","200"),d.setAttribute("preserveAspectRatio","xMidYMid meet"),d.setAttributeNS("http://www.w3.org/1999/xlink","href",e.fullUrl),r.appendChild(d);const u=pe(d);u&&(d.style.cursor="pointer",d.addEventListener("click",x=>{x.stopPropagation(),dt();const E=Va(u.overlay,d);E&&(ze=E)})),console.log("[InkWise Studio] Inserted raster graphic:",s)}updatePreview(Le),flushAutosave("graphic-inserted"),console.log("[InkWise Studio] Graphic inserted successfully")}catch(i){console.error("[InkWise Studio] Failed to insert graphic:",i),alert("Failed to insert graphic. Please try again.")}}const xa=document.querySelector(".graphics-categories-labels"),j=document.getElementById("graphics-browser-samples"),cr=document.querySelectorAll(".graphics-category-button"),yt=document.getElementById("graphics-search-form"),bt=document.getElementById("graphics-search-input"),dr="53250708-d3f88461e75cb0c2c5366a181",ei={shapes:{provider:"iconify",baseUrl:"https://api.iconify.design",perPage:36,query:"circle",prefix:"",label:"Shapes",searchPlaceholder:"Search shapes"},image:{provider:"unsplash",apiKey:"iFpUZ_6aTnLGz0Voz0MYlprq9i_RBl83ux9DzV6EMOs",perPage:12,query:"wedding invitation design",label:"Images",searchPlaceholder:"Search images"},icons:{provider:"flaticon",apiKey:"FPSX2c99579cb6ea5314189561ca375a1648",perPage:48,query:"wedding icon",label:"Icons",searchPlaceholder:"Search icons"},illustrations:{provider:"pixabay",apiKey:dr,perPage:18,query:"wedding illustration",imageType:"illustration",label:"Illustrations",searchPlaceholder:"Search illustrations"},patterns:{provider:"pixabay",apiKey:dr,perPage:18,query:"seamless pattern",imageType:"vector",label:"Patterns",searchPlaceholder:"Search patterns"}},ur=new Map;let qa=0;function Sa(e,t){const a=(t||"").trim();return a||e.query||e.defaultQuery||""}function Ua(){j&&(j.innerHTML="",j.dataset.category="",j.dataset.page="0",j.dataset.loading="0",j.dataset.hasMore="0",j.dataset.searchTerm="",j.dataset.requestToken="")}function Oa(){if(!xa||!j)return;xa.querySelectorAll(".category-row").forEach(t=>{t.style.display="flex",t.dataset.expanded="0"}),cr.forEach(t=>{t.setAttribute("aria-expanded","false"),t.classList.remove("is-open")}),j.scrollTop=0,j.innerHTML="",j.dataset.category="",j.dataset.page="0",j.dataset.loading="0",j.dataset.hasMore="0",j.dataset.searchTerm="",j.dataset.requestToken="",yt&&(yt.classList.add("is-hidden"),yt.dataset.category=""),bt&&(bt.value="",bt.blur())}function Wa(e){return ei[e]||null}async function fr(e){var h,w,y;const t=e.dataset.category;if(!t||!j||!xa)return;if(e.getAttribute("aria-expanded")==="true"){Oa(),Ua();return}const r=Wa(t);if(!r){console.warn(`[InkWise Studio] No graphics configuration found for category "${t}".`);return}Oa();const i=ur.get(t)||"",s=r.label||"",l=(y=(w=(h=e.closest(".category-row"))==null?void 0:h.querySelector(".category-label"))==null?void 0:w.textContent)==null?void 0:y.trim(),d=s||l||t,u=r.searchPlaceholder||`Search ${d.toLowerCase()}`;yt&&(yt.classList.remove("is-hidden"),yt.dataset.category=t),bt&&(bt.placeholder=u,bt.value=i),e.setAttribute("aria-expanded","true"),e.classList.add("is-open"),xa.querySelectorAll(".category-row").forEach(p=>{p.dataset.categoryRow===t?(p.style.display="flex",p.dataset.expanded="1"):p.style.display="none"}),j.innerHTML="",j.dataset.category=t,j.dataset.page="0",j.dataset.loading="0",j.dataset.hasMore="1",j.dataset.searchTerm=i,j.scrollTop=0;const E=String(++qa);j.dataset.requestToken=E,pr(),await Ha(t,1,i,E)}function pr(){if(!j)return;const e=j.querySelector(".graphics-loading");if(e){e.style.display="flex";return}const t=document.createElement("div");t.className="graphics-loading",t.textContent="Loading assets…",j.appendChild(t)}function mr(){if(!j)return;const e=j.querySelector(".graphics-loading");e&&e.remove()}function hr(e){if(!j)return;j.innerHTML="";const t=document.createElement("div");t.className="graphics-error",t.textContent=e||"Unable to load assets at the moment.",j.appendChild(t)}function ti(e){if(!j||!Array.isArray(e))return;const t=document.createDocumentFragment();e.forEach(a=>{if(!a||!a.thumbUrl)return;const r=document.createElement("div");r.className="graphics-sample",r.title=a.alt||"Graphic sample";const i=document.createElement("img");if(i.src=a.thumbUrl,i.alt=a.alt||"Graphic sample",i.loading="lazy",r.appendChild(i),a.label){const s=document.createElement("span");s.className="sample-label",s.textContent=a.label,r.appendChild(s)}r.addEventListener("click",async()=>{console.log("Selected asset",a);try{await Qr(a)}catch(s){console.error("[InkWise Studio] Failed to insert graphic:",s)}}),t.appendChild(r)}),mr(),j.appendChild(t)}async function Ha(e,t,a,r){if(!j)return;const i=Wa(e);if(!i)return;const s=j.dataset.requestToken||"",l=r||s||String(++qa);if(!(j.dataset.loading==="1"&&l===s)){j.dataset.loading="1",pr();try{const d=typeof a=="string"?a:j.dataset.searchTerm||"",u=await ai(i,t,d);if(j.dataset.requestToken!==l)return;if(j.dataset.loading="0",mr(),!u.length&&t===1){hr("No assets found for this category right now. Try again in a moment."),j.dataset.hasMore="0";return}ti(u),j.dataset.page=String(t);const x=i.perPage||12;j.dataset.hasMore=u.length>=x?"1":"0"}catch(d){if(console.error("[InkWise Studio] Failed to load graphics assets:",d),j.dataset.requestToken!==l)return;j.dataset.loading="0",hr("We ran into a problem loading assets. Please try again."),j.dataset.hasMore="0"}}}async function ai(e,t,a){switch(e.provider){case"unsplash":return ri(e,t,a);case"pixabay":return ii(e,t,a);case"flaticon":return si(e,t,a);case"iconify":return ni(e,t,a);default:return console.warn("[InkWise Studio] Unknown graphics provider:",e.provider),[]}}async function ri(e,t,a){const r=e.perPage||12,i=Sa(e,a),s=i?"https://api.unsplash.com/search/photos":"https://api.unsplash.com/photos",l=new URLSearchParams({per_page:String(r),page:String(t),client_id:e.apiKey});i&&(l.set("query",i),l.set("orientation","portrait"));const d=`${s}?${l.toString()}`,u=await fetch(d);if(!u.ok)throw new Error(`Unsplash API error: ${u.status}`);const x=await u.json();return(Array.isArray(x)?x:Array.isArray(x.results)?x.results:[]).map(h=>{const w=h.urls||{};return{id:`unsplash-${h.id}`,thumbUrl:w.small||w.thumb||w.regular||"",fullUrl:w.full||w.regular||w.raw||"",alt:h.alt_description||h.description||h.slug||"Unsplash image"}}).filter(h=>!!h.thumbUrl)}async function ii(e,t,a){const r=e.perPage||18,i=new URLSearchParams({key:e.apiKey,q:Sa(e,a),per_page:String(r),page:String(t),safesearch:"true",order:"popular"});e.imageType&&i.set("image_type",e.imageType),e.category&&i.set("category",e.category);const s=await fetch(`https://pixabay.com/api/?${i.toString()}`);if(!s.ok)throw new Error(`Pixabay API error: ${s.status}`);const l=await s.json();return(Array.isArray(l==null?void 0:l.hits)?l.hits:[]).map(u=>({id:`pixabay-${u.id}`,thumbUrl:u.previewURL||u.webformatURL||"",fullUrl:u.largeImageURL||u.webformatURL||"",alt:u.tags||"Pixabay asset",label:u.user?`@${u.user}`:null})).filter(u=>!!u.thumbUrl)}async function si(e,t,a){const r=e.perPage||48,i=new URLSearchParams({q:Sa(e,a)||"icon",limit:String(r),page:String(t)});i.set("apikey",e.apiKey);const s=await fetch(`https://api.flaticon.com/v3/search/icons?${i.toString()}`,{headers:{Accept:"application/json",apikey:e.apiKey,Authorization:`Bearer ${e.apiKey}`}});if(!s.ok)throw new Error(`Flaticon API error: ${s.status}`);const l=await s.json();return(Array.isArray(l==null?void 0:l.data)?l.data:Array.isArray(l==null?void 0:l.icons)?l.icons:Array.isArray(l==null?void 0:l.result)?l.result:[]).map(u=>{var p;const x=(u==null?void 0:u.images)||u,E=(x==null?void 0:x.png)||{},h=(x==null?void 0:x.svg)||(x==null?void 0:x.svg)||null,w=E[128]||E[256]||h||(x==null?void 0:x["64"])||null,y=E[512]||E[256]||h||w;return w?{id:`flaticon-${(u==null?void 0:u.id)||(u==null?void 0:u.icon_id)||(u==null?void 0:u.id_icon)||Math.random().toString(36).slice(2)}`,thumbUrl:w,fullUrl:y,alt:(u==null?void 0:u.description)||(Array.isArray(u==null?void 0:u.tags)?u.tags.join(", "):"Icon asset"),label:((p=u==null?void 0:u.uploader)==null?void 0:p.name)||(u==null?void 0:u.category)||null}:null}).filter(Boolean)}async function ni(e,t,a){const r=e.perPage||36,i=Math.max(0,(t-1)*r),s=new URLSearchParams({query:Sa(e,a)||"shape",limit:String(r),offset:String(i)});e.prefix&&s.set("prefix",e.prefix);const l=(e.baseUrl||"https://api.iconify.design").replace(/\/$/,""),d=await fetch(`${l}/search?${s.toString()}`,{headers:{Accept:"application/json"}});if(!d.ok)throw new Error(`Iconify API error: ${d.status}`);const u=await d.json(),x=Array.isArray(u==null?void 0:u.icons)?u.icons:[],E=Array.isArray(u==null?void 0:u.prefixes)&&u.prefixes.length===1?u.prefixes[0]:(u==null?void 0:u.prefix)||e.prefix||"";return x.map(h=>{if(typeof h=="string"){const w=h.includes(":")?h:E?`${E}:${h}`:h;if(!w)return null;const y=w.split(":").map(A=>encodeURIComponent(A)).join(":"),p=w.split(":").pop()||w;return{id:`iconify-${w.replace(/[^a-zA-Z0-9:]/g,"-")}-${t}`,thumbUrl:`${l}/${y}.svg?height=120&width=120`,fullUrl:`${l}/${y}.svg`,alt:p.replace(/[-_]/g," "),label:p.replace(/[-_]/g," ")}}if(h&&typeof h=="object"){const w=h.name||h.icon||h.id||"";if(!w)return null;const y=h.prefix||E,p=y?`${y}:${w}`:w,A=p.split(":").map(te=>encodeURIComponent(te)).join(":"),L=h.label||w;return{id:`iconify-${p.replace(/[^a-zA-Z0-9:]/g,"-")}-${t}`,thumbUrl:`${l}/${A}.svg?height=120&width=120`,fullUrl:`${l}/${A}.svg`,alt:L.replace(/[-_]/g," "),label:L.replace(/[-_]/g," ")}}return null}).filter(h=>!!(h!=null&&h.thumbUrl))}async function oi(){if(!j)return;const e=j.dataset.category;if(!e||j.dataset.loading==="1"||j.dataset.hasMore==="0")return;if(j.scrollTop+j.clientHeight>=j.scrollHeight-180){const a=Number(j.dataset.page||"1")+1,r=j.dataset.searchTerm||"";await Ha(e,a,r)}}cr.forEach(e=>{e.addEventListener("click",()=>fr(e))}),j&&(j.addEventListener("scroll",()=>{oi().catch(e=>{console.error("[InkWise Studio] graphics scroll handler error:",e)})}),Ua()),yt&&bt&&yt.addEventListener("submit",async e=>{if(e.preventDefault(),!j)return;const t=j.dataset.category;if(!t||!Wa(t))return;const a=bt.value.trim();ur.set(t,a),j.scrollTop=0,j.innerHTML="",j.dataset.page="0",j.dataset.hasMore="1",j.dataset.searchTerm=a,j.dataset.loading="0";const r=String(++qa);j.dataset.requestToken=r;try{await Ha(t,1,a,r)}catch(i){console.error("[InkWise Studio] graphics search failed:",i)}});const gr=e=>!e||!N?null:N.querySelector(`input[data-preview-target="${e}"]`),li=e=>!e||!F?null:F.querySelector(`[data-preview-node="${e}"]`),yr=(()=>{let e=!1;return()=>{if(e||typeof document>"u")return;const t=document.createElement("style");t.id="inkwise-crop-overlay-styles",t.textContent=`
.crop-overlay {
  position: absolute;
  inset: 0;
  z-index: 12;
}

.crop-overlay__scrim {
  position: absolute;
  background: rgba(15, 23, 42, 0.35);
  backdrop-filter: blur(10px);
  pointer-events: none;
  transition: transform 0.18s ease, opacity 0.18s ease;
}

.crop-frame {
  position: absolute;
  border-radius: 18px;
  border: 1.5px solid rgba(255, 255, 255, 0.92);
  box-shadow: 0 18px 36px rgba(15, 23, 42, 0.3);
  pointer-events: auto;
  cursor: grab;
  background: rgba(15, 23, 42, 0.08);
  transition: box-shadow 0.24s ease, border-color 0.24s ease;
}

.crop-frame:active {
  cursor: grabbing;
  box-shadow: 0 24px 48px rgba(15, 23, 42, 0.34);
}

.crop-frame::after {
  content: '';
  position: absolute;
  inset: 0;
  border: 1px solid rgba(255, 255, 255, 0.45);
  border-radius: inherit;
  pointer-events: none;
  mix-blend-mode: screen;
}

.crop-frame__corner {
  position: absolute;
  width: 28px;
  height: 28px;
  pointer-events: auto;
}

.crop-frame__corner .corner-arm {
  position: absolute;
  background: rgba(255, 255, 255, 0.98);
  box-shadow: 0 6px 14px rgba(15, 23, 42, 0.28);
  border-radius: 999px;
  pointer-events: none;
}

.crop-frame__corner .corner-arm--horizontal {
  width: 18px;
  height: 3px;
}

.crop-frame__corner .corner-arm--vertical {
  width: 3px;
  height: 18px;
}

.crop-frame__corner--top-left {
  top: -4px;
  left: -4px;
}

.crop-frame__corner--top-right {
  top: -4px;
  right: -4px;
}

.crop-frame__corner--bottom-left {
  bottom: -4px;
  left: -4px;
}

.crop-frame__corner--bottom-right {
  bottom: -4px;
  right: -4px;
}

.crop-frame__corner--top-left .corner-arm--horizontal,
.crop-frame__corner--bottom-left .corner-arm--horizontal {
  top: 0;
  left: 0;
}

.crop-frame__corner--top-left .corner-arm--vertical,
.crop-frame__corner--top-right .corner-arm--vertical {
  top: 0;
}

.crop-frame__corner--top-right .corner-arm--horizontal,
.crop-frame__corner--bottom-right .corner-arm--horizontal {
  top: 0;
  right: 0;
}

.crop-frame__corner--bottom-left .corner-arm--horizontal,
.crop-frame__corner--bottom-right .corner-arm--horizontal {
  bottom: 0;
}

.crop-frame__corner--bottom-left .corner-arm--vertical,
.crop-frame__corner--bottom-right .corner-arm--vertical {
  bottom: 0;
}

.crop-frame__corner--top-right .corner-arm--vertical,
.crop-frame__corner--bottom-right .corner-arm--vertical {
  right: 0;
}

.crop-frame__corner--top-left .corner-arm--vertical,
.crop-frame__corner--bottom-left .corner-arm--vertical {
  left: 0;
}

.crop-frame__edge-handle {
  position: absolute;
  width: 16px;
  height: 16px;
  border-radius: 999px;
  border: 2px solid rgba(255, 255, 255, 0.92);
  background: rgba(15, 23, 42, 0.55);
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.32);
  pointer-events: none;
}

.crop-frame__edge-handle--top {
  top: -10px;
  left: 50%;
  transform: translate(-50%, 0);
}

.crop-frame__edge-handle--right {
  right: -10px;
  top: 50%;
  transform: translate(0, -50%);
}

.crop-frame__edge-handle--bottom {
  bottom: -10px;
  left: 50%;
  transform: translate(-50%, 0);
}

.crop-frame__edge-handle--left {
  left: -10px;
  top: 50%;
  transform: translate(0, -50%);
}

.editor-overlay--crop-active {
  border-color: transparent !important;
  box-shadow: none !important;
  background: transparent !important;
}

.editor-overlay--crop-active .editor-overlay__handle {
  display: none !important;
}

.editor-overlay--crop-active::after {
  display: none !important;
}

.editor-overlay--hidden-for-crop {
  opacity: 0;
  pointer-events: none;
}

.crop-overlay__controls {
  position: absolute;
  left: 50%;
  bottom: 24px;
  transform: translateX(-50%);
  display: flex;
  gap: 12px;
  pointer-events: auto;
  z-index: 5;
}

.crop-overlay__button {
  border: none;
  border-radius: 999px;
  padding: 9px 20px;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: #ffffff;
  cursor: pointer;
  background: rgba(15, 23, 42, 0.82);
  box-shadow: 0 16px 36px rgba(15, 23, 42, 0.35);
  transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
}

.crop-overlay__button:hover {
  background: rgba(15, 23, 42, 0.92);
  transform: translateY(-1px);
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.4);
}

.crop-overlay__button:active {
  transform: translateY(0);
  box-shadow: 0 12px 28px rgba(15, 23, 42, 0.34);
}

.crop-overlay__button:focus-visible {
  outline: 2px solid rgba(96, 165, 250, 0.95);
  outline-offset: 2px;
}

.crop-overlay__button--cancel {
  background: rgba(148, 163, 184, 0.74);
  color: rgba(15, 23, 42, 0.92);
}

.crop-overlay__button--cancel:hover {
  background: rgba(226, 232, 240, 0.92);
  color: rgba(15, 23, 42, 0.95);
}

.crop-overlay__button--apply {
  background: linear-gradient(135deg, rgba(14, 165, 233, 0.92), rgba(59, 130, 246, 0.9));
}

.crop-overlay__button--apply:hover {
  background: linear-gradient(135deg, rgba(14, 165, 233, 1), rgba(37, 99, 235, 0.98));
}

@media (prefers-reduced-motion: reduce) {
  .crop-overlay__scrim,
  .crop-frame {
    transition: none;
  }
}
        `,document.head.appendChild(t),e=!0}})(),dt=()=>{ze&&(ze.teardown(),ze=null)},Va=(e,t)=>{if(!e||!t)return null;yr(),getComputedStyle(e).position==="static"&&(e.style.position="relative");const a=(m,k,$)=>Math.min(Math.max(m,k),$);(()=>{if(t.dataset.cropSourceWidth&&t.dataset.cropSourceHeight)return;let m=null;try{m=t.getBBox()}catch{m=null}const k=m&&Number.isFinite(m.width)&&m.width>0?m.width:parseFloat(t.getAttribute("width"))||0,$=m&&Number.isFinite(m.height)&&m.height>0?m.height:parseFloat(t.getAttribute("height"))||0,T=m&&Number.isFinite(m.x)?m.x:parseFloat(t.getAttribute("x"))||0,se=m&&Number.isFinite(m.y)?m.y:parseFloat(t.getAttribute("y"))||0;k>0&&$>0&&(t.dataset.cropSourceWidth=k,t.dataset.cropSourceHeight=$,t.dataset.cropSourceX=T,t.dataset.cropSourceY=se)})();const i=document.createElement("div");i.className="crop-overlay";const s=(()=>{const m=typeof t.dataset.cropRect=="string"?t.dataset.cropRect:"",k=t.getAttribute("clip-path")||"",$=t.style&&typeof t.style.clipPath=="string"?t.style.clipPath:"",T=t.style&&typeof t.style.webkitClipPath=="string"?t.style.webkitClipPath:"",se=t.dataset.cropClipId||"",oe=(()=>{const ee=k.match(/^url\(#(.+)\)$/);return ee?ee[1]:""})(),le=se||oe;let ae=null;if(le){const ee=Tt(t.ownerSVGElement||null),O=ee==null?void 0:ee.querySelector(`#${le}`),W=O==null?void 0:O.querySelector("rect");W&&(ae={x:W.getAttribute("x")||"",y:W.getAttribute("y")||"",width:W.getAttribute("width")||"",height:W.getAttribute("height")||""})}return{rectString:m,clipPathAttr:k,clipId:le,clipRect:ae,clipPathStyle:$,webkitClipPathStyle:T}})(),l=[],d=document.createElement("div");d.className="crop-overlay__scrim crop-overlay__scrim--top";const u=document.createElement("div");u.className="crop-overlay__scrim crop-overlay__scrim--right";const x=document.createElement("div");x.className="crop-overlay__scrim crop-overlay__scrim--bottom";const E=document.createElement("div");E.className="crop-overlay__scrim crop-overlay__scrim--left",[d,u,x,E].forEach(m=>{m.style.pointerEvents="none",i.appendChild(m)});const w=document.createElement("div");w.className="crop-frame",i.appendChild(w);const y=document.createElement("div");y.className="crop-overlay__controls";const p=document.createElement("button");p.type="button",p.className="crop-overlay__button crop-overlay__button--cancel",p.textContent="Cancel";const A=document.createElement("button");A.type="button",A.className="crop-overlay__button crop-overlay__button--apply",A.textContent="Crop",y.appendChild(p),y.appendChild(A),i.appendChild(y);const L=["top-left","top-right","bottom-left","bottom-right"],te=[],ye={"top-left":"nwse-resize","bottom-right":"nwse-resize","top-right":"nesw-resize","bottom-left":"nesw-resize"};L.forEach(m=>{const k=document.createElement("div");k.className=`crop-frame__corner crop-frame__corner--${m}`,k.dataset.corner=m,k.style.pointerEvents="auto",k.style.cursor=ye[m]||"nwse-resize";const $=document.createElement("span");$.className="corner-arm corner-arm--horizontal",$.style.pointerEvents="none";const T=document.createElement("span");T.className="corner-arm corner-arm--vertical",T.style.pointerEvents="none",k.appendChild($),k.appendChild(T),w.appendChild(k),te.push(k)});const Q=["top","right","bottom","left"],we=[];Q.forEach(m=>{const k=document.createElement("div");k.className=`crop-frame__edge-handle crop-frame__edge-handle--${m}`,k.dataset.edge=m,k.style.pointerEvents="auto",k.style.cursor=m==="top"||m==="bottom"?"ns-resize":"ew-resize",w.appendChild(k),we.push(k)}),e.appendChild(i);let U=e.getBoundingClientRect(),B=U.width||e.offsetWidth,M=U.height||e.offsetHeight,Ue=B,St=M;if(!B||!M)return i.remove(),null;Ae.forEach(m=>{!m||!m.overlay||m.overlay!==e&&(m.overlay.classList.contains("editor-overlay--hidden-for-crop")||(m.overlay.classList.add("editor-overlay--hidden-for-crop"),l.push(m.overlay)))}),e.classList.add("editor-overlay--crop-active"),e.dataset.cropSessionActive="true",re(),i.style.pointerEvents="none",w.style.pointerEvents="auto";const at=(()=>{const m=t.dataset.cropRect;if(!m)return null;const k=m.split(",").map($=>Number($));return k.length!==4||k.some($=>!Number.isFinite($))?null:{left:a(k[0],0,1),top:a(k[1],0,1),width:a(k[2],0,1),height:a(k[3],0,1)}})(),Ht=parseFloat(t.dataset.cropSourceWidth)||0,Fa=parseFloat(t.dataset.cropSourceHeight)||0;let fe,be;const Vt=()=>{be=Math.min(B,Math.max(48,B*.08)),fe=Math.min(M,Math.max(48,M*.08))};Vt();const C={left:0,top:0,width:0,height:0};if(at&&at.width>0&&at.height>0){const m=at.width*B,k=at.height*M;C.width=a(m,be,B),C.height=a(k,fe,M),C.left=a(at.left*B,0,B-C.width),C.top=a(at.top*M,0,M-C.height)}else{const m=Ht>0&&Fa>0?Ht/Fa:B>0&&M>0?B/M:1;let k,$;m>=1?(k=B*.85,$=k/m):($=M*.85,k=$*m),C.width=a(k,be,B),C.height=a($,fe,M),C.left=Math.max(0,(B-C.width)/2),C.top=Math.max(0,(M-C.height)/2)}C.width=a(C.width,be,B),C.height=a(C.height,fe,M),C.left=a(C.left,0,B-C.width),C.top=a(C.top,0,M-C.height);const is=()=>{const m=C.left+C.width,k=C.top+C.height;d.style.top="0px",d.style.left="0px",d.style.width="100%",d.style.height=`${Math.max(0,C.top)}px`,d.style.display=C.top>0?"block":"none",x.style.top=`${k}px`,x.style.left="0px",x.style.width="100%",x.style.height=`${Math.max(0,M-k)}px`,x.style.display=k<M?"block":"none",E.style.top=`${C.top}px`,E.style.left="0px",E.style.width=`${Math.max(0,C.left)}px`,E.style.height=`${C.height}px`,E.style.display=C.left>0?"block":"none",u.style.top=`${C.top}px`,u.style.left=`${m}px`,u.style.width=`${Math.max(0,B-m)}px`,u.style.height=`${C.height}px`,u.style.display=m<B?"block":"none"},Mr=(m,k,$,T)=>{const se=t.ownerSVGElement;if(!se)return;const oe=parseFloat(t.dataset.cropSourceWidth)||0,le=parseFloat(t.dataset.cropSourceHeight)||0,ae=parseFloat(t.dataset.cropSourceX)||0,ee=parseFloat(t.dataset.cropSourceY)||0;let O=oe,W=le,Ye=ae,Ba=ee;if(!O||!W){let Ee=null;try{Ee=t.getBBox()}catch{Ee=null}O=Ee&&Number.isFinite(Ee.width)&&Ee.width>0?Ee.width:parseFloat(t.getAttribute("width"))||0,W=Ee&&Number.isFinite(Ee.height)&&Ee.height>0?Ee.height:parseFloat(t.getAttribute("height"))||0,Ye=Ee&&Number.isFinite(Ee.x)?Ee.x:parseFloat(t.getAttribute("x"))||0,Ba=Ee&&Number.isFinite(Ee.y)?Ee.y:parseFloat(t.getAttribute("y"))||0}if(!O||!W)return;if(t instanceof HTMLImageElement){const Ee=a(k,0,1)*100,Yr=a(m,0,1)*100,us=a(1-(k+T),0,1)*100,fs=a(1-(m+$),0,1)*100,ar=`inset(${Ee}% ${fs}% ${us}% ${Yr}%)`;t.style.clipPath=ar,t.style.webkitClipPath=ar,delete t.dataset.cropClipId,t.dataset.cropCssClip=ar;return}const Yt=Tt(se);if(!Yt)return;const pt=t.dataset.cropClipId||`inkwiseCrop_${Date.now()}_${Math.floor(Math.random()*1e3)}`;let Je=Yt.querySelector(`#${pt}`);Je||(Je=document.createElementNS(H,"clipPath"),Je.id=pt,Je.setAttribute("clipPathUnits","userSpaceOnUse"),Yt.appendChild(Je));let Ze=Je.querySelector("rect");Ze||(Ze=document.createElementNS(H,"rect"),Je.appendChild(Ze));const os=O*$,ls=W*T,cs=Ye+O*m,ds=Ba+W*k;Ze.setAttribute("x",cs),Ze.setAttribute("y",ds),Ze.setAttribute("width",os),Ze.setAttribute("height",ls),t.dataset.cropClipId=pt,t.setAttribute("clip-path",`url(#${pt})`),t.style.removeProperty("clip-path"),t.style.removeProperty("-webkit-clip-path"),delete t.dataset.cropCssClip},ss=()=>{if(!B||!M)return;const m=t.dataset.cropRect||"",k=typeof t.getAttribute("clip-path")=="string"&&t.getAttribute("clip-path").length>0,$=t.ownerSVGElement,T=C.left/B,se=C.top/M,oe=C.width/B,le=C.height/M,ae=a(T,0,1),ee=a(se,0,1),O=a(oe,0,1-ae),W=a(le,0,1-ee),Ye=ae+O,Ba=ee+W;if(ae<=.001&&ee<=.001&&Ye>=.999&&Ba>=.999){const pt=t.dataset.cropClipId;if(pt){const Je=Tt($),Ze=Je==null?void 0:Je.querySelector(`#${pt}`);Ze==null||Ze.remove(),delete t.dataset.cropClipId}t.removeAttribute("clip-path"),t.style.removeProperty("clip-path"),t.style.removeProperty("-webkit-clip-path"),delete t.dataset.cropCssClip,delete t.dataset.cropRect,(m||k)&&(v==null||v.schedule("image-crop"),re());return}const Yt=[ae,ee,O,W].map(pt=>pt.toFixed(6)).join(",");t.dataset.cropRect=Yt,Mr(ae,ee,O,W),m!==Yt&&(v==null||v.schedule("image-crop"),re())},Br=()=>{var ee;const m=t.dataset.cropRect||"",k=t.getAttribute("clip-path")||"",$=t.dataset.cropClipId||"",T=t.ownerSVGElement,se=t.dataset.cropClipId;if(se&&se!==s.clipId){const O=Tt(T);(ee=O==null?void 0:O.querySelector(`#${se}`))==null||ee.remove()}if(s.rectString){t.dataset.cropRect=s.rectString,s.clipId?t.dataset.cropClipId=s.clipId:delete t.dataset.cropClipId;const O=s.rectString.split(",").map(W=>Number(W));O.length===4&&O.every(W=>Number.isFinite(W))&&Mr(O[0],O[1],O[2],O[3]),s.clipPathAttr?t.setAttribute("clip-path",s.clipPathAttr):t.removeAttribute("clip-path"),s.clipPathStyle?(t.style.clipPath=s.clipPathStyle,t.dataset.cropCssClip=s.clipPathStyle):(t.style.removeProperty("clip-path"),delete t.dataset.cropCssClip),s.webkitClipPathStyle?t.style.webkitClipPath=s.webkitClipPathStyle:t.style.removeProperty("-webkit-clip-path")}else{if(delete t.dataset.cropRect,s.clipId){if(t.dataset.cropClipId=s.clipId,s.clipRect){const O=Tt(T);if(O){let W=O.querySelector(`#${s.clipId}`);W||(W=document.createElementNS(H,"clipPath"),W.id=s.clipId,W.setAttribute("clipPathUnits","userSpaceOnUse"),O.appendChild(W));let Ye=W.querySelector("rect");Ye||(Ye=document.createElementNS(H,"rect"),W.appendChild(Ye)),Ye.setAttribute("x",s.clipRect.x),Ye.setAttribute("y",s.clipRect.y),Ye.setAttribute("width",s.clipRect.width),Ye.setAttribute("height",s.clipRect.height)}}s.clipPathAttr&&t.setAttribute("clip-path",s.clipPathAttr)}else delete t.dataset.cropClipId,s.clipPathAttr?t.setAttribute("clip-path",s.clipPathAttr):t.removeAttribute("clip-path");s.clipPathStyle?(t.style.clipPath=s.clipPathStyle,t.dataset.cropCssClip=s.clipPathStyle):(t.style.removeProperty("clip-path"),delete t.dataset.cropCssClip),s.webkitClipPathStyle?t.style.webkitClipPath=s.webkitClipPathStyle:t.style.removeProperty("-webkit-clip-path")}const oe=t.dataset.cropRect||"",le=t.getAttribute("clip-path")||"",ae=t.dataset.cropClipId||"";(m!==oe||k!==le||$!==ae)&&(v==null||v.schedule("image-crop"),re())},ft=()=>{w.style.left=`${C.left}px`,w.style.top=`${C.top}px`,w.style.width=`${C.width}px`,w.style.height=`${C.height}px`,is(),ss()};ft();let Ne=null,ne=null;const er=()=>{const m=B||(U==null?void 0:U.width)||(c==null?void 0:c.clientWidth)||0,k=M||(U==null?void 0:U.height)||(c==null?void 0:c.clientHeight)||0,$=Math.min(m,k);return Math.max(8,Math.round($*.02))},Gt=(m,k)=>{const $=[],T=Math.round(m/Dt)*Dt;$.push(T),Number.isFinite(k)&&k>0&&$.push(k/2);let se=m,oe=Number.POSITIVE_INFINITY;return $.forEach(le=>{const ae=Math.abs(le-m);ae<oe&&ae<=ha&&(se=le,oe=ae)}),se},Rr=m=>{if(m.button!==0||m.target!==w)return;m.preventDefault(),U=e.getBoundingClientRect();const k=U.width||B,$=U.height||M;Ne={pointerId:m.pointerId,startX:m.clientX,startY:m.clientY,widthLimit:k,heightLimit:$,startLeft:C.left,startTop:C.top},w.setPointerCapture(m.pointerId)},Pr=m=>{if(!Ne||m.pointerId!==Ne.pointerId)return;m.preventDefault();const k=m.clientX-Ne.startX,$=m.clientY-Ne.startY,T=er(),se=Math.max(0,Ne.widthLimit-C.width-T*2),oe=Math.max(0,Ne.heightLimit-C.height-T*2),le=Ne.startLeft+k,ae=Ne.startTop+$,ee=Gt(le,Ne.widthLimit),O=Gt(ae,Ne.heightLimit);C.left=a(ee,T,T+se),C.top=a(O,T,T+oe),ft()},_a=m=>{if(!(!Ne||m.pointerId!==Ne.pointerId)){try{w.releasePointerCapture(m.pointerId)}catch{}Ne=null}};w.addEventListener("pointerdown",Rr),w.addEventListener("pointermove",Pr),w.addEventListener("pointerup",_a),w.addEventListener("pointercancel",_a);const $r=()=>{Ne=null};w.addEventListener("lostpointercapture",$r);const zr=m=>{m.button===0&&(m.preventDefault(),m.stopPropagation(),U=e.getBoundingClientRect(),B=U.width||e.offsetWidth||B,M=U.height||e.offsetHeight||M,Vt(),ne={pointerId:m.pointerId,mode:"edge",edge:m.currentTarget.dataset.edge,anchor:{left:C.left,top:C.top,right:C.left+C.width,bottom:C.top+C.height},target:m.currentTarget},m.currentTarget.setPointerCapture(m.pointerId))},Dr=m=>{if(!ne||m.pointerId!==ne.pointerId||ne.mode!=="edge")return;m.preventDefault(),U=e.getBoundingClientRect(),B=U.width||e.offsetWidth||B,M=U.height||e.offsetHeight||M,Vt();const k=m.clientX-U.left,$=m.clientY-U.top,T=ne.anchor,se=er();let oe=T.left,le=T.top,ae=a(T.right-T.left,be,B),ee=a(T.bottom-T.top,fe,M);if(ne.edge==="top"){const O=Math.min(T.bottom-fe,M-fe),W=a($,0,Math.max(0,O));le=W,ee=Math.max(fe,T.bottom-W)}else if(ne.edge==="bottom"){const O=T.top+fe,W=a($,O,M);le=T.top,ee=Math.max(fe,W-T.top)}else if(ne.edge==="left"){const O=Math.min(T.right-be,B-be),W=a(k,0,Math.max(0,O));oe=W,ae=Math.max(be,T.right-W)}else if(ne.edge==="right"){const O=T.left+be,W=a(k,O,B);oe=T.left,ae=Math.max(be,W-T.left)}ae=a(ae,be,B),ee=a(ee,fe,M),oe=Gt(a(oe,se,B-se-ae),B),le=Gt(a(le,se,M-se-ee),M),C.left=oe,C.top=le,C.width=ae,C.height=ee,ft()},ja=m=>{var k;if(!(!ne||m.pointerId!==ne.pointerId)){try{(k=ne.target)==null||k.releasePointerCapture(m.pointerId)}catch{}ne=null,ft()}},qr=()=>{ne=null},Ur=m=>{m.button===0&&(m.preventDefault(),m.stopPropagation(),U=e.getBoundingClientRect(),B=U.width||e.offsetWidth||B,M=U.height||e.offsetHeight||M,Vt(),ne={pointerId:m.pointerId,mode:"corner",corner:m.currentTarget.dataset.corner,anchor:{left:C.left,top:C.top,right:C.left+C.width,bottom:C.top+C.height},target:m.currentTarget},m.currentTarget.setPointerCapture(m.pointerId))},Or=m=>{if(!ne||m.pointerId!==ne.pointerId||ne.mode!=="corner")return;m.preventDefault(),U=e.getBoundingClientRect(),B=U.width||e.offsetWidth||B,M=U.height||e.offsetHeight||M,Vt();const k=m.clientX-U.left,$=m.clientY-U.top,T=ne.anchor,se=er();let oe=T.left,le=T.top,ae=a(T.right-T.left,be,B),ee=a(T.bottom-T.top,fe,M);switch(ne.corner){case"top-left":{const O=a(k,0,T.right-be),W=a($,0,T.bottom-fe);oe=O,le=W,ae=Math.max(be,T.right-O),ee=Math.max(fe,T.bottom-W);break}case"top-right":{const O=a(k,T.left+be,B),W=a($,0,T.bottom-fe);oe=T.left,le=W,ae=Math.max(be,O-T.left),ee=Math.max(fe,T.bottom-W);break}case"bottom-left":{const O=a(k,0,T.right-be),W=a($,T.top+fe,M);oe=O,le=T.top,ae=Math.max(be,T.right-O),ee=Math.max(fe,W-T.top);break}case"bottom-right":{const O=a(k,T.left+be,B),W=a($,T.top+fe,M);oe=T.left,le=T.top,ae=Math.max(be,O-T.left),ee=Math.max(fe,W-T.top);break}default:return}ae=a(ae,be,B),ee=a(ee,fe,M),oe=Gt(a(oe,se,B-se-ae),B),le=Gt(a(le,se,M-se-ee),M),C.left=oe,C.top=le,C.width=ae,C.height=ee,ft()},Ma=m=>{var k;if(!(!ne||m.pointerId!==ne.pointerId)){try{(k=ne.target)==null||k.releasePointerCapture(m.pointerId)}catch{}ne=null,ft()}},Wr=()=>{ne=null};we.forEach(m=>{m.addEventListener("pointerdown",zr),m.addEventListener("pointermove",Dr),m.addEventListener("pointerup",ja),m.addEventListener("pointercancel",ja),m.addEventListener("lostpointercapture",qr)}),te.forEach(m=>{m.addEventListener("pointerdown",Ur),m.addEventListener("pointermove",Or),m.addEventListener("pointerup",Ma),m.addEventListener("pointercancel",Ma),m.addEventListener("lostpointercapture",Wr)});const Hr=m=>{m.preventDefault(),m.stopPropagation(),Br(),dt()},Vr=m=>{m.preventDefault(),m.stopPropagation(),ft()};p.addEventListener("click",Hr),A.addEventListener("click",Vr);const Gr=m=>{m.key==="Escape"&&(m.preventDefault(),Br(),dt()),m.key==="Enter"&&(m.metaKey||m.ctrlKey)&&(m.preventDefault(),ft(),dt())};document.addEventListener("keydown",Gr);const tr=()=>{if(U=e.getBoundingClientRect(),B=U.width||e.offsetWidth||B,M=U.height||e.offsetHeight||M,!B||!M)return;Vt();const m=t.dataset.cropRect||null;if(m){const k=m.split(",").map($=>Number($));if(k.length===4&&k.every($=>Number.isFinite($))){const $=a(k[2]*B,be,B),T=a(k[3]*M,fe,M),se=a(k[0]*B,0,B-$),oe=a(k[1]*M,0,M-T);C.left=se,C.top=oe,C.width=$,C.height=T}}else{const k=Ue?C.width/Ue:1,$=St?C.height/St:1,T=Ue?C.left/Ue:0,se=St?C.top/St:0;C.width=a(k*B,be,B),C.height=a($*M,fe,M),C.left=a(T*B,0,B-C.width),C.top=a(se*M,0,M-C.height)}Ue=B,St=M,ft()};return window.addEventListener("resize",tr),{overlay:e,refresh:tr,teardown:()=>{var m;if(Ne&&typeof Ne.pointerId<"u"){try{w.releasePointerCapture(Ne.pointerId)}catch{}Ne=null}if(ne&&typeof ne.pointerId<"u"){try{(m=ne.target)==null||m.releasePointerCapture(ne.pointerId)}catch{}ne=null}window.removeEventListener("resize",tr),w.removeEventListener("pointerdown",Rr),w.removeEventListener("pointermove",Pr),w.removeEventListener("pointerup",_a),w.removeEventListener("pointercancel",_a),w.removeEventListener("lostpointercapture",$r),we.forEach(k=>{k.removeEventListener("pointerdown",zr),k.removeEventListener("pointermove",Dr),k.removeEventListener("pointerup",ja),k.removeEventListener("pointercancel",ja),k.removeEventListener("lostpointercapture",qr)}),te.forEach(k=>{k.removeEventListener("pointerdown",Ur),k.removeEventListener("pointermove",Or),k.removeEventListener("pointerup",Ma),k.removeEventListener("pointercancel",Ma),k.removeEventListener("lostpointercapture",Wr)}),p.removeEventListener("click",Hr),A.removeEventListener("click",Vr),document.removeEventListener("keydown",Gr),e.classList.remove("editor-overlay--crop-active"),delete e.dataset.cropSessionActive,l.forEach(k=>k.classList.remove("editor-overlay--hidden-for-crop")),l.length=0,re(),i.parentNode===e?e.removeChild(i):i.remove()}}},sa=()=>{he||me||$e?document.body.classList.add("text-toolbar-visible"):document.body.classList.remove("text-toolbar-visible")},na=()=>{Ae.forEach(({overlay:e,type:t})=>{var s;if(!e)return;const a=((s=e.dataset)==null?void 0:s.previewNode)||"",r=!!he&&a===he&&t==="text",i=!!me&&a===me&&t==="image";e.classList.toggle("editor-overlay--selected",r||i)})},qe=()=>$e?"background":me?"image":he?"text":null,Ga=e=>{if(typeof e!="string")return null;const t=e.match(/rgba?\s*\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})/i);if(!t)return null;const a=Number(t[1]),r=Number(t[2]),i=Number(t[3]);if([a,r,i].some(l=>Number.isNaN(l)||l<0||l>255))return null;const s=l=>l.toString(16).padStart(2,"0");return`#${s(a)}${s(r)}${s(i)}`.toUpperCase()};function ci(e){var t;try{if(e==="background"){if(!c)return null;const r=window.getComputedStyle(c).backgroundColor||c.style.backgroundColor||"";return Lt(r)||Ga(r)||null}if(e==="text"){const a=qt();if(!a.length)return null;const r=a[0],i=r.getAttribute("fill")||r.style.fill||r.dataset.color||"";return Lt(i)||Ga(i)||null}if(e==="image"){const a=Et();if(!a.length)return null;const i=((t=a[0].dataset)==null?void 0:t.tintColor)||"";return Lt(i)||null}}catch{return null}return null}const oa=()=>{if(typeof window>"u")return;const e=qe(),t=e==="text"?he:e==="image"?me:null,a=ci(e);try{const r=new CustomEvent("inkwise:active-element",{detail:{type:e,key:t,color:a}});window.dispatchEvent(r)}catch{if(typeof document<"u"&&document.createEvent){const i=document.createEvent("CustomEvent");i.initCustomEvent("inkwise:active-element",!0,!0,{type:e,key:t,color:a}),window.dispatchEvent(i)}}},vt=e=>{const t=typeof e=="string"&&e.trim()!==""?e.trim():null;he===t&&!me||(dt(),he=t,t&&(me=null,$e=!1),na(),sa(),oa())},wt=e=>{const t=typeof e=="string"&&e.trim()!==""?e.trim():null;me===t&&!he||(me!==t&&dt(),me=t,t&&(he=null,$e=!1),na(),sa(),oa())},di=()=>{$e||(dt(),$e=!0,he=null,me=null,na(),sa(),oa())},qt=()=>{if(!he)return[];const e=_||f||document;if(!e)return[];const t=`[data-preview-node="${he}"]`,a=new Set;return e.querySelectorAll(t).forEach(r=>{if(!r||Y(r))return;const i=(r.tagName||"").toLowerCase();if(i==="tspan"||i==="g"){const s=r.closest("text");if(s){a.add(s);return}}a.add(r)}),Array.from(a)},Et=()=>{if(!me)return[];const e=_||f||document;if(!e)return[];const t=`[data-preview-node="${me}"]`;let a=new Set;return e.querySelectorAll(t).forEach(r=>{const i=_e(r);i&&a.add(i)}),a.size===0&&e!==document&&document.querySelectorAll(t).forEach(r=>{const i=_e(r);i&&a.add(i)}),Array.from(a)},Ut=()=>gr(he),It=(e,t,a)=>{const r=Number(e);return Number.isFinite(r)?Math.min(Math.max(r,t),a):t},Lt=e=>{if(typeof e!="string")return null;let t=e.trim();return!t||(t.startsWith("#")||(t=`#${t}`),/^#([0-9a-f]{3})$/i.test(t)&&(t=`#${t[1]}${t[1]}${t[2]}${t[2]}${t[3]}${t[3]}`),!/^#([0-9a-f]{6})$/i.test(t))?null:t.toUpperCase()},ka=e=>{var s,l;if(!e||typeof e.getBBox!="function")return;const t=[],a=Number(((s=e.dataset)==null?void 0:s.rotation)||e.getAttribute("data-rotation")||0);if(Number.isFinite(a)&&a!==0)try{const d=e.getBBox(),u=d.x+d.width/2,x=d.y+d.height/2;t.push(`rotate(${a} ${u} ${x})`)}catch{t.push(`rotate(${a})`)}((l=e.dataset)==null?void 0:l.effectShape)==="curve"&&t.push("skewX(-8) skewY(4)");const i=t.join(" ").trim();i?e.setAttribute("transform",i):e.removeAttribute("transform")},Fe=(e,t={})=>{const a=qt();if(!a.length)return!1;if(a.forEach(r=>{try{e(r)}catch(i){console.warn("[InkWise Studio] Toolbar mutation failed.",i)}}),t.skipTransformUpdate||a.forEach(r=>{try{ka(r)}catch{}}),t.skipOverlaySync||re(),t.autosaveReason!==!1){const r=typeof t.autosaveReason=="string"&&t.autosaveReason.trim()!==""?t.autosaveReason:"text-style";v==null||v.schedule(r)}return!0},ut=(e,t={})=>{const a=Et();if(!a.length)return!1;if(a.forEach(r=>{try{e(r)}catch(i){console.warn("[InkWise Studio] Image mutation failed.",i)}}),t.skipTransformUpdate||a.forEach(r=>{try{ka(r)}catch{}}),t.skipOverlaySync||re(),t.autosaveReason!==!1){const r=typeof t.autosaveReason=="string"&&t.autosaveReason.trim()!==""?t.autosaveReason:"image-style";v==null||v.schedule(r)}return!0},Tt=(e=null)=>{var r;let t=_;if(!t&&e&&(t=e),!t)return null;if(typeof t.tagName=="string"&&t.tagName.toLowerCase()!=="svg"){const i=(r=t.closest)==null?void 0:r.call(t,"svg");i?t=i:e&&e!==t&&(t=e)}if(!t)return null;let a=t.querySelector('defs[data-inkwise-runtime="true"]');return a||(a=document.createElementNS(H,"defs"),a.setAttribute("data-inkwise-runtime","true"),t.insertBefore(a,t.firstChild||null)),a},Na=e=>{const t=e.dataset.previewTarget;if(!t)return;const a=document.querySelector(`[data-preview-node="${t}"]`),r=a?a.dataset.defaultText||a.textContent:"",i=()=>{if(!a)return;const s=e.value.trim();a.textContent=s||r||"",re()};e.dataset.defaultValue||(e.dataset.defaultValue=r||""),e.addEventListener("focus",()=>{vt(t)}),e.addEventListener("input",()=>{i(),v==null||v.schedule("text-change")}),i()};o.forEach(Na);const ui=(e,t="")=>{const a=normalizeSideKey(Le),r=gt(t),i=document.createElement("div");i.className="text-field-item";const s=document.createElement("span");s.className="text-field-label",s.textContent="Custom",i.appendChild(s);const l=document.createElement("input");l.type="text",l.className="text-field-input",l.placeholder="Add your text",l.dataset.previewTarget=e,l.dataset.templateSide=a,l.value=r,l.dataset.defaultValue=r||"",setStoredTextValue(a,e,r),captureDefaultTextValue(a,e,r),i.appendChild(l);const d=document.createElement("button");if(d.type="button",d.className="text-field-delete",d.setAttribute("aria-label","Delete field"),d.innerHTML='<i class="fa-regular fa-trash-can"></i>',i.appendChild(d),N.appendChild(i),F){const u=document.createElement("div");u.className="pill",u.dataset.previewNode=e,u.dataset.defaultText=t||"CUSTOM TEXT",u.textContent=t||"CUSTOM TEXT",F.appendChild(u)}return Na(l),Aa(i),v==null||v.schedule("add-text-field"),l},la=()=>{f&&(aa(),_=null,Kt=null,f.innerHTML="",f.style.display="none")},fi=e=>{if(typeof e!="string")return!1;const t=e.trim();return t?t.startsWith("data:image/svg+xml")?!0:/\.svg($|\?)/i.test(t):!1},br=e=>{if(!e)return;const t=r=>{var s,l,d;let i=(r==null?void 0:r.parentNode)||null;for(;i;){const u=typeof i.getAttribute=="function"?i.getAttribute("fill"):null,x=(s=i.style)==null?void 0:s.fill,E=((l=i.dataset)==null?void 0:l.color)||((d=i.dataset)==null?void 0:d.defaultColor)||null,h=u||x||E;if(h&&h!=="none"&&h!=="transparent")return h;i=i.parentNode||null}return null};e.querySelectorAll("text, tspan").forEach(r=>{var w,y;r.removeAttribute("opacity"),r.style.opacity="1",r.style&&r.style.mixBlendMode&&(r.style.mixBlendMode="normal");const i=r.getAttribute("fill"),s=(w=r.style)==null?void 0:w.fill,l=(y=r.dataset)==null?void 0:y.color;let d=i&&i!=="none"?i:null;if((!d||d==="transparent")&&s&&s!=="none"&&(d=s),(!d||d==="transparent")&&l&&l!=="none"&&(d=l),(!d||d==="transparent")&&typeof window<"u"&&typeof window.getComputedStyle=="function")try{const p=window.getComputedStyle(r).fill;p&&p!=="none"&&p!=="transparent"&&(d=p)}catch{}if(!d||d==="transparent"||d==="none"){const p=t(r);p&&p!=="none"&&p!=="transparent"&&(d=p)}const u=Lt(d||"")||Ga(d||"")||(d&&d!=="none"&&d!=="transparent"?d:null),E=u||"#111111";r.setAttribute("fill",E),r.style&&(r.style.fill=E,r.style.fillOpacity="1",r.style.strokeOpacity="1"),r.dataset&&(r.dataset.color=E,u&&(r.dataset.defaultColor=u)),r.removeAttribute("fill-opacity"),r.removeAttribute("stroke-opacity"),r.getAttribute("stroke")||r.setAttribute("stroke","none"),r.getAttribute("paint-order")||r.setAttribute("paint-order","stroke fill");const h=r.getAttribute("font-family")||r.style.fontFamily;if(h){const p=h.toLowerCase().replace(/[^a-z]/g,"");p.includes("greatvibes")?r.setAttribute("font-family","Great Vibes"):p.includes("poppins")&&r.setAttribute("font-family","Poppins")}})},pi=async e=>{var t,a;if(!f||!e)return la(),!1;try{let r="";if(e.startsWith("data:image/svg+xml")){const p=e.indexOf(","),A=p>=0?e.slice(0,p):e,L=p>=0?e.slice(p+1):"";if(/;base64/i.test(A))try{const ye=L.replace(/\s+/g,"");r=typeof window<"u"&&typeof window.atob=="function"?window.atob(ye):atob(ye)}catch(ye){try{r=decodeURIComponent(L)}catch(Q){console.warn("[InkWise Studio] Failed to decode inline SVG data URI.",ye,Q),r=""}}else try{r=decodeURIComponent(L)}catch{r=L}}else{const p=await fetch(e,{cache:"no-store"});if(!p.ok)return console.warn("Failed to fetch SVG:",p.status),la(),!1;r=await p.text()}if(!r)return la(),!1;f.innerHTML=r,f.style.display="block";const i=document.getElementById("canvas-loading");i&&(i.style.display="none"),f.setAttribute("preserveAspectRatio","xMidYMid meet"),f.setAttribute("width","100%"),f.setAttribute("height","100%"),f.style.width="100%",f.style.height="100%",f.style.maxWidth="100%",f.style.maxHeight="100%";const s=f.querySelector("svg");s?(s.setAttribute("preserveAspectRatio","xMidYMid meet"),s.setAttribute("width","100%"),s.setAttribute("height","100%"),s.style.width="100%",s.style.height="100%",s.style.maxWidth="100%",s.style.maxHeight="100%",_=s):_=f,_&&(mt(_),br(_)),_&&(_.setAttribute("data-svg-editor","true"),_.__inkwiseSvgTemplateEditor||(_.__inkwiseSvgTemplateEditor=new ua(_,{onTextChange:(p,A,L)=>{ot(),v&&v.schedule("text-change")},onImageChange:(p,A,L)=>{ot(),v&&v.schedule("image-change")}})),Kt=_.__inkwiseSvgTemplateEditor,setTimeout(()=>ot(),100));const d=new DOMParser().parseFromString(r,"image/svg+xml").documentElement;let u=Ke(d==null?void 0:d.getAttribute("width")),x=Ke(d==null?void 0:d.getAttribute("height"));if(!Number.isFinite(u)||!Number.isFinite(x)){const p=d==null?void 0:d.getAttribute("viewBox");if(p){const A=p.split(/[\s,]+/).map(Number),L=A[2],te=A[3];!Number.isNaN(L)&&!Number.isNaN(te)&&L>0&&te>0&&(u=L,x=te)}}let E=Number.isFinite(u)?u:Number.NaN,h=Number.isFinite(x)?x:Number.NaN;if(z&&Number.isFinite(z.width)&&Number.isFinite(z.height)){const p=z.width/z.height,A=Number.isFinite(E)&&Number.isFinite(h)?E/h:p,L=Math.abs(A-p)/p,te=Number.isFinite(E)?Math.abs(E-z.width)/z.width:Number.POSITIVE_INFINITY,ye=Number.isFinite(h)?Math.abs(h-z.height)/z.height:Number.POSITIVE_INFINITY;(!Number.isFinite(E)||!Number.isFinite(h)||L>.02||te>.05&&ye>.05)&&(E=z.width,h=z.height)}if(Number.isFinite(E)&&Number.isFinite(h)){const p=(z==null?void 0:z.unit)??"px";Se(E,h,{unit:p,shape:z==null?void 0:z.shape}),Be(We(E,p),We(h,p),"in",2)}const w=Da(f);if(aa(),N){N.innerHTML="";const p=(L,te="",ye="")=>{const Q=document.createElement("div");Q.className="text-field-item";const we=document.createElement("span");we.className="text-field-label",we.textContent=ye||L,Q.appendChild(we);const U=document.createElement("input");U.type="text",U.className="text-field-input",U.dataset.previewTarget=L,U.value=te||"",U.dataset.defaultValue=te||"",Q.appendChild(U);const B=document.createElement("button");return B.type="button",B.className="text-field-delete",B.setAttribute("aria-label","Delete field"),B.innerHTML='<i class="fa-regular fa-trash-can"></i>',Q.appendChild(B),N.appendChild(Q),Na(U),Aa(Q),U},A=()=>{[["date","Date"],["heading","Heading"],["accent","Accent"],["subheading","Subheading"],["names","Names"],["location","Location"]].forEach(([te,ye])=>p(te,"",ye))};if(w.length>0){let L=!1;const te=new Set,ye=new Set;w.forEach(Q=>{var M,Ue;const we=Q.getAttribute("data-preview-node");if(!we||te.has(we))return;te.add(we);const U=Y(Q);if(ce(Q)){L=!0;const St=((M=Q.dataset)==null?void 0:M.previewLabel)||we,at=((Ue=Q.dataset)==null?void 0:Ue.defaultText)||Oe(Q)||"",Ht=(St||"").toString().trim().toLowerCase(),Fa=(at||"").toString().trim().toLowerCase(),fe=`${Ht}|${Fa}`;if(Ht&&ye.has(fe))return;Ht&&ye.add(fe),p(we,at,St)}}),L||A()}else A()}const y=(a=(t=J==null?void 0:J.orderSummary)==null?void 0:t.metadata)==null?void 0:a.design;return y&&jt(y),w.forEach(p=>{const A=p.getAttribute("data-preview-node");if(!A)return;const L=Y(p),te=ce(p);L&&p.setAttribute("data-changeable","image"),pe(p)&&Ie(p),te?(p.setAttribute("contenteditable","true"),p.style.cursor="text",p.style.userSelect="text",p.addEventListener("input",()=>{const we=document.querySelector(`#textFieldList input[data-preview-target="${A}"]`);we&&(we.value=Oe(p)),p.dataset.currentText=Oe(p)||"",re(),v==null||v.schedule("text-edit")}),p.addEventListener("click",()=>{vt(A),Ca(A)})):L&&(p.style.cursor="pointer",p.addEventListener("click",()=>{p.dataset.locked!=="true"&&(wt(A),Ct(p))}));const Q=document.querySelector(`#textFieldList input[data-preview-target="${A}"]`);Q&&te&&(Q.addEventListener("input",()=>{rt(p,Q.value),v==null||v.schedule("text-change")}),Q.value&&Q.value.trim()!==""?rt(p,Q.value):Q.value=Oe(p)||"")}),requestAnimationFrame(()=>re()),Ge(10),!0}catch(r){return console.warn("Could not load SVG for binding:",r),la(),!1}},mi=async(e={})=>{var Q,we,U,B;const{scale:t=3,filename:a="inkwise-template.png",download:r=!0}=e,i=_||f;if(!i)throw new Error("No active canvas to export.");mt(i);const l=new XMLSerializer().serializeToString(i),d=M=>{const Ue=Number(M);return Number.isFinite(Ue)?Ue:null},u=(i.getAttribute("viewBox")||"").split(/[\s,]+/).map(d),x=u.length===4?u[2]:null,E=u.length===4?u[3]:null,h=d((Q=c==null?void 0:c.dataset)==null?void 0:Q.canvasWidth)||d((we=Z==null?void 0:Z.dataset)==null?void 0:we.canvasWidth)||x||1080,w=d((U=c==null?void 0:c.dataset)==null?void 0:U.canvasHeight)||d((B=Z==null?void 0:Z.dataset)==null?void 0:B.canvasHeight)||E||1527,y=Math.max(1,Math.round(h*Math.max(1,t))),p=Math.max(1,Math.round(w*Math.max(1,t))),A=new Image;A.crossOrigin="anonymous",A.src=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(l)}`,await new Promise((M,Ue)=>{A.onload=M,A.onerror=Ue});const L=document.createElement("canvas");L.width=y,L.height=p;const te=L.getContext("2d");te.fillStyle="#ffffff",te.fillRect(0,0,y,p),te.drawImage(A,0,0,y,p);const ye=L.toDataURL("image/png",1);if(r){const M=document.createElement("a");M.href=ye,M.download=a,M.click()}return{dataUrl:ye,width:y,height:p}};typeof window<"u"&&(window.inkwiseExportCurrentSide=(e={})=>mi(e));const Aa=e=>{if(!e)return;const t=e.querySelector(".text-field-delete"),a=e.querySelector("input[data-preview-target]");if(!t||!a||t.disabled||t.getAttribute("aria-disabled")==="true")return;t.replaceWith(t.cloneNode(!0)),e.querySelector(".text-field-delete").addEventListener("click",()=>{const i=a.dataset.previewTarget;if(e.remove(),F){const s=F.querySelector(`[data-preview-node="${i}"]`);s==null||s.remove()}if(_){const s=_.querySelector(`[data-preview-node="${i}"]`);s==null||s.remove()}deleteStoredTextValue(normalizeSideKey(Le),i),v==null||v.schedule("remove-text-field")})};document.querySelectorAll("#textFieldList .text-field-item").forEach(e=>Aa(e));const Ca=e=>{if(!e)return;sr(),nr("text"),de.forEach(a=>a.classList.remove("active"));const t=document.querySelector('.sidenav-btn[data-nav="text"]');t==null||t.classList.add("active"),setTimeout(()=>{const a=document.querySelector(`#textFieldList input[data-preview-target="${e}"]`);if(a){try{a.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{const s=document.getElementById("textFieldList");s&&(s.scrollTop=a.offsetTop-12)}a.focus({preventScroll:!1});return}const r=document.querySelector("[data-add-text-field]");r==null||r.focus({preventScroll:!1})},60)};$t=Ca;const Ot=async e=>{if(!ga(e)||(Le=e,!c))return;let t="",a="";e==="front"&&et?(t=et,a=et):e==="back"&&tt?(t=tt,a=tt):(a=c.dataset[`${e}Svg`]||"",t=c.dataset[`${e}Image`]||"");let r=!1;if(a&&fi(a)&&await pi(a)&&(r=!0,c.style.backgroundImage="none",c.style.backgroundSize="",br(_)),!r){const i=t||c.dataset[`${e}Image`]||"";window!=null&&window.console&&console.debug("[InkWise Studio] Using raster preview for",e,i||"<empty>"),la(),c.style.backgroundImage=i?`url('${i}')`:"",c.style.backgroundSize=i?"cover":"",c.style.backgroundPosition=i?"center center":"",c.style.backgroundRepeat=i?"no-repeat":"",i&&za(i),aa(),_=null}S.forEach(i=>{i.classList.toggle("active",i.dataset.cardView===e)}),g.forEach(i=>{const s=i.dataset.cardThumb===e;i.classList.toggle("active",s),i.setAttribute("aria-pressed",s?"true":"false")}),flushAutosave("side-switch")};S.forEach(e=>{e.addEventListener("click",()=>{Ot(e.dataset.cardView)})}),g.forEach(e=>{e.addEventListener("click",()=>{Ot(e.dataset.cardThumb)})});const Ya=Ot("front");Ya&&typeof Ya.then=="function"?Ya.catch(()=>{}).then(()=>{Ge(6),v==null||v.schedule("initial-load")}):(Ge(6),v==null||v.schedule("initial-load"));const vr=document.querySelector(".preview-overlay")||document.querySelector(".preview-canvas-wrapper");vr&&vr.addEventListener("click",e=>{const t=e.target.closest("[data-preview-node]");if(t){e.stopPropagation();const a=t.dataset.previewNode;a&&(Y(t)?wt(a):(vt(a),Ca(a)))}}),R&&N&&R.addEventListener("click",()=>{console.log("[InkWise Studio] New Text Field button clicked");const e=`custom_${Date.now()}_${ke}`;ke+=1;const t=document.createElement("div");t.className="text-field-item";const a=document.createElement("span");a.className="text-field-label",a.textContent="Custom",t.appendChild(a);const r=document.createElement("input");r.type="text",r.className="text-field-input",r.placeholder="Add your text",r.dataset.previewTarget=e,t.appendChild(r);const i=document.createElement("button");if(i.type="button",i.className="text-field-delete",i.setAttribute("aria-label","Delete field"),i.innerHTML='<i class="fa-regular fa-trash-can"></i>',t.appendChild(i),N.appendChild(t),F){const l=document.createElement("div");l.className="pill",l.dataset.previewNode=e,l.dataset.defaultText="CUSTOM TEXT",l.textContent="CUSTOM TEXT",F.appendChild(l)}let s=null;console.log("[InkWise Studio] currentSvgRoot:",_),_?(console.log("[InkWise Studio] Creating SVG text element"),s=document.createElementNS("http://www.w3.org/2000/svg","text"),s.setAttribute("id",e),s.setAttribute("data-preview-node",e),s.setAttribute("data-default-text","CUSTOM TEXT"),s.setAttribute("x","50%"),s.setAttribute("y","50%"),s.setAttribute("text-anchor","middle"),s.setAttribute("dominant-baseline","middle"),s.setAttribute("font-family","Arial, sans-serif"),s.setAttribute("font-size","24"),s.setAttribute("fill","#000000"),s.textContent="CUSTOM TEXT",s.setAttribute("contenteditable","true"),s.style.cursor="text",s.style.userSelect="text",s.addEventListener("input",()=>{r&&(r.value=s.textContent),s.dataset.currentText=s.textContent||"",re(),v==null||v.schedule("text-edit")}),s.addEventListener("click",()=>{vt(e),Ca(e)}),_.appendChild(s),pe(s)&&Ie(s),console.log("[InkWise Studio] SVG text element created and appended")):console.log("[InkWise Studio] No currentSvgRoot found, skipping SVG text creation"),Na(r),r.addEventListener("input",()=>{s&&(s.textContent=r.value,s.dataset.currentText=r.value),v==null||v.schedule("text-change")}),vt(e),s&&s.textContent&&s.textContent.trim()!==""?r.value=s.textContent:(r.value="CUSTOM TEXT",s&&(s.textContent="CUSTOM TEXT")),Aa(t),setTimeout(()=>{try{N.scrollHeight>N.clientHeight&&N.scrollTo({top:N.scrollHeight,behavior:"smooth"})}catch{N.scrollTop=N.scrollHeight}r.focus({preventScroll:!1})},60)}),et=null,tt=null,Le="front";const ca=document.getElementById("image-upload"),wr=document.getElementById("upload-button"),xr=document.getElementById("quick-upload-button"),Ea=document.getElementById("recentUploadsGrid"),Ia=document.getElementById("quickRecentUploads"),Xa="inkwise_recent_uploads",Sr=12,Ka=()=>{try{const e=localStorage.getItem(Xa);return e?JSON.parse(e):[]}catch{return[]}},hi=(e,t,a)=>{const r=Ka(),i={id:Date.now(),dataUrl:e,filename:t,side:a,timestamp:new Date().toISOString()},s=r.filter(d=>d.filename!==t);s.unshift(i);const l=s.slice(0,Sr);try{localStorage.setItem(Xa,JSON.stringify(l))}catch{const u=l.slice(0,Math.floor(Sr/2));localStorage.setItem(Xa,JSON.stringify(u))}Nr(),Ar()},kr=(e,t,a="front")=>{var r,i;if(e&&(hi(e,t||`upload-${Date.now()}`,a),!(me&&ut(l=>{l.setAttribute("href",e),l.setAttributeNS("http://www.w3.org/1999/xlink","href",e)},{autosaveReason:"image-upload"})))){if(_){const s=((r=_.tagName)==null?void 0:r.toLowerCase())==="svg"?_:_.closest("svg");if(s){const l=s.querySelectorAll('image[data-changeable="image"], image.changeable-image, image.svg-changeable-image, [data-editable-image]');if(l.length>0){const d=l[0];d.setAttribute("href",e),d.setAttributeNS("http://www.w3.org/1999/xlink","href",e),d.setAttribute("data-replaced-image","true");const u=document.querySelector(`[data-card-thumb="${a}"] .thumb-preview`);u&&(u.style.backgroundImage=`url('${e}')`),flushAutosave("image-upload-replace"),updatePreview(Le);return}}}if(_){const s=((i=_.tagName)==null?void 0:i.toLowerCase())==="svg"?_:_.closest("svg");if(s){const l=s.getAttribute("viewBox");let d=200,u=200,x=150;if(l){const y=l.split(/[\s,]+/).map(Number);y.length===4&&y.every(Number.isFinite)&&(d=y[0]+y[2]/2,u=y[1]+y[3]/2,x=Math.min(y[2],y[3])*.3)}const E=`uploaded_${Date.now()}`,h=document.createElementNS("http://www.w3.org/2000/svg","image");h.setAttribute("id",E),h.setAttribute("data-preview-node",E),h.setAttribute("href",e),h.setAttributeNS("http://www.w3.org/1999/xlink","href",e),h.setAttribute("x",String(d-x/2)),h.setAttribute("y",String(u-x/2)),h.setAttribute("width",String(x)),h.setAttribute("height",String(x)),h.setAttribute("preserveAspectRatio","xMidYMid meet"),s.appendChild(h),pe(h)&&Ie(h),wt(E),v==null||v.schedule("image-upload");return}}a==="front"?et=e:a==="back"&&(tt=e),Le===a&&Ot(a),v==null||v.schedule("image-upload")}},Nr=()=>{if(!Ea)return;const e=Ka();if(e.length===0){Ea.innerHTML=`
                <div class="no-recent-uploads">
                    <p>No recent uploads found. Upload some images above to see them here.</p>
                </div>
            `;return}const t=e.map(r=>`
            <div class="recent-upload-item" data-upload-id="${r.id}" data-image-url="${r.dataUrl}" data-side="${r.side}">
                <img src="${r.dataUrl}" alt="${r.filename}" loading="lazy">
                <div class="upload-info">
                    <span>${r.filename}</span>
                </div>
            </div>
        `).join("");Ea.innerHTML=t;const a=Ea.querySelectorAll(".recent-upload-item");a.forEach(r=>{r.addEventListener("click",()=>{var l;const i=r.dataset.imageUrl;if(a.forEach(d=>d.classList.remove("selected")),r.classList.add("selected"),me&&ut(u=>{u.setAttribute("href",i),u.setAttributeNS("http://www.w3.org/1999/xlink","href",i)},{autosaveReason:"image-select"})){r.style.transform="scale(0.95)",setTimeout(()=>{r.style.transform=""},150);return}if(_){const d=((l=_.tagName)==null?void 0:l.toLowerCase())==="svg"?_:_.closest("svg");if(d){const u=d.getAttribute("viewBox");let x=200,E=200,h=150;if(u){const A=u.split(/[\s,]+/).map(Number);A.length===4&&A.every(Number.isFinite)&&(x=A[0]+A[2]/2,E=A[1]+A[3]/2,h=Math.min(A[2],A[3])*.3)}const w=`uploaded_${Date.now()}`,y=document.createElementNS("http://www.w3.org/2000/svg","image");y.setAttribute("id",w),y.setAttribute("data-preview-node",w),y.setAttribute("href",i),y.setAttributeNS("http://www.w3.org/1999/xlink","href",i),y.setAttribute("x",String(x-h/2)),y.setAttribute("y",String(E-h/2)),y.setAttribute("width",String(h)),y.setAttribute("height",String(h)),y.setAttribute("preserveAspectRatio","xMidYMid meet"),d.appendChild(y),pe(y)&&Ie(y),wt(w),v==null||v.schedule("image-select"),r.style.transform="scale(0.95)",setTimeout(()=>{r.style.transform=""},150);return}}const s=r.dataset.side;s==="front"?et=i:tt=i,Le===s&&Ot(s),r.style.transform="scale(0.95)",setTimeout(()=>{r.style.transform=""},150),v==null||v.schedule("image-select")})})},Ar=()=>{if(!Ia)return;const t=Ka().slice(0,5);if(t.length===0){Ia.innerHTML="";return}const a=t.map(i=>`
            <div class="quick-recent-upload-item" data-upload-id="${i.id}" data-image-url="${i.dataUrl}" data-side="${i.side}" title="${i.filename}">
                <img src="${i.dataUrl}" alt="${i.filename}" loading="lazy">
            </div>
        `).join("");Ia.innerHTML=a;const r=Ia.querySelectorAll(".quick-recent-upload-item");r.forEach(i=>{i.addEventListener("click",()=>{var d;const s=i.dataset.imageUrl;if(r.forEach(u=>u.classList.remove("selected")),i.classList.add("selected"),me&&ut(x=>{x.setAttribute("href",s),x.setAttributeNS("http://www.w3.org/1999/xlink","href",s)},{autosaveReason:"image-select"})){i.style.transform="scale(0.9)",setTimeout(()=>{i.style.transform=""},150);return}if(_){const u=((d=_.tagName)==null?void 0:d.toLowerCase())==="svg"?_:_.closest("svg");if(u){const x=u.getAttribute("viewBox");let E=200,h=200,w=150;if(x){const L=x.split(/[\s,]+/).map(Number);L.length===4&&L.every(Number.isFinite)&&(E=L[0]+L[2]/2,h=L[1]+L[3]/2,w=Math.min(L[2],L[3])*.3)}const y=`uploaded_${Date.now()}`,p=document.createElementNS("http://www.w3.org/2000/svg","image");p.setAttribute("id",y),p.setAttribute("data-preview-node",y),p.setAttribute("href",s),p.setAttributeNS("http://www.w3.org/1999/xlink","href",s),p.setAttribute("x",String(E-w/2)),p.setAttribute("y",String(h-w/2)),p.setAttribute("width",String(w)),p.setAttribute("height",String(w)),p.setAttribute("preserveAspectRatio","xMidYMid meet"),u.appendChild(p),pe(p)&&Ie(p),wt(y),v==null||v.schedule("image-select"),i.style.transform="scale(0.9)",setTimeout(()=>{i.style.transform=""},150);return}}const l=i.dataset.side;l==="front"?et=s:tt=s,Le===l&&Ot(l),i.style.transform="scale(0.9)",setTimeout(()=>{i.style.transform=""},150),v==null||v.schedule("image-select")})})},gi=e=>{const t=e.files[0];if(!t)return;const a=new FileReader;a.onload=r=>{const i=r.target.result;kr(i,t.name,Le)},a.readAsDataURL(t)};ca&&ca.addEventListener("change",()=>gi(ca)),wr&&wr.addEventListener("click",()=>{ca.click()}),xr&&xr.addEventListener("click",()=>{ca.click()});const yi=e=>{var a;const t=(a=e.clipboardData)==null?void 0:a.items;if(!(!t||t.length===0))for(const r of t){if(!r||typeof r.type!="string"||!r.type.startsWith("image/"))continue;const i=r.getAsFile();if(!i)continue;const s=new FileReader;s.onload=l=>{const d=l.target.result,u=i.name||`pasted-${Date.now()}.png`;kr(d,u,Le||"front")},s.readAsDataURL(i),e.preventDefault();break}};Nr(),Ar(),document.addEventListener("paste",yi);const Ja=document.querySelectorAll(".pill-with-tooltip"),Za=document.querySelector(".preview-canvas-wrapper"),Qa=document.querySelector(".preview-guides"),Cr=(e,t)=>{e==="safety-pill"&&(Za==null||Za.classList.toggle("highlight-safety",t)),e==="bleed-pill"&&(Qa==null||Qa.classList.toggle("highlight-bleed",t))},La=e=>{const t=e==null?void 0:e.querySelector(".canvas-pill"),a=e==null?void 0:e.querySelector(".tooltip");!t||!a||(e.classList.remove("is-active"),t.setAttribute("aria-expanded","false"),a.setAttribute("aria-hidden","true"),Cr(t.id,!1))};Ja.forEach(e=>{const t=e.querySelector(".canvas-pill"),a=e.querySelector(".tooltip");!t||!a||(t.addEventListener("click",r=>{r.preventDefault();const i=!e.classList.contains("is-active");Ja.forEach(s=>{s!==e&&La(s)}),i?(e.classList.add("is-active"),t.setAttribute("aria-expanded","true"),a.setAttribute("aria-hidden","false"),Cr(t.id,!0)):La(e)}),t.addEventListener("mouseenter",()=>{a.setAttribute("aria-hidden","false")}),t.addEventListener("focus",()=>{a.setAttribute("aria-hidden","false")}),e.addEventListener("mouseleave",()=>{e.classList.contains("is-active")||a.setAttribute("aria-hidden","true")}),t.addEventListener("blur",()=>{!e.contains(document.activeElement)&&!e.classList.contains("is-active")&&a.setAttribute("aria-hidden","true")}),t.addEventListener("keydown",r=>{r.key==="Escape"&&(La(e),t.blur())}))}),document.addEventListener("click",e=>{e.target.closest(".pill-with-tooltip")||Ja.forEach(a=>La(a))});const bi=e=>{if(!e)return!1;const t=Fe(a=>{a.setAttribute("font-family",e),a.style.fontFamily=e},{autosaveReason:"text-font",skipTransformUpdate:!0});if(t){const a=Ut();a&&(a.dataset.fontFamily=e)}return t},vi=e=>{const t=It(e,6,400),a=Fe(r=>{r.setAttribute("font-size",t),r.style.fontSize=`${t}px`},{autosaveReason:"text-size"});if(a){const r=Ut();r&&(r.dataset.fontSize=String(t))}return a},wi=e=>{const t=It(e,8,400),a=39;return ut(r=>{const i=typeof r.getBBox=="function"?r.getBBox():null,s=parseFloat(r.getAttribute("width")),l=parseFloat(r.getAttribute("height")),d=Number(r.dataset.baseWidth)||(Number.isFinite(s)?s:(i==null?void 0:i.width)||1),u=Number(r.dataset.baseHeight)||(Number.isFinite(l)?l:(i==null?void 0:i.height)||1);r.dataset.baseWidth||(r.dataset.baseWidth=d),r.dataset.baseHeight||(r.dataset.baseHeight=u);const x=t/a,E=Math.max(1,d*x),h=Math.max(1,u*x);r.setAttribute("width",E),r.setAttribute("height",h)},{autosaveReason:"image-scale"})},xi=e=>{const t=Lt(e);if(!t)return!1;const a=Fe(r=>{r.setAttribute("fill",t),r.style.fill=t},{autosaveReason:"text-color",skipTransformUpdate:!0});if(a){const r=Ut();r&&(r.dataset.color=t)}return a},Si=e=>{const t=Lt(e);if(!t||!c)return!1;try{return c.style.backgroundColor=t,c.dataset.backgroundColor=t,v==null||v.schedule("background-color"),!0}catch(a){return console.warn("[InkWise Studio] Failed to apply background color",a),!1}},ki=e=>{if(!e||!c)return!1;try{return c.style.backgroundImage=`url(${e})`,c.style.backgroundSize="cover",c.style.backgroundPosition="center",c.style.backgroundRepeat="no-repeat",c.dataset.backgroundImage=e,v==null||v.schedule("background-image"),!0}catch(t){return console.warn("[InkWise Studio] Failed to apply background image",t),!1}},Ni=e=>new Promise((t,a)=>{const r=new FileReader;r.onload=()=>t(r.result),r.onerror=a,r.readAsDataURL(e)}),Ai=e=>{const t=Lt(e);return t?ut(a=>{if(t==="#FFFFFF"){const w=a.dataset.tintFilterId;if(w){const y=Tt(a.ownerSVGElement||null),p=y==null?void 0:y.querySelector(`#${w}`);p==null||p.remove(),delete a.dataset.tintFilterId}a.removeAttribute("filter");try{delete a.dataset.tintColor}catch{}return}const r=Tt(a.ownerSVGElement||null);if(!r)return;const i=a.dataset.tintFilterId||`inkwiseImageTint_${Date.now()}_${Math.floor(Math.random()*1e3)}`,s=parseInt(t.slice(1,3),16)/255,l=parseInt(t.slice(3,5),16)/255,d=parseInt(t.slice(5,7),16)/255;let u=r.querySelector(`#${i}`);if(!u){u=document.createElementNS(H,"filter"),u.id=i,u.setAttribute("color-interpolation-filters","sRGB");const w=document.createElementNS(H,"feColorMatrix");w.setAttribute("type","matrix"),w.setAttribute("values","0.2126 0.7152 0.0722 0 0  0.2126 0.7152 0.0722 0 0  0.2126 0.7152 0.0722 0 0  0 0 0 1 0"),u.appendChild(w);const y=document.createElementNS(H,"feComponentTransfer"),p=document.createElementNS(H,"feFuncR");p.setAttribute("type","linear"),y.appendChild(p);const A=document.createElementNS(H,"feFuncG");A.setAttribute("type","linear"),y.appendChild(A);const L=document.createElementNS(H,"feFuncB");L.setAttribute("type","linear"),y.appendChild(L);const te=document.createElementNS(H,"feFuncA");te.setAttribute("type","identity"),y.appendChild(te),u.appendChild(y),r.appendChild(u)}const x=u.querySelector("feFuncR"),E=u.querySelector("feFuncG"),h=u.querySelector("feFuncB");x&&x.setAttribute("slope",s.toString()),E&&E.setAttribute("slope",l.toString()),h&&h.setAttribute("slope",d.toString()),a.dataset.tintFilterId=i,a.setAttribute("filter",`url(#${i})`);try{a.dataset.tintColor=t}catch{}},{autosaveReason:"image-color",skipTransformUpdate:!0}):!1},Ci=()=>Fe(e=>{const t=e.getAttribute("font-weight")||e.style.fontWeight||"",a=Number(t);t==="bold"||a>=600?(e.setAttribute("font-weight","400"),e.style.fontWeight="400"):(e.setAttribute("font-weight","700"),e.style.fontWeight="700")},{autosaveReason:"text-style",skipTransformUpdate:!0}),Ei=()=>Fe(e=>{const t=e.getAttribute("font-style")||e.style.fontStyle||"normal";t==="italic"||t==="oblique"?(e.setAttribute("font-style","normal"),e.style.fontStyle="normal"):(e.setAttribute("font-style","italic"),e.style.fontStyle="italic")},{autosaveReason:"text-style",skipTransformUpdate:!0}),Er=e=>Fe(t=>{const r=(t.style.textDecoration||t.getAttribute("text-decoration")||"").split(/\s+/).filter(Boolean),i=new Set(r);i.has(e)?i.delete(e):i.add(e);const s=Array.from(i).join(" ");s?(t.style.textDecoration=s,t.setAttribute("text-decoration",s)):(t.style.textDecoration="",t.removeAttribute("text-decoration"))},{autosaveReason:"text-style",skipTransformUpdate:!0}),Ii=e=>{const t={"align-left":"start","align-center":"middle","align-right":"end","align-justify":"start"},a={"align-left":"left","align-center":"center","align-right":"right","align-justify":"justify"},r=t[e]||"start",i=a[e]||"left",s=Fe(l=>{l.setAttribute("text-anchor",r);const d=l.getAttribute("x");d&&l.querySelectorAll("tspan").forEach(u=>u.setAttribute("x",d)),l.style.textAlign=i},{autosaveReason:"text-align",skipTransformUpdate:!0});if(s){const l=Ut();l&&(l.dataset.align=i)}return s},Li=e=>{let t=null;const a=Fe(r=>{const i=r.textContent||"";let s=i;e==="uppercase"?s=i.toUpperCase():e==="lowercase"&&(s=i.toLowerCase()),r.textContent=s,r.dataset.currentText=s,t=s},{autosaveReason:"text-transform",skipTransformUpdate:!0});if(a){const r=Ut();r&&t!==null&&(r.value=t)}return a},Ti=()=>{const e=Ut();return Fe(t=>{const r=(t.textContent||"").split(/\r?\n/),i=t.dataset.listType==="bullet"||r.every(l=>l.trim().startsWith("•")),s=i?r.map(l=>l.replace(/^\s*•\s*/u,"")).join(`
`):r.map(l=>{const d=l.trim();return d?`• ${d}`:"•"}).join(`
`);i?delete t.dataset.listType:t.dataset.listType="bullet",t.textContent=s,t.dataset.currentText=s,e&&e.dataset.previewTarget===he&&(e.value=s)},{autosaveReason:"text-list",skipTransformUpdate:!0})},Fi=e=>{const t=It(e,.5,5);return Fe(a=>{a.dataset.lineHeight=t,a.style.lineHeight=t},{autosaveReason:"text-spacing",skipTransformUpdate:!0})},_i=e=>{if(e==null)return!1;const t=Number(e);return Number.isFinite(t)?Fe(a=>{if(Math.abs(t)<1e-4)a.style.letterSpacing="",a.removeAttribute("letter-spacing"),delete a.dataset.letterSpacing;else{const r=`${t.toFixed(2)}em`;a.style.letterSpacing=r,a.setAttribute("letter-spacing",r),a.dataset.letterSpacing=t.toFixed(2)}},{autosaveReason:"text-spacing",skipTransformUpdate:!0}):!1},ji=e=>{const t=typeof e=="string"?e:"none";return Fe(a=>{switch(t){case"shadow":a.dataset.effectStyle="shadow",a.style.filter="drop-shadow(2px 4px 8px rgba(15, 23, 42, 0.35))",a.style.stroke="",a.style.strokeWidth="",a.style.paintOrder="";break;case"highlight":a.dataset.effectStyle="highlight",a.style.filter="none",a.style.paintOrder="stroke fill",a.style.stroke="rgba(253, 224, 71, 0.85)",a.style.strokeWidth=6;break;case"glitch":a.dataset.effectStyle="glitch",a.style.filter="drop-shadow(-2px 0 rgba(236, 72, 153, 0.5)) drop-shadow(2px 0 rgba(56, 189, 248, 0.5))",a.style.stroke="",a.style.strokeWidth="",a.style.paintOrder="";break;case"echo":a.dataset.effectStyle="echo",a.style.filter="drop-shadow(3px 3px rgba(15, 23, 42, 0.4))",a.style.stroke="",a.style.strokeWidth="",a.style.paintOrder="";break;default:delete a.dataset.effectStyle,a.style.filter="",a.style.stroke="",a.style.strokeWidth="",a.style.paintOrder="";break}},{autosaveReason:"text-effect",skipTransformUpdate:!0})},Mi=e=>{const t=e==="curve"?"curve":"none";return Fe(a=>{t==="curve"?a.dataset.effectShape="curve":delete a.dataset.effectShape},{autosaveReason:"text-effect",skipTransformUpdate:!1})},Bi=e=>{const t=It(e,0,100)/100;return Fe(a=>{a.style.opacity=t,a.setAttribute("opacity",t)},{autosaveReason:"text-opacity",skipTransformUpdate:!0})},Ri=e=>{const t=It(e,0,100)/100;return ut(a=>{a.style.opacity=t,a.setAttribute("opacity",t)},{autosaveReason:"image-opacity",skipTransformUpdate:!0})},Pi=e=>{const t=It(e,-180,180);return Fe(a=>{Math.abs(t)<1e-4?(delete a.dataset.rotation,a.removeAttribute("data-rotation")):(a.dataset.rotation=t,a.setAttribute("data-rotation",t))},{autosaveReason:"text-rotation",skipTransformUpdate:!1})},$i=e=>{const t=It(e,-180,180);return ut(a=>{Math.abs(t)<1e-4?(delete a.dataset.rotation,a.removeAttribute("data-rotation")):(a.dataset.rotation=t,a.setAttribute("data-rotation",t))},{autosaveReason:"image-rotation",skipTransformUpdate:!1})},Ir=(e="text")=>{const t=e.replace(/[^a-z0-9_-]+/gi,"")||"text";let a=`${t}_${Date.now()}`,r=1;for(;document.querySelector(`[data-preview-node="${a}"]`);)a=`${t}_${Date.now()}_${r}`,r+=1;return a},zi=()=>{const e=qt();if(e.length===0)return!1;const t=e[0];if(!t||!t.parentNode)return!1;const a=Ir(he||"text"),r=t.cloneNode(!0);r.setAttribute("data-preview-node",a),r.dataset.previewNode=a,r.id=a,r.dataset.defaultText=r.dataset.defaultText||r.textContent||"",t.parentNode.appendChild(r),ka(r),pe(r)&&Ie(r);const s=ui(a,r.textContent||"");return s&&(s.value=r.textContent||"",setTimeout(()=>{try{s.focus({preventScroll:!1})}catch{}},0)),vt(a),re(),v==null||v.schedule("duplicate-text-node"),!0},Di=()=>{const e=qt();if(!e.length)return!1;const t=he;if(e.forEach(a=>{var i;const r=(i=Ae.get(a))==null?void 0:i.overlay;r&&(r.remove(),Qe.delete(r)),Ae.delete(a),a.remove()}),t){const a=gr(t),r=a==null?void 0:a.closest(".text-field-item");r&&r.remove();const i=li(t);i==null||i.remove()}return vt(null),re(),v==null||v.schedule("remove-text-node"),!0},qi=()=>{const e=Et();if(!e.length)return!1;const t=e[0];if(!t||!t.parentNode)return!1;const a=Ir(me||"image"),r=t.cloneNode(!0);r.setAttribute("data-preview-node",a),r.dataset.previewNode=a,r.id=a;const i=parseFloat(t.getAttribute("x"))||0,s=parseFloat(t.getAttribute("y"))||0;return r.setAttribute("x",i+10),r.setAttribute("y",s+10),r.dataset.tintFilterId&&(delete r.dataset.tintFilterId,r.removeAttribute("filter")),t.parentNode.appendChild(r),ka(r),pe(r)&&Ie(r),wt(a),re(),v==null||v.schedule("duplicate-image-node"),!0},Ui=()=>{const e=Et();return e.length?(e.forEach(t=>{var r;const a=(r=Ae.get(t))==null?void 0:r.overlay;a&&(a.remove(),Qe.delete(a)),Ae.delete(t),t.remove()}),wt(null),re(),v==null||v.schedule("remove-image-node"),!0):!1},Oi=()=>{const e=qe();if(e==="text"){const t=Fe(a=>{var l;const i=!(a.dataset.locked==="true");i?a.dataset.locked="true":delete a.dataset.locked;const s=(l=Ae.get(a))==null?void 0:l.overlay;s&&(s.classList.toggle("editor-overlay--locked",i),s.style.pointerEvents=i?"none":"")},{autosaveReason:"text-lock",skipTransformUpdate:!0,skipOverlaySync:!0});return t&&re(),t}if(e==="image"){const t=ut(a=>{var l;const i=!(a.dataset.locked==="true");i?a.dataset.locked="true":delete a.dataset.locked;const s=(l=Ae.get(a))==null?void 0:l.overlay;s&&(s.classList.toggle("editor-overlay--locked",i),s.style.pointerEvents=i?"none":"")},{autosaveReason:"image-lock",skipTransformUpdate:!0,skipOverlaySync:!0});return t&&re(),t}return!1},Wi=()=>{var a;const e=qt();if(!e.length)return!1;const t=e[0].textContent||"";if(!t)return!1;if((a=navigator==null?void 0:navigator.clipboard)!=null&&a.writeText)return navigator.clipboard.writeText(t).catch(r=>{console.warn("[InkWise Studio] Clipboard write failed.",r)}),!0;try{const r=document.createElement("textarea");return r.value=t,r.style.position="fixed",r.style.opacity="0",document.body.appendChild(r),r.focus(),r.select(),document.execCommand("copy"),r.remove(),!0}catch(r){return console.warn("[InkWise Studio] Clipboard fallback failed.",r),!1}},Hi=()=>{var r;const e=Et();if(!e.length)return!1;const t=e[0],a=t.getAttribute("href")||t.getAttribute("xlink:href")||t.getAttributeNS("http://www.w3.org/1999/xlink","href")||t.dataset.src||"";if(!a)return!1;if((r=navigator==null?void 0:navigator.clipboard)!=null&&r.writeText)return navigator.clipboard.writeText(a).catch(i=>{console.warn("[InkWise Studio] Clipboard write failed for image.",i)}),!0;try{const i=document.createElement("textarea");return i.value=a,i.style.position="fixed",i.style.opacity="0",document.body.appendChild(i),i.focus(),i.select(),document.execCommand("copy"),i.remove(),!0}catch(i){return console.warn("[InkWise Studio] Clipboard fallback failed for image.",i),!1}},Vi=()=>{const e=qe();return e==="text"?Wi():e==="image"?Hi():!1},Gi=()=>{const e=qe();return e==="text"?zi():e==="image"?qi():!1},Yi=()=>{const e=qe();return e==="text"?Di():e==="image"?Ui():!1},Xi=e=>{const t=qe();return t==="text"?es(e):t==="image"?ts(e):!1},Ki=e=>{const t=qe();return t==="text"?Bi(e):t==="image"?Ri(e):!1},Ji=e=>{const t=qe();return t==="text"?Pi(e):t==="image"?$i(e):!1},Zi=e=>{const t=qe();return t==="text"?xi(e):t==="image"?Ai(e):t==="background"?Si(e):!1},Qi=e=>{const t=qe();return t==="text"?vi(e):t==="image"?wi(e):!1},es=e=>{const t=qt();if(!t.length)return!1;const a=t[0],r=a.parentNode;if(!r)return!1;const i=Array.from(r.children),s=i.indexOf(a);if(s===-1)return!1;if(e==="bring-to-front")r.appendChild(a);else if(e==="send-to-back")r.insertBefore(a,i[0]);else if(e==="bring-forward"){const l=Math.min(i.length-1,s+1);if(l!==s){const d=i[l+1]||null;r.insertBefore(a,d)}}else if(e==="send-backward"){const l=Math.max(0,s-1);if(l!==s){const d=i[l];r.insertBefore(a,d)}}else return!1;return re(),v==null||v.schedule("text-layer"),!0},ts=e=>{const t=Et();if(!t.length)return!1;const a=t[0],r=a.parentNode;if(!r)return!1;const i=Array.from(r.children),s=i.indexOf(a);if(s===-1)return!1;if(e==="bring-to-front")r.appendChild(a);else if(e==="send-to-back")r.insertBefore(a,i[0]);else if(e==="bring-forward"){const l=Math.min(i.length-1,s+1);if(l!==s){const d=i[l+1]||null;r.insertBefore(a,d)}}else if(e==="send-backward"){const l=Math.max(0,s-1);if(l!==s){const d=i[l];r.insertBefore(a,d)}}else return!1;return re(),v==null||v.schedule("image-layer"),!0},as={setFontFamily:e=>qe()!=="text"?!1:bi(e),setFontSize:e=>Qi(e),setColor:e=>Zi(e),getActiveKey:()=>he,getSelection:()=>{const e=qe();return{type:e,key:e==="text"?he:e==="image"?me:null,textKey:he,imageKey:me}},dispatch(e,t){const a=qe();switch(e){case"bold":a==="text"&&Ci();break;case"italic":a==="text"&&Ei();break;case"underline":a==="text"&&Er("underline");break;case"strikethrough":a==="text"&&Er("line-through");break;case"align-left":case"align-center":case"align-right":case"align-justify":a==="text"&&Ii(e);break;case"list-bullets":a==="text"&&Ti();break;case"line-spacing":a==="text"&&Fi(t);break;case"letter-spacing":a==="text"&&_i(t);break;case"uppercase":case"lowercase":a==="text"&&Li(e);break;case"effect-style":a==="text"&&ji(t);break;case"effect-shape":a==="text"&&Mi(t);break;case"opacity":Ki(t);break;case"rotation":Ji(t);break;case"layer":Xi(t);break;case"more":t==="duplicate"?Gi():t==="delete"?Yi():t==="lock"?Oi():t==="copy"&&Vi();break;case"replace-image":const r=document.createElement("input");r.type="file",r.accept="image/*",r.onchange=i=>{const s=i.target.files[0];if(s){const l=new FileReader;l.onload=d=>{const u=d.target.result;ut(x=>{x.setAttribute("href",u),x.setAttributeNS("http://www.w3.org/1999/xlink","href",u)}),v==null||v.schedule("image-replace")},l.readAsDataURL(s)}},r.click();break;case"crop":{const i=Et();if(!i.length)break;const s=Ae.get(i[0]),l=s==null?void 0:s.overlay;if(!l)break;if(yr(),(ze==null?void 0:ze.overlay)===l)ze.refresh();else{dt();const d=Va(l,i[0]);d&&(ze=d)}break}default:console.debug("[InkWise Studio] Unhandled toolbar action",e,t);break}}};typeof window<"u"&&(window.inkwiseToolbar=as);const Wt=document.getElementById("canvas-zoom-select"),Lr=document.getElementById("canvas-zoom-display"),rs=document.querySelectorAll("[data-zoom-step]"),Tr=document.querySelector(".preview-canvas-wrapper"),Ta=D,xt=[.25,.5,.75,1,1.5,2,3];if(Wt&&Tr&&Ta){const e=a=>{Ta.style.setProperty("--canvas-scale",a.toString()),Tr.style.removeProperty("transform"),Wt.value=a.toString(),Lr&&(Lr.textContent=`${Math.round(a*100)}%`),re()},t=a=>{const r=parseFloat(Wt.value)||1,i=xt.indexOf(r);if(i===-1)return;let s=i;a==="up"&&i<xt.length-1&&(s=i+1),a==="down"&&i>0&&(s=i-1),s!==i&&e(xt[s])};Wt.addEventListener("change",a=>{const r=parseFloat(a.target.value)||1;e(r)}),rs.forEach(a=>{a.addEventListener("click",()=>{const r=a.dataset.zoomStep;r&&t(r==="up"?"up":"down")})}),Ta&&Ta.addEventListener("wheel",a=>{a.preventDefault();const r=parseFloat(Wt.value)||1;let i=r;if(a.deltaY>0){const s=xt.indexOf(r);s>0&&(i=xt[s-1])}else{const s=xt.indexOf(r);s<xt.length-1&&(i=xt[s+1])}i!==r&&e(i)},{passive:!1}),e(parseFloat(Wt.value)||1)}document.addEventListener("focusin",e=>{e.target.matches("#textFieldList input")&&document.body.classList.add("text-toolbar-visible")}),document.addEventListener("focusout",e=>{e.target.matches("#textFieldList input")&&setTimeout(()=>{const t=document.activeElement,a=t&&typeof t.matches=="function"&&t.matches("#textFieldList input"),r=t&&typeof t.closest=="function"&&t.closest(".studio-react-widgets");!a&&!r&&(he||me||$e?sa():document.body.classList.remove("text-toolbar-visible"))},100)})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",G,{once:!0}):G()}const rr=[{name:"Lobster",family:"Lobster",weight:"400",style:"normal"},{name:"Fredoka One",family:"Fredoka One",weight:"400",style:"normal"},{name:"Pacifico",family:"Pacifico",weight:"400",style:"normal"},{name:"Baloo 2",family:"Baloo 2",weight:"400",style:"normal"},{name:"Poppins Bold",family:"Poppins",weight:"700",style:"normal"},{name:"Anton",family:"Anton",weight:"400",style:"normal"},{name:"Gochi Hand",family:"Gochi Hand",weight:"400",style:"normal"},{name:"Bangers",family:"Bangers",weight:"400",style:"normal"},{name:"Chewy",family:"Chewy",weight:"400",style:"normal"},{name:"Rubik ExtraBold",family:"Rubik",weight:"800",style:"normal"},{name:"Comic Neue Bold",family:"Comic Neue",weight:"700",style:"normal"},{name:"Amatic SC Bold",family:"Amatic SC",weight:"700",style:"normal"},{name:"Luckiest Guy",family:"Luckiest Guy",weight:"400",style:"normal"},{name:"Kalam Bold",family:"Kalam",weight:"700",style:"normal"},{name:"Bubblegum Sans",family:"Bubblegum Sans",weight:"400",style:"normal"},{name:"Shrikhand",family:"Shrikhand",weight:"400",style:"normal"},{name:"Jua",family:"Jua",weight:"400",style:"normal"},{name:"DynaPuff",family:"DynaPuff",weight:"400",style:"normal"},{name:"Cabin Sketch",family:"Cabin Sketch",weight:"400",style:"normal"},{name:"Titan One",family:"Titan One",weight:"400",style:"normal"},{name:"Montserrat SemiBold",family:"Montserrat",weight:"600",style:"normal"},{name:"Helvetica Neue",family:"Helvetica Neue",weight:"400",style:"normal"},{name:"Lato Bold",family:"Lato",weight:"700",style:"normal"},{name:"Source Sans Pro",family:"Source Sans Pro",weight:"400",style:"normal"},{name:"Poppins Medium",family:"Poppins",weight:"500",style:"normal"},{name:"Roboto Condensed",family:"Roboto Condensed",weight:"400",style:"normal"},{name:"Open Sans",family:"Open Sans",weight:"400",style:"normal"},{name:"Oswald",family:"Oswald",weight:"400",style:"normal"},{name:"Nunito Sans",family:"Nunito Sans",weight:"400",style:"normal"},{name:"Inter SemiBold",family:"Inter",weight:"600",style:"normal"},{name:"Futura PT",family:"Futura PT",weight:"400",style:"normal"},{name:"Avenir Next",family:"Avenir Next",weight:"400",style:"normal"},{name:"Work Sans Medium",family:"Work Sans",weight:"500",style:"normal"},{name:"Proxima Nova",family:"Proxima Nova",weight:"400",style:"normal"},{name:"IBM Plex Sans",family:"IBM Plex Sans",weight:"400",style:"normal"},{name:"Barlow SemiCondensed",family:"Barlow Semi Condensed",weight:"400",style:"normal"},{name:"Sora",family:"Sora",weight:"400",style:"normal"},{name:"Metropolis",family:"Metropolis",weight:"400",style:"normal"},{name:"Urbanist",family:"Urbanist",weight:"400",style:"normal"},{name:"Manrope",family:"Manrope",weight:"400",style:"normal"},{name:"Quicksand Light",family:"Quicksand",weight:"300",style:"normal"},{name:"Great Vibes",family:"Great Vibes",weight:"400",style:"normal"},{name:"Parisienne",family:"Parisienne",weight:"400",style:"normal"},{name:"Nunito Light",family:"Nunito",weight:"300",style:"normal"},{name:"Cormorant Garamond",family:"Cormorant Garamond",weight:"400",style:"normal"},{name:"Playfair Display",family:"Playfair Display",weight:"400",style:"normal"},{name:"Allura",family:"Allura",weight:"400",style:"normal"},{name:"DM Sans",family:"DM Sans",weight:"400",style:"normal"},{name:"Satisfy",family:"Satisfy",weight:"400",style:"normal"},{name:"Karla",family:"Karla",weight:"400",style:"normal"},{name:"Josefin Light",family:"Josefin Sans",weight:"300",style:"normal"},{name:"Merriweather Light",family:"Merriweather",weight:"300",style:"normal"},{name:"Sacramento",family:"Sacramento",weight:"400",style:"normal"},{name:"Dancing Script",family:"Dancing Script",weight:"400",style:"normal"},{name:"Marcellus",family:"Marcellus",weight:"400",style:"normal"},{name:"Crimson Pro",family:"Crimson Pro",weight:"400",style:"normal"},{name:"ABeeZee",family:"ABeeZee",weight:"400",style:"normal"},{name:"GFS Didot",family:"GFS Didot",weight:"400",style:"normal"},{name:"Overlock Light",family:"Overlock",weight:"300",style:"normal"},{name:"Hind Soft",family:"Hind",weight:"400",style:"normal"},{name:"Cinzel",family:"Cinzel",weight:"400",style:"normal"},{name:"Cormorant Infant",family:"Cormorant Infant",weight:"400",style:"normal"},{name:"Playfair Display Italic",family:"Playfair Display",weight:"400",style:"italic"},{name:"Alex Brush",family:"Alex Brush",weight:"400",style:"normal"},{name:"Montserrat Light",family:"Montserrat",weight:"300",style:"normal"},{name:"Bodoni Moda",family:"Bodoni Moda",weight:"400",style:"normal"},{name:"Cormorant Upright",family:"Cormorant Upright",weight:"400",style:"normal"},{name:"Libre Baskerville Italic",family:"Libre Baskerville",weight:"400",style:"italic"},{name:"Tangerine",family:"Tangerine",weight:"400",style:"normal"},{name:"Cinzel Decorative",family:"Cinzel Decorative",weight:"400",style:"normal"},{name:"Forum",family:"Forum",weight:"400",style:"normal"},{name:"Cardo Italic",family:"Cardo",weight:"400",style:"italic"},{name:"Unna Italic",family:"Unna",weight:"400",style:"italic"},{name:"Prata",family:"Prata",weight:"400",style:"normal"},{name:"Gilda Display",family:"Gilda Display",weight:"400",style:"normal"},{name:"Cormorant SC",family:"Cormorant SC",weight:"400",style:"normal"},{name:"Quattrocento",family:"Quattrocento",weight:"400",style:"normal"},{name:"Marcellus SC",family:"Marcellus SC",weight:"400",style:"normal"}],gs=[12,14,16,18,24,32,36,39,42,48,60];function ir(G,o,c){return Math.min(Math.max(G,o),c)}function ys({onFontChange:G=()=>{},onSizeChange:o=()=>{},onAction:c=()=>{},onColorChange:f=()=>{},activeElementType:g=null}){const S=P.useMemo(()=>rr[0],[]),[F,N]=P.useState(S),[R,de]=P.useState(39),[D,H]=P.useState(!1),[K,X]=P.useState(!1),Z=P.useRef(null),ke=P.useRef(null),[ue,V]=P.useState(!1),ie=P.useRef(null),[Y,ce]=P.useState(!1),Oe=P.useRef(null),[rt,_e]=P.useState(!1),Ft=P.useRef(null),[mt,J]=P.useState("#FFFFFF"),[Me,it]=P.useState([]),fa=P.useMemo(()=>[{label:"Grayscale",colors:["#FFFFFF","#E5E7EB","#9CA3AF","#4B5563","#111827"]},{label:"Blues",colors:["#DCEEFB","#A8D1FF","#4DA1FF","#2563EB","#0B3D91"]},{label:"Greens",colors:["#DEF7EC","#BFEBD3","#34D399","#059669","#064E3B"]},{label:"Yellows",colors:["#FFFBEB","#FEF3C7","#FBBF24","#F59E0B","#B45309"]},{label:"Oranges",colors:["#FFF1E6","#FFD8B5","#FB923C","#F97316","#7C2D12"]},{label:"Reds",colors:["#FFEFF2","#FFD6DD","#EF4444","#DC2626","#58151C"]}],[]),[kt,Nt]=P.useState(0),[_t,Xt]=P.useState(0),[jt,pa]=P.useState(100),[st,Mt]=P.useState("swatches"),We=P.useRef(null),ma=P.useRef(!1),Re=g==="text",z=g==="image",xe=Re||z,[Bt,Rt]=P.useState(0),[Pe,Ae]=P.useState(0),[Qe,Pt]=P.useState(0),[ve,_]=P.useState(0);function Kt(b,I,q,ge){const pe=b/100,Se=I/100,Be=q/100,Ke=ge/100,ct=Math.round(255*(1-pe)*(1-Ke)),za=Math.round(255*(1-Se)*(1-Ke)),ra=Math.round(255*(1-Be)*(1-Ke)),ia=Da=>Da.toString(16).padStart(2,"0").toUpperCase();return`#${ia(ct)}${ia(za)}${ia(ra)}`}P.useEffect(()=>{try{const b=typeof window<"u"?window.inkwiseToolbar:null;if(b&&typeof b.getSelection=="function"){const I=b.getSelection();if(I){if(I.fontFamily){const q=rr.find(ge=>ge.family===I.fontFamily||ge.name===I.fontFamily);q&&N(q)}Number.isFinite(Number(I.fontSize))&&de(Number(I.fontSize)),I.color&&J(String(I.color))}}}catch{}if(st==="cmyk")try{const b=Kt(Bt,Pe,Qe,ve);J(b),f(b)}catch{}},[Bt,Pe,Qe,ve,st]);function $t(b){const I=b.replace("#",""),q=parseInt(I,16),ge=q>>16&255,pe=q>>8&255,Se=q&255;return{r:ge,g:pe,b:Se}}function Le(b,I,q){b/=255,I/=255,q/=255;const ge=Math.max(b,I,q),pe=Math.min(b,I,q);let Se=0,Be=0,Ke=(ge+pe)/2;if(ge!==pe){const ct=ge-pe;switch(Be=Ke>.5?ct/(2-ge-pe):ct/(ge+pe),ge){case b:Se=(I-q)/ct+(I<q?6:0);break;case I:Se=(q-b)/ct+2;break;case q:Se=(b-I)/ct+4;break}Se/=6}return{h:Math.round(Se*360),s:Math.round(Be*100),l:Math.round(Ke*100)}}function et(b,I,q){I/=100,q/=100;const ge=Be=>(Be+b/30)%12,pe=I*Math.min(q,1-q),Se=Be=>{const Ke=q-pe*Math.max(-1,Math.min(ge(Be)-3,Math.min(9-ge(Be),1)));return Math.round(255*Ke).toString(16).padStart(2,"0")};return`#${Se(0)}${Se(8)}${Se(4)}`.toUpperCase()}P.useEffect(()=>{try{const b=$t(mt.replace("#","")),{h:I,s:q,l:ge}=Le(b.r,b.g,b.b);Nt(I),Xt(q),pa(ge)}catch{}},[mt]),P.useEffect(()=>{const b=et(kt,_t,jt);J(b)},[kt,_t,jt]);const tt=b=>{ma.current=!0,v(b),window.addEventListener("mousemove",v),window.addEventListener("mouseup",At)},v=b=>{if(!We.current)return;const I=We.current.getBoundingClientRect(),q=Math.min(Math.max(0,(b.clientX-I.left)/I.width),1),ge=Math.min(Math.max(0,(b.clientY-I.top)/I.height),1),pe=Math.round(q*100),Se=Math.round((1-ge)*100);Xt(pe),pa(Se)},At=()=>{ma.current=!1,window.removeEventListener("mousemove",v),window.removeEventListener("mouseup",At)};P.useEffect(()=>{const b=q=>{(D&&Z.current&&!Z.current.contains(q.target)||K&&ke.current&&!ke.current.contains(q.target)||ue&&ie.current&&!ie.current.contains(q.target)||Y&&Oe.current&&!Oe.current.contains(q.target)||nt&&ht.current&&!ht.current.contains(q.target)||ot&&Jt.current&&!Jt.current.contains(q.target)||zt&&Dt.current&&!Dt.current.contains(q.target)||Qt&&ta.current&&!ta.current.contains(q.target))&&(H(!1),X(!1),V(!1),ce(!1),Ce(!1),je(!1),Te(!1),Xe(!1))},I=q=>{(q.key==="Escape"||q.key==="Esc")&&(H(!1),X(!1),V(!1),ce(!1),Ce(!1),je(!1),Te(!1),Xe(!1),De(!1),Ie(!1),Ge(!1),_e(!1))};return(D||K||ue||Y||nt||ot||zt||rt||Qt||Ve||lt||re)&&(document.addEventListener("mousedown",b),document.addEventListener("keydown",I)),()=>{document.removeEventListener("mousedown",b),document.removeEventListener("keydown",I)}},[D,K]);const he=b=>{Re&&(N(b),G(b.family),H(!1))},me=b=>{const I=(b||"#FFFFFF").toUpperCase();J(I),f(I),it(q=>[I,...q.filter(pe=>pe!==I)].slice(0,8)),X(!1)},$e=b=>{const I=ir(b,8,96);de(I),o(I)},ze=b=>{xe&&$e(R+b)},He=b=>{if(!xe)return;const I=Number(b.target.value);Number.isFinite(I)&&$e(I)},[nt,Ce]=P.useState(!1),ht=P.useRef(null),[ot,je]=P.useState(!1),Jt=P.useRef(null),[zt,Te]=P.useState(!1),Dt=P.useRef(null),[ha,gt]=P.useState(1.4),[ga,Zt]=P.useState(.12),[Qt,Xe]=P.useState(!1),[ea,ya]=P.useState(100),ta=P.useRef(null),[Ve,De]=P.useState(!1),[Ct,ba]=P.useState(0),aa=P.useRef(null),[lt,Ie]=P.useState(!1),Ra=P.useRef(null),[re,Ge]=P.useState(!1),va=P.useRef(null);P.useEffect(()=>{Re||(H(!1),V(!1),ce(!1),Ce(!1),je(!1),Te(!1),_e(!1))},[Re]),P.useEffect(()=>{xe||(X(!1),Xe(!1),De(!1),Ie(!1),Ge(!1))},[xe]);const Pa=()=>{Re&&(gt(1.4),c("line-spacing")(1.4))},$a=()=>{Re&&(Zt(.12),c("letter-spacing")(.12))};return n.jsxs("div",{className:`text-mini-toolbar ${xe?"floating":""}`,role:"toolbar","aria-label":z?"Image editing toolbar":"Text editing toolbar",children:[n.jsxs("div",{className:"toolbar-group toolbar-group--font",children:[z?n.jsxs(n.Fragment,{children:[n.jsx("button",{type:"button",className:"ghost-button",onClick:()=>c("replace-image"),children:"Replace Image"}),n.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),n.jsxs("button",{type:"button",className:"ghost-button",onClick:()=>c("crop"),children:[n.jsx("i",{className:"fa-solid fa-crop-simple"})," Crop"]})]}):n.jsxs("button",{type:"button",className:"font-select-button",onClick:()=>{Re&&H(b=>!b)},"aria-label":Re?"Choose font family":"Font selection available for text elements","aria-haspopup":"listbox","aria-expanded":D,disabled:!Re,children:[Re?F.name:"Select element"," ",n.jsx("i",{className:"fa-solid fa-chevron-down","aria-hidden":"true"})]}),Re&&D&&n.jsx("div",{className:"font-modal",ref:Z,children:n.jsx("div",{className:"font-modal-content",children:rr.map(b=>n.jsx("button",{type:"button",className:"font-option",onClick:()=>he(b),style:{fontFamily:b.family,fontWeight:b.weight,fontStyle:b.style},children:b.name},b.name))})})]}),n.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),n.jsxs("div",{className:"toolbar-group toolbar-group--size",role:"group","aria-label":z?"Image scale":"Font size",children:[n.jsx("button",{type:"button",className:"ghost-button","aria-label":z?"Decrease image scale":"Decrease font size",onClick:()=>ze(-2),disabled:!xe,children:n.jsx("i",{className:"fa-solid fa-minus","aria-hidden":"true"})}),n.jsx("label",{className:"sr-only",htmlFor:"mini-toolbar-size",children:z?"Image scale":"Font size"}),n.jsx("select",{id:"mini-toolbar-size",className:"size-select",value:R,onChange:He,disabled:!xe,children:gs.map(b=>n.jsx("option",{value:b,children:b},b))}),n.jsx("button",{type:"button",className:"ghost-button","aria-label":z?"Increase image scale":"Increase font size",onClick:()=>ze(2),disabled:!xe,children:n.jsx("i",{className:"fa-solid fa-plus","aria-hidden":"true"})})]}),n.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{type:"button",className:"color-swatch","aria-label":z?"Choose image tint":"Choose text color",onClick:()=>{xe&&(H(!1),X(b=>!b))},disabled:!xe,"aria-expanded":K,children:n.jsx("span",{className:"color-swatch__chip",style:{background:mt}})}),K&&n.jsx("div",{className:"color-modal",ref:ke,children:n.jsxs("div",{className:"color-modal-content",children:[n.jsxs("div",{className:"color-modal-header",children:[n.jsx("div",{className:"color-modal-title",children:z?"Image tint":"Text color"}),n.jsx("button",{type:"button",className:"ghost-button",onClick:()=>X(!1),"aria-label":"Close color picker",children:n.jsx("i",{className:"fa-solid fa-x"})})]}),n.jsx("div",{className:"color-picker-area",children:n.jsx("div",{className:"inline-color-picker",children:n.jsxs("div",{className:"spectrum-picker",children:[n.jsx("div",{className:"spectrum-area",ref:We,onMouseDown:tt,style:{background:`linear-gradient(to right, #fff, hsl(${kt}, 100%, 50%)), linear-gradient(to top, rgba(0,0,0,0), rgba(0,0,0,1))`},role:"application","aria-label":"Color spectrum",children:n.jsx("div",{className:"spectrum-handle",style:{left:`${_t}%`,top:`${100-jt}%`},"aria-hidden":"true"})}),n.jsx("div",{className:"hue-row",children:n.jsx("input",{className:"hue-range",type:"range",min:"0",max:"360",value:kt,onChange:b=>Nt(Number(b.target.value)),style:{background:`linear-gradient(to right, ${Array.from({length:13}).map((b,I)=>`hsl(${I*30},100%,50%)`).join(",")})`},"aria-label":"Hue"})}),n.jsxs("div",{className:"hex-row",children:[n.jsx("input",{type:"text",className:"hex-input",value:et(kt,_t,jt),onChange:b=>J(b.target.value),"aria-label":"Hex color value"}),n.jsx("button",{type:"button",className:"eyedropper-button",title:"Eyedropper","aria-label":"Eyedropper",children:n.jsx("i",{className:"fa-solid fa-eye-dropper"})})]})]})})}),n.jsxs("div",{className:"swatch-sections",children:[n.jsxs("div",{className:"tabs",children:[n.jsx("div",{className:`tab ${st==="swatches"?"active":""}`,onClick:()=>Mt("swatches"),children:"Swatches"}),n.jsx("div",{className:`tab ${st==="cmyk"?"active":""}`,onClick:()=>Mt("cmyk"),children:"CMYK"})]}),n.jsx("div",{className:"section-divider","aria-hidden":"true"}),st==="swatches"&&n.jsxs(n.Fragment,{children:[Me.length>0&&n.jsxs("div",{className:"swatch-section",children:[n.jsx("div",{className:"swatch-title",children:"Recent colors"}),n.jsx("div",{className:"swatches-grid",children:Me.map(b=>n.jsx("button",{type:"button",className:"swatch",style:{background:b},onClick:()=>me(b)},b))})]}),Me.length>0&&fa.length>0&&n.jsx("div",{className:"section-divider","aria-hidden":"true"}),n.jsx("div",{className:"swatch-section",children:n.jsx("div",{className:"preset-groups",children:fa.map((b,I)=>n.jsx("div",{className:"swatch-group",children:n.jsx("div",{className:"swatches-grid preset",children:b.colors.map(q=>n.jsx("button",{type:"button",className:"swatch",style:{background:q},onClick:()=>me(q)},q))})},I))})})]}),st==="cmyk"&&n.jsxs("div",{className:"swatch-section cmyk-section",children:[n.jsx("div",{className:"swatch-title",children:"CMYK (preview)"}),n.jsxs("div",{className:"cmyk-row",children:[n.jsx("div",{className:"cmyk-label",children:"C"}),n.jsx("input",{type:"range",min:"0",max:"100",value:Bt,onChange:b=>Rt(Number(b.target.value)),className:"cmyk-range c-range","aria-label":"Cyan"}),n.jsxs("div",{className:"cmyk-value",children:[Bt,"%"]})]}),n.jsxs("div",{className:"cmyk-row",children:[n.jsx("div",{className:"cmyk-label",children:"M"}),n.jsx("input",{type:"range",min:"0",max:"100",value:Pe,onChange:b=>Ae(Number(b.target.value)),className:"cmyk-range m-range","aria-label":"Magenta"}),n.jsxs("div",{className:"cmyk-value",children:[Pe,"%"]})]}),n.jsxs("div",{className:"cmyk-row",children:[n.jsx("div",{className:"cmyk-label",children:"Y"}),n.jsx("input",{type:"range",min:"0",max:"100",value:Qe,onChange:b=>Pt(Number(b.target.value)),className:"cmyk-range y-range","aria-label":"Yellow"}),n.jsxs("div",{className:"cmyk-value",children:[Qe,"%"]})]}),n.jsxs("div",{className:"cmyk-row",children:[n.jsx("div",{className:"cmyk-label",children:"K"}),n.jsx("input",{type:"range",min:"0",max:"100",value:ve,onChange:b=>_(Number(b.target.value)),className:"cmyk-range k-range","aria-label":"Key Black"}),n.jsxs("div",{className:"cmyk-value",children:[ve,"%"]})]})]})]})]})})]}),Re&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),n.jsxs("div",{className:"toolbar-group toolbar-group--actions",role:"group","aria-label":"Text format actions",style:{position:"relative"},children:[n.jsx("button",{type:"button",className:"ghost-button","aria-label":"Bold",onClick:()=>{V(b=>!b),X(!1),H(!1)},children:n.jsx("span",{className:"toolbar-label",children:"B"})}),ue&&n.jsx("div",{className:"format-modal",ref:ie,role:"dialog","aria-label":"Text formatting options",children:n.jsxs("div",{className:"format-modal-content",children:[n.jsx("button",{type:"button",className:"format-option",title:"Bold",onClick:()=>{c("bold"),V(!1)},children:n.jsx("i",{className:"fi fi-ss-bold","aria-hidden":"true"})}),n.jsx("button",{type:"button",className:"format-option",title:"Italic",onClick:()=>{c("italic"),V(!1)},children:n.jsx("i",{className:"fi fi-br-italic","aria-hidden":"true"})}),n.jsx("button",{type:"button",className:"format-option",title:"Underline",onClick:()=>{c("underline"),V(!1)},children:n.jsx("i",{className:"fi fi-br-underline","aria-hidden":"true"})}),n.jsx("button",{type:"button",className:"format-option",title:"Strikethrough",onClick:()=>{c("strikethrough"),V(!1)},children:n.jsx("i",{className:"fi fi-br-strikethrough","aria-hidden":"true"})})]})}),n.jsx("button",{type:"button",className:"ghost-button","aria-label":"Align center",onClick:()=>{Ce(b=>!b),V(!1),X(!1),H(!1)},children:n.jsx("i",{className:"fa-solid fa-align-center","aria-hidden":"true"})}),nt&&n.jsx("div",{className:"align-modal",ref:ht,role:"dialog","aria-label":"Alignment options",children:n.jsxs("div",{className:"align-modal-content",children:[n.jsx("button",{type:"button",className:"align-option",title:"Align-justify",onClick:()=>{c("align-justify"),Ce(!1)},children:n.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[n.jsx("rect",{x:"3",y:"4",width:"18",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"3",y:"9",width:"18",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"3",y:"14",width:"18",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1",fill:"currentColor"})]})}),n.jsx("button",{type:"button",className:"align-option",title:"Align-center",onClick:()=>{c("align-center"),Ce(!1)},children:n.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[n.jsx("rect",{x:"5",y:"4",width:"14",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"3",y:"9",width:"18",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"5",y:"14",width:"14",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1",fill:"currentColor"})]})}),n.jsx("button",{type:"button",className:"align-option",title:"Align-left",onClick:()=>{c("align-left"),Ce(!1)},children:n.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[n.jsx("rect",{x:"3",y:"4",width:"12",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"3",y:"9",width:"18",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"3",y:"14",width:"12",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1",fill:"currentColor"})]})}),n.jsx("button",{type:"button",className:"align-option",title:"Align-right",onClick:()=>{c("align-right"),Ce(!1)},children:n.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[n.jsx("rect",{x:"9",y:"4",width:"12",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"3",y:"9",width:"18",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"9",y:"14",width:"12",height:"2",rx:"1",fill:"currentColor"}),n.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1",fill:"currentColor"})]})})]})}),n.jsx("button",{type:"button",className:"ghost-button","aria-label":"Bulleted list",onClick:()=>{je(b=>!b),Ce(!1),V(!1),X(!1),H(!1)},children:n.jsx("i",{className:"fa-solid fa-list-ul","aria-hidden":"true"})}),ot&&n.jsx("div",{className:"list-modal",ref:Jt,role:"dialog","aria-label":"List options",children:n.jsxs("div",{className:"list-modal-content",children:[n.jsx("button",{type:"button",className:"list-option",title:"Numbered list",onClick:()=>{je(!1),Te(!0)},children:n.jsx("i",{className:"fa-solid fa-list-ol","aria-hidden":"true"})}),n.jsx("button",{type:"button",className:"list-option",title:"Bulleted list",onClick:()=>{c("list-bullets"),je(!1)},children:n.jsx("i",{className:"fa-solid fa-list-ul","aria-hidden":"true"})})]})}),n.jsx("button",{type:"button",className:"ghost-button","aria-label":"Numbered list",onClick:()=>{Te(b=>!b),je(!1),Ce(!1),V(!1),X(!1),H(!1)},children:n.jsx("i",{className:"fa-solid fa-text-height","aria-hidden":"true"})}),zt&&n.jsx("div",{className:"number-modal",ref:Dt,role:"dialog","aria-label":"Text spacing options",children:n.jsxs("div",{className:"number-modal-content",children:[n.jsxs("div",{className:"slider-row number-row",children:[n.jsx("label",{className:"slider-label",children:"Line spacing"}),n.jsx("input",{type:"range",min:"0.8",max:"3",step:"0.01",value:ha,onChange:b=>{const I=Number(b.target.value);gt(I),c("line-spacing")(I)},className:"number-range line-range","aria-label":"Line spacing"}),n.jsx("button",{type:"button",className:"reset-button",title:"Reset",onClick:Pa,"aria-label":"Reset line spacing",children:"⟲"}),n.jsx("input",{className:"slider-value-input",type:"number",step:"0.01",value:ha,onChange:b=>{const I=Number(b.target.value);gt(I),c("line-spacing")(I)}})]}),n.jsxs("div",{className:"slider-row number-row",children:[n.jsx("label",{className:"slider-label",children:"Letter spacing"}),n.jsx("input",{type:"range",min:"-0.5",max:"1",step:"0.01",value:ga,onChange:b=>{const I=Number(b.target.value);Zt(I),c("letter-spacing")(I)},className:"number-range letter-range","aria-label":"Letter spacing"}),n.jsx("button",{type:"button",className:"reset-button",title:"Reset",onClick:$a,"aria-label":"Reset letter spacing",children:"⟲"}),n.jsx("input",{className:"slider-value-input",type:"number",step:"0.01",value:ga,onChange:b=>{const I=Number(b.target.value);Zt(I),c("letter-spacing")(I)}})]})]})})]}),n.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),n.jsxs("div",{className:"toolbar-group toolbar-group--menu",role:"group","aria-label":"Text styles",style:{position:"relative"},children:[n.jsx("button",{type:"button",className:"text-button",onClick:()=>{ce(b=>!b),je(!1),Ce(!1),X(!1),H(!1),Te(!1),V(!1),_e(!1)},"aria-label":"Format",children:"Format"}),Y&&n.jsx("div",{className:"case-modal format-modal",ref:Oe,role:"dialog","aria-label":"Case options",children:n.jsxs("div",{className:"format-modal-content",children:[n.jsx("button",{type:"button",className:"format-option ",title:"Lowercase",onClick:()=>{c("lowercase"),ce(!1)},children:n.jsx("span",{className:"format-text-icon","aria-hidden":"true",children:"a"})}),n.jsx("button",{type:"button",className:"format-option ",title:"Uppercase",onClick:()=>{c("uppercase"),ce(!1)},children:n.jsx("span",{className:"format-text-icon","aria-hidden":"true",children:"A"})})]})}),n.jsxs("button",{type:"button",className:"text-button",onClick:()=>{_e(b=>!b),ce(!1),je(!1),Ce(!1),V(!1),X(!1),H(!1),Te(!1)},children:["T",n.jsx("span",{className:"text-button__super",children:"+"})," Effects"]}),rt&&n.jsxs("div",{className:"effects-modal",ref:Ft,role:"dialog","aria-label":"Text effects",children:[n.jsx("button",{type:"button",className:"modal-close-btn","aria-label":"Close effects",onClick:()=>_e(!1),children:n.jsx("i",{className:"fa-solid fa-x","aria-hidden":"true"})}),n.jsxs("div",{className:"effects-modal-content",children:[n.jsxs("div",{className:"effects-section",children:[n.jsx("div",{className:"effects-section-title",children:"Style"}),n.jsxs("div",{className:"effects-grid",children:[n.jsx("button",{type:"button",className:"effect-option",title:"None",onClick:()=>{c("effect-style")("none")},children:n.jsx("div",{className:"effect-preview none",children:n.jsx("i",{className:"fa-solid fa-ban","aria-hidden":"true"})})}),n.jsx("button",{type:"button",className:"effect-option",title:"Shadow",onClick:()=>{c("effect-style")("shadow")},children:n.jsx("div",{className:"effect-preview shadow",children:n.jsx("i",{className:"fi fi-rr-text-shadow","aria-hidden":"true"})})}),n.jsx("button",{type:"button",className:"effect-option",title:"Highlight",onClick:()=>{c("effect-style")("highlight")},children:n.jsx("div",{className:"effect-preview highlight",children:n.jsx("i",{className:"fa-solid fa-highlighter","aria-hidden":"true"})})}),n.jsx("button",{type:"button",className:"effect-option",title:"Glitch",onClick:()=>{c("effect-style")("glitch")},children:n.jsx("div",{className:"effect-preview glitch",children:n.jsx("span",{className:"glitch-mark",children:"/A"})})}),n.jsx("button",{type:"button",className:"effect-option",title:"Echo",onClick:()=>{c("effect-style")("echo")},children:n.jsx("div",{className:"effect-preview echo",children:n.jsx("span",{className:"echo-mark",children:"//A"})})})]})]}),n.jsxs("div",{className:"effects-section",children:[n.jsx("div",{className:"effects-section-title",children:"Shape"}),n.jsxs("div",{className:"effects-grid two",children:[n.jsx("button",{type:"button",className:"effect-option",title:"None",onClick:()=>{c("effect-shape")("none")},children:n.jsx("div",{className:"effect-preview none",children:"None"})}),n.jsx("button",{type:"button",className:"effect-option",title:"Curve",onClick:()=>{c("effect-shape")("curve")},children:n.jsx("div",{className:"effect-preview curve",children:"Curve"})})]})]})]})]})]})]}),n.jsx("div",{className:"toolbar-divider","aria-hidden":"true"}),n.jsxs("div",{className:"toolbar-group toolbar-group--utility",role:"group","aria-label":"Utility actions",style:{position:"relative"},children:[n.jsxs("div",{style:{display:"inline-block",position:"relative"},children:[n.jsx("button",{type:"button",className:"ghost-button","aria-label":"Spacing",onClick:()=>{xe&&(Xe(b=>!b),_e(!1),ce(!1),je(!1),Ce(!1),V(!1),X(!1),H(!1),Te(!1))},disabled:!xe,children:n.jsx("i",{className:"fi fi-rr-chess-board","aria-hidden":"true"})}),Qt&&n.jsx("div",{className:"opacity-modal",ref:ta,role:"dialog","aria-label":"Opacity",style:{position:"absolute",right:0,top:"42px",zIndex:1200},children:n.jsxs("div",{className:"opacity-modal-content",children:[n.jsxs("div",{className:"opacity-row",children:[n.jsx("label",{className:"opacity-label",children:"Opacity"}),n.jsx("input",{className:"opacity-input",type:"number",min:"0",max:"100",value:ea,onChange:b=>{const I=ir(Number(b.target.value)||0,0,100);ya(I),c("opacity")(I)},"aria-label":"Opacity percent"})]}),n.jsx("div",{className:"opacity-slider-row",children:n.jsx("input",{type:"range",min:"0",max:"100",value:ea,onChange:b=>{const I=Number(b.target.value);ya(I),c("opacity")(I)},className:"opacity-slider","aria-label":"Opacity slider",style:{background:"linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,1))"}})})]})})]}),n.jsxs("div",{style:{display:"inline-block",position:"relative"},children:[n.jsx("button",{type:"button",className:"ghost-button","aria-label":"Layers",onClick:()=>{xe&&(Ie(b=>!b),De(!1),Xe(!1),_e(!1),ce(!1),je(!1),Ce(!1),V(!1),X(!1),H(!1),Te(!1))},disabled:!xe,children:n.jsx("i",{className:"fa-solid fa-layer-group","aria-hidden":"true"})}),lt&&n.jsx("div",{className:"layers-modal",ref:Ra,role:"dialog","aria-label":"Layer management",style:{position:"absolute",right:0,top:"42px",zIndex:1200},children:n.jsxs("div",{className:"layers-modal-content",children:[n.jsxs("button",{type:"button",className:"layer-option",title:"Bring to front",onClick:()=>{c("layer")("bring-to-front"),Ie(!1)},children:[n.jsx("i",{className:"fi fi-rr-chevron-double-up","aria-hidden":"true"}),n.jsx("span",{className:"layer-label",children:"Bring to front"})]}),n.jsxs("button",{type:"button",className:"layer-option",title:"Bring forward",onClick:()=>{c("layer")("bring-forward"),Ie(!1)},children:[n.jsx("i",{className:"fi fi-rr-angle-up","aria-hidden":"true"}),n.jsx("span",{className:"layer-label",children:"Bring forward"})]}),n.jsxs("button",{type:"button",className:"layer-option",title:"Send backward",onClick:()=>{c("layer")("send-backward"),Ie(!1)},children:[n.jsx("i",{className:"fi fi-rr-angle-down","aria-hidden":"true"}),n.jsx("span",{className:"layer-label",children:"Send backward"})]}),n.jsxs("button",{type:"button",className:"layer-option",title:"Send to back",onClick:()=>{c("layer")("send-to-back"),Ie(!1)},children:[n.jsx("i",{className:"fi fi-rr-chevron-double-down","aria-hidden":"true"}),n.jsx("span",{className:"layer-label",children:"Send to back"})]})]})})]}),n.jsxs("div",{style:{display:"inline-block",position:"relative"},children:[n.jsx("button",{type:"button",className:"ghost-button","aria-label":"Share / Rotation",onClick:()=>{xe&&(De(b=>!b),Xe(!1),_e(!1),ce(!1),je(!1),Ce(!1),V(!1),X(!1),H(!1),Te(!1))},disabled:!xe,children:n.jsx("i",{className:"fi fi-rr-refresh","aria-hidden":"true"})}),Ve&&n.jsx("div",{className:"rotation-modal",ref:aa,role:"dialog","aria-label":"Rotation",style:{position:"absolute",right:0,top:"42px",zIndex:1200},children:n.jsxs("div",{className:"rotation-modal-content",children:[n.jsxs("div",{className:"rotation-row",children:[n.jsx("label",{className:"rotation-label",children:"Rotation"}),n.jsx("input",{className:"rotation-input",type:"number",min:"-180",max:"180",value:Ct,onChange:b=>{const I=ir(Number(b.target.value)||0,-180,180);ba(I),c("rotation")(I)},"aria-label":"Rotation degrees"})]}),n.jsxs("div",{className:"rotation-slider-row",children:[n.jsx("input",{type:"range",min:"-180",max:"180",value:Ct,onChange:b=>{const I=Number(b.target.value);ba(I),c("rotation")(I)},className:"rotation-slider","aria-label":"Rotation slider"}),n.jsx("i",{className:"fa-solid fa-rotate-right rotation-icon","aria-hidden":"true"})]})]})})]}),n.jsxs("div",{style:{display:"inline-block",position:"relative"},children:[n.jsx("button",{type:"button",className:"ghost-button","aria-label":"More options",onClick:()=>{xe&&(Ge(b=>!b),Ie(!1),De(!1),Xe(!1),_e(!1),ce(!1),je(!1),Ce(!1),V(!1),X(!1),H(!1),Te(!1))},disabled:!xe,children:n.jsx("i",{className:"fa-solid fa-ellipsis","aria-hidden":"true"})}),re&&n.jsx("div",{className:"more-modal",ref:va,role:"dialog","aria-label":"More options",style:{position:"absolute",right:0,top:"42px",zIndex:1200},children:n.jsxs("div",{className:"more-modal-content",children:[n.jsxs("button",{type:"button",className:"more-option",title:"Duplicate",onClick:()=>{c("more")("duplicate"),Ge(!1)},children:[n.jsx("i",{className:"fa-solid fa-clone","aria-hidden":"true"}),n.jsx("span",{className:"more-label",children:"Duplicate"})]}),n.jsxs("button",{type:"button",className:"more-option",title:"Delete",onClick:()=>{c("more")("delete"),Ge(!1)},children:[n.jsx("i",{className:"fi fi-rr-trash","aria-hidden":"true"}),n.jsx("span",{className:"more-label",children:"Delete"})]}),n.jsxs("button",{type:"button",className:"more-option",title:"Lock",onClick:()=>{c("more")("lock"),Ge(!1)},children:[n.jsx("i",{className:"fi fi-rr-unlock","aria-hidden":"true"}),n.jsx("span",{className:"more-label",children:"Lock"})]}),n.jsxs("button",{type:"button",className:"more-option",title:"Copy",onClick:()=>{c("more")("copy"),Ge(!1)},children:[n.jsx("i",{className:"fa-solid fa-copy","aria-hidden":"true"}),n.jsx("span",{className:"more-label",children:"Copy"})]})]})})]})]})]})}function Zr(){const G=document.getElementById("inkwise-customer-studio-bootstrap");if(G)try{const o=JSON.parse(G.textContent||"{}");if(o&&typeof o=="object")return typeof window<"u"&&(window.inkwiseStudioBootstrap=o),o}catch(o){console.error("[InkWise Studio] Failed to parse bootstrap payload.",o)}return typeof window<"u"&&window.inkwiseStudioBootstrap?window.inkwiseStudioBootstrap:{}}function bs({template:G}){if(!G)return n.jsx("span",{className:"studio-status__message",children:"Template data unavailable"});const o=G.updated_at?new Date(G.updated_at):null,c=o&&!Number.isNaN(o.getTime())?o.toLocaleString():"Not yet saved";return n.jsxs("div",{className:"studio-status__summary",children:[n.jsx("span",{className:"studio-status__template-name",title:G.name||"Untitled Template",children:G.name||"Untitled Template"}),G.svg_path&&n.jsx("span",{className:"studio-status__badge studio-status__badge--svg",children:"SVG ready"}),G.preview&&n.jsx("span",{className:"studio-status__badge studio-status__badge--preview",children:"Preview loaded"}),n.jsxs("span",{className:"studio-status__meta",children:["Updated: ",c]})]})}function vs({bootstrap:G,status:o}){const c=(G==null?void 0:G.template)??null,f=(G==null?void 0:G.product)??null,g=o==="ready"?"Design canvas ready":o==="initializing"?"Preparing editor…":o;return n.jsxs("div",{className:"studio-status",role:"status","aria-live":"polite",children:[n.jsxs("div",{className:"studio-status__header",children:[n.jsx("span",{className:"studio-status__dot","data-state":o}),n.jsx("span",{className:"studio-status__label",children:g})]}),n.jsx(bs,{template:c}),f&&n.jsxs("div",{className:"studio-status__product",children:["Editing: ",f.name||`Product #${f.id}`]})]})}function ws(){const G=P.useMemo(()=>Zr(),[]),[o,c]=P.useState("initializing"),[f,g]=P.useState(null);return P.useEffect(()=>{if(typeof document>"u")return;const S=f==="text"||f==="image";return document.body.classList.toggle("text-toolbar-visible",!!S),()=>{document.body.classList.remove("text-toolbar-visible")}},[f]),P.useEffect(()=>{hs(),c("ready")},[]),P.useEffect(()=>{if(typeof window>"u")return;const S=N=>{const R=(N==null?void 0:N.detail)||{};g(R.type||null)};window.addEventListener("inkwise:active-element",S);const F=window.inkwiseToolbar;if(F&&typeof F.getSelection=="function")try{const N=F.getSelection();N&&N.type&&g(N.type)}catch(N){console.debug("[InkWise Studio] Unable to read initial toolbar selection.",N)}return()=>{window.removeEventListener("inkwise:active-element",S)}},[]),!G||Object.keys(G).length===0?null:n.jsx("div",{className:"studio-status-wrapper",children:n.jsx(vs,{bootstrap:G,status:o})})}function xs(){P.useMemo(()=>Zr(),[]);const[G,o]=P.useState(null);P.useEffect(()=>{if(typeof window>"u")return;const F=R=>{const de=(R==null?void 0:R.detail)||{};o(de.type||null)};window.addEventListener("inkwise:active-element",F);const N=typeof window<"u"?window.inkwiseToolbar:null;if(N&&typeof N.getSelection=="function")try{const R=N.getSelection();R&&R.type&&o(R.type)}catch{}return()=>window.removeEventListener("inkwise:active-element",F)},[]),P.useEffect(()=>{if(typeof document>"u")return;const F=G==="text"||G==="image";return document.body.classList.toggle("text-toolbar-visible",!!F),()=>document.body.classList.remove("text-toolbar-visible")},[G]);const c=F=>{const N=typeof window<"u"?window.inkwiseToolbar:null;!N||typeof N.setFontFamily!="function"||N.setFontFamily(F)},f=F=>{const N=typeof window<"u"?window.inkwiseToolbar:null;!N||typeof N.setFontSize!="function"||N.setFontSize(F)},g=F=>{const N=typeof window<"u"?window.inkwiseToolbar:null;!N||typeof N.setColor!="function"||N.setColor(F)},S=F=>{const N=typeof window<"u"?window.inkwiseToolbar:null;return!N||typeof N.dispatch!="function"?()=>{}:new Set(["line-spacing","letter-spacing","effect-style","effect-shape","opacity","rotation","layer","more"]).has(F)?de=>N.dispatch(F,de):(N.dispatch(F),()=>{})};return n.jsx("div",{className:"studio-react-widgets","aria-hidden":!1,children:n.jsx(ys,{onAction:S,onFontChange:c,onSizeChange:f,onColorChange:g,activeElementType:G})})}function Ss(){const G=()=>{const o=document.getElementById("inkwise-customer-studio-root");if(!o)return;Xr.createRoot(o).render(n.jsx(Kr.StrictMode,{children:n.jsx(ws,{})}));try{const f=document.querySelector(".preview-canvas-wrapper");let S=document.getElementById("inkwise-mini-toolbar-root");!S&&f&&(S=document.createElement("div"),S.id="inkwise-mini-toolbar-root",S.className="studio-react-widgets",f.parentNode.insertBefore(S,f.nextSibling)),S&&Xr.createRoot(S).render(n.jsx(Kr.StrictMode,{children:n.jsx(xs,{})}))}catch(f){console.debug("[InkWise Studio] Failed to mount toolbar in preview area",f)}};if(document.readyState==="complete"||document.readyState==="interactive"){G();return}document.addEventListener("DOMContentLoaded",G,{once:!0})}Ss();
