const y="http://www.w3.org/2000/svg",C="http://www.w3.org/1999/xlink";class A{constructor(t,i={}){console.log("SvgTemplateEditor: Constructor called for SVG element:",t),this.svg=t,this.options={onImageChange:i.onImageChange||null,onTextChange:i.onTextChange||null,...i};const s=document&&document.body&&document.body.dataset?document.body.dataset:{},e=(s.imageReplacementMode||"").toLowerCase();let a="full";e==="panel-only"||e==="disabled"?a=e:s.allowImageReplacement==="false"&&(a="disabled"),this.imageReplacementMode=a,this.allowCanvasImageTools=a!=="disabled",this.changeableImages=[],this.textElements=[],this.imageClassTokens=new Set(["canvas-layer__image","changeable-image","svg-changeable-image","inkwise-image"]),this.init()}init(){console.log("SvgTemplateEditor: Initializing..."),this.parseSvgData(),this.setupImageHandlers(),this.setupTextHandlers(),this.addCssStyles(),console.log("SvgTemplateEditor: Initialization complete")}parseSvgData(){const t=this.svg.dataset.svgData;if(t)try{const i=JSON.parse(t);this.changeableImages=i.changeable_images||[],this.textElements=i.text_elements||[]}catch(i){console.warn("SvgTemplateEditor: Failed to parse data-svg-data payload",i)}}readDatasetTokens(t){return!t||!t.dataset?[]:["changeable","editableType","elementType","layerType","previewType","fieldType"].map(s=>t.dataset[s]).filter(s=>typeof s=="string"&&s.trim()!=="").map(s=>s.trim().toLowerCase())}findImageContentNode(t){return!t||typeof t.querySelector!="function"?null:t.querySelector('[data-changeable="image"], [data-editable-image], .canvas-layer__image, img, image')}nodeRepresentsImage(t){if(!t)return!1;const i=typeof t.tagName=="string"?t.tagName.toLowerCase():"";if(i==="image"||i==="img"||this.readDatasetTokens(t).some(e=>e==="image"||e==="photo"||e==="graphic")||typeof t.hasAttribute=="function"&&(t.hasAttribute("data-editable-image")||t.hasAttribute("data-changeable-image")))return!0;if(t.classList){for(const e of this.imageClassTokens)if(t.classList.contains(e))return!0}return i==="foreignobject"?!!this.findImageContentNode(t):!1}resolveImageNode(t){if(!t)return null;if(this.nodeRepresentsImage(t))return t;if(typeof t.closest=="function"){const i=t.closest("[data-preview-node]");if(i&&i!==t&&this.nodeRepresentsImage(i))return i}return this.findImageContentNode(t)}resolveImageHandleNodes(t){const i=this.resolveImageNode(t);return i?{interactionNode:typeof i.closest=="function"&&i.closest("foreignObject")||i,contentNode:i}:null}applyImageSourceToNode(t,i){if(!t||!i)return null;const s=typeof t.tagName=="string"?t.tagName.toLowerCase():"";if(s==="image")return t.setAttributeNS(C,"href",i),t.setAttribute("href",i),t.dataset&&(t.dataset.src=i),t;if(s==="img")return t.setAttribute("src",i),t.dataset&&(t.dataset.src=i),t;if(s==="foreignobject"){const e=this.findImageContentNode(t);return e&&e!==t?this.applyImageSourceToNode(e,i):null}return s==="rect"?this.convertRectToImage(t,i):(t.style&&typeof t.style.setProperty=="function"&&(t.style.backgroundImage=`url('${i}')`),t.dataset&&(t.dataset.src=i,t.dataset.replacedImage="true"),t)}convertRectToImage(t,i){if(!t||!t.parentNode)return null;const s=document.createElementNS(y,"image");return["x","y","width","height","transform","preserveAspectRatio"].forEach(a=>{t.hasAttribute&&t.hasAttribute(a)&&s.setAttribute(a,t.getAttribute(a))}),Array.from(t.attributes||[]).forEach(a=>{(a.name==="id"||a.name.startsWith("data-"))&&s.setAttribute(a.name,a.value)}),t.classList&&t.classList.length&&t.classList.forEach(a=>s.classList.add(a)),s.setAttribute("href",i),s.setAttributeNS(C,"href",i),s.hasAttribute("preserveAspectRatio")||s.setAttribute("preserveAspectRatio","xMidYMid slice"),t.parentNode.replaceChild(s,t),s}escapeSelector(t){return typeof t!="string"||!t.length?"":typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(t):t.replace(/([^a-zA-Z0-9_-])/g,"\\$1")}resolveNodeFromMetadata(t){if(!t||typeof t!="object")return null;const i=t.id||t.element_id||t.node_id;if(i){const e=`#${this.escapeSelector(i)}`,a=this.svg.querySelector(e);if(a)return a}const s=t.selector||t.css_selector;if(s)try{const e=this.svg.querySelector(s);if(e)return e}catch(e){console.warn("SvgTemplateEditor: Invalid selector in changeable image metadata",s,e)}return null}collectImageCandidates(){const t=new Set;return this.changeableImages.forEach(s=>{const e=this.resolveNodeFromMetadata(s);e&&t.add(e)}),this.svg.querySelectorAll('[data-changeable="image"], [data-editable-image], .changeable-image, .canvas-layer__image, image, img, foreignObject').forEach(s=>{t.add(s)}),Array.from(t)}getBBoxSafe(t){if(!t||typeof t.getBBox!="function")return null;try{return t.getBBox()}catch(i){return console.warn("SvgTemplateEditor: Unable to compute bounding box for element",i,t),null}}toSvgPoint(t,i){if(!this.svg||typeof this.svg.createSVGPoint!="function")return null;const s=this.svg.createSVGPoint();s.x=t,s.y=i;const e=this.svg.getScreenCTM();return e?s.matrixTransform(e.inverse()):null}setupImageHandlers(){const t=this.collectImageCandidates();if(console.log("SvgTemplateEditor: Found",t.length,"changeable image elements"),!this.allowCanvasImageTools){t.forEach(i=>{const s=this.resolveImageHandleNodes(i);if(!s)return;const{interactionNode:e}=s;if(e.style.cursor="default",e.classList.remove("svg-changeable-image"),e.classList.remove("changeable-image-hover"),e._boundingBox){try{e._boundingBox.remove()}catch{}e._boundingBox=null}});return}setTimeout(()=>{t.forEach((i,s)=>{const e=this.resolveImageHandleNodes(i);if(!e)return;const{interactionNode:a,contentNode:o}=e;if(!a||a.__inkwiseSvgImageBound)return;console.log("SvgTemplateEditor: Setting up element",s,a),a.__inkwiseSvgImageBound=!0,a.__inkwiseImageContent=o||a,a.style.cursor="pointer",a.classList.add("svg-changeable-image"),a.classList.add("changeable-image-hover"),a.addEventListener("mouseenter",()=>{a.classList.add("changeable-image-active")}),a.addEventListener("mouseleave",()=>{a.classList.remove("changeable-image-active")}),a.addEventListener("click",n=>{n.preventDefault(),this.showImageUploadDialog(a)});const r=this.createBoundingBox(a);r&&(a._boundingBox=r),this.makeDraggable(a)})},200)}createBoundingBox(t){const i=this.getBBoxSafe(t);if(!i)return null;const s=document.createElementNS(y,"g");s.classList.add("svg-bounding-box");const e=document.createElementNS(y,"rect");return e.classList.add("svg-bounding-box__rect"),e.setAttribute("fill","none"),e.setAttribute("stroke","#007cba"),e.setAttribute("stroke-width","2"),e.setAttribute("stroke-dasharray","5,5"),e.setAttribute("rx","3"),e.style.pointerEvents="none",s.appendChild(e),this.createResizeHandles().forEach(o=>s.appendChild(o)),this.svg.appendChild(s),this.positionBoundingElements(s,i),s}createResizeHandles(){const t=[];return[{name:"nw",x:0,y:0},{name:"ne",x:1,y:0},{name:"sw",x:0,y:1},{name:"se",x:1,y:1}].forEach(s=>{const e=document.createElementNS(y,"circle");e.setAttribute("r","4"),e.setAttribute("fill","#007cba"),e.setAttribute("stroke","#ffffff"),e.setAttribute("stroke-width","1"),e.classList.add("resize-handle",`handle-${s.name}`),e.style.pointerEvents="all",e.style.cursor=`${s.name}-resize`,t.push(e)}),t}positionBoundingElements(t,i){if(!t||!i)return;const s=t.querySelector(".svg-bounding-box__rect");if(!s)return;const e=5,a=i.x-e,o=i.y-e,r=i.width+e*2,n=i.height+e*2;s.setAttribute("x",a),s.setAttribute("y",o),s.setAttribute("width",Math.max(r,0)),s.setAttribute("height",Math.max(n,0)),t.querySelectorAll(".resize-handle").forEach(c=>{c.classList.contains("handle-nw")?(c.setAttribute("cx",a),c.setAttribute("cy",o)):c.classList.contains("handle-ne")?(c.setAttribute("cx",a+r),c.setAttribute("cy",o)):c.classList.contains("handle-sw")?(c.setAttribute("cx",a),c.setAttribute("cy",o+n)):c.classList.contains("handle-se")?(c.setAttribute("cx",a+r),c.setAttribute("cy",o+n)):c.classList.contains("handle-n")?(c.setAttribute("cx",a+r/2),c.setAttribute("cy",o)):c.classList.contains("handle-s")?(c.setAttribute("cx",a+r/2),c.setAttribute("cy",o+n)):c.classList.contains("handle-e")?(c.setAttribute("cx",a+r),c.setAttribute("cy",o+n/2)):c.classList.contains("handle-w")&&(c.setAttribute("cx",a),c.setAttribute("cy",o+n/2))})}updateBoundingBox(t){if(!t||!t._boundingBox)return;const i=this.getBBoxSafe(t);this.positionBoundingElements(t._boundingBox,i)}focusElementById(t){if(!t||!this.svg)return!1;const i=`#${this.escapeSelector(t)}`;let s=null;try{s=this.svg.querySelector(i)}catch(r){return console.warn("SvgTemplateEditor: Invalid selector generated for element id",t,r),!1}if(s||(s=this.svg.querySelector(`[data-element-id="${t}"]`)),!s)return!1;const a=(this.resolveImageHandleNodes(s)||{interactionNode:s}).interactionNode||s;return this.getBBoxSafe(a)?(this.updateBoundingBox(a),a._boundingBox&&(a._boundingBox.classList.add("svg-bounding-box--pulse"),setTimeout(()=>{a._boundingBox&&a._boundingBox.classList.remove("svg-bounding-box--pulse")},1e3)),typeof a.scrollIntoView=="function"&&a.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),a.classList.add("changeable-image-active"),setTimeout(()=>a.classList.remove("changeable-image-active"),1200),!0):!1}makeDraggable(t){let i=!1,s=0,e=0,a=0,o=0,r=0,n=0;const m=u=>{if(u.target.closest(".resize-handle"))return;const g=this.toSvgPoint(u.clientX,u.clientY);if(!g)return;const d=this.getBBoxSafe(t);if(!d)return;const h=typeof t.getAttribute=="function",l=typeof t.setAttribute=="function";s=h?parseFloat(t.getAttribute("x")):d.x,e=h?parseFloat(t.getAttribute("y")):d.y,Number.isNaN(s)&&(s=d.x,l&&t.setAttribute("x",s)),Number.isNaN(e)&&(e=d.y,l&&t.setAttribute("y",e)),a=g.x-s,o=g.y-e,r=s,n=e,i=!0,t.style.cursor="grabbing",this.svg.style.cursor="grabbing",document.body.style.userSelect="none",u.preventDefault()},c=u=>{if(!i)return;const g=this.toSvgPoint(u.clientX,u.clientY);g&&(r=g.x-a,n=g.y-o,typeof t.removeAttribute=="function"&&t.removeAttribute("transform"),typeof t.setAttribute=="function"&&(t.setAttribute("x",r),t.setAttribute("y",n)),this.updateBoundingBox(t),u.preventDefault())},f=u=>{if(!i)return;i=!1,t.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="",this.updateBoundingBox(t);const g=new CustomEvent("svgImageMoved",{detail:{element:t,x:r,y:n}});this.svg.dispatchEvent(g),u.preventDefault()};t.addEventListener("mousedown",m),document.addEventListener("mousemove",c),document.addEventListener("mouseup",f),t._boundingBox&&t._boundingBox.querySelectorAll(".resize-handle").forEach(g=>{this.makeResizable(t,g)})}makeResizable(t,i){let s=!1,e=null,a=0,o=0,r=0,n=0,m="",c=0;const f=d=>{const h=this.toSvgPoint(d.clientX,d.clientY);if(!h)return;const l=this.getBBoxSafe(t);if(!l)return;a=l.width,o=l.height;const v=typeof t.getAttribute=="function",p=typeof t.setAttribute=="function";r=v?parseFloat(t.getAttribute("x")):l.x,n=v?parseFloat(t.getAttribute("y")):l.y,Number.isNaN(r)&&(r=l.x,p&&t.setAttribute("x",r)),Number.isNaN(n)&&(n=l.y,p&&t.setAttribute("y",n)),c=parseFloat(t.getAttribute("font-size"))||parseFloat(window.getComputedStyle(t).fontSize)||16,e=h,m=Array.from(i.classList).find(b=>b.startsWith("handle-"))||"",s=!0,t.style.cursor=i.style.cursor,this.svg.style.cursor=i.style.cursor,document.body.style.userSelect="none",d.preventDefault(),d.stopPropagation()},u=d=>{if(!s)return;const h=this.toSvgPoint(d.clientX,d.clientY);if(!h)return;const l=h.x-e.x,v=h.y-e.y;let p=a,b=o,w=r,S=n;switch(m){case"handle-se":p=a+l,b=o+v;break;case"handle-sw":p=a-l,b=o+v,w=r+l;break;case"handle-ne":p=a+l,b=o-v,S=n+v;break;case"handle-nw":p=a-l,b=o-v,w=r+l,S=n+v;break}p=Math.max(20,p),b=Math.max(20,b);const E=t.tagName.toLowerCase();if((E==="image"||E==="rect")&&typeof t.setAttribute=="function")t.setAttribute("width",p),t.setAttribute("height",b),t.setAttribute("x",w),t.setAttribute("y",S);else{const T=Math.max(1,a),k=Math.max(1,o),_=p/T,I=b/k,N=Math.max(_,I),L=Math.max(6,c*N);typeof t.setAttribute=="function"&&t.setAttribute("font-size",L)}this.updateBoundingBox(t),d.preventDefault(),d.stopPropagation()},g=d=>{if(!s)return;s=!1,t.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="";const h={element:t,width:parseFloat(t.getAttribute?t.getAttribute("width"):"")||a,height:parseFloat(t.getAttribute?t.getAttribute("height"):"")||o,x:parseFloat(t.getAttribute?t.getAttribute("x"):"")||r,y:parseFloat(t.getAttribute?t.getAttribute("y"):"")||n},l=new CustomEvent("svgImageResized",{detail:h});this.svg.dispatchEvent(l),d.preventDefault(),d.stopPropagation()};i.addEventListener("mousedown",f),document.addEventListener("mousemove",u),document.addEventListener("mouseup",g)}setupTextHandlers(){const t=this;this.svg.querySelectorAll('[data-editable="true"]').forEach(s=>{s.style.cursor="pointer",s.classList.add("svg-editable-text"),s.addEventListener("click",function(e){e.preventDefault(),t.showTextEditDialog(s)}),s.addEventListener("mouseenter",function(){s.classList.add("editable-text-hover")}),s.addEventListener("mouseleave",function(){s.classList.remove("editable-text-hover")})})}showImageUploadDialog(t){const i=this,s=document.createElement("input");s.type="file",s.accept="image/*",s.style.display="none",s.addEventListener("change",function(e){const a=e.target.files[0];a&&i.handleImageUpload(a,t),s.parentNode&&s.parentNode.removeChild(s)}),document.body.appendChild(s),s.click()}async handleImageUpload(t,i){var c;const s=this,e=i&&i.__inkwiseImageContent?i.__inkwiseImageContent:i,a=((c=document.querySelector('meta[name="csrf-token"]'))==null?void 0:c.getAttribute("content"))||null,o=new FormData;o.append("image",t),a&&o.append("_token",a);let r=null;try{const f=await fetch("/design/upload-image",{method:"POST",body:o,credentials:"same-origin"});if(!f.ok){const g=await f.text().catch(()=>"");throw new Error(`Upload failed (${f.status}): ${g}`)}const u=await f.json();r=u.url||u.path||null}catch(f){console.error("SvgTemplateEditor: Failed to upload image",f),alert("We could not upload your image. Please try again.");const u=new CustomEvent("svgImageUploadFailed",{detail:{error:f,file:t}});s.svg.dispatchEvent(u);return}if(!r){alert("Upload did not return a usable image URL.");return}const n=s.applyImageSourceToNode(e,r)||e;i&&n&&i.__inkwiseImageContent!==n&&(i.__inkwiseImageContent=n);const m=new CustomEvent("svgImageChanged",{detail:{element:n,imageUrl:r,file:t}});s.svg.dispatchEvent(m),s.options.onImageChange&&s.options.onImageChange(n,r,t),s.updateBoundingBox(i||n)}showTextEditDialog(t){const i=this,s=t.textContent||"",e=document.createElement("input");e.type="text",e.value=s,e.className="svg-text-editor";const a=t.getBoundingClientRect(),o=i.svg.getBoundingClientRect();e.style.position="absolute",e.style.left=a.left-o.left+"px",e.style.top=a.top-o.top+"px",e.style.width=Math.max(a.width,100)+"px",e.style.fontSize=window.getComputedStyle(t).fontSize,e.style.fontFamily=window.getComputedStyle(t).fontFamily,e.style.border="1px solid #007cba",e.style.padding="2px",e.style.background="white",e.style.zIndex="1000",t.style.visibility="hidden",i.svg.parentNode.appendChild(e),e.focus(),e.select();const r=function(){const n=e.value;for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(n)),t.style.visibility="visible",e.parentNode&&e.parentNode.removeChild(e);const m=new CustomEvent("svgTextChanged",{detail:{element:t,oldText:s,newText:n}});i.svg.dispatchEvent(m),i.options.onTextChange&&i.options.onTextChange(t,s,n)};e.addEventListener("blur",r),e.addEventListener("keydown",function(n){n.key==="Enter"?r():n.key==="Escape"&&(t.style.visibility="visible",e.parentNode&&e.parentNode.removeChild(e))})}addCssStyles(){if(document.getElementById("svg-editor-styles"))return;const t=document.createElement("style");t.id="svg-editor-styles",t.textContent=`
            .svg-changeable-image {
                transition: all 0.2s ease;
            }

            .changeable-image-hover:hover {
                filter: brightness(0.8);
                stroke: #007cba !important;
                stroke-width: 2px !important;
            }

            .changeable-image-active {
                filter: brightness(0.7);
                stroke: #007cba !important;
                stroke-width: 3px !important;
            }

            .svg-bounding-box {
                transition: all 0.2s ease;
            }

            .svg-bounding-box__rect {
                pointer-events: none;
            }

            .resize-handle {
                transition: all 0.2s ease;
                pointer-events: all !important;
            }

            .resize-handle:hover {
                fill: #005a87;
                r: 6px;
            }

            .svg-editable-text {
                transition: all 0.2s ease;
            }

            .editable-text-hover:hover {
                fill: #007cba !important;
                text-decoration: underline;
            }

            .uploaded-image {
                transition: all 0.2s ease;
            }

            .svg-text-editor {
                box-sizing: border-box;
                outline: none;
            }

            .svg-text-editor:focus {
                box-shadow: 0 0 5px rgba(0, 124, 186, 0.5);
            }
                .svg-bounding-box--pulse .svg-bounding-box__rect {
                    animation: svgBoundingBoxPulse 1s ease-out;
                }

                @keyframes svgBoundingBoxPulse {
                    0% {
                        stroke-width: 2;
                        opacity: 1;
                    }
                    50% {
                        stroke-width: 4;
                        opacity: 0.4;
                    }
                    100% {
                        stroke-width: 2;
                        opacity: 1;
                    }
                }
        `,document.head.appendChild(t)}getSvgString(){const t=this.svg.cloneNode(!0);t.querySelectorAll('.svg-bounding-box, .inkwise-editor-marker, [data-editor-only="true"]').forEach(e=>{var a;(a=e.parentNode)==null||a.removeChild(e)}),t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),t.style.width="",t.style.height="",t.style.maxWidth="",t.style.maxHeight="",t.removeAttribute("preserveAspectRatio");const i=document.createElementNS(y,"style");return i.id="inkwise-export-styles",i.textContent=`
            @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
            text { white-space: pre; }
        `,t.insertBefore(i,t.firstChild),new XMLSerializer().serializeToString(t)}getSvgDataUrl(){const t=this.getSvgString();return"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(t)))}async saveSvg(t,i="front"){const s=this.getSvgString();try{const e=await fetch(`/staff/templates/${t}/save-svg`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({svg_content:s,side:i})});if(!e.ok){const o=await e.text().catch(()=>"");throw new Error(o||`Request failed with status ${e.status}`)}let a;try{a=await e.json()}catch(o){console.warn("SvgTemplateEditor: Failed to parse save response",o),a={success:!1,error:"Invalid response from server"}}return a}catch(e){return console.error("Failed to save SVG:",e),{success:!1,error:e.message}}}}function B(){const x=()=>{const t=document.querySelectorAll("svg[data-svg-editor]");console.log("SvgTemplateEditor: Found",t.length,"SVGs with data-svg-editor attribute"),t.forEach((i,s)=>{i.__inkwiseSvgTemplateEditor||(console.log("SvgTemplateEditor: Initializing editor",s,"for SVG:",i),i.__inkwiseSvgTemplateEditor=new A(i))})};if(document.readyState==="complete"||document.readyState==="interactive"?x():document.addEventListener("DOMContentLoaded",x,{once:!0}),!window.__inkwiseSvgTemplateEditorObserver){const t=new MutationObserver(i=>{i.forEach(s=>{s.addedNodes.forEach(e=>{e.nodeType===1&&e.matches&&e.matches("svg[data-svg-editor]")&&(e.__inkwiseSvgTemplateEditor||(e.__inkwiseSvgTemplateEditor=new A(e)))})})});t.observe(document.body,{childList:!0,subtree:!0}),window.__inkwiseSvgTemplateEditorObserver=t}}typeof window<"u"&&(window.SvgTemplateEditor=A,window.__inkwiseSvgTemplateEditorAutoInit||(window.__inkwiseSvgTemplateEditorAutoInit=!0,B()));
