document.addEventListener("DOMContentLoaded",()=>{var Se,ke,Le;const u=document.getElementById("zoomOutBtn"),B=document.getElementById("zoomInBtn"),h=document.querySelector(".zoom-controls span"),o=document.getElementById("templateCanvas"),t=o.getContext("2d");let n=100;function N(){o.style.transform=`scale(${n/100})`,h.textContent=`${n}%`,Me(),f()}u==null||u.addEventListener("click",()=>{n>10&&(n-=10,N())}),B==null||B.addEventListener("click",()=>{n<300&&(n+=10,N())});let W=[],m=[],x=[],l=null,A=null,j=!1,$=!1,G={x:0,y:0},v=null,O=null,_=!1,K=!1,V={x:0,y:0},b=null,a=null,z=null;function f(){t.clearRect(0,0,o.width,o.height),Te(),m.forEach(e=>{t.save(),t.strokeStyle=l===e?"#2563eb":"#aaa",t.lineWidth=l===e?2:1,t.strokeRect(e.x*(n/100),e.y*(n/100),e.w*(n/100),e.h*(n/100));const r=e.fontStyle&&e.fontStyle!=="normal"?e.fontStyle+" ":"",s=e.fontWeight||"400";t.font=`${r}${s} ${e.fontSize*(n/100)}px ${e.fontFamily}`,t.fillStyle=e.color,t.textBaseline="top",t.textAlign=e.textAlign||"left",t.save(),t.beginPath(),t.rect(e.x*(n/100)+8,e.y*(n/100)+8,(e.w-16)*(n/100),(e.h-16)*(n/100)),t.clip();const d=e.textTransform==="uppercase"?(e.text||"").toUpperCase():e.text||"";if(t.fillText(d,e.x*(n/100)+8,e.y*(n/100)+8,(e.w-16)*(n/100)),e.textDecoration&&e.textDecoration.includes("underline")){t.measureText(d);const i=e.y*(n/100)+8+e.fontSize*(n/100);t.beginPath(),t.strokeStyle=e.color||"#000",t.lineWidth=Math.max(1,e.fontSize*(n/100)/12);let g=e.x*(n/100)+8,p=e.x*(n/100)+(e.w-16)*(n/100);t.moveTo(g,i),t.lineTo(p,i),t.stroke()}t.restore(),t.fillStyle="#2563eb",t.fillRect(e.x*(n/100)+e.w*(n/100)-8,e.y*(n/100)+e.h*(n/100)-8,8,8),t.font="bold 18px Arial",t.fillStyle="#e11d48",t.textAlign="right",t.textBaseline="top",t.fillText("‚úï",e.x*(n/100)+e.w*(n/100)-12,e.y*(n/100)+4);const c=[[e.x,e.y],[e.x+e.w,e.y],[e.x,e.y+e.h],[e.x+e.w,e.y+e.h]];t.fillStyle="#2563eb",c.forEach(([i,g])=>{t.fillRect(i*(n/100)-4,g*(n/100)-4,8,8)}),t.restore()})}function Te(){x.forEach(e=>{t.save(),e.type==="image"&&e.img&&t.drawImage(e.img,e.x*(n/100),e.y*(n/100),e.w*(n/100),e.h*(n/100)),e.type==="video"&&(t.strokeStyle="#aaa",t.strokeRect(e.x*(n/100),e.y*(n/100),e.w*(n/100),e.h*(n/100)),t.font="bold 16px Arial",t.fillStyle="#888",t.fillText("Video",e.x*(n/100)+10,e.y*(n/100)+24)),t.fillStyle="#2563eb",t.beginPath(),t.arc(e.x*(n/100)+e.w*(n/100)-12,e.y*(n/100)+e.h*(n/100)-12,12,0,2*Math.PI),t.fill(),t.font="20px Arial",t.fillStyle="#fff",t.textAlign="center",t.textBaseline="middle",t.fillText("‚§¢",e.x*(n/100)+e.w*(n/100)-12,e.y*(n/100)+e.h*(n/100)-12),t.font="28px Arial",t.textAlign="right",t.textBaseline="top",t.fillStyle="#2563eb",e.locked?t.fillText("üîí",(e.x+e.w)*(n/100)-10,e.y*(n/100)+2):t.fillText("üîì",(e.x+e.w)*(n/100)-10,e.y*(n/100)+2),t.font="28px Arial",t.fillStyle="#e11d48",t.textAlign="left",t.textBaseline="top",t.fillText("‚®Ø",e.x*(n/100)+4,e.y*(n/100)+4),t.font="22px Arial",t.fillStyle="#2563eb",t.textAlign="center",t.textBaseline="middle",t.fillText("‚á≤",e.x*(n/100)+e.w*(n/100)-32,e.y*(n/100)+e.h*(n/100)-32),t.restore()})}o.addEventListener("mousedown",function(e){if(a)return;const r=o.getBoundingClientRect(),s=(e.clientX-r.left)*(o.width/r.width)/(n/100),d=(e.clientY-r.top)*(o.height/r.height)/(n/100);for(let c=m.length-1;c>=0;c--){const i=m[c],g=i.x+i.w-24,p=i.y+4;if(s>g&&s<g+20&&d>p&&d<p+20){ce(),m.splice(c,1),l=null,oe(),f();return}}for(let c=x.length-1;c>=0;c--){const i=x[c],g=i.x+i.w-24,p=i.y+2;if(s>g&&s<g+22&&d>p&&d<p+22){i.locked=!i.locked,f();return}}l=null,O=null,v=null,j=!1,$=!1;for(let c=m.length-1;c>=0;c--){const i=m[c],g=[{name:"tl",x:i.x,y:i.y},{name:"tr",x:i.x+i.w,y:i.y},{name:"bl",x:i.x,y:i.y+i.h},{name:"br",x:i.x+i.w,y:i.y+i.h}];for(const p of g)if(s>p.x-8&&s<p.x+8&&d>p.y-8&&d<p.y+8){l=i,$=!0,v=i,O=p.name,G={x:s-i.x,y:d-i.y},f(),J();return}if(s>i.x&&s<i.x+i.w&&d>i.y&&d<i.y+i.h){ce(),l=i,j=!0,O="move",v=i,G={x:s-i.x,y:d-i.y},f(),J();return}}A=null,_=!1,K=!1,b=null;for(let c=x.length-1;c>=0;c--){const i=x[c];if(!i.locked){if(s>i.x+i.w-8&&s<i.x+i.w&&d>i.y+i.h-8&&d<i.y+i.h){A=i,K=!0,b=i,V={x:s-i.x,y:d-i.y};return}if(s>i.x&&s<i.x+i.w&&d>i.y&&d<i.y+i.h){A=i,_=!0,b=i,V={x:s-i.x,y:d-i.y};return}}}f(),l||oe()}),o.addEventListener("mousemove",function(e){const r=o.getBoundingClientRect(),s=(e.clientX-r.left)*(o.width/r.width)/(n/100),d=(e.clientY-r.top)*(o.height/r.height)/(n/100);if(j&&O==="move"&&v&&(v.x=s-G.x,v.y=d-G.y,f(),l&&fe(l)),$&&v){let c=v.x,i=v.y,g=v.w,p=v.h;O==="tl"?(g+=c-s,p+=i-d,c=s,i=d):O==="tr"?(g=s-v.x,p+=i-d,i=d):O==="bl"?(g+=c-s,c=s,p=d-v.y):O==="br"&&(g=s-v.x,p=d-v.y),v.x=c,v.y=i,v.w=Math.max(40,g),v.h=Math.max(28,p),f(),l&&fe(l)}_&&b&&(b.x=s-V.x,b.y=d-V.y,f()),K&&b&&(b.w=Math.max(40,s-b.x),b.h=Math.max(30,d-b.y),f())}),document.addEventListener("mouseup",function(){j=!1,$=!1,O=null,v=null,_=!1,K=!1,b=null}),o.addEventListener("dblclick",function(e){if(a)return;const r=o.getBoundingClientRect(),s=(e.clientX-r.left)*(o.width/r.width)/(n/100),d=(e.clientY-r.top)*(o.height/r.height)/(n/100);for(let c=m.length-1;c>=0;c--){const i=m[c];if(s>i.x&&s<i.x+i.w&&d>i.y&&d<i.y+i.h){l=i,z=i,Ce(i),J();return}}});let Z=[],Q=[];function ce(){Z.push({textBoxes:JSON.parse(JSON.stringify(m)),mediaBoxes:JSON.parse(JSON.stringify(x))}),Q=[]}function ge(e){e&&(m=JSON.parse(JSON.stringify(e.textBoxes)),x=JSON.parse(JSON.stringify(e.mediaBoxes)),f(),oe())}(Se=document.getElementById("undoBtn"))==null||Se.addEventListener("click",function(){if(Z.length>0){Q.push({textBoxes:JSON.parse(JSON.stringify(m)),mediaBoxes:JSON.parse(JSON.stringify(x))});const e=Z.pop();ge(e)}}),(ke=document.getElementById("redoBtn"))==null||ke.addEventListener("click",function(){if(Q.length>0){Z.push({textBoxes:JSON.parse(JSON.stringify(m)),mediaBoxes:JSON.parse(JSON.stringify(x))});const e=Q.pop();ge(e)}});function Ce(e){if(a)return;a=document.createElement("textarea"),a.value=e.text,a.style.position="absolute",a.style.left=o.offsetLeft+e.x*(n/100)+"px",a.style.top=o.offsetTop+e.y*(n/100)+"px",a.style.width=e.w*(n/100)+"px",a.style.height=e.h*(n/100)+"px",a.style.fontSize=e.fontSize*(n/100)+"px",a.style.fontFamily=e.fontFamily,a.style.color=e.color,a.style.zIndex=10,a.style.background="rgba(255,255,255,0.95)",a.style.border="1px solid #2563eb",a.style.resize="none",a.style.overflow="hidden",a.style.padding="2px 4px",a.style.boxSizing="border-box",a.style.outline="none",a.style.borderRadius="6px",a.style.boxShadow="0 2px 8px rgba(0,0,0,0.08)",a.rows=1;const r=o.parentNode;r.appendChild(a),a.focus(),a.addEventListener("blur",function(){e.text=a.value,r.removeChild(a),a=null,z=null,f()})}function Me(){!a||!z||(a.style.left=o.offsetLeft+z.x*(n/100)+"px",a.style.top=o.offsetTop+z.y*(n/100)+"px",a.style.width=z.w*(n/100)+"px",a.style.height=z.h*(n/100)+"px",a.style.fontSize=z.fontSize*(n/100)+"px")}const F=document.querySelector(".small-floating-toolbar"),ee=document.getElementById("fontSizeToolbar"),te=document.getElementById("boldToolbar"),ne=document.getElementById("italicToolbar"),ie=document.getElementById("underlineToolbar"),pe=document.getElementById("alignLeftToolbar"),he=document.getElementById("alignCenterToolbar"),xe=document.getElementById("alignJustifyToolbar"),ve=document.getElementById("uppercaseToolbar"),we=document.getElementById("colorPickerInput");function oe(){F&&(F.style.display="none");const e=document.getElementById("colorPickerDropdown");e&&(e.style.display="none")}function fe(e){if(!F||!e)return;const r=n/100,s=o.offsetLeft+e.x*r+e.w*r/2,d=o.offsetTop+e.y*r-46;F.style.transform="",F.style.left=s-20+"px",F.style.top=Math.max(6,d)+"px",F.style.display="flex"}function J(){if(F){if(!l){oe();return}ee&&(ee.value=l.fontSize||20),te&&te.classList.toggle("active",parseInt(l.fontWeight||"400")>=700),ne&&ne.classList.toggle("active",l.fontStyle==="italic"),ie&&ie.classList.toggle("active",l.textDecoration&&l.textDecoration.includes("underline")),fe(l)}}ee&&ee.addEventListener("input",function(){l&&(l.fontSize=parseInt(this.value,10)||12,f(),a&&(a.style.fontSize=l.fontSize*(n/100)+"px"))}),te&&te.addEventListener("click",function(){l&&(l.fontWeight=parseInt(l.fontWeight||"400")>=700?"400":"700",f())}),ne&&ne.addEventListener("click",function(){l&&(l.fontStyle=l.fontStyle==="italic"?"normal":"italic",f())}),ie&&ie.addEventListener("click",function(){l&&(l.textDecoration=l.textDecoration&&l.textDecoration.includes("underline")?"":"underline",f())}),pe&&pe.addEventListener("click",function(){l&&(l.textAlign="left",f())}),he&&he.addEventListener("click",function(){l&&(l.textAlign="center",f())}),xe&&xe.addEventListener("click",function(){l&&(l.textAlign="justify",f())}),ve&&ve.addEventListener("click",function(){l&&(l.textTransform=l.textTransform==="uppercase"?"none":"uppercase",f())}),we&&we.addEventListener("input",function(){l&&(l.color=this.value,f(),a&&(a.style.color=this.value))});const Ee=document.getElementById("symbolToolbar");Ee&&Ee.addEventListener("click",function(){if(!l)return;const e="‚òÖ";typeof l.text!="string"&&(l.text=""),l.text=l.text+e,a&&z===l&&(a.value=l.text),J(),f()});function U(e="New Text",r=20,s="normal"){ce(),m.push({text:e,x:60,y:60,w:180,h:40,fontSize:r,fontWeight:s,fontFamily:W[0],color:"#222"}),l=m[m.length-1],f(),J()}const ue=document.querySelectorAll(".editor-sidebar li"),D=document.getElementById("floatingPanel"),Ae={Text:`
            <h3>Text Tools</h3>
            <input type="search" id="fontSearch" placeholder="Search fonts...">
            <div class="font-list" id="fontList"></div>
            <label style="display:block;margin:8px 0 4px 0;font-size:13px;">Font Size</label>
            <input type="number" id="fontSizeInput" min="8" max="120" value="20" style="width:70px;margin-bottom:10px;">
            <label style="display:block;margin:8px 0 4px 0;font-size:13px;">Text Color</label>
            <input type="color" id="textColorPicker" value="#222" style="margin-bottom:10px;">
            <div id="colorPalette" style="display:flex;flex-wrap:wrap;margin-bottom:10px;"></div>
            <button class="btn full" id="addTextBox">+ Add Text Box</button>
            <div style="margin-top:10px;">
                <button class="btn full" id="addHeading">Add Heading</button>
                <button class="btn full" id="addSubHeading">Add Sub Heading</button>
                <button class="btn full" id="addBodyText">Add Body Text</button>
            </div>
        `,Images:`
            <h3>Image/Video Tools</h3>
            <input type="search" id="imageSearch" placeholder="Search images...">
            <button class="btn full" id="searchImageBtn">Search Image</button>
            <input type="file" accept="image/*,video/*" id="uploadMedia">
            <button class="btn full" id="uploadMediaBtn">Upload Image/Video</button>
            <div class="font-list" id="mediaList"></div>
            <div id="imageResults" style="margin-top:10px;"></div>
        `,Graphics:`
            <h3>Graphics Tools</h3>
            <input type="search" id="graphicSearch" placeholder="Search graphics...">
            <p><strong>Shapes</strong></p>
            <div class="shape-grid">
                <button title="Circle">‚ö™</button>
                <button title="Square">‚¨õ</button>
                <button title="Triangle">üî∫</button>
                <button title="Line">‚ûñ</button>
            </div>
            <p><strong>Icons</strong></p>
            <div class="icon-grid">
                <button>‚≠ê</button>
                <button>‚ù§Ô∏è</button>
                <button>üíç</button>
                <button>üç∑</button>
                <button>üéÇ</button>
                <button>üé∂</button>
                <button>üå∏</button>
                <button>üåô</button>
                <button>üî•</button>
                <button>üíí</button>
            </div>
        `};ue.forEach(e=>{e.addEventListener("click",()=>{ue.forEach(c=>c.classList.remove("active")),e.classList.add("active");const r=Ae[e.textContent.trim()];if(r){if(D.innerHTML=r,D.style.display="block",e.textContent.trim()==="Text"){let H=function(w=""){c.innerHTML="",W.filter(E=>E.toLowerCase().includes(w.toLowerCase())).forEach(E=>{const y=document.createElement("div");y.textContent=E,y.style.fontFamily=E,y.style.cursor="pointer",y.style.padding="2px 6px",y.style.borderRadius="4px",y.onmouseover=()=>y.style.background="#e0e7ff",y.onmouseout=()=>y.style.background="",y.addEventListener("click",()=>{l&&(l.fontFamily=E,f(),a&&(a.style.fontFamily=E))}),c.appendChild(y)})};var s=H;const c=document.getElementById("fontList"),i=document.getElementById("fontSearch"),g=document.getElementById("addTextBox"),p=document.getElementById("addHeading"),X=document.getElementById("addSubHeading"),ae=document.getElementById("addBodyText"),se=document.getElementById("textColorPicker"),L=document.getElementById("fontSizeInput");async function me(){const w=localStorage.getItem("googleFontsList");if(w)return JSON.parse(w);try{const T=(await(await fetch("https://www.googleapis.com/webfonts/v1/webfonts?key=AIzaSyCSdMyA37wm0nt9gJIZSjTrxEHgXwxBMeM")).json()).items.map(k=>k.family);return localStorage.setItem("googleFontsList",JSON.stringify(T)),T}catch(E){return console.error("Failed to fetch fonts:",E),["Nunito","Roboto","Montserrat","Poppins","Oswald","Playfair Display","Great Vibes","Lobster","Dancing Script","Merriweather"]}}(async()=>(W=await me(),H()))(),H(),i.addEventListener("input",w=>H(w.target.value)),setTimeout(()=>i.focus(),100),se&&se.addEventListener("input",w=>{l&&(l.color=w.target.value,f(),a&&(a.style.color=w.target.value))}),L&&L.addEventListener("input",w=>{l&&(l.fontSize=parseInt(w.target.value,10)||20,f(),a&&(a.style.fontSize=l.fontSize*(n/100)+"px"))}),g&&g.addEventListener("click",()=>U("New Text",20,"bold")),p&&p.addEventListener("click",()=>U("Heading Text",32,"bold")),X&&X.addEventListener("click",()=>U("Sub Heading",24,"600")),ae&&ae.addEventListener("click",()=>U("A little bit of body text...",16,"normal"))}if(e.textContent.trim()==="Images"){let X=function(){g.innerHTML="",p.forEach((w,E)=>{const y=document.createElement("img");y.src=w.url,y.alt="Uploaded image preview",y.style.width="48px",y.style.height="48px",y.style.objectFit="cover",y.style.margin="6px",y.style.cursor="pointer",y.title="Insert again",y.setAttribute("tabindex","0"),y.setAttribute("aria-label","Insert image"),y.onclick=()=>{x.push({type:"image",img:w.img,x:120+Math.random()*60,y:120+Math.random()*60,w:200,h:150,locked:!1}),f()},g.appendChild(y)})};var d=X;const c=document.getElementById("uploadMedia"),i=document.getElementById("uploadMediaBtn"),g=document.getElementById("mediaList");let p=[];i.addEventListener("click",()=>c.click()),c.addEventListener("change",function(w){const E=w.target.files[0];if(!E)return;const y=URL.createObjectURL(E);if(E.type.startsWith("image/")){const T=new window.Image;T.onload=function(){x.push({type:"image",img:T,x:100,y:100,w:200,h:150,locked:!1}),p.push({img:T,url:y}),f(),X()},T.src=y}});const ae=document.getElementById("imageSearch"),se=document.getElementById("searchImageBtn"),L=document.getElementById("imageResults");L.style.maxHeight="260px",L.style.overflowY="auto";const me="AIzaSyBRCDdZjTcR4brOsHV_OBsDO11We11BVi0",H="c5ae3ced1c423443c";se.addEventListener("click",async()=>{const w=ae.value.trim();if(w){L.innerHTML="Searching...";try{const y=await(await fetch(`https://www.googleapis.com/customsearch/v1?key=${me}&cx=${H}&searchType=image&q=${encodeURIComponent(w)}&num=8`)).json();L.innerHTML="",y.items&&y.items.length?y.items.forEach(T=>{const k=document.createElement("img");k.src=T.link,k.style.width="60px",k.style.height="60px",k.style.objectFit="cover",k.style.margin="4px",k.style.cursor="pointer",k.title="Insert image",k.onclick=()=>{const re=new window.Image;re.crossOrigin="anonymous",re.onload=function(){x.push({type:"image",img:re,x:120+Math.random()*60,y:120+Math.random()*60,w:200,h:150,locked:!1}),f()},re.src=T.link},L.appendChild(k)}):L.innerHTML="No images found."}catch{L.innerHTML="Error loading images."}}})}e.textContent.trim()}else D.style.display="none"})}),(Le=ue[0])==null||Le.click();const Be=document.getElementById("insertQuickText");Be&&Be.addEventListener("click",function(){const e=document.getElementById("quickTextInput"),r=document.getElementById("quickFontSelect"),s=document.getElementById("quickTextColor"),d=e?e.value.trim():"",c=r?r.value:W[0]||"Arial",i=s?s.value:"#222";if(!d)return;U(d,20,"normal");const g=m[m.length-1];g&&(g.fontFamily=c,g.color=i),f()});function le(e){e._highlight=!0,f(),setTimeout(()=>{e._highlight=!1,f()},400)}document.getElementById("bringForwardBtn").onclick=()=>{if(l){const e=m.indexOf(l);e<m.length-1&&([m[e],m[e+1]]=[m[e+1],m[e]],le(l))}if(A){const e=x.indexOf(A);e<x.length-1&&([x[e],x[e+1]]=[x[e+1],x[e]],le(A))}f()},document.getElementById("sendBackwardBtn").onclick=()=>{if(l){const e=m.indexOf(l);e>0&&([m[e],m[e-1]]=[m[e-1],m[e]],le(l))}if(A){const e=x.indexOf(A);e>0&&([x[e],x[e-1]]=[x[e-1],x[e]],le(A))}f()},m.forEach(e=>{t.save(),e._highlight&&(t.shadowColor="#8c52ff",t.shadowBlur=16),t.restore()}),x.forEach(e=>{t.save(),e._highlight&&(t.shadowColor="#8c52ff",t.shadowBlur=16),t.restore()}),document.getElementById("exportBtn").addEventListener("click",()=>{const e=o.toDataURL("image/png"),r=document.createElement("a");r.href=e,r.download="template.png",r.click()}),document.getElementById("exportPdfBtn").addEventListener("click",()=>{const e=new jsPDF({orientation:"portrait",unit:"px",format:[o.width,o.height]});e.addImage(o.toDataURL("image/png"),"PNG",0,0,o.width,o.height),e.save("template.pdf")});const S=document.createElement("div");S.style.position="absolute",S.style.right="10px",S.style.top="10px",S.style.background="#fff",S.style.padding="2px 8px",S.style.borderRadius="4px",S.style.fontSize="12px",S.style.boxShadow="0 1px 3px rgba(0,0,0,.08)",S.style.zIndex=100,o.parentNode.appendChild(S),o.addEventListener("mousemove",function(e){const r=o.getBoundingClientRect(),s=Math.round((e.clientX-r.left)*(o.width/r.width)),d=Math.round((e.clientY-r.top)*(o.height/r.height));S.textContent=`X: ${s}, Y: ${d}`}),o.addEventListener("mouseleave",function(){S.textContent=""});let ye=!1,Ie=0,be=0;D.addEventListener("mousedown",function(e){e.target===D&&(ye=!0,Ie=e.offsetX,be=e.offsetY)}),document.addEventListener("mousemove",function(e){ye&&(D.style.left=e.clientX-Ie+"px",D.style.top=e.clientY-be+"px")}),document.addEventListener("mouseup",function(){ye=!1}),document.addEventListener("keydown",function(e){var r,s;(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="z"&&(e.preventDefault(),(r=document.getElementById("undoBtn"))==null||r.click()),(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="y"&&(e.preventDefault(),(s=document.getElementById("redoBtn"))==null||s.click())})});console.log(window.TEMPLATE_ID,window.CSRF_TOKEN);window.addImageToCanvas=function(u){const B=100+Math.random()*80,h=100+Math.random()*80,o=Math.min(u.width,200),t=Math.min(u.height,150);mediaBoxes.push({type:"image",img:u,x:B,y:h,w:o,h:t,locked:!1}),draw()};const M=document.getElementById("imageDropZone"),Oe=document.getElementById("sidebarImageInput"),C=document.getElementById("sidebarImageThumbs"),P=document.getElementById("imageUploadSpinner"),I=document.getElementById("imageUploadError");let q=[];function ze(u){I.style.display="none",P.style.display="block";let B=0,h=0;Array.from(u).forEach(o=>{if(!o.type.startsWith("image/")){I.textContent="Only image files are allowed.",I.style.display="block",P.style.display="none";return}if(o.size>5*1024*1024){I.textContent="File too large (max 5MB).",I.style.display="block",P.style.display="none";return}h++;const t=URL.createObjectURL(o),n=new window.Image;n.onload=function(){if(q.push({img:n,url:t}),de(),B++,B===h){P.style.display="none";const N=C.querySelectorAll("img");N.length&&N[N.length-h].focus()}},n.onerror=function(){I.textContent="Failed to load image.",I.style.display="block",P.style.display="none"},n.src=t}),h===0&&(P.style.display="none")}C.addEventListener("keydown",function(u){if((u.key==="Delete"||u.key==="Backspace")&&document.activeElement.tagName==="IMG"){const h=Array.from(C.querySelectorAll("img")).indexOf(document.activeElement);if(h!==-1){q.splice(h,1),de();const o=Array.from(C.querySelectorAll("img"));o[h]?o[h].focus():o[h-1]&&o[h-1].focus()}}});M.setAttribute("role","button");M.setAttribute("aria-label","Upload images by drag and drop or click");C.setAttribute("role","list");function de(){C.innerHTML="",q.forEach((u,B)=>{const h=document.createElement("div");h.style.position="relative",h.style.display="inline-block",h.setAttribute("role","listitem");const o=document.createElement("img");o.src=u.url,o.alt="Uploaded image preview",o.style.width="48px",o.style.height="48px",o.style.objectFit="cover",o.style.borderRadius="6px",o.style.cursor="pointer",o.title="Insert image to canvas",o.setAttribute("tabindex","0"),o.setAttribute("aria-label","Insert image to canvas"),o.onclick=()=>{window.addImageToCanvas&&window.addImageToCanvas(u.img)},o.onkeydown=function(n){(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),window.addImageToCanvas&&window.addImageToCanvas(u.img))},o.addEventListener("focus",function(){o.style.outline="2px solid #2563eb",o.style.boxShadow="0 0 0 3px #e0e7ff"}),o.addEventListener("blur",function(){o.style.outline="",o.style.boxShadow=""});const t=document.createElement("span");t.textContent="‚úï",t.style.position="absolute",t.style.right="2px",t.style.top="2px",t.style.background="#fff",t.style.color="#e11d48",t.style.borderRadius="50%",t.style.cursor="pointer",t.style.fontSize="14px",t.style.padding="2px 5px",t.title="Remove image",t.setAttribute("aria-label","Remove image"),t.onclick=n=>{n.stopPropagation(),q.splice(B,1),de()},h.appendChild(o),h.appendChild(t),C.appendChild(h)})}const Y=document.createElement("button");Y.textContent="Clear All Images";Y.className="btn full";Y.style.margin="10px 0";Y.onclick=function(){q=[],de()};C.parentNode&&C.parentNode.insertBefore(Y,C);M.addEventListener("dragover",u=>{u.preventDefault(),M.classList.add("dragover")});M.addEventListener("dragleave",u=>{M.classList.remove("dragover")});M.addEventListener("drop",u=>{u.preventDefault(),M.classList.remove("dragover"),ze(u.dataTransfer.files)});M.addEventListener("keydown",function(u){(u.key==="Enter"||u.key===" ")&&(u.preventDefault(),Oe.click())});M.setAttribute("tabindex","0");const R=document.getElementById("templateCanvas");R&&(R.addEventListener("dragover",u=>{u.preventDefault(),R.style.border="2px dashed #2563eb"}),R.addEventListener("dragleave",u=>{R.style.border=""}),R.addEventListener("drop",u=>{u.preventDefault(),R.style.border="",Array.from(u.dataTransfer.files).forEach(B=>{if(!B.type.startsWith("image/")){I.textContent="Only image files are allowed.",I.style.display="block";return}if(B.size>5*1024*1024){I.textContent="File too large (max 5MB).",I.style.display="block";return}const h=URL.createObjectURL(B),o=new window.Image;o.onload=function(){window.addImageToCanvas&&window.addImageToCanvas(o)},o.onerror=function(){I.textContent="Failed to load image.",I.style.display="block"},o.src=h})}));
