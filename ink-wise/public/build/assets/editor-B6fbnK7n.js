document.addEventListener("DOMContentLoaded",()=>{var Te,Ae,Ce,Me,Oe,De;const m=document.getElementById("zoomOutBtn"),v=document.getElementById("zoomInBtn"),c=document.querySelector(".zoom-controls span"),i=document.getElementById("templateCanvas"),t=i.getContext("2d");let n=100;function w(){i.style.transform=`scale(${n/100})`,c.textContent=`${n}%`,Re(),y()}m==null||m.addEventListener("click",()=>{n>10&&(n-=10,w())}),v==null||v.addEventListener("click",()=>{n<300&&(n+=10,w())});let B=[],s=[],g=[],l=null,b=null,N=!1,P=!1,Z={x:0,y:0},E=null,z=null,Q=!1,ee=!1,te={x:0,y:0},T=null,d=null,F=null,H=null,J=null;function ze(e){s=[],g=[],e.pages&&Array.isArray(e.pages)&&e.pages.forEach(r=>{r.nodes&&Array.isArray(r.nodes)&&r.nodes.forEach(a=>{var u,f,o,h,x,q,X,W;if(a.type==="text")s.push({x:((u=a.frame)==null?void 0:u.x)||0,y:((f=a.frame)==null?void 0:f.y)||0,w:((o=a.frame)==null?void 0:o.width)||100,h:((h=a.frame)==null?void 0:h.height)||50,text:a.content||"",fontSize:a.fontSize||24,color:a.fill||"#000000",fontFamily:a.fontFamily||"Arial, sans-serif",textAlign:a.textAlign||"left",fontStyle:a.fontStyle||"normal",fontWeight:a.fontWeight||"400",textTransform:a.textTransform||"none",textDecoration:a.textDecoration||""});else if(a.type==="image"){const L=new Image;L.onload=function(){y()},L.src=a.src||"",g.push({type:"image",img:L,x:((x=a.frame)==null?void 0:x.x)||0,y:((q=a.frame)==null?void 0:q.y)||0,w:((X=a.frame)==null?void 0:X.width)||100,h:((W=a.frame)==null?void 0:W.height)||100,locked:!1})}else a.type})}),y()}function y(){t.clearRect(0,0,i.width,i.height),H&&H.complete&&H.naturalWidth>0&&t.drawImage(H,0,0,i.width,i.height),J&&J.complete&&J.naturalWidth>0&&t.drawImage(J,0,0,i.width,i.height),Fe(),s.forEach(e=>{t.save(),t.strokeStyle=l===e?"#2563eb":"#aaa",t.lineWidth=l===e?2:1,t.strokeRect(e.x*(n/100),e.y*(n/100),e.w*(n/100),e.h*(n/100));const r=e.fontStyle&&e.fontStyle!=="normal"?e.fontStyle+" ":"",a=e.fontWeight||"400";t.font=`${r}${a} ${e.fontSize*(n/100)}px ${e.fontFamily}`,t.fillStyle=e.color,t.textBaseline="top",t.textAlign=e.textAlign||"left",t.save(),t.beginPath(),t.rect(e.x*(n/100)+8,e.y*(n/100)+8,(e.w-16)*(n/100),(e.h-16)*(n/100)),t.clip();const u=e.textTransform==="uppercase"?(e.text||"").toUpperCase():e.text||"";if(t.fillText(u,e.x*(n/100)+8,e.y*(n/100)+8,(e.w-16)*(n/100)),e.textDecoration&&e.textDecoration.includes("underline")){t.measureText(u);const o=e.y*(n/100)+8+e.fontSize*(n/100);t.beginPath(),t.strokeStyle=e.color||"#000",t.lineWidth=Math.max(1,e.fontSize*(n/100)/12);let h=e.x*(n/100)+8,x=e.x*(n/100)+(e.w-16)*(n/100);t.moveTo(h,o),t.lineTo(x,o),t.stroke()}t.restore(),t.fillStyle="#2563eb",t.fillRect(e.x*(n/100)+e.w*(n/100)-8,e.y*(n/100)+e.h*(n/100)-8,8,8),t.font="bold 18px Arial",t.fillStyle="#e11d48",t.textAlign="right",t.textBaseline="top",t.fillText("‚úï",e.x*(n/100)+e.w*(n/100)-12,e.y*(n/100)+4);const f=[[e.x,e.y],[e.x+e.w,e.y],[e.x,e.y+e.h],[e.x+e.w,e.y+e.h]];t.fillStyle="#2563eb",f.forEach(([o,h])=>{t.fillRect(o*(n/100)-4,h*(n/100)-4,8,8)}),t.restore()})}function Fe(){g.forEach(e=>{t.save(),e.type==="image"&&e.img&&t.drawImage(e.img,e.x*(n/100),e.y*(n/100),e.w*(n/100),e.h*(n/100)),e.type==="video"&&(t.strokeStyle="#aaa",t.strokeRect(e.x*(n/100),e.y*(n/100),e.w*(n/100),e.h*(n/100)),t.font="bold 16px Arial",t.fillStyle="#888",t.fillText("Video",e.x*(n/100)+10,e.y*(n/100)+24)),t.fillStyle="#2563eb",t.beginPath(),t.arc(e.x*(n/100)+e.w*(n/100)-12,e.y*(n/100)+e.h*(n/100)-12,12,0,2*Math.PI),t.fill(),t.font="20px Arial",t.fillStyle="#fff",t.textAlign="center",t.textBaseline="middle",t.fillText("‚§¢",e.x*(n/100)+e.w*(n/100)-12,e.y*(n/100)+e.h*(n/100)-12),t.font="28px Arial",t.textAlign="right",t.textBaseline="top",t.fillStyle="#2563eb",e.locked?t.fillText("üîí",(e.x+e.w)*(n/100)-10,e.y*(n/100)+2):t.fillText("üîì",(e.x+e.w)*(n/100)-10,e.y*(n/100)+2),t.font="28px Arial",t.fillStyle="#e11d48",t.textAlign="left",t.textBaseline="top",t.fillText("‚®Ø",e.x*(n/100)+4,e.y*(n/100)+4),t.font="22px Arial",t.fillStyle="#2563eb",t.textAlign="center",t.textBaseline="middle",t.fillText("‚á≤",e.x*(n/100)+e.w*(n/100)-32,e.y*(n/100)+e.h*(n/100)-32),t.restore()})}i.addEventListener("mousedown",function(e){if(d)return;const r=i.getBoundingClientRect(),a=(e.clientX-r.left)*(i.width/r.width)/(n/100),u=(e.clientY-r.top)*(i.height/r.height)/(n/100);for(let f=s.length-1;f>=0;f--){const o=s[f],h=o.x+o.w-24,x=o.y+4;if(a>h&&a<h+20&&u>x&&u<x+20){fe(),s.splice(f,1),l=null,re(),y();return}}for(let f=g.length-1;f>=0;f--){const o=g[f],h=o.x+o.w-24,x=o.y+2;if(a>h&&a<h+22&&u>x&&u<x+22){o.locked=!o.locked,y();return}}l=null,z=null,E=null,N=!1,P=!1;for(let f=s.length-1;f>=0;f--){const o=s[f],h=[{name:"tl",x:o.x,y:o.y},{name:"tr",x:o.x+o.w,y:o.y},{name:"bl",x:o.x,y:o.y+o.h},{name:"br",x:o.x+o.w,y:o.y+o.h}];for(const x of h)if(a>x.x-8&&a<x.x+8&&u>x.y-8&&u<x.y+8){l=o,P=!0,E=o,z=x.name,Z={x:a-o.x,y:u-o.y},y(),$();return}if(a>o.x&&a<o.x+o.w&&u>o.y&&u<o.y+o.h){fe(),l=o,N=!0,z="move",E=o,Z={x:a-o.x,y:u-o.y},y(),$();return}}b=null,Q=!1,ee=!1,T=null;for(let f=g.length-1;f>=0;f--){const o=g[f];if(!o.locked){if(a>o.x+o.w-8&&a<o.x+o.w&&u>o.y+o.h-8&&u<o.y+o.h){b=o,ee=!0,T=o,te={x:a-o.x,y:u-o.y};return}if(a>o.x&&a<o.x+o.w&&u>o.y&&u<o.y+o.h){b=o,Q=!0,T=o,te={x:a-o.x,y:u-o.y};return}}}y(),l||re()}),i.addEventListener("mousemove",function(e){const r=i.getBoundingClientRect(),a=(e.clientX-r.left)*(i.width/r.width)/(n/100),u=(e.clientY-r.top)*(i.height/r.height)/(n/100);if(N&&z==="move"&&E&&(E.x=a-Z.x,E.y=u-Z.y,y(),l&&me(l)),P&&E){let f=E.x,o=E.y,h=E.w,x=E.h;z==="tl"?(h+=f-a,x+=o-u,f=a,o=u):z==="tr"?(h=a-E.x,x+=o-u,o=u):z==="bl"?(h+=f-a,f=a,x=u-E.y):z==="br"&&(h=a-E.x,x=u-E.y),E.x=f,E.y=o,E.w=Math.max(40,h),E.h=Math.max(28,x),y(),l&&me(l)}Q&&T&&(T.x=a-te.x,T.y=u-te.y,y()),ee&&T&&(T.w=Math.max(40,a-T.x),T.h=Math.max(30,u-T.y),y())}),document.addEventListener("mouseup",function(){N=!1,P=!1,z=null,E=null,Q=!1,ee=!1,T=null}),i.addEventListener("dblclick",function(e){if(d)return;const r=i.getBoundingClientRect(),a=(e.clientX-r.left)*(i.width/r.width)/(n/100),u=(e.clientY-r.top)*(i.height/r.height)/(n/100);for(let f=s.length-1;f>=0;f--){const o=s[f];if(a>o.x&&a<o.x+o.w&&u>o.y&&u<o.y+o.h){l=o,F=o,Ne(o),$();return}}});let ne=[],oe=[];function fe(){ne.push({textBoxes:JSON.parse(JSON.stringify(s)),mediaBoxes:JSON.parse(JSON.stringify(g))}),oe=[]}function he(e){e&&(s=JSON.parse(JSON.stringify(e.textBoxes)),g=JSON.parse(JSON.stringify(e.mediaBoxes)),y(),re())}(Te=document.getElementById("undoBtn"))==null||Te.addEventListener("click",function(){if(ne.length>0){oe.push({textBoxes:JSON.parse(JSON.stringify(s)),mediaBoxes:JSON.parse(JSON.stringify(g))});const e=ne.pop();he(e)}}),(Ae=document.getElementById("redoBtn"))==null||Ae.addEventListener("click",function(){if(oe.length>0){ne.push({textBoxes:JSON.parse(JSON.stringify(s)),mediaBoxes:JSON.parse(JSON.stringify(g))});const e=oe.pop();he(e)}});function Ne(e){if(d)return;d=document.createElement("textarea"),d.value=e.text,d.style.position="absolute",d.style.left=i.offsetLeft+e.x*(n/100)+"px",d.style.top=i.offsetTop+e.y*(n/100)+"px",d.style.width=e.w*(n/100)+"px",d.style.height=e.h*(n/100)+"px",d.style.fontSize=e.fontSize*(n/100)+"px",d.style.fontFamily=e.fontFamily,d.style.color=e.color,d.style.zIndex=10,d.style.background="rgba(255,255,255,0.95)",d.style.border="1px solid #2563eb",d.style.resize="none",d.style.overflow="hidden",d.style.padding="2px 4px",d.style.boxSizing="border-box",d.style.outline="none",d.style.borderRadius="6px",d.style.boxShadow="0 2px 8px rgba(0,0,0,0.08)",d.rows=1;const r=i.parentNode;r.appendChild(d),d.focus(),d.addEventListener("blur",function(){e.text=d.value,r.removeChild(d),d=null,F=null,y()})}function Re(){!d||!F||(d.style.left=i.offsetLeft+F.x*(n/100)+"px",d.style.top=i.offsetTop+F.y*(n/100)+"px",d.style.width=F.w*(n/100)+"px",d.style.height=F.h*(n/100)+"px",d.style.fontSize=F.fontSize*(n/100)+"px")}const R=document.querySelector(".small-floating-toolbar"),ie=document.getElementById("fontSizeToolbar"),le=document.getElementById("boldToolbar"),ae=document.getElementById("italicToolbar"),se=document.getElementById("underlineToolbar"),xe=document.getElementById("alignLeftToolbar"),ve=document.getElementById("alignCenterToolbar"),we=document.getElementById("alignJustifyToolbar"),Ee=document.getElementById("uppercaseToolbar"),be=document.getElementById("colorPickerInput");function re(){R&&(R.style.display="none");const e=document.getElementById("colorPickerDropdown");e&&(e.style.display="none")}function me(e){if(!R||!e)return;const r=n/100,a=i.offsetLeft+e.x*r+e.w*r/2,u=i.offsetTop+e.y*r-46;R.style.transform="",R.style.left=a-20+"px",R.style.top=Math.max(6,u)+"px",R.style.display="flex"}function $(){if(R){if(!l){re();return}ie&&(ie.value=l.fontSize||20),le&&le.classList.toggle("active",parseInt(l.fontWeight||"400")>=700),ae&&ae.classList.toggle("active",l.fontStyle==="italic"),se&&se.classList.toggle("active",l.textDecoration&&l.textDecoration.includes("underline")),me(l)}}ie&&ie.addEventListener("input",function(){l&&(l.fontSize=parseInt(this.value,10)||12,y(),d&&(d.style.fontSize=l.fontSize*(n/100)+"px"))}),le&&le.addEventListener("click",function(){l&&(l.fontWeight=parseInt(l.fontWeight||"400")>=700?"400":"700",y())}),ae&&ae.addEventListener("click",function(){l&&(l.fontStyle=l.fontStyle==="italic"?"normal":"italic",y())}),se&&se.addEventListener("click",function(){l&&(l.textDecoration=l.textDecoration&&l.textDecoration.includes("underline")?"":"underline",y())}),xe&&xe.addEventListener("click",function(){l&&(l.textAlign="left",y())}),ve&&ve.addEventListener("click",function(){l&&(l.textAlign="center",y())}),we&&we.addEventListener("click",function(){l&&(l.textAlign="justify",y())}),Ee&&Ee.addEventListener("click",function(){l&&(l.textTransform=l.textTransform==="uppercase"?"none":"uppercase",y())}),be&&be.addEventListener("input",function(){l&&(l.color=this.value,y(),d&&(d.style.color=this.value))});const Se=document.getElementById("symbolToolbar");Se&&Se.addEventListener("click",function(){if(!l)return;const e="‚òÖ";typeof l.text!="string"&&(l.text=""),l.text=l.text+e,d&&F===l&&(d.value=l.text),$(),y()});function G(e="New Text",r=20,a="normal"){fe(),s.push({text:e,x:60,y:60,w:180,h:40,fontSize:r,fontWeight:a,fontFamily:B[0],color:"#222"}),l=s[s.length-1],y(),$()}const ye=document.querySelectorAll(".editor-sidebar li"),U=document.getElementById("floatingPanel"),qe={Text:`
            <h3>Text Tools</h3>
            <input type="search" id="fontSearch" placeholder="Search fonts...">
            <div class="font-list" id="fontList"></div>
            <label style="display:block;margin:8px 0 4px 0;font-size:13px;">Font Size</label>
            <input type="number" id="fontSizeInput" min="8" max="120" value="20" style="width:70px;margin-bottom:10px;">
            <label style="display:block;margin:8px 0 4px 0;font-size:13px;">Text Color</label>
            <input type="color" id="textColorPicker" value="#222" style="margin-bottom:10px;">
            <div id="colorPalette" style="display:flex;flex-wrap:wrap;margin-bottom:10px;"></div>
            <button class="btn full" id="addTextBox">+ Add Text Box</button>
            <div style="margin-top:10px;">
                <button class="btn full" id="addHeading">Add Heading</button>
                <button class="btn full" id="addSubHeading">Add Sub Heading</button>
                <button class="btn full" id="addBodyText">Add Body Text</button>
            </div>
        `,Images:`
            <h3>Image/Video Tools</h3>
            <input type="search" id="imageSearch" placeholder="Search images...">
            <button class="btn full" id="searchImageBtn">Search Image</button>
            <input type="file" accept="image/*,video/*" id="uploadMedia">
            <button class="btn full" id="uploadMediaBtn">Upload Image/Video</button>
            <div class="font-list" id="mediaList"></div>
            <div id="imageResults" style="margin-top:10px;"></div>
        `,Graphics:`
            <h3>Graphics Tools</h3>
            <input type="search" id="graphicSearch" placeholder="Search graphics...">
            <p><strong>Shapes</strong></p>
            <div class="shape-grid">
                <button title="Circle">‚ö™</button>
                <button title="Square">‚¨õ</button>
                <button title="Triangle">üî∫</button>
                <button title="Line">‚ûñ</button>
            </div>
            <p><strong>Icons</strong></p>
            <div class="icon-grid">
                <button>‚≠ê</button>
                <button>‚ù§Ô∏è</button>
                <button>üíç</button>
                <button>üç∑</button>
                <button>üéÇ</button>
                <button>üé∂</button>
                <button>üå∏</button>
                <button>üåô</button>
                <button>üî•</button>
                <button>üíí</button>
            </div>
        `};ye.forEach(e=>{e.addEventListener("click",()=>{ye.forEach(f=>f.classList.remove("active")),e.classList.add("active");const r=qe[e.textContent.trim()];if(r){if(U.innerHTML=r,U.style.display="block",e.textContent.trim()==="Text"){let Y=function(S=""){f.innerHTML="",B.filter(I=>I.toLowerCase().includes(S.toLowerCase())).forEach(I=>{const p=document.createElement("div");p.textContent=I,p.style.fontFamily=I,p.style.cursor="pointer",p.style.padding="2px 6px",p.style.borderRadius="4px",p.onmouseover=()=>p.style.background="#e0e7ff",p.onmouseout=()=>p.style.background="",p.addEventListener("click",()=>{l&&(l.fontFamily=I,y(),d&&(d.style.fontFamily=I))}),f.appendChild(p)})};var a=Y;const f=document.getElementById("fontList"),o=document.getElementById("fontSearch"),h=document.getElementById("addTextBox"),x=document.getElementById("addHeading"),q=document.getElementById("addSubHeading"),X=document.getElementById("addBodyText"),W=document.getElementById("textColorPicker"),L=document.getElementById("fontSizeInput");async function pe(){const S=localStorage.getItem("googleFontsList");if(S)return JSON.parse(S);try{const M=(await(await fetch("https://www.googleapis.com/webfonts/v1/webfonts?key=AIzaSyCSdMyA37wm0nt9gJIZSjTrxEHgXwxBMeM")).json()).items.map(C=>C.family);return localStorage.setItem("googleFontsList",JSON.stringify(M)),M}catch(I){return console.error("Failed to fetch fonts:",I),["Nunito","Roboto","Montserrat","Poppins","Oswald","Playfair Display","Great Vibes","Lobster","Dancing Script","Merriweather"]}}(async()=>(B=await pe(),Y()))(),Y(),o.addEventListener("input",S=>Y(S.target.value)),setTimeout(()=>o.focus(),100),W&&W.addEventListener("input",S=>{l&&(l.color=S.target.value,y(),d&&(d.style.color=S.target.value))}),L&&L.addEventListener("input",S=>{l&&(l.fontSize=parseInt(S.target.value,10)||20,y(),d&&(d.style.fontSize=l.fontSize*(n/100)+"px"))}),h&&h.addEventListener("click",()=>G("New Text",20,"bold")),x&&x.addEventListener("click",()=>G("Heading Text",32,"bold")),q&&q.addEventListener("click",()=>G("Sub Heading",24,"600")),X&&X.addEventListener("click",()=>G("A little bit of body text...",16,"normal"))}if(e.textContent.trim()==="Images"){let q=function(){h.innerHTML="",x.forEach((S,I)=>{const p=document.createElement("img");p.src=S.url,p.alt="Uploaded image preview",p.style.width="48px",p.style.height="48px",p.style.objectFit="cover",p.style.margin="6px",p.style.cursor="pointer",p.title="Insert again",p.setAttribute("tabindex","0"),p.setAttribute("aria-label","Insert image"),p.onclick=()=>{g.push({type:"image",img:S.img,x:120+Math.random()*60,y:120+Math.random()*60,w:200,h:150,locked:!1}),y()},h.appendChild(p)})};var u=q;const f=document.getElementById("uploadMedia"),o=document.getElementById("uploadMediaBtn"),h=document.getElementById("mediaList");let x=[];o.addEventListener("click",()=>f.click()),f.addEventListener("change",function(S){const I=S.target.files[0];if(!I)return;const p=URL.createObjectURL(I);if(I.type.startsWith("image/")){const M=new window.Image;M.onload=function(){g.push({type:"image",img:M,x:100,y:100,w:200,h:150,locked:!1}),x.push({img:M,url:p}),y(),q()},M.src=p}});const X=document.getElementById("imageSearch"),W=document.getElementById("searchImageBtn"),L=document.getElementById("imageResults");L.style.maxHeight="260px",L.style.overflowY="auto";const pe="AIzaSyBRCDdZjTcR4brOsHV_OBsDO11We11BVi0",Y="c5ae3ced1c423443c";W.addEventListener("click",async()=>{const S=X.value.trim();if(S){L.innerHTML="Searching...";try{const p=await(await fetch(`https://www.googleapis.com/customsearch/v1?key=${pe}&cx=${Y}&searchType=image&q=${encodeURIComponent(S)}&num=8`)).json();L.innerHTML="",p.items&&p.items.length?p.items.forEach(M=>{const C=document.createElement("img");C.src=M.link,C.style.width="60px",C.style.height="60px",C.style.objectFit="cover",C.style.margin="4px",C.style.cursor="pointer",C.title="Insert image",C.onclick=()=>{const ce=new window.Image;ce.crossOrigin="anonymous",ce.onload=function(){g.push({type:"image",img:ce,x:120+Math.random()*60,y:120+Math.random()*60,w:200,h:150,locked:!1}),y()},ce.src=M.link},L.appendChild(C)}):L.innerHTML="No images found."}catch{L.innerHTML="Error loading images."}}})}e.textContent.trim()}else U.style.display="none"})}),(Ce=ye[0])==null||Ce.click();const Ie=document.getElementById("insertQuickText");Ie&&Ie.addEventListener("click",function(){const e=document.getElementById("quickTextInput"),r=document.getElementById("quickFontSelect"),a=document.getElementById("quickTextColor"),u=e?e.value.trim():"",f=r?r.value:B[0]||"Arial",o=a?a.value:"#222";if(!u)return;G(u,20,"normal");const h=s[s.length-1];h&&(h.fontFamily=f,h.color=o),y()});function de(e){e._highlight=!0,y(),setTimeout(()=>{e._highlight=!1,y()},400)}document.getElementById("bringForwardBtn").onclick=()=>{if(l){const e=s.indexOf(l);e<s.length-1&&([s[e],s[e+1]]=[s[e+1],s[e]],de(l))}if(b){const e=g.indexOf(b);e<g.length-1&&([g[e],g[e+1]]=[g[e+1],g[e]],de(b))}y()},document.getElementById("sendBackwardBtn").onclick=()=>{if(l){const e=s.indexOf(l);e>0&&([s[e],s[e-1]]=[s[e-1],s[e]],de(l))}if(b){const e=g.indexOf(b);e>0&&([g[e],g[e-1]]=[g[e-1],g[e]],de(b))}y()},s.forEach(e=>{t.save(),e._highlight&&(t.shadowColor="#8c52ff",t.shadowBlur=16),t.restore()}),g.forEach(e=>{t.save(),e._highlight&&(t.shadowColor="#8c52ff",t.shadowBlur=16),t.restore()}),document.getElementById("exportBtn").addEventListener("click",()=>{const e=i.toDataURL("image/png"),r=document.createElement("a");r.href=e,r.download="template.png",r.click()}),document.getElementById("exportPdfBtn").addEventListener("click",()=>{const e=new jsPDF({orientation:"portrait",unit:"px",format:[i.width,i.height]});e.addImage(i.toDataURL("image/png"),"PNG",0,0,i.width,i.height),e.save("template.pdf")});const A=document.createElement("div");A.style.position="absolute",A.style.right="10px",A.style.top="10px",A.style.background="#fff",A.style.padding="2px 8px",A.style.borderRadius="4px",A.style.fontSize="12px",A.style.boxShadow="0 1px 3px rgba(0,0,0,.08)",A.style.zIndex=100,i.parentNode.appendChild(A),i.addEventListener("mousemove",function(e){const r=i.getBoundingClientRect(),a=Math.round((e.clientX-r.left)*(i.width/r.width)),u=Math.round((e.clientY-r.top)*(i.height/r.height));A.textContent=`X: ${a}, Y: ${u}`}),i.addEventListener("mouseleave",function(){A.textContent=""});let ge=!1,Le=0,ke=0;U.addEventListener("mousedown",function(e){e.target===U&&(ge=!0,Le=e.offsetX,ke=e.offsetY)}),document.addEventListener("mousemove",function(e){ge&&(U.style.left=e.clientX-Le+"px",U.style.top=e.clientY-ke+"px")}),document.addEventListener("mouseup",function(){ge=!1}),document.addEventListener("keydown",function(e){var r,a;(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="z"&&(e.preventDefault(),(r=document.getElementById("undoBtn"))==null||r.click()),(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="y"&&(e.preventDefault(),(a=document.getElementById("redoBtn"))==null||a.click())});const Be=document.getElementById("inkwise-builder-bootstrap");if(Be)try{const e=JSON.parse(Be.textContent),r=(Me=e.template)==null?void 0:Me.preview_front;r&&(H=new Image,H.onload=function(){y()},H.src=r);const a=(Oe=e.template)==null?void 0:Oe.svg_path;a&&(J=new Image,J.onload=function(){y()},J.src=a);const u=(De=e.template)==null?void 0:De.design;u&&u.pages&&ze(u)}catch(e){console.error("Failed to load bootstrap data:",e)}});console.log(window.TEMPLATE_ID,window.CSRF_TOKEN);window.addImageToCanvas=function(m){const v=100+Math.random()*80,c=100+Math.random()*80,i=Math.min(m.width,200),t=Math.min(m.height,150);mediaBoxes.push({type:"image",img:m,x:v,y:c,w:i,h:t,locked:!1}),draw()};const D=document.getElementById("imageDropZone"),Pe=document.getElementById("sidebarImageInput"),O=document.getElementById("sidebarImageThumbs"),_=document.getElementById("imageUploadSpinner"),k=document.getElementById("imageUploadError");let V=[];function He(m){k.style.display="none",_.style.display="block";let v=0,c=0;Array.from(m).forEach(i=>{if(!i.type.startsWith("image/")){k.textContent="Only image files are allowed.",k.style.display="block",_.style.display="none";return}if(i.size>5*1024*1024){k.textContent="File too large (max 5MB).",k.style.display="block",_.style.display="none";return}c++;const t=URL.createObjectURL(i),n=new window.Image;n.onload=function(){if(V.push({img:n,url:t}),ue(),v++,v===c){_.style.display="none";const w=O.querySelectorAll("img");w.length&&w[w.length-c].focus()}},n.onerror=function(){k.textContent="Failed to load image.",k.style.display="block",_.style.display="none"},n.src=t}),c===0&&(_.style.display="none")}O.addEventListener("keydown",function(m){if((m.key==="Delete"||m.key==="Backspace")&&document.activeElement.tagName==="IMG"){const c=Array.from(O.querySelectorAll("img")).indexOf(document.activeElement);if(c!==-1){V.splice(c,1),ue();const i=Array.from(O.querySelectorAll("img"));i[c]?i[c].focus():i[c-1]&&i[c-1].focus()}}});D.setAttribute("role","button");D.setAttribute("aria-label","Upload images by drag and drop or click");O.setAttribute("role","list");function ue(){O.innerHTML="",V.forEach((m,v)=>{const c=document.createElement("div");c.style.position="relative",c.style.display="inline-block",c.setAttribute("role","listitem");const i=document.createElement("img");i.src=m.url,i.alt="Uploaded image preview",i.style.width="48px",i.style.height="48px",i.style.objectFit="cover",i.style.borderRadius="6px",i.style.cursor="pointer",i.title="Insert image to canvas",i.setAttribute("tabindex","0"),i.setAttribute("aria-label","Insert image to canvas"),i.onclick=()=>{window.addImageToCanvas&&window.addImageToCanvas(m.img)},i.onkeydown=function(n){(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),window.addImageToCanvas&&window.addImageToCanvas(m.img))},i.addEventListener("focus",function(){i.style.outline="2px solid #2563eb",i.style.boxShadow="0 0 0 3px #e0e7ff"}),i.addEventListener("blur",function(){i.style.outline="",i.style.boxShadow=""});const t=document.createElement("span");t.textContent="‚úï",t.style.position="absolute",t.style.right="2px",t.style.top="2px",t.style.background="#fff",t.style.color="#e11d48",t.style.borderRadius="50%",t.style.cursor="pointer",t.style.fontSize="14px",t.style.padding="2px 5px",t.title="Remove image",t.setAttribute("aria-label","Remove image"),t.onclick=n=>{n.stopPropagation(),V.splice(v,1),ue()},c.appendChild(i),c.appendChild(t),O.appendChild(c)})}const K=document.createElement("button");K.textContent="Clear All Images";K.className="btn full";K.style.margin="10px 0";K.onclick=function(){V=[],ue()};O.parentNode&&O.parentNode.insertBefore(K,O);D.addEventListener("dragover",m=>{m.preventDefault(),D.classList.add("dragover")});D.addEventListener("dragleave",m=>{D.classList.remove("dragover")});D.addEventListener("drop",m=>{m.preventDefault(),D.classList.remove("dragover"),He(m.dataTransfer.files)});D.addEventListener("keydown",function(m){(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),Pe.click())});D.setAttribute("tabindex","0");const j=document.getElementById("templateCanvas");j&&(j.addEventListener("dragover",m=>{m.preventDefault(),j.style.border="2px dashed #2563eb"}),j.addEventListener("dragleave",m=>{j.style.border=""}),j.addEventListener("drop",m=>{m.preventDefault(),j.style.border="",Array.from(m.dataTransfer.files).forEach(v=>{if(!v.type.startsWith("image/")){k.textContent="Only image files are allowed.",k.style.display="block";return}if(v.size>5*1024*1024){k.textContent="File too large (max 5MB).",k.style.display="block";return}const c=URL.createObjectURL(v),i=new window.Image;i.onload=function(){window.addImageToCanvas&&window.addImageToCanvas(i)},i.onerror=function(){k.textContent="Failed to load image.",k.style.display="block"},i.src=c})}));document.addEventListener("DOMContentLoaded",function(){const m=document.querySelector(".create-form"),v=document.getElementById("design");m&&v&&m.addEventListener("submit",function(){v.value=JSON.stringify({text:"Please join us...",bride:"ELEANOR",groom:"VINCENT",date:"25 October 2025"})});const c=document.getElementById("previewModal"),i=document.getElementById("modalImg"),t=document.getElementById("closePreview");c&&i&&t&&(document.querySelectorAll(".preview-thumb").forEach(function(w){w.addEventListener("click",function(){i.src=w.dataset.img,c.classList.add("is-visible")})}),t.addEventListener("click",function(){c.classList.remove("is-visible"),i.src=""}),c.addEventListener("click",function(w){w.target===this&&(c.classList.remove("is-visible"),i.src="")})),document.querySelectorAll(".video-swatches").forEach(w=>{const B=w.closest(".w-full");if(!B)return;const s=B.querySelector(".template-video"),g=B.querySelector(".template-image"),l=s?s.querySelector("source"):null;w.querySelectorAll(".swatch-btn").forEach(b=>{b.addEventListener("click",()=>{if(!(s&&g&&l))return;const N=b.getAttribute("data-video"),P=b.getAttribute("data-image");N&&(g.classList.add("hidden"),s.classList.remove("hidden"),l.src!==N&&(l.src=N,s.load()),s.play()),P&&(g.src=P,g.classList.remove("hidden"),s.classList.add("hidden"))})})}),document.querySelectorAll(".btn-upload").forEach(w=>{w.addEventListener("click",function(B){B.preventDefault();let s=w.getAttribute("data-url");if(!s){const l=w.closest("form");s=l?l.getAttribute("action"):w.getAttribute("href")}if(!s){n("Upload URL not found",!0);return}w.classList.add("disabled"),w.setAttribute("aria-disabled","true");let g=document.querySelector("meta[name=csrf-token]")?document.querySelector("meta[name=csrf-token]").getAttribute("content"):"";if(!g){const l=w.closest("form");if(l){const b=l.querySelector("input[name=_token]");b&&(g=b.value)}}fetch(s,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":g,Accept:"application/json"}}).then(l=>{if(l.ok)return l.json().catch(()=>({}));throw new Error("Upload failed")}).then(l=>{const b=w.closest(".template-card");b&&b.remove(),l.success?n("Sent"):l&&l.existing?n("Already exists"):n("Sent")}).catch(l=>{console.error(l),n("Failed to send template",!0),w.classList.remove("disabled"),w.removeAttribute("aria-disabled")})})});function n(w,B=!1){let s=document.getElementById("tw-toast");s||(s=document.createElement("div"),s.id="tw-toast",s.className="tw-toast",document.body.appendChild(s)),s.textContent=w,s.classList.toggle("error",!!B),s.classList.add("visible"),setTimeout(()=>s.classList.remove("visible"),3e3)}});document.addEventListener("DOMContentLoaded",function(){console.log("Template dropdown script loaded");const m=document.querySelector(".create-dropdown-container"),v=document.querySelector(".dropdown-toggle"),c=document.querySelector(".create-dropdown-menu");console.log("Found elements:",{container:!!m,toggle:!!v,menu:!!c}),m&&v&&c?(console.log("All dropdown elements found, attaching event listeners"),c.style.display="none",c.setAttribute("aria-hidden","true"),v.addEventListener("click",function(i){console.log("Dropdown toggle clicked"),i.preventDefault(),i.stopPropagation();const t=c.style.display==="block";console.log("Dropdown currently visible:",t),t?(c.style.display="none",c.setAttribute("aria-hidden","true"),v.setAttribute("aria-expanded","false"),console.log("Dropdown hidden")):(c.style.display="block",c.setAttribute("aria-hidden","false"),v.setAttribute("aria-expanded","true"),console.log("Dropdown shown"))}),document.addEventListener("click",function(i){m.contains(i.target)||(c.style.display="none",c.setAttribute("aria-hidden","true"),v.setAttribute("aria-expanded","false"))}),document.addEventListener("keydown",function(i){i.key==="Escape"&&(c.style.display="none",c.setAttribute("aria-hidden","true"),v.setAttribute("aria-expanded","false"))}),c.addEventListener("click",function(i){i.target.closest(".dropdown-item")&&(c.style.display="none",c.setAttribute("aria-hidden","true"),v.setAttribute("aria-expanded","false"))})):console.error("Dropdown elements not found - this may cause the create template button to not work")});
