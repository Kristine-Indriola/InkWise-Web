const w="http://www.w3.org/2000/svg",k="http://www.w3.org/1999/xlink";class E{constructor(t,s={}){console.log("SvgTemplateEditor: Constructor called for SVG element:",t),this.svg=t,this.options={onImageChange:s.onImageChange||null,onTextChange:s.onTextChange||null,...s};const e=document&&document.body&&document.body.dataset?document.body.dataset:{},i=(e.imageReplacementMode||"").toLowerCase();let n="full";i==="panel-only"||i==="disabled"?n=i:e.allowImageReplacement==="false"&&(n="disabled"),this.imageReplacementMode=n,this.allowCanvasImageTools=n!=="disabled",this.changeableImages=[],this.textElements=[],this.imageClassTokens=new Set(["canvas-layer__image","changeable-image","svg-changeable-image","inkwise-image"]),this.init()}init(){console.log("SvgTemplateEditor: Initializing..."),this.parseSvgData(),this.setupImageHandlers(),this.setupTextHandlers(),this.addCssStyles(),typeof window<"u"&&window.addEventListener("inkwise:text-style-changed",t=>{try{const s=t&&t.detail?t.detail:{},{attribute:e,value:i,key:n}=s;if(!e)return;const a=this._currentInlineEditor||null;if(a&&a.element){const o=a.element.getAttribute("data-preview-node")||a.element.id||null;if(n&&o&&n!==o)return;const l=a.editable;if(!l)return;if(e==="font-family")a.element.setAttribute("font-family",String(i)),a.element.style&&(a.element.style.fontFamily=String(i)),l.style.fontFamily=String(i)||l.style.fontFamily;else if(e==="font-size"){const c=Number(i);Number.isFinite(c)&&(a.element.setAttribute("font-size",String(c)),a.element.style&&(a.element.style.fontSize=`${c}px`),l.style.fontSize=`${c}px`)}else(e==="fill"||e==="color")&&(a.element.setAttribute("fill",String(i)),a.element.style&&(a.element.style.fill=String(i)),l.style.color=String(i)||l.style.color);a.element._boundingBox&&a.element._boundingBox.classList.add("svg-bounding-box--active");return}let r=[];if(n&&typeof n=="string")try{const o=typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(n):n;r=Array.from(this.svg.querySelectorAll(`[data-preview-node="${o}"]`))}catch{r=Array.from(this.svg.querySelectorAll(`[data-preview-node="${n}"]`))}if(!r.length){const o=this.svg.querySelector(".svg-text-focus");o&&r.push(o)}r.forEach(o=>{if(o){if(e==="font-family"){o.setAttribute("font-family",String(i)),o.style&&(o.style.fontFamily=String(i));try{const l=o.getAttribute("style")||"";o.setAttribute("style",`font-family: '${String(i)}', system-ui, sans-serif; ${l}`)}catch{}}else if(e==="font-size"){const l=Number(i);Number.isFinite(l)&&(o.setAttribute("font-size",String(l)),o.style&&(o.style.fontSize=`${l}px`))}else(e==="fill"||e==="color")&&(o.setAttribute("fill",String(i)),o.style&&(o.style.fill=String(i)));try{this.updateBoundingBox(o)}catch{}try{o._boundingBox&&o._boundingBox.classList.add("svg-bounding-box--active")}catch{}}})}catch(s){console.warn("SvgTemplateEditor: failed to apply toolbar style change to inline editor or SVG nodes",s)}}),console.log("SvgTemplateEditor: Initialization complete")}parseSvgData(){const t=this.svg.dataset.svgData;if(t)try{const s=JSON.parse(t);this.changeableImages=s.changeable_images||[],this.textElements=s.text_elements||[],this.textElements.forEach(e=>{const i=this.svg.querySelector(`[data-element-id="${e.id}"]`)||this.svg.querySelector(`#${e.id}`);i&&i.setAttribute("data-editable","true")})}catch(s){console.warn("SvgTemplateEditor: Failed to parse data-svg-data payload",s),this.fallbackParseSvg()}else this.fallbackParseSvg()}fallbackParseSvg(){console.log("SvgTemplateEditor: Using fallback SVG parsing"),this.changeableImages=[],this.textElements=[],this.svg.querySelectorAll("text").forEach((e,i)=>{const n=`fallback-text-${i}`;e.setAttribute("data-element-id",n),e.setAttribute("data-editable","true"),this.textElements.push({id:n,text:e.textContent||"",fontFamily:e.getAttribute("font-family")||"Arial",fontSize:parseFloat(e.getAttribute("font-size"))||16,fill:e.getAttribute("fill")||"#000000",x:parseFloat(e.getAttribute("x"))||0,y:parseFloat(e.getAttribute("y"))||0})}),this.svg.querySelectorAll("image, img").forEach((e,i)=>{const n=`fallback-image-${i}`;e.setAttribute("data-element-id",n),e.setAttribute("data-changeable","image"),this.changeableImages.push({id:n,src:e.getAttribute("href")||e.getAttribute("src")||"",x:parseFloat(e.getAttribute("x"))||0,y:parseFloat(e.getAttribute("y"))||0,width:parseFloat(e.getAttribute("width"))||100,height:parseFloat(e.getAttribute("height"))||100})}),console.log("SvgTemplateEditor: Fallback parsed",this.textElements.length,"text elements,",this.changeableImages.length,"images")}readDatasetTokens(t){return!t||!t.dataset?[]:["changeable","editableType","elementType","layerType","previewType","fieldType"].map(e=>t.dataset[e]).filter(e=>typeof e=="string"&&e.trim()!=="").map(e=>e.trim().toLowerCase())}findImageContentNode(t){return!t||typeof t.querySelector!="function"?null:t.querySelector('[data-changeable="image"], [data-editable-image], .canvas-layer__image, img, image')}nodeRepresentsImage(t){if(!t)return!1;const s=typeof t.tagName=="string"?t.tagName.toLowerCase():"";if(s==="image"||s==="img"||this.readDatasetTokens(t).some(i=>i==="image"||i==="photo"||i==="graphic")||typeof t.hasAttribute=="function"&&(t.hasAttribute("data-editable-image")||t.hasAttribute("data-changeable-image")))return!0;if(t.classList){for(const i of this.imageClassTokens)if(t.classList.contains(i))return!0}return s==="foreignobject"?!!this.findImageContentNode(t):!1}resolveImageNode(t){if(!t)return null;if(this.nodeRepresentsImage(t))return t;if(typeof t.closest=="function"){const s=t.closest("[data-preview-node]");if(s&&s!==t&&this.nodeRepresentsImage(s))return s}return this.findImageContentNode(t)}resolveImageHandleNodes(t){const s=this.resolveImageNode(t);return s?{interactionNode:typeof s.closest=="function"&&s.closest("foreignObject")||s,contentNode:s}:null}applyImageSourceToNode(t,s){if(!t||!s)return null;const e=typeof t.tagName=="string"?t.tagName.toLowerCase():"";if(e==="image")return t.setAttributeNS(k,"href",s),t.setAttribute("href",s),t.dataset&&(t.dataset.src=s),t;if(e==="img")return t.setAttribute("src",s),t.dataset&&(t.dataset.src=s),t;if(e==="foreignobject"){const i=this.findImageContentNode(t);return i&&i!==t?this.applyImageSourceToNode(i,s):null}return e==="rect"?this.convertRectToImage(t,s):(t.style&&typeof t.style.setProperty=="function"&&(t.style.backgroundImage=`url('${s}')`),t.dataset&&(t.dataset.src=s,t.dataset.replacedImage="true"),t)}convertRectToImage(t,s){if(!t||!t.parentNode)return null;const e=document.createElementNS(w,"image");return["x","y","width","height","transform","preserveAspectRatio"].forEach(n=>{t.hasAttribute&&t.hasAttribute(n)&&e.setAttribute(n,t.getAttribute(n))}),Array.from(t.attributes||[]).forEach(n=>{(n.name==="id"||n.name.startsWith("data-"))&&e.setAttribute(n.name,n.value)}),t.classList&&t.classList.length&&t.classList.forEach(n=>e.classList.add(n)),e.setAttribute("href",s),e.setAttributeNS(k,"href",s),e.hasAttribute("preserveAspectRatio")||e.setAttribute("preserveAspectRatio","xMidYMid slice"),t.parentNode.replaceChild(e,t),e}escapeSelector(t){return typeof t!="string"||!t.length?"":typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(t):t.replace(/([^a-zA-Z0-9_-])/g,"\\$1")}resolveNodeFromMetadata(t){if(!t||typeof t!="object")return null;const s=t.id||t.element_id||t.node_id;if(s){const i=`#${this.escapeSelector(s)}`,n=this.svg.querySelector(i);if(n)return n}const e=t.selector||t.css_selector;if(e)try{const i=this.svg.querySelector(e);if(i)return i}catch(i){console.warn("SvgTemplateEditor: Invalid selector in changeable image metadata",e,i)}return null}collectImageCandidates(){const t=new Set;return this.changeableImages.forEach(e=>{const i=this.resolveNodeFromMetadata(e);i&&t.add(i)}),this.svg.querySelectorAll('[data-changeable="image"], [data-editable-image], .changeable-image, .canvas-layer__image, image, img, foreignObject').forEach(e=>{t.add(e)}),Array.from(t)}getBBoxSafe(t){if(!t||typeof t.getBBox!="function")return null;try{return t.getBBox()}catch(s){return console.warn("SvgTemplateEditor: Unable to compute bounding box for element",s,t),null}}toSvgPoint(t,s){if(!this.svg||typeof this.svg.createSVGPoint!="function")return null;const e=this.svg.createSVGPoint();e.x=t,e.y=s;const i=this.svg.getScreenCTM();return i?e.matrixTransform(i.inverse()):null}setupImageHandlers(){const t=this.collectImageCandidates();if(console.log("SvgTemplateEditor: Found",t.length,"changeable image elements"),!this.allowCanvasImageTools){t.forEach(s=>{const e=this.resolveImageHandleNodes(s);if(!e)return;const{interactionNode:i}=e;if(i.style.cursor="default",i.classList.remove("svg-changeable-image"),i.classList.remove("changeable-image-hover"),i._boundingBox){try{i._boundingBox.remove()}catch{}i._boundingBox=null}});return}setTimeout(()=>{t.forEach((s,e)=>{const i=this.resolveImageHandleNodes(s);if(!i)return;const{interactionNode:n,contentNode:a}=i;if(!n||n.__inkwiseSvgImageBound)return;console.log("SvgTemplateEditor: Setting up element",e,n),n.__inkwiseSvgImageBound=!0,n.__inkwiseImageContent=a||n,n.style.cursor="pointer",n.classList.add("svg-changeable-image"),n.classList.add("changeable-image-hover"),n.addEventListener("mouseenter",()=>{n.classList.add("changeable-image-active")}),n.addEventListener("mouseleave",()=>{n.classList.remove("changeable-image-active")}),n.addEventListener("click",o=>{o.preventDefault(),this.showImageUploadDialog(n)});const r=this.createBoundingBox(n);r&&(n._boundingBox=r),this.makeDraggable(n)})},200)}createBoundingBox(t){const s=this.getBBoxSafe(t);if(!s)return null;const e=document.createElementNS(w,"g");e.classList.add("svg-bounding-box");const i=document.createElementNS(w,"rect");return i.classList.add("svg-bounding-box__rect"),i.setAttribute("fill","transparent"),i.setAttribute("stroke","#007cba"),i.setAttribute("stroke-width","2"),i.setAttribute("stroke-dasharray","5,5"),i.setAttribute("rx","3"),i.style.pointerEvents="all",e.appendChild(i),this.createResizeHandles().forEach(a=>e.appendChild(a)),e.style.pointerEvents="all",e.style.cursor="pointer",e.addEventListener("click",a=>{try{a.preventDefault(),a.stopPropagation();const r=e._targetElement||t,l=(this.resolveImageHandleNodes(r)||{interactionNode:r}).interactionNode||r;this.focusElement(l)}catch(r){console.warn("SvgTemplateEditor: bbox click handler error",r)}}),this.svg.appendChild(e),this.positionBoundingElements(e,s),e}createResizeHandles(){const t=[];return[{name:"nw",x:0,y:0},{name:"ne",x:1,y:0},{name:"sw",x:0,y:1},{name:"se",x:1,y:1}].forEach(e=>{const i=document.createElementNS(w,"circle");i.setAttribute("r","4"),i.setAttribute("fill","#007cba"),i.setAttribute("stroke","#ffffff"),i.setAttribute("stroke-width","1"),i.classList.add("resize-handle",`handle-${e.name}`),i.style.pointerEvents="all",i.style.cursor=`${e.name}-resize`,t.push(i)}),t}positionBoundingElements(t,s){if(!t||!s)return;const e=t.querySelector(".svg-bounding-box__rect");if(!e)return;const i=5,n=s.x-i,a=s.y-i,r=s.width+i*2,o=s.height+i*2;e.setAttribute("x",n),e.setAttribute("y",a),e.setAttribute("width",Math.max(r,0)),e.setAttribute("height",Math.max(o,0)),t.querySelectorAll(".resize-handle").forEach(c=>{c.classList.contains("handle-nw")?(c.setAttribute("cx",n),c.setAttribute("cy",a)):c.classList.contains("handle-ne")?(c.setAttribute("cx",n+r),c.setAttribute("cy",a)):c.classList.contains("handle-sw")?(c.setAttribute("cx",n),c.setAttribute("cy",a+o)):c.classList.contains("handle-se")?(c.setAttribute("cx",n+r),c.setAttribute("cy",a+o)):c.classList.contains("handle-n")?(c.setAttribute("cx",n+r/2),c.setAttribute("cy",a)):c.classList.contains("handle-s")?(c.setAttribute("cx",n+r/2),c.setAttribute("cy",a+o)):c.classList.contains("handle-e")?(c.setAttribute("cx",n+r),c.setAttribute("cy",a+o/2)):c.classList.contains("handle-w")&&(c.setAttribute("cx",n),c.setAttribute("cy",a+o/2))})}updateBoundingBox(t){if(!t||!t._boundingBox)return;const s=this.getBBoxSafe(t);this.positionBoundingElements(t._boundingBox,s)}focusElementById(t){if(!t||!this.svg)return!1;const s=`#${this.escapeSelector(t)}`;let e=null;try{e=this.svg.querySelector(s)}catch(i){return console.warn("SvgTemplateEditor: Invalid selector generated for element id",t,i),!1}return e||(e=this.svg.querySelector(`[data-element-id="${t}"]`)),e?this.focusElement(e):!1}focusElement(t){const e=(this.resolveImageHandleNodes(t)||{interactionNode:t}).interactionNode||t;if(!this.getBBoxSafe(e))return!1;if(e._boundingBox||(e._boundingBox=this.createBoundingBox(e),e._boundingBox&&(e._boundingBox._targetElement=e,e._boundingBox.querySelectorAll(".resize-handle").forEach(a=>this.makeResizable(e,a)),this.makeDraggable(e._boundingBox))),this.updateBoundingBox(e),e._boundingBox&&(e._boundingBox.classList.add("svg-bounding-box--pulse"),setTimeout(()=>{e._boundingBox&&e._boundingBox.classList.remove("svg-bounding-box--pulse")},1e3)),typeof e.scrollIntoView=="function"&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),e.classList.add("changeable-image-active"),setTimeout(()=>e.classList.remove("changeable-image-active"),1200),e.tagName&&e.tagName.toLowerCase()==="text"){const n=e.getAttribute("data-preview-node")||e.id||null;try{window.dispatchEvent(new CustomEvent("inkwise:active-element",{detail:{type:"text",key:n}}))}catch{if(typeof document<"u"&&document.createEvent){const r=document.createEvent("CustomEvent");r.initCustomEvent("inkwise:active-element",!0,!0,{type:"text",key:n}),window.dispatchEvent(r)}}this.showTextEditDialog(e)}return!0}makeDraggable(t){let s=!1,e=0,i=0,n=0,a=0,r=0,o=0;const l=t._targetElement||t,c=g=>{if(g.target.closest(".resize-handle"))return;const u=this.toSvgPoint(g.clientX,g.clientY);if(!u)return;const h=this.getBBoxSafe(l);if(!h)return;const f=typeof l.getAttribute=="function",m=typeof l.setAttribute=="function";e=f?parseFloat(l.getAttribute("x")):h.x,i=f?parseFloat(l.getAttribute("y")):h.y,Number.isNaN(e)&&(e=h.x,m&&l.setAttribute("x",e)),Number.isNaN(i)&&(i=h.y,m&&l.setAttribute("y",i)),n=u.x-e,a=u.y-i,r=e,o=i,s=!0,t.style.cursor="grabbing",this.svg.style.cursor="grabbing",document.body.style.userSelect="none",g.preventDefault()},p=g=>{if(!s)return;const u=this.toSvgPoint(g.clientX,g.clientY);u&&(r=u.x-n,o=u.y-a,typeof l.removeAttribute=="function"&&l.removeAttribute("transform"),typeof l.setAttribute=="function"&&(l.setAttribute("x",r),l.setAttribute("y",o)),this.updateBoundingBox(l),g.preventDefault())},v=g=>{if(!s)return;s=!1,t.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="",this.updateBoundingBox(l);const u=new CustomEvent("svgImageMoved",{detail:{element:l,x:r,y:o}});this.svg.dispatchEvent(u),g.preventDefault()};t.addEventListener("mousedown",c),document.addEventListener("mousemove",p),document.addEventListener("mouseup",v),t._boundingBox&&t._boundingBox.querySelectorAll(".resize-handle").forEach(u=>{this.makeResizable(t,u)})}makeResizable(t,s){let e=!1,i=null,n=0,a=0,r=0,o=0,l="",c=0;const p=u=>{const h=this.toSvgPoint(u.clientX,u.clientY);if(!h)return;const f=this.getBBoxSafe(t);if(!f)return;n=f.width,a=f.height;const m=typeof t.getAttribute=="function",d=typeof t.setAttribute=="function";r=m?parseFloat(t.getAttribute("x")):f.x,o=m?parseFloat(t.getAttribute("y")):f.y,Number.isNaN(r)&&(r=f.x,d&&t.setAttribute("x",r)),Number.isNaN(o)&&(o=f.y,d&&t.setAttribute("y",o)),c=parseFloat(t.getAttribute("font-size"))||parseFloat(window.getComputedStyle(t).fontSize)||16,i=h,l=Array.from(s.classList).find(b=>b.startsWith("handle-"))||"",e=!0,t.style.cursor=s.style.cursor,this.svg.style.cursor=s.style.cursor,document.body.style.userSelect="none",u.preventDefault(),u.stopPropagation()},v=u=>{if(!e)return;const h=this.toSvgPoint(u.clientX,u.clientY);if(!h)return;const f=h.x-i.x,m=h.y-i.y;let d=n,b=a,y=r,x=o;switch(l){case"handle-se":d=n+f,b=a+m;break;case"handle-sw":d=n-f,b=a+m,y=r+f;break;case"handle-ne":d=n+f,b=a-m,x=o+m;break;case"handle-nw":d=n-f,b=a-m,y=r+f,x=o+m;break}d=Math.max(20,d),b=Math.max(20,b);const A=t.tagName.toLowerCase();if((A==="image"||A==="rect")&&typeof t.setAttribute=="function")t.setAttribute("width",d),t.setAttribute("height",b),t.setAttribute("x",y),t.setAttribute("y",x);else{const C=Math.max(1,n),_=Math.max(1,a),T=d/C,L=b/_,B=Math.max(T,L),I=Math.max(6,c*B);typeof t.setAttribute=="function"&&t.setAttribute("font-size",I)}this.updateBoundingBox(t),u.preventDefault(),u.stopPropagation()},g=u=>{if(!e)return;e=!1,t.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="";const h={element:t,width:parseFloat(t.getAttribute?t.getAttribute("width"):"")||n,height:parseFloat(t.getAttribute?t.getAttribute("height"):"")||a,x:parseFloat(t.getAttribute?t.getAttribute("x"):"")||r,y:parseFloat(t.getAttribute?t.getAttribute("y"):"")||o},f=new CustomEvent("svgImageResized",{detail:h});this.svg.dispatchEvent(f),u.preventDefault(),u.stopPropagation()};s.addEventListener("mousedown",p),document.addEventListener("mousemove",v),document.addEventListener("mouseup",g)}setupTextHandlers(){const t=this;this.svg.querySelectorAll('[data-editable="true"]').forEach(e=>{e.style.cursor="pointer",e.classList.add("svg-editable-text"),e.addEventListener("click",function(i){i.preventDefault(),t.focusElement(e)}),e.addEventListener("mouseenter",function(){e.classList.add("editable-text-hover")}),e.addEventListener("mouseleave",function(){e.classList.remove("editable-text-hover")})})}showImageUploadDialog(t){const s=this,e=document.createElement("input");e.type="file",e.accept="image/*",e.style.display="none",e.addEventListener("change",function(i){const n=i.target.files[0];n&&s.handleImageUpload(n,t),e.parentNode&&e.parentNode.removeChild(e)}),document.body.appendChild(e),e.click()}async handleImageUpload(t,s){var c;const e=this,i=s&&s.__inkwiseImageContent?s.__inkwiseImageContent:s,n=((c=document.querySelector('meta[name="csrf-token"]'))==null?void 0:c.getAttribute("content"))||null,a=new FormData;a.append("image",t),n&&a.append("_token",n);let r=null;try{const p=await fetch("/design/upload-image",{method:"POST",body:a,credentials:"same-origin"});if(!p.ok){const g=await p.text().catch(()=>"");throw new Error(`Upload failed (${p.status}): ${g}`)}const v=await p.json();r=v.url||v.path||null}catch(p){console.error("SvgTemplateEditor: Failed to upload image",p),alert("We could not upload your image. Please try again.");const v=new CustomEvent("svgImageUploadFailed",{detail:{error:p,file:t}});e.svg.dispatchEvent(v);return}if(!r){alert("Upload did not return a usable image URL.");return}const o=e.applyImageSourceToNode(i,r)||i;s&&o&&s.__inkwiseImageContent!==o&&(s.__inkwiseImageContent=o);const l=new CustomEvent("svgImageChanged",{detail:{element:o,imageUrl:r,file:t}});e.svg.dispatchEvent(l),e.options.onImageChange&&e.options.onImageChange(o,r,t),e.updateBoundingBox(s||o)}showTextEditDialog(t){const s=this,e=t.textContent||"",i=this.getBBoxSafe(t);if(!i)return;const n=2,a=document.createElementNS(w,"foreignObject");a.setAttribute("x",i.x-n),a.setAttribute("y",i.y-n),a.setAttribute("width",Math.max(i.width+n*2,40)),a.setAttribute("height",Math.max(i.height+n*2,20)),a.classList.add("svg-text-foreignobject"),a.style.pointerEvents="all";const r="http://www.w3.org/1999/xhtml",o=document.createElementNS(r,"div");o.setAttribute("xmlns",r),o.contentEditable="true",o.className="svg-text-editor-fo";const l=window.getComputedStyle(t);o.style.fontSize=l.fontSize||"16px",o.style.fontFamily=l.fontFamily||"sans-serif",o.style.lineHeight=l.lineHeight||"1";const c=t.getAttribute("fill")||l.color||"#000";o.style.color=c,o.style.width="100%",o.style.height="100%",o.style.background="transparent",o.style.padding="2px",o.style.outline="none",o.style.overflow="hidden",o.style.resize="none",o.style.whiteSpace="pre",o.style.textAlign=t.getAttribute("text-anchor")==="middle"?"center":"left",o.style.caretColor="#007cba",o.textContent=e,t.style.visibility="hidden";const p=function(d=!0){try{g&&(u&&g.removeEventListener("mousedown",u),h&&g.removeEventListener("mouseup",h))}catch{}const b=o.textContent||"";if(t.style.visibility="visible",a.parentNode&&a.parentNode.removeChild(a),d){for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(b));const y=new CustomEvent("svgTextChanged",{detail:{element:t,oldText:e,newText:b}});s.svg.dispatchEvent(y),s.options.onTextChange&&s.options.onTextChange(t,e,b)}t._boundingBox&&t._boundingBox.classList.remove("svg-bounding-box--active");try{window.dispatchEvent(new CustomEvent("inkwise:active-element",{detail:{type:null}}))}catch{if(typeof document<"u"&&document.createEvent){const x=document.createEvent("CustomEvent");x.initCustomEvent("inkwise:active-element",!0,!0,{type:null}),window.dispatchEvent(x)}}},v=function(){try{g&&(u&&g.removeEventListener("mousedown",u),h&&g.removeEventListener("mouseup",h))}catch{}t.style.visibility="visible",a.parentNode&&a.parentNode.removeChild(a),t._boundingBox&&t._boundingBox.classList.remove("svg-bounding-box--active");try{window.dispatchEvent(new CustomEvent("inkwise:active-element",{detail:{type:null}}))}catch{if(typeof document<"u"&&document.createEvent){const b=document.createEvent("CustomEvent");b.initCustomEvent("inkwise:active-element",!0,!0,{type:null}),window.dispatchEvent(b)}}},g=typeof document<"u"?document.querySelector(".studio-react-widgets"):null;let u=null,h=null,f=!1;g&&(u=function(){f=!0},h=function(){setTimeout(()=>{f=!1;try{o.focus()}catch{}},0)},g.addEventListener("mousedown",u),g.addEventListener("mouseup",h)),o.addEventListener("focus",function(){try{window.dispatchEvent(new CustomEvent("inkwise:active-element",{detail:{type:"text"}}))}catch{if(typeof document<"u"&&document.createEvent){const b=document.createEvent("CustomEvent");b.initCustomEvent("inkwise:active-element",!0,!0,{type:"text"}),window.dispatchEvent(b)}}}),o.addEventListener("blur",function(){f||p(!0)}),o.addEventListener("keydown",function(d){d.key==="Enter"?(d.preventDefault(),p(!0)):d.key==="Escape"&&(d.preventDefault(),v())}),a.appendChild(o),this.svg.appendChild(a),t._boundingBox&&t._boundingBox.classList.add("svg-bounding-box--active"),o.focus();const m=window.getSelection();try{const d=document.createRange();d.selectNodeContents(o),m.removeAllRanges(),m.addRange(d)}catch{}}addCssStyles(){if(document.getElementById("svg-editor-styles"))return;const t=document.createElement("style");t.id="svg-editor-styles",t.textContent=`
            .svg-changeable-image {
                transition: all 0.2s ease;
            }

            .changeable-image-hover:hover {
                filter: brightness(0.8);
                stroke: #007cba !important;
                stroke-width: 2px !important;
            }

            .changeable-image-active {
                filter: brightness(0.7);
                stroke: #007cba !important;
                stroke-width: 3px !important;
            }

            .svg-bounding-box {
                transition: all 0.2s ease;
            }

            .svg-bounding-box__rect {
                pointer-events: none;
            }

            .resize-handle {
                transition: all 0.2s ease;
                pointer-events: all !important;
            }

            .resize-handle:hover {
                fill: #005a87;
                r: 6px;
            }

            .svg-editable-text {
                transition: all 0.2s ease;
            }

            .editable-text-hover:hover {
                fill: #007cba !important;
                text-decoration: underline;
            }

            .uploaded-image {
                transition: all 0.2s ease;
            }

            .svg-text-editor {
                box-sizing: border-box;
                outline: none;
            }

            .svg-text-editor:focus {
                box-shadow: 0 0 5px rgba(0, 124, 186, 0.5);
            }

            /* foreignObject inline editor styles */
            .svg-text-foreignobject { pointer-events: all; }
            .svg-text-editor-fo {
                width: 100%;
                height: 100%;
                box-sizing: border-box;
                -webkit-tap-highlight-color: rgba(0,0,0,0);
                padding: 2px;
                white-space: pre;
                overflow: hidden;
                outline: none;
            }

            .svg-bounding-box--active .svg-bounding-box__rect {
                stroke: #007cba;
                stroke-width: 3;
                opacity: 1;
            }
                .svg-bounding-box--pulse .svg-bounding-box__rect {
                    animation: svgBoundingBoxPulse 1s ease-out;
                }

                @keyframes svgBoundingBoxPulse {
                    0% {
                        stroke-width: 2;
                        opacity: 1;
                    }
                    50% {
                        stroke-width: 4;
                        opacity: 0.4;
                    }
                    100% {
                        stroke-width: 2;
                        opacity: 1;
                    }
                }
        `,document.head.appendChild(t)}getSvgString(){const t=this.svg.cloneNode(!0);t.querySelectorAll('.svg-bounding-box, .inkwise-editor-marker, [data-editor-only="true"]').forEach(i=>{var n;(n=i.parentNode)==null||n.removeChild(i)}),t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),t.style.width="",t.style.height="",t.style.maxWidth="",t.style.maxHeight="",t.removeAttribute("preserveAspectRatio");const s=document.createElementNS(w,"style");return s.id="inkwise-export-styles",s.textContent=`
            @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
            text { white-space: pre; }
        `,t.insertBefore(s,t.firstChild),new XMLSerializer().serializeToString(t)}getSvgDataUrl(){const t=this.getSvgString();return"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(t)))}async saveSvg(t,s="front"){const e=this.getSvgString();try{const i=await fetch(`/staff/templates/${t}/save-svg`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({svg_content:e,side:s})});if(!i.ok){const a=await i.text().catch(()=>"");throw new Error(a||`Request failed with status ${i.status}`)}let n;try{n=await i.json()}catch(a){console.warn("SvgTemplateEditor: Failed to parse save response",a),n={success:!1,error:"Invalid response from server"}}return n}catch(i){return console.error("Failed to save SVG:",i),{success:!1,error:i.message}}}}function N(){const S=()=>{const t=document.querySelectorAll("svg[data-svg-editor]");console.log("SvgTemplateEditor: Found",t.length,"SVGs with data-svg-editor attribute"),t.forEach((s,e)=>{s.__inkwiseSvgTemplateEditor||(console.log("SvgTemplateEditor: Initializing editor",e,"for SVG:",s),s.__inkwiseSvgTemplateEditor=new E(s))})};if(document.readyState==="complete"||document.readyState==="interactive"?S():document.addEventListener("DOMContentLoaded",S,{once:!0}),!window.__inkwiseSvgTemplateEditorObserver){const t=new MutationObserver(s=>{s.forEach(e=>{e.addedNodes.forEach(i=>{i.nodeType===1&&i.matches&&i.matches("svg[data-svg-editor]")&&(i.__inkwiseSvgTemplateEditor||(i.__inkwiseSvgTemplateEditor=new E(i)))})})});t.observe(document.body,{childList:!0,subtree:!0}),window.__inkwiseSvgTemplateEditorObserver=t}}typeof window<"u"&&(window.SvgTemplateEditor=E,window.__inkwiseSvgTemplateEditorAutoInit||(window.__inkwiseSvgTemplateEditorAutoInit=!0,N()));
