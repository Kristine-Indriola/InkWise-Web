class w{constructor(t,s={}){console.log("SvgTemplateEditor: Constructor called for SVG element:",t),this.svg=t,this.options={onImageChange:s.onImageChange||null,onTextChange:s.onTextChange||null,...s};const i=document&&document.body&&document.body.dataset?document.body.dataset:{},e=(i.imageReplacementMode||"").toLowerCase();let o="full";e==="panel-only"||e==="disabled"?o=e:i.allowImageReplacement==="false"&&(o="disabled"),this.imageReplacementMode=o,this.allowCanvasImageTools=o!=="disabled",this.changeableImages=[],this.textElements=[],this.init()}init(){console.log("SvgTemplateEditor: Initializing..."),this.parseSvgData(),this.setupImageHandlers(),this.setupTextHandlers(),this.addCssStyles(),console.log("SvgTemplateEditor: Initialization complete")}parseSvgData(){const t=this.svg.dataset.svgData;if(t){const s=JSON.parse(t);this.changeableImages=s.changeable_images||[],this.textElements=s.text_elements||[]}}toSvgPoint(t,s){if(!this.svg||typeof this.svg.createSVGPoint!="function")return null;const i=this.svg.createSVGPoint();i.x=t,i.y=s;const e=this.svg.getScreenCTM();return e?i.matrixTransform(e.inverse()):null}setupImageHandlers(){const t=this.svg.querySelectorAll('[data-changeable="image"], [data-editable-image]');if(console.log("SvgTemplateEditor: Found",t.length,"changeable image elements"),!this.allowCanvasImageTools){t.forEach(s=>{if(s.style.cursor="default",s.classList.remove("svg-changeable-image"),s.classList.remove("changeable-image-hover"),s._boundingBox){try{s._boundingBox.remove()}catch{}s._boundingBox=null}});return}setTimeout(()=>{t.forEach((s,i)=>{console.log("SvgTemplateEditor: Setting up element",i,s),s.style.cursor="pointer",s.classList.add("svg-changeable-image"),s.classList.add("changeable-image-hover"),s.addEventListener("mouseenter",function(){s.classList.add("changeable-image-active")}),s.addEventListener("mouseleave",function(){s.classList.remove("changeable-image-active")});const e=this.createBoundingBox(s);s._boundingBox=e,this.makeDraggable(s)})},200)}createBoundingBox(t){const s=t.getBBox(),i=document.createElementNS("http://www.w3.org/2000/svg","g");i.classList.add("svg-bounding-box");const e=document.createElementNS("http://www.w3.org/2000/svg","rect");return e.classList.add("svg-bounding-box__rect"),e.setAttribute("fill","none"),e.setAttribute("stroke","#007cba"),e.setAttribute("stroke-width","2"),e.setAttribute("stroke-dasharray","5,5"),e.setAttribute("rx","3"),e.style.pointerEvents="none",i.appendChild(e),this.createResizeHandles().forEach(n=>i.appendChild(n)),this.svg.appendChild(i),this.positionBoundingElements(i,s),i}createResizeHandles(){const t=[];return[{name:"nw",x:0,y:0},{name:"ne",x:1,y:0},{name:"sw",x:0,y:1},{name:"se",x:1,y:1}].forEach(i=>{const e=document.createElementNS("http://www.w3.org/2000/svg","circle");e.setAttribute("r","4"),e.setAttribute("fill","#007cba"),e.setAttribute("stroke","#ffffff"),e.setAttribute("stroke-width","1"),e.classList.add("resize-handle",`handle-${i.name}`),e.style.pointerEvents="all",e.style.cursor=`${i.name}-resize`,t.push(e)}),t}positionBoundingElements(t,s){const i=t.querySelector(".svg-bounding-box__rect");if(!i)return;const e=5,o=s.x-e,n=s.y-e,c=s.width+e*2,a=s.height+e*2;i.setAttribute("x",o),i.setAttribute("y",n),i.setAttribute("width",Math.max(c,0)),i.setAttribute("height",Math.max(a,0)),t.querySelectorAll(".resize-handle").forEach(r=>{r.classList.contains("handle-nw")?(r.setAttribute("cx",o),r.setAttribute("cy",n)):r.classList.contains("handle-ne")?(r.setAttribute("cx",o+c),r.setAttribute("cy",n)):r.classList.contains("handle-sw")?(r.setAttribute("cx",o),r.setAttribute("cy",n+a)):r.classList.contains("handle-se")?(r.setAttribute("cx",o+c),r.setAttribute("cy",n+a)):r.classList.contains("handle-n")?(r.setAttribute("cx",o+c/2),r.setAttribute("cy",n)):r.classList.contains("handle-s")?(r.setAttribute("cx",o+c/2),r.setAttribute("cy",n+a)):r.classList.contains("handle-e")?(r.setAttribute("cx",o+c),r.setAttribute("cy",n+a/2)):r.classList.contains("handle-w")&&(r.setAttribute("cx",o),r.setAttribute("cy",n+a/2))})}updateBoundingBox(t){if(!t._boundingBox)return;const s=t.getBBox();this.positionBoundingElements(t._boundingBox,s)}makeDraggable(t){let s=!1,i=0,e=0,o=0,n=0,c=0,a=0;const p=l=>{if(l.target.closest(".resize-handle"))return;const d=this.toSvgPoint(l.clientX,l.clientY);if(!d)return;const u=t.getBBox();i=parseFloat(t.getAttribute("x")),e=parseFloat(t.getAttribute("y")),Number.isNaN(i)&&(i=u.x,t.setAttribute("x",i)),Number.isNaN(e)&&(e=u.y,t.setAttribute("y",e)),o=d.x-i,n=d.y-e,c=i,a=e,s=!0,t.style.cursor="grabbing",this.svg.style.cursor="grabbing",document.body.style.userSelect="none",l.preventDefault()},r=l=>{if(!s)return;const d=this.toSvgPoint(l.clientX,l.clientY);d&&(c=d.x-o,a=d.y-n,t.removeAttribute("transform"),t.setAttribute("x",c),t.setAttribute("y",a),this.updateBoundingBox(t),l.preventDefault())},y=l=>{if(!s)return;s=!1,t.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="",this.updateBoundingBox(t);const d=new CustomEvent("svgImageMoved",{detail:{element:t,x:c,y:a}});this.svg.dispatchEvent(d),l.preventDefault()};t.addEventListener("mousedown",p),document.addEventListener("mousemove",r),document.addEventListener("mouseup",y),t._boundingBox.querySelectorAll(".resize-handle").forEach(l=>{this.makeResizable(t,l)})}makeResizable(t,s){let i=!1,e=null,o=0,n=0,c=0,a=0,p="",r=0;const y=d=>{const u=this.toSvgPoint(d.clientX,d.clientY);if(!u)return;const g=t.getBBox();o=g.width,n=g.height,c=parseFloat(t.getAttribute("x")),a=parseFloat(t.getAttribute("y")),Number.isNaN(c)&&(c=g.x,t.setAttribute("x",c)),Number.isNaN(a)&&(a=g.y,t.setAttribute("y",a)),r=parseFloat(t.getAttribute("font-size"))||parseFloat(window.getComputedStyle(t).fontSize)||16,e=u,p=Array.from(s.classList).find(h=>h.startsWith("handle-"))||"",i=!0,t.style.cursor=s.style.cursor,this.svg.style.cursor=s.style.cursor,document.body.style.userSelect="none",d.preventDefault(),d.stopPropagation()},A=d=>{if(!i)return;const u=this.toSvgPoint(d.clientX,d.clientY);if(!u)return;const g=u.x-e.x,h=u.y-e.y;let b=o,v=n,x=c,m=a;switch(p){case"handle-se":b=o+g,v=n+h;break;case"handle-sw":b=o-g,v=n+h,x=c+g;break;case"handle-ne":b=o+g,v=n-h,m=a+h;break;case"handle-nw":b=o-g,v=n-h,x=c+g,m=a+h;break}b=Math.max(20,b),v=Math.max(20,v);const S=t.tagName.toLowerCase();if(S==="image"||S==="rect")t.setAttribute("width",b),t.setAttribute("height",v),t.setAttribute("x",x),t.setAttribute("y",m);else{const E=Math.max(1,o),C=Math.max(1,n),L=b/E,T=v/C,k=Math.max(L,T),z=Math.max(6,r*k);t.setAttribute("font-size",z)}this.updateBoundingBox(t),d.preventDefault(),d.stopPropagation()},l=d=>{if(!i)return;i=!1,t.style.cursor="pointer",this.svg.style.cursor="default",document.body.style.userSelect="";const u={element:t,width:parseFloat(t.getAttribute("width")),height:parseFloat(t.getAttribute("height")),x:parseFloat(t.getAttribute("x")),y:parseFloat(t.getAttribute("y"))},g=new CustomEvent("svgImageResized",{detail:u});this.svg.dispatchEvent(g),d.preventDefault(),d.stopPropagation()};s.addEventListener("mousedown",y),document.addEventListener("mousemove",A),document.addEventListener("mouseup",l)}setupTextHandlers(){const t=this;this.svg.querySelectorAll('[data-editable="true"]').forEach(i=>{i.style.cursor="pointer",i.classList.add("svg-editable-text"),i.addEventListener("click",function(e){e.preventDefault(),t.showTextEditDialog(i)}),i.addEventListener("mouseenter",function(){i.classList.add("editable-text-hover")}),i.addEventListener("mouseleave",function(){i.classList.remove("editable-text-hover")})})}showImageUploadDialog(t){const s=this,i=document.createElement("input");i.type="file",i.accept="image/*",i.style.display="none",i.addEventListener("change",function(e){const o=e.target.files[0];o&&s.handleImageUpload(o,t),document.body.removeChild(i)}),document.body.appendChild(i),i.click()}handleImageUpload(t,s){const i=this,e=new FileReader;e.onload=function(o){const n=o.target.result;if(s.tagName.toLowerCase()==="image")s.setAttribute("href",n),s.hasAttribute("xlink:href")&&s.removeAttribute("xlink:href");else if(s.tagName.toLowerCase()==="rect"){const a=document.createElementNS("http://www.w3.org/2000/svg","image");a.setAttribute("x",s.getAttribute("x")||"0"),a.setAttribute("y",s.getAttribute("y")||"0"),a.setAttribute("width",s.getAttribute("width")||"100"),a.setAttribute("height",s.getAttribute("height")||"100"),a.setAttribute("href",n),a.setAttribute("preserveAspectRatio","xMidYMid slice"),a.classList.add("uploaded-image"),s.parentNode.replaceChild(a,s),s=a}const c=new CustomEvent("svgImageChanged",{detail:{element:s,imageUrl:n,file:t}});i.svg.dispatchEvent(c),i.options.onImageChange&&i.options.onImageChange(s,n,t)},e.readAsDataURL(t)}showTextEditDialog(t){const s=this,i=t.textContent||"",e=document.createElement("input");e.type="text",e.value=i,e.className="svg-text-editor";const o=t.getBoundingClientRect(),n=s.svg.getBoundingClientRect();e.style.position="absolute",e.style.left=o.left-n.left+"px",e.style.top=o.top-n.top+"px",e.style.width=Math.max(o.width,100)+"px",e.style.fontSize=window.getComputedStyle(t).fontSize,e.style.fontFamily=window.getComputedStyle(t).fontFamily,e.style.border="1px solid #007cba",e.style.padding="2px",e.style.background="white",e.style.zIndex="1000",t.style.visibility="hidden",s.svg.parentNode.appendChild(e),e.focus(),e.select();const c=function(){const a=e.value;for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(a)),t.style.visibility="visible",e.parentNode&&e.parentNode.removeChild(e);const p=new CustomEvent("svgTextChanged",{detail:{element:t,oldText:i,newText:a}});s.svg.dispatchEvent(p),s.options.onTextChange&&s.options.onTextChange(t,i,a)};e.addEventListener("blur",c),e.addEventListener("keydown",function(a){a.key==="Enter"?c():a.key==="Escape"&&(t.style.visibility="visible",e.parentNode&&e.parentNode.removeChild(e))})}addCssStyles(){if(document.getElementById("svg-editor-styles"))return;const t=document.createElement("style");t.id="svg-editor-styles",t.textContent=`
            .svg-changeable-image {
                transition: all 0.2s ease;
            }

            .changeable-image-hover:hover {
                filter: brightness(0.8);
                stroke: #007cba !important;
                stroke-width: 2px !important;
            }

            .changeable-image-active {
                filter: brightness(0.7);
                stroke: #007cba !important;
                stroke-width: 3px !important;
            }

            .svg-bounding-box {
                transition: all 0.2s ease;
            }

            .svg-bounding-box__rect {
                pointer-events: none;
            }

            .resize-handle {
                transition: all 0.2s ease;
                pointer-events: all !important;
            }

            .resize-handle:hover {
                fill: #005a87;
                r: 6px;
            }

            .svg-editable-text {
                transition: all 0.2s ease;
            }

            .editable-text-hover:hover {
                fill: #007cba !important;
                text-decoration: underline;
            }

            .uploaded-image {
                transition: all 0.2s ease;
            }

            .svg-text-editor {
                box-sizing: border-box;
                outline: none;
            }

            .svg-text-editor:focus {
                box-shadow: 0 0 5px rgba(0, 124, 186, 0.5);
            }
        `,document.head.appendChild(t)}getSvgString(){return new XMLSerializer().serializeToString(this.svg)}getSvgDataUrl(){const t=this.getSvgString();return"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(t)))}async saveSvg(t,s="front"){const i=this.getSvgString();try{return await(await fetch(`/staff/templates/${t}/save-svg`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({svg_content:i,side:s})})).json()}catch(e){return console.error("Failed to save SVG:",e),{success:!1,error:e.message}}}}function _(){const f=()=>{const t=document.querySelectorAll("svg[data-svg-editor]");console.log("SvgTemplateEditor: Found",t.length,"SVGs with data-svg-editor attribute"),t.forEach((s,i)=>{s.__inkwiseSvgTemplateEditor||(console.log("SvgTemplateEditor: Initializing editor",i,"for SVG:",s),s.__inkwiseSvgTemplateEditor=new w(s))})};if(document.readyState==="complete"||document.readyState==="interactive"?f():document.addEventListener("DOMContentLoaded",f,{once:!0}),!window.__inkwiseSvgTemplateEditorObserver){const t=new MutationObserver(s=>{s.forEach(i=>{i.addedNodes.forEach(e=>{e.nodeType===1&&e.matches&&e.matches("svg[data-svg-editor]")&&(e.__inkwiseSvgTemplateEditor||(e.__inkwiseSvgTemplateEditor=new w(e)))})})});t.observe(document.body,{childList:!0,subtree:!0}),window.__inkwiseSvgTemplateEditorObserver=t}}typeof window<"u"&&(window.SvgTemplateEditor=w,window.__inkwiseSvgTemplateEditorAutoInit||(window.__inkwiseSvgTemplateEditorAutoInit=!0,_()));
